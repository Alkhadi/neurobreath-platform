generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Session {
  id           String   @id @default(cuid())
  deviceId     String
  technique    String   // box, coherent, four78, sos, roulette, ladder, colourPath
  label        String
  minutes      Int
  breaths      Int      @default(0)
  rounds       Int      @default(0)
  completedAt  DateTime @default(now())
  category     String?  // calm, focus, sleep, school, mood

  @@index([deviceId, completedAt])
}

model Progress {
  id                   String   @id @default(cuid())
  deviceId             String   @unique
  totalSessions        Int      @default(0)
  totalMinutes         Int      @default(0)
  totalBreaths         Int      @default(0)
  currentStreak        Int      @default(0)
  longestStreak        Int      @default(0)
  lastSessionDate      String?  // Store as YYYY-MM-DD for streak tracking
  updatedAt            DateTime @default(now()) @updatedAt
}

model Badge {
  id              String   @id @default(cuid())
  deviceId        String
  badgeKey        String   // firstBreath, weekWarrior, steadyNavigator, etc
  badgeName       String
  badgeIcon       String
  unlockedAt      DateTime @default(now())

  @@unique([deviceId, badgeKey])
  @@index([deviceId])
}

model Challenge {
  id               String   @id @default(cuid())
  deviceId         String
  challengeKey     String   // dailyCalm, morningFocus, sleepReset, etc
  challengeName    String
  category         String   // calm, focus, sleep, school, mood
  targetSessions   Int
  currentSessions  Int      @default(0)
  isCompleted      Boolean  @default(false)
  lastCompletedDate String? // YYYY-MM-DD
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt

  @@unique([deviceId, challengeKey])
  @@index([deviceId, category])
}

model DailyQuest {
  id            String   @id @default(cuid())
  deviceId      String
  questDate     String   // YYYY-MM-DD
  category      String   // calm, focus, sleep, school, mood
  minutes       Int
  technique     String
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  points        Int      @default(0)

  @@unique([deviceId, questDate, category])
  @@index([deviceId, questDate])
}

model VoicePreference {
  id              String   @id @default(cuid())
  deviceId        String   @unique
  voiceName       String   @default("UK English Voice")
  voiceSpeed      String   @default("Steady")
  useTTS          Boolean  @default(true)
  useVibration    Boolean  @default(false)
  updatedAt       DateTime @default(now()) @updatedAt
}

// ============================================================================
// READING ASSESSMENT MODELS
// ============================================================================

model NbCardFrame {
  id          String   @id @default(cuid())
  name        String
  category    String   // ADDRESS | BANK | BUSINESS
  imageUrl    String
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([category, isActive, sortOrder])
}

model ReadingPassage {
  id              String   @id @default(cuid())
  title           String
  text            String
  wordCount       Int
  levelBand       String   // beginner, elementary, intermediate, advanced
  nbLevel         String?  // NB-L0 through NB-L8 (new placement system)
  license         String   @default("public-domain") // public-domain, cc0, user-authored, licensed
  sourceAttribution String?
  
  // Extended metadata for realistic assessment
  tags            String[] @default([]) // phonicsFocus, morphologyFocus, topic tags
  readabilityHint String?  // Additional readability notes
  learnerGroups   String[] @default([]) // children, youth, adolescence, adult - content suitability
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  readingAttempts ReadingAttempt[]
  comprehensionQuestions ComprehensionQuestion[]

  @@index([levelBand, createdAt])
  @@index([nbLevel])
}

model WordList {
  id              String   @id @default(cuid())
  title           String
  description     String?
  levelBand       String   // beginner, elementary, intermediate, advanced
  nbLevel         String?  // NB-L0 through NB-L8 (new placement system)
  words           String[] // array of words
  wordCount       Int
  license         String   @default("public-domain")
  
  // Extended metadata for categorization
  category        String?  // high-frequency, decodable-cvc, vowel-teams, morphology, confusables
  learnerGroups   String[] @default([]) // children, youth, adolescence, adult - content suitability
  
  createdAt       DateTime @default(now())

  readingAttempts ReadingAttempt[]

  @@index([levelBand])
  @@index([levelBand, category])
  @@index([nbLevel])
}

model PseudowordList {
  id              String   @id @default(cuid())
  title           String
  levelBand       String   // beginner, elementary, intermediate, advanced
  nbLevel         String?  // NB-L0 through NB-L8 (new placement system)
  items           String[] // array of pseudowords
  generatorParams Json // stores the pattern rules used to generate
  createdAt       DateTime @default(now())

  readingAttempts ReadingAttempt[]

  @@index([levelBand])
  @@index([nbLevel])
}

model ComprehensionQuestion {
  id                 String   @id @default(cuid())
  passageId          String
  passage            ReadingPassage @relation(fields: [passageId], references: [id], onDelete: Cascade)
  prompt             String
  choices            Json   // { index: 0, text: "Choice A" }, etc
  correctChoiceIndex Int
  explanation        String?
  difficulty         String @default("intermediate") // easy, intermediate, hard
  
  // Question type for realistic assessment
  questionType       String @default("literal") // literal, inferential, vocab, sequence, main-idea
  
  createdAt          DateTime @default(now())
  
  // Track responses for this question
  responses          AttemptComprehensionResponse[]

  @@index([passageId])
  @@index([passageId, questionType])
}

// Main assessment session that can contain multiple parts
model ReadingAttempt {
  id                      String   @id @default(cuid())
  deviceId                String
  assessmentType          String   // fullCheckIn, orf, wordList, pseudoword, comprehension, quickAssessment
  
  // Learner Group (for age-appropriate content and weighting)
  learnerGroup            String?  // children, youth, adolescence, adult
  
  // Content references
  passageId               String?
  passage                 ReadingPassage? @relation(fields: [passageId], references: [id], onDelete: SetNull)
  wordListId              String?
  wordList                WordList? @relation(fields: [wordListId], references: [id], onDelete: SetNull)
  pseudowordListId        String?
  pseudowordList          PseudowordList? @relation(fields: [pseudowordListId], references: [id], onDelete: SetNull)
  
  // Timing
  startedAt               DateTime @default(now())
  endedAt                 DateTime?
  durationSeconds         Int      @default(0)
  
  // Target and result bands for adaptive routing
  levelBandTarget         String?  // What level was attempted (legacy band)
  levelBandResult         String?  // What level was determined (legacy band)
  confidence              String?  // low, medium, high - based on evidence quantity
  
  // Placement Results (new NB Level system)
  placementLevel          String?  // NB-L0 through NB-L8
  placementConfidence     String?  // low, medium, high
  placementPlanJson       Json?    // Full PlacementPlan object
  
  // ORF / Word Reading Metrics
  totalWords              Int      @default(0)
  wordsCorrect            Int      @default(0)
  errorsTotal             Int      @default(0)
  accuracyPct             Float    @default(0)
  wcpm                    Float    @default(0) // Words Correct Per Minute
  selfCorrections         Int      @default(0)
  
  // Comprehension
  comprehensionScore      Float    @default(0) // 0-100
  comprehensionCorrect    Int      @default(0)
  comprehensionTotal      Int      @default(0)
  
  // Reading Profile scores (JSON for flexibility)
  readingProfile          Json?    // { decoding, wordRecognition, fluency, comprehension }
  
  // Reading Level Assessment (legacy/quick assessment scoring)
  readingLevelBand        String?  // beginner, elementary, intermediate, advanced
  readingLevelPercentile  Int      @default(0) // 0-100 - NeuroBreath internal index only
  
  // Strengths and needs analysis
  strengthsNeeds          Json?    // { strengths: [], needs: [], suggestedFocus: "" }
  
  // Notes
  notes                   String?
  audioUrl                String?  // optional audio recording
  
  // Related detail records
  errorDetails            AttemptErrorDetail[]
  wordResponses           AttemptWordResponse[]
  comprehensionResponses  AttemptComprehensionResponse[]
  
  createdAt               DateTime @default(now())

  @@index([deviceId, createdAt])
  @@index([deviceId, assessmentType])
  @@index([passageId])
}

// Detailed error tracking for ORF marking
model AttemptErrorDetail {
  id                String   @id @default(cuid())
  attemptId         String
  attempt           ReadingAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  wordIndex         Int
  wordText          String
  errorType         String   // substitution, omission, insertion, reversal, hesitation, unknown
  corrected         Boolean  @default(false) // Self-corrected within 3 seconds
  
  createdAt         DateTime @default(now())
  
  @@index([attemptId])
}

// Word-level responses for word lists and pseudowords
model AttemptWordResponse {
  id                String   @id @default(cuid())
  attemptId         String
  attempt           ReadingAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  itemType          String   // word, pseudoword
  itemText          String
  isCorrect         Boolean
  responseTimeMs    Int?     // Optional timing per item
  
  createdAt         DateTime @default(now())
  
  @@index([attemptId])
}

// Comprehension question responses
model AttemptComprehensionResponse {
  id                String   @id @default(cuid())
  attemptId         String
  attempt           ReadingAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId        String
  question          ComprehensionQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedIndex     Int
  isCorrect         Boolean
  
  createdAt         DateTime @default(now())
  
  @@unique([attemptId, questionId])
  @@index([attemptId])
}

// ============================================================================
// LESSON CATALOG & PLACEMENT SYSTEM
// ============================================================================

// Catalog of available lessons/practice activities for placement routing
model LessonCatalog {
  id                String   @id @default(cuid())
  
  // Basic info
  slug              String   @unique // URL-friendly identifier
  title             String
  description       String?
  
  // Placement targeting
  nbLevel           String   // NB-L0 through NB-L8 - primary level
  learnerGroups     String[] @default([]) // children, youth, adolescence, adult
  
  // Skill focus
  skillFocus        String[] @default([]) // decoding, word-recognition, fluency, comprehension
  subSkills         String[] @default([]) // cvc, blends, vowel-teams, sight-words, etc.
  
  // Lesson details
  lessonType        String   // lesson, practice, game, worksheet
  durationMinutes   Int      @default(15)
  difficulty        String   @default("medium") // easy, medium, hard
  
  // Prerequisites and sequencing
  prerequisites     String[] @default([]) // slug references to prerequisite lessons
  suggestedNext     String[] @default([]) // slug references to next lessons
  orderInLevel      Int      @default(0) // Order within the level
  
  // Content metadata
  contentPath       String?  // Path to component or page
  thumbnailUrl      String?
  tags              String[] @default([])
  
  // Status
  isActive          Boolean  @default(true)
  isFreeContent     Boolean  @default(true) // Available without subscription
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  @@index([nbLevel])
  @@index([isActive, nbLevel])
}

// Learner's assigned placement and plan
model LearnerPlacement {
  id                String   @id @default(cuid())
  deviceId          String   @unique
  
  // Current placement
  learnerGroup      String   // children, youth, adolescence, adult
  currentLevel      String   // NB-L0 through NB-L8
  placementConfidence String @default("medium") // low, medium, high
  
  // When placement was determined
  assessmentId      String?  // Reference to the ReadingAttempt that set this
  placedAt          DateTime @default(now())
  
  // Full placement plan
  placementPlanJson Json?    // { dailyPractice, weeklyGoals, lessonPath, etc. }
  
  // Progress tracking
  lessonsCompleted  String[] @default([]) // Array of lesson slugs
  currentLessonSlug String?  // Current lesson in progress
  
  updatedAt         DateTime @default(now()) @updatedAt
  
  @@index([deviceId])
  @@index([currentLevel])
}

// ============================================================================
// SEND REPORTING SYSTEM
// ============================================================================

// AI-assisted SEND (Special Educational Needs & Disabilities) reports
// NOT diagnostic - training recommendations only
model SENDReport {
  id              String   @id @default(cuid())
  deviceId        String
  learnerName     String?
  reportDate      DateTime @default(now())
  
  // Data inputs
  assessmentIds   String[] @default([]) // References to ReadingAttempt IDs
  sessionIds      String[] @default([]) // References to Session IDs
  dateRangeJson   Json     // { from: ISO date, to: ISO date }
  
  // AI Analysis or Rules-Based Summary
  patternSummary  String   @db.Text // AI-generated or rule-based summary
  strengths       String[] @default([])
  challenges      String[] @default([])
  recommendations String[] @default([])
  confidence      String   @default("medium") // high, medium, low
  
  // Metadata
  generatedBy     String   // "ai-gpt4", "ai-abacus", "rules-engine"
  isEdited        Boolean  @default(false)
  editedContent   String?  @db.Text
  
  // Print settings
  isPrintFriendly Boolean  @default(true)
  disclaimerShown Boolean  @default(true)
  
  // Disclaimer text (always included)
  disclaimer      String   @default("This report provides training recommendations only and is NOT a diagnostic assessment. For formal educational or clinical assessment, please consult qualified professionals.")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  
  @@index([deviceId, reportDate])
  @@index([deviceId, createdAt])
}

// ============================================================================
// PARENT COMPANION SYSTEM
// ============================================================================

// Parent/Guardian read-only access to learner progress
model ParentAccess {
  id            String   @id @default(cuid())
  parentEmail   String?  // Optional - for notifications
  parentCode    String   @unique // 6-digit code for simple auth
  deviceId      String   // Learner's device ID
  learnerName   String?  // Optional display name
  
  // Access control
  isActive      Boolean  @default(true)
  canEdit       Boolean  @default(false) // Always false for v1 - read-only
  
  // Expiry (optional)
  createdAt     DateTime @default(now())
  expiresAt     DateTime? // Optional expiry date
  lastAccessedAt DateTime? // Track when parent last viewed
  
  @@index([parentCode])
  @@index([deviceId])
  @@index([isActive])
}

// ============================================================================
// USER PROFILE & ONBOARDING SYSTEM
// ============================================================================

// User profile for onboarding completion tracking
model UserProfile {
  id                String   @id @default(cuid())
  deviceId          String   @unique
  profileComplete   Boolean  @default(false)
  name              String?
  age               Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
}

// ============================================================================
// OPTIONAL AUTH (NEXTAUTH JWT + CREDENTIALS) — ISOLATED FROM EXISTING Session
// ============================================================================

model AuthUser {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String?
  passwordHash       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt

  // Cookie consent (shared across devices for signed-in users)
  consentState        Json?
  consentUpdatedAt    DateTime?

  // Universal progress tracking consent marker (one-time prompt)
  progressConsentAt   DateTime?

  // Optional link into the existing “deviceId” ecosystem
  primaryDeviceId    String?

  // 2FA (TOTP)
  twoFactorEnabled   Boolean  @default(false)
  twoFactorSecretEnc String?  // encrypted secret blob (AES-256-GCM)

  passwordResets     AuthPasswordResetToken[]
  trustedDevices     AuthTrustedDevice[]
  rateLimits         AuthRateLimit[]
  accounts           Account[]
  sessions           AuthSession[]
  universalProgressEvents UniversalProgressEvent[]
  progressEvents          ProgressEvent[]
  userDevices             UserDevice[]
  subjectAccesses         SubjectAccess[]

  @@index([primaryDeviceId])
}

// ============================================================================
// APPEND-ONLY PROGRESS EVENT STREAM (DEVICE + USER)
// ============================================================================

// ============================================================================
// SUBJECT PROFILES (LEARNERS) + ACCESS CONTROL
// ============================================================================

model SubjectProfile {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  kind            String   @default("learner")
  displayName     String
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  archivedAt      DateTime?

  accesses        SubjectAccess[]

  @@index([createdByUserId, createdAt])
  @@index([archivedAt])
}

model SubjectAccess {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subjectId String        @db.Uuid
  subject   SubjectProfile @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  userId    String
  user      AuthUser      @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      String
  canWrite  Boolean       @default(true)
  createdAt DateTime      @default(now())

  @@unique([subjectId, userId])
  @@index([userId, subjectId])
}

model ProgressEvent {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  occurredAt DateTime @default(now())
  type       String

  userId   String?
  user     AuthUser? @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId String

  // Future-proofing: parent/teacher views can later write events for a subject profile
  // (e.g. child learner). For now, the API forces subjectId to the signed-in user id
  // ("self") or null for anonymous events.
  subjectId String?

  path     String?
  metadata Json

  @@index([userId, occurredAt])
  @@index([deviceId, occurredAt])
  @@index([subjectId, occurredAt])
  @@index([type, occurredAt])
}

model UserDevice {
  deviceId    String   @id
  userId      String
  user        AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  @@index([userId, lastSeenAt])
}

// ============================================================================
// UNIVERSAL PROGRESS TRACKING (USER + DEVICE)
// ============================================================================

model UniversalProgressEvent {
  id              String   @id @default(cuid())

  // Identity
  userId          String?
  user            AuthUser? @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId        String?

  // Activity
  activityType    String
  activityId      String
  completedAt     DateTime @default(now())

  // Optional metadata
  score           Int?
  durationSeconds Int?
  data            Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  @@unique([userId, activityType, activityId])
  @@unique([deviceId, activityType, activityId])
  @@index([userId, activityType])
  @@index([deviceId, activityType])
}

model AuthPasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuthTrustedDevice {
  id             String   @id @default(cuid())
  userId         String
  deviceTokenHash String  @unique
  deviceName     String?
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuthRateLimit {
  id             String   @id @default(cuid())
  userId         String?
  ipAddress      String?
  email          String?
  attemptType    String   // login, password_reset, register
  attemptCount   Int      @default(1)
  lockedUntil    DateTime?
  firstAttemptAt DateTime @default(now())
  lastAttemptAt  DateTime @default(now())

  user AuthUser? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, attemptType])
  @@unique([ipAddress, attemptType])
  @@unique([email, attemptType])
  @@index([lockedUntil])
}

// NextAuth adapter models for OAuth and magic links
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AuthSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
