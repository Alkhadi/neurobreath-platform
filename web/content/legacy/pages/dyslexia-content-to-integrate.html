<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Brand: NeuroBreath -->
  <title>Dyslexia Reading Training Hub • NeuroBreath</title>
  <meta name="description" content="Mobile-first dyslexia reading training: calm warm-ups, structured drills, voice coaching, rewards and rights guidance for children, teens and adults." />

  <!-- Social (Open Graph / Twitter) -->
  <meta property="og:site_name" content="NeuroBreath" />
  <meta property="og:title" content="Dyslexia Reading Training Hub • NeuroBreath" />
  <meta property="og:description" content="Structured literacy games, calm breathing, focus tools and rights guidance for dyslexic learners." />
  <meta property="og:url" content="https://www.mindpaylink.com/dyslexia-reading-training.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/assets/icons/neurobreath-favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/neurobreath-logo-square-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/neurobreath-logo-square-16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/neurobreath-logo-square-180.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/neurobreath-logo-square-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/assets/icons/neurobreath-logo-square-512.png" />
  <meta name="msapplication-TileImage" content="/assets/icons/neurobreath-logo-square-150.png" />

  <link rel="stylesheet" href="assets/css/site.css" />

  <style>
    /* === Stage 2: Alphabet & Vowel map layout upgrades (2025) === */
    .dlx-section--stage2 {
      position: relative;
    }

    .dlx-grid--stage2 {
      display: flex;
      flex-direction: column;
      gap: clamp(1.5rem, 3vw, 2.5rem);
      align-items: stretch;
    }

    /* Alphabet atlas card: 6×5 grid on desktop, responsive on smaller screens */
    #alphabetAtlas .dlx-alpha-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 0.75rem;
      align-items: stretch;
    }

    @media (max-width: 1024px) {
      #alphabetAtlas .dlx-alpha-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      #alphabetAtlas .dlx-alpha-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (max-width: 540px) {
      #alphabetAtlas .dlx-alpha-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    #alphabetAtlas .dlx-alpha-chip {
      border-radius: 999px;
      padding: 0.55rem 0.35rem;
      min-height: 3.1rem;
      background: radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.16), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.65);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      transition:
        transform 150ms ease-out,
        box-shadow 150ms ease-out,
        border-color 150ms ease-out,
        background 150ms ease-out;
    }

    #alphabetAtlas .dlx-alpha-chip__upper {
      font-size: clamp(1.2rem, 0.95rem + 0.4vw, 1.55rem);
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    #alphabetAtlas .dlx-alpha-chip__lower {
      font-size: 0.85rem;
      opacity: 0.85;
    }

    /* Colour coding using existing JS classes: is-vowel vs consonant */
    #alphabetAtlas .dlx-alpha-chip.is-vowel {
      background: radial-gradient(circle at 10% 0%, rgba(94, 234, 212, 0.28), rgba(15, 23, 42, 0.98));
      border-color: rgba(94, 234, 212, 0.9);
    }

    #alphabetAtlas .dlx-alpha-chip:not(.is-vowel) {
      background: radial-gradient(circle at 10% 0%, rgba(168, 85, 247, 0.26), rgba(15, 23, 42, 0.98));
      border-color: rgba(168, 85, 247, 0.85);
    }

    #alphabetAtlas .dlx-alpha-chip.is-highlighted,
    #alphabetAtlas .dlx-alpha-chip:focus-visible,
    #alphabetAtlas .dlx-alpha-chip[aria-pressed="true"] {
      outline: 2px solid var(--dlx-accent, #38bdf8);
      outline-offset: 2px;
      transform: translateY(-2px);
      box-shadow: 0 18px 38px rgba(15, 23, 42, 0.9);
    }

    #alphabetAtlas .dlx-alpha-chip.is-speaking {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 12px 28px rgba(8, 47, 73, 0.7);
    }

    /* Vowel/consonant legend under the grid */
    #alphabetAtlas .dlx-alpha-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem 1.25rem;
      align-items: center;
      font-size: 0.82rem;
      margin-top: 0.4rem;
    }

    #alphabetAtlas .dlx-alpha-legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      white-space: nowrap;
    }

    #alphabetAtlas .dlx-alpha-legend-badge {
      width: 0.85rem;
      height: 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 30% 0%, rgba(148, 163, 184, 0.5), rgba(15, 23, 42, 1));
    }

    #alphabetAtlas .dlx-alpha-legend-badge--vowel {
      border-color: rgba(94, 234, 212, 0.9);
      background: radial-gradient(circle at 20% 0%, rgba(94, 234, 212, 0.55), rgba(15, 23, 42, 1));
    }

    #alphabetAtlas .dlx-alpha-legend-badge--consonant {
      border-color: rgba(168, 85, 247, 0.9);
      background: radial-gradient(circle at 20% 0%, rgba(168, 85, 247, 0.55), rgba(15, 23, 42, 1));
    }

    /* Vowel Universe + Routine cards: equal height, tidy spacing */
    #vowelUniverse,
    #routineMap {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #vowelUniverse .dlx-training-card__body,
    #routineMap .dlx-training-card__body {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      flex: 1 1 auto;
    }

    #vowelUniverse .dlx-vowel-map-detail {
      margin-top: 1.5rem;
      padding: clamp(1rem, 2vw, 1.5rem);
      border-radius: 20px;
      background: rgba(6, 12, 28, 0.92);
      border: 1px solid rgba(59, 130, 246, 0.35);
      box-shadow: 0 25px 60px rgba(2, 6, 23, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      position: relative;
    }

    #vowelUniverse .dlx-vowel-support {
      margin-top: 1.5rem;
      display: grid;
      gap: clamp(1rem, 2vw, 1.5rem);
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    #vowelUniverse .dlx-vowel-support__card {
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(4, 7, 19, 0.9);
      padding: clamp(1rem, 2vw, 1.4rem);
      box-shadow: 0 18px 40px rgba(2, 6, 23, 0.55);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #vowelUniverse .dlx-vowel-support__head {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    #vowelUniverse .dlx-vowel-support__head h4 {
      margin: 0;
    }

    #vowelUniverse .dlx-vowel-support__actions {
      display: flex;
      justify-content: flex-end;
    }

    body[data-page-id="dyslexia"] .dlx-vowel-map-detail.is-empty {
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.35);
      color: rgba(148, 163, 184, 0.85);
    }

    .dlx-vowel-map-detail__stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.65rem;
      font-size: 0.85rem;
    }

    .dlx-vowel-map-detail__stats dt {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(148, 163, 184, 0.85);
    }

    .dlx-vowel-map-detail__stats dd {
      margin: 0;
      font-weight: 600;
      color: #e5e7eb;
    }

    body[data-page-id="dyslexia"] .dlx-vowel-map-detail__actions .btn[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }

    body[data-page-id="dyslexia"] .dlx-vowel-card.is-active {
      border-color: rgba(14, 165, 233, 0.8);
      box-shadow: 0 25px 50px rgba(8, 47, 73, 0.65);
    }

    #vowelUniverse .dlx-vowel-card .btn-chip {
      transition:
        transform 160ms ease,
        box-shadow 160ms ease;
    }

    #vowelUniverse .dlx-vowel-card .btn-chip.is-speaking,
    #vowelUniverse .dlx-vowel-card .btn-chip:active {
      transform: translateY(1px) scale(0.96);
      box-shadow: 0 16px 32px rgba(8, 47, 73, 0.6);
    }

    .dlx-map-pulse {
      animation: dlx-map-pulse 1.1s ease;
    }

    @keyframes dlx-map-pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.6);
      }
      100% {
        box-shadow: 0 0 0 32px rgba(56, 189, 248, 0);
      }
    }

    .dlx-stage--flash {
      animation: dlx-stage-flash 1.4s ease;
    }

    @keyframes dlx-stage-flash {
      0% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
      }
      100% {
        box-shadow: 0 0 0 50px rgba(34, 197, 94, 0);
      }
    }
  </style>

  <script src="assets/js/voice-preferences.js" defer></script>
  <script src="assets/js/site.js" defer></script>
  <script src="assets/js/dyslexia-progress.js" defer></script>
  <script src="assets/js/home-goal-tiles.js" defer></script>
  <script src="assets/js/quick-start-modal.js" defer></script>

  <!-- Dyslexia Reading Training Hub – page-scoped layout & background fixes -->
  <style>
    body {
      background: #020617;
      color: #e5e7eb;
    }

    .site-header,
    .site-footer {
      background: rgba(2, 6, 23, 0.98);
      color: #f1f5f9;
      border-color: rgba(148, 163, 184, 0.35);
    }

    .site-header a,
    .site-footer a {
      color: #a5b4fc;
    }

    .site-header a:hover,
    .site-footer a:hover {
      color: #c7d2fe;
    }

    .site-header .menu-toggle {
      color: #fff;
    }

    body[data-page-id="dyslexia"] .btn-quick-start {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.96), rgba(217, 119, 6, 0.92));
      border: 1px solid rgba(251, 191, 36, 0.75);
      color: #ffffff;
      font-weight: 700;
      font-size: 1.05rem;
      padding: 0.75rem 1.5rem;
      border-radius: 999px;
      box-shadow: 0 6px 22px rgba(245, 158, 11, 0.4), 0 2px 0 rgba(255, 255, 255, 0.15) inset;
      position: relative;
      overflow: hidden;
      animation: gentle-pulse 3.5s ease-in-out infinite, quick-start-slide 18s ease-in-out infinite;
      transition: transform 150ms ease, box-shadow 150ms ease;
    }

    body[data-page-id="dyslexia"] .btn-quick-start::after {
      content: "";
      position: absolute;
      top: -40%;
      bottom: -40%;
      width: 45%;
      left: 0;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.5) 45%, rgba(255, 255, 255, 0) 100%);
      transform: translateX(-160%) skewX(-18deg);
      animation: shine 6s ease-in-out infinite;
      pointer-events: none;
    }

    body[data-page-id="dyslexia"] .btn-quick-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 26px rgba(245, 158, 11, 0.45), 0 2px 0 rgba(255, 255, 255, 0.18) inset;
    }

    body[data-page-id="dyslexia"] .btn-quick-start:active {
      transform: translateY(0);
    }

    @keyframes gentle-pulse {
      0%,
      100% {
        box-shadow: 0 6px 22px rgba(245, 158, 11, 0.4), 0 2px 0 rgba(255, 255, 255, 0.15) inset;
      }
      50% {
        box-shadow: 0 8px 28px rgba(245, 158, 11, 0.55), 0 2px 0 rgba(255, 255, 255, 0.18) inset;
      }
    }

    @keyframes quick-start-slide {
      0%,
      10% {
        margin-inline-start: 0;
      }
      50% {
        margin-inline-start: 12px;
      }
      90%,
      100% {
        margin-inline-start: 0;
      }
    }

    @keyframes shine {
      0% {
        transform: translateX(-160%) skewX(-18deg);
      }
      60% {
        transform: translateX(220%) skewX(-18deg);
      }
      100% {
        transform: translateX(220%) skewX(-18deg);
      }
    }

    body[data-page-id="dyslexia"] .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.88);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }

    body[data-page-id="dyslexia"] .modal-overlay.active {
      display: flex;
    }

    body[data-page-id="dyslexia"] .home-modal-card {
      width: min(640px, 92%);
      border-radius: 26px;
      border: 1px solid rgba(59, 130, 246, 0.35);
      background: linear-gradient(170deg, rgba(2, 6, 23, 0.98), rgba(15, 23, 42, 0.95));
      color: #e5e7eb;
      box-shadow: 0 35px 95px rgba(2, 6, 23, 0.95);
      padding: clamp(1.2rem, 3vw, 1.7rem);
      max-height: 90vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    body[data-page-id="dyslexia"] .quick-start-lede {
      margin: 0;
      font-size: clamp(1rem, 0.95rem + 0.4vw, 1.2rem);
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #fef3c7;
      text-transform: uppercase;
    }

    body[data-page-id="dyslexia"] .quick-start-next {
      border-radius: 20px;
      border: 1px solid rgba(45, 212, 191, 0.25);
      background: rgba(2, 15, 32, 0.92);
      padding: 1rem 1.25rem;
      box-shadow: 0 18px 38px rgba(2, 6, 23, 0.75);
      display: grid;
      gap: 0.7rem;
    }

    body[data-page-id="dyslexia"] .quick-start-next__lede {
      margin: 0;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: rgba(125, 211, 252, 0.95);
    }

    body[data-page-id="dyslexia"] .quick-start-next__list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    body[data-page-id="dyslexia"] .quick-start-next__item {
      display: grid;
      gap: 0.25rem;
    }

    body[data-page-id="dyslexia"] .quick-start-next__label {
      margin: 0;
      font-size: 0.9rem;
      color: rgba(226, 232, 240, 0.9);
    }

    body[data-page-id="dyslexia"] .quick-start-next__btn {
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.4);
      background: rgba(8, 25, 53, 0.9);
      color: #f1f5f9;
      padding: 0.4rem 1rem;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      transition: transform 150ms ease, border-color 150ms ease, box-shadow 150ms ease;
    }

    body[data-page-id="dyslexia"] .quick-start-next__btn:hover,
    body[data-page-id="dyslexia"] .quick-start-next__btn:focus-visible {
      border-color: rgba(14, 165, 233, 0.85);
      box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.35), 0 16px 30px rgba(2, 6, 23, 0.8);
      transform: translateY(-1px);
      color: #fef3c7;
    }

    body[data-page-id="dyslexia"] .home-modal-card .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    body[data-page-id="dyslexia"] .home-modal-card .btn-close {
      border: none;
      background: none;
      font-size: 1.6rem;
      color: #cbd5f5;
      cursor: pointer;
      line-height: 1;
      padding: 0.25rem 0.5rem;
      transition: color 150ms ease;
    }

    body[data-page-id="dyslexia"] .home-modal-card .btn-close:hover {
      color: #facc15;
    }

    body[data-page-id="dyslexia"] .modal-voice-card {
      border-radius: 20px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(4, 13, 31, 0.92);
      padding: clamp(1rem, 2vw, 1.35rem);
      box-shadow: 0 25px 45px rgba(2, 6, 23, 0.65);
      display: grid;
      gap: 0.75rem;
    }

    body[data-page-id="dyslexia"] .modal-voice-card__header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    body[data-page-id="dyslexia"] .voice-icon {
      font-size: 1.25rem;
      color: #fcd34d;
    }

    body[data-page-id="dyslexia"] .modal-voice-card__eyebrow {
      margin: 0;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.8);
    }

    body[data-page-id="dyslexia"] .modal-voice-card__title {
      margin: 0.1rem 0 0;
      font-weight: 600;
      color: #f8fafc;
    }

    body[data-page-id="dyslexia"] .modal-voice-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.6rem;
    }

    body[data-page-id="dyslexia"] .modal-voice-controls .btn,
    body[data-page-id="dyslexia"] .modal-voice-controls .voice-select {
      justify-content: center;
      background: rgba(6, 17, 40, 0.95);
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: #f1f5f9;
      box-shadow: 0 14px 28px rgba(2, 6, 23, 0.65);
      font-weight: 600;
    }

    body[data-page-id="dyslexia"] .modal-voice-controls .btn:hover,
    body[data-page-id="dyslexia"] .modal-voice-controls .voice-select:hover,
    body[data-page-id="dyslexia"] .modal-voice-controls .btn:focus-visible,
    body[data-page-id="dyslexia"] .modal-voice-controls .voice-select:focus-visible {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(14, 165, 233, 0.8);
      color: #fef3c7;
      box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25), 0 18px 32px rgba(2, 6, 23, 0.75);
    }

    body[data-page-id="dyslexia"] .voice-status {
      font-size: 0.85rem;
      color: #cbd5f5;
      margin: 0;
    }

    body[data-page-id="dyslexia"] .technique-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: clamp(0.75rem, 2vw, 1rem);
    }

    body[data-page-id="dyslexia"] .technique-option {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      border-radius: 18px;
      border: 1px solid rgba(56, 189, 248, 0.25);
      background: rgba(3, 9, 26, 0.92);
      box-shadow: 0 18px 32px rgba(2, 6, 23, 0.85);
      text-align: left;
      transition: transform 150ms ease, border-color 150ms ease, box-shadow 150ms ease, background 150ms ease;
    }

    body[data-page-id="dyslexia"] .technique-option:hover {
      transform: translateY(-2px);
      border-color: rgba(14, 165, 233, 0.55);
    }

    body[data-page-id="dyslexia"] .technique-option.selected,
    body[data-page-id="dyslexia"] .technique-option[aria-pressed="true"] {
      border-color: rgba(14, 165, 233, 0.9);
      background: linear-gradient(145deg, rgba(2, 132, 199, 0.35), rgba(8, 47, 73, 0.95));
      box-shadow: 0 25px 45px rgba(14, 165, 233, 0.35);
    }

    body[data-page-id="dyslexia"] .technique-option__copy {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    body[data-page-id="dyslexia"] .technique-option__copy strong {
      color: #f8fafc;
    }

    body[data-page-id="dyslexia"] .technique-option__copy small {
      color: rgba(203, 213, 225, 0.88);
      font-size: 0.85rem;
    }

    body[data-page-id="dyslexia"] .selected-badge {
      margin-left: auto;
      border-radius: 999px;
      padding: 0.1rem 0.6rem;
      background: rgba(251, 191, 36, 0.15);
      color: #fde68a;
      font-size: 0.75rem;
    }

    body[data-page-id="dyslexia"] .duration-selector {
      border-radius: 18px;
      border: 1px solid rgba(59, 130, 246, 0.25);
      background: rgba(3, 9, 26, 0.92);
      padding: clamp(1rem, 2vw, 1.4rem);
      display: grid;
      gap: 0.75rem;
    }

    body[data-page-id="dyslexia"] .duration-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    body[data-page-id="dyslexia"] .duration-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(8, 25, 53, 0.95);
      color: #e2e8f0;
      padding: 0.45rem 1rem;
      font-weight: 600;
    }

    body[data-page-id="dyslexia"] .duration-btn.selected,
    body[data-page-id="dyslexia"] .duration-btn[aria-pressed="true"] {
      border-color: rgba(14, 165, 233, 0.9);
      color: #f0f9ff;
      box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
    }

    body[data-page-id="dyslexia"] .breathing-session-area {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1rem;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 22px;
      padding: 1rem;
      color: #e2e8f0;
    }

    body[data-page-id="dyslexia"] .breathing-session-area.hidden {
      display: none;
    }

    body[data-page-id="dyslexia"] .dlx-focus-screen__backdrop {
      background: rgba(2, 6, 23, 0.88);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    body[data-page-id="dyslexia"] .dlx-song-panel,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel,
    body[data-page-id="dyslexia"] .dlx-focus-panel {
      background: linear-gradient(165deg, rgba(2, 6, 23, 0.98), rgba(8, 23, 47, 0.95));
      border: 1px solid rgba(56, 189, 248, 0.25);
      box-shadow: 0 30px 80px rgba(2, 6, 23, 0.85);
      color: #e5e7eb;
    }

    body[data-page-id="dyslexia"] .dlx-song-panel .dlx-kicker,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel .dlx-kicker,
    body[data-page-id="dyslexia"] .dlx-focus-panel__head .dlx-kicker {
      color: #bae6fd;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    body[data-page-id="dyslexia"] .dlx-song-letter-card,
    body[data-page-id="dyslexia"] .dlx-letter-sound-buzz,
    body[data-page-id="dyslexia"] .dlx-memory-card {
      background: radial-gradient(circle at 30% 0%, rgba(59, 130, 246, 0.18), rgba(2, 6, 23, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 25px 60px rgba(2, 6, 23, 0.8);
    }

    body[data-page-id="dyslexia"] .dlx-song-letter-card .dlx-song-letter {
      color: #fef3c7;
      text-shadow: 0 0 18px rgba(253, 224, 71, 0.4);
    }

    body[data-page-id="dyslexia"] .dlx-song-actions .btn,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel .btn,
    body[data-page-id="dyslexia"] .dlx-focus-panel .btn {
      background: rgba(8, 25, 53, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #e5e7eb;
      box-shadow: 0 14px 30px rgba(2, 6, 23, 0.75);
      font-weight: 600;
      transition: transform 150ms ease, box-shadow 150ms ease, border-color 150ms ease;
    }

    body[data-page-id="dyslexia"] .dlx-song-actions .btn:hover,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel .btn:hover,
    body[data-page-id="dyslexia"] .dlx-focus-panel .btn:hover,
    body[data-page-id="dyslexia"] .dlx-song-actions .btn:focus-visible,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel .btn:focus-visible,
    body[data-page-id="dyslexia"] .dlx-focus-panel .btn:focus-visible {
      border-color: rgba(14, 165, 233, 0.85);
      box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.35), 0 18px 38px rgba(2, 6, 23, 0.8);
      transform: translateY(-1px);
      color: #fef3c7;
    }

    body[data-page-id="dyslexia"] .dlx-song-panel .btn.btn-ghost,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel .btn.btn-ghost,
    body[data-page-id="dyslexia"] .dlx-focus-panel .btn.btn-ghost {
      background: rgba(2, 9, 23, 0.65);
      border-color: rgba(148, 163, 184, 0.35);
      color: #cbd5f5;
      box-shadow: none;
    }

    body[data-page-id="dyslexia"] .dlx-song-panel .btn.btn-outline,
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel .btn.btn-outline,
    body[data-page-id="dyslexia"] .dlx-focus-panel .btn.btn-outline {
      background: rgba(4, 12, 28, 0.9);
      border-color: rgba(148, 163, 184, 0.55);
      color: #e2e8f0;
    }

    body[data-page-id="dyslexia"] #dlxSongStart,
    body[data-page-id="dyslexia"] #dlxLetterSoundStart,
    body[data-page-id="dyslexia"] #dlxLetterSoundContinue,
    body[data-page-id="dyslexia"] .dlx-letter-sound-certificate-actions .btn.btn-success,
    body[data-page-id="dyslexia"] .dlx-letter-sound-certificate-form .btn.btn-primary,
    body[data-page-id="dyslexia"] .dlx-song-panel .btn.btn-primary,
    body[data-page-id="dyslexia"] .dlx-focus-panel .btn.btn-success {
      background: linear-gradient(120deg, rgba(34, 197, 94, 0.92), rgba(101, 163, 13, 0.9));
      border-color: rgba(74, 222, 128, 0.65);
      color: #041307;
      box-shadow: 0 18px 40px rgba(6, 78, 59, 0.7);
    }

    body[data-page-id="dyslexia"] #dlxSongPause,
    body[data-page-id="dyslexia"] #dlxSongRestart,
    body[data-page-id="dyslexia"] #dlxSongClose,
    body[data-page-id="dyslexia"] #dlxLetterSoundPause,
    body[data-page-id="dyslexia"] #dlxLetterSoundRestart,
    body[data-page-id="dyslexia"] #dlxLetterSoundClose,
    body[data-page-id="dyslexia"] #dlxLetterSoundRandomHead,
    body[data-page-id="dyslexia"] #dlxCertificateEditBtn,
    body[data-page-id="dyslexia"] #dlxCertificateHomeLink,
    body[data-page-id="dyslexia"] #dlxCertificateBackToHub {
      color: #e5e7eb;
    }

    body[data-page-id="dyslexia"] .dlx-song-progress input[type="range"],
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel input[type="range"],
    body[data-page-id="dyslexia"] .dlx-soundquest-panel input[type="range"],
    body[data-page-id="dyslexia"] .dlx-letter-sound-panel progress,
    body[data-page-id="dyslexia"] .dlx-soundquest-panel progress {
      accent-color: #38bdf8;
      color: #38bdf8;
    }

    body[data-page-id="dyslexia"] #dlxSoundQuestPlay,
    body[data-page-id="dyslexia"] #dlxSoundQuestLock {
      background: linear-gradient(120deg, rgba(34, 197, 94, 0.92), rgba(101, 163, 13, 0.88));
      border-color: rgba(74, 222, 128, 0.65);
      color: #02110a;
      box-shadow: 0 18px 40px rgba(6, 78, 59, 0.7);
    }

    body[data-page-id="dyslexia"] #dlxSoundQuestLock {
      color: #041407;
    }

    body[data-page-id="dyslexia"] #dlxSoundQuestPause,
    body[data-page-id="dyslexia"] #dlxSoundQuestStop,
    body[data-page-id="dyslexia"] #dlxSoundQuestReset,
    body[data-page-id="dyslexia"] #dlxSoundQuestSkip {
      background: rgba(10, 16, 32, 0.9);
      border-color: rgba(148, 163, 184, 0.45);
    }

    body[data-page-id="dyslexia"] #dlxSoundQuestClose {
      background: rgba(2, 9, 23, 0.85);
      border-color: rgba(148, 163, 184, 0.25);
      color: #cbd5f5;
    }

    body[data-page-id="dyslexia"] .breathing-viz-container {
      min-height: 220px;
      background: radial-gradient(circle at 20% 15%, rgba(59, 130, 246, 0.18), transparent 70%), rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    body[data-page-id="dyslexia"] .breathing-controls-panel {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    body[data-page-id="dyslexia"] .phase-label {
      font-size: 1.15rem;
      font-weight: 600;
      color: #fef3c7;
      margin: 0;
    }

    body[data-page-id="dyslexia"] .breathing-progress {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.4);
    }

    body[data-page-id="dyslexia"] .breathing-legend {
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    body[data-page-id="dyslexia"] .modal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: flex-end;
    }

    body[data-page-id="dyslexia"] .modal-actions .btn {
      flex: 1 1 auto;
      min-width: 140px;
    }

    #cancelQuickStart {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
      box-shadow: 0 12px 28px rgba(2, 6, 23, 0.8);
    }

    #cancelQuickStart:hover,
    #cancelQuickStart:focus-visible {
      background: rgba(127, 29, 29, 0.85);
      color: #fff5f5;
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.35), 0 18px 36px rgba(2, 6, 23, 0.85);
    }

    #confirmQuickStart {
      background: linear-gradient(120deg, rgba(34, 197, 94, 0.95), rgba(101, 163, 13, 0.92));
      border: 1px solid rgba(74, 222, 128, 0.65);
      color: #04120c;
      font-weight: 700;
      box-shadow: 0 18px 40px rgba(6, 95, 70, 0.65);
    }

    #confirmQuickStart:hover,
    #confirmQuickStart:focus-visible {
      background: linear-gradient(120deg, rgba(74, 222, 128, 0.98), rgba(163, 230, 53, 0.95));
      border-color: rgba(190, 242, 100, 0.85);
      box-shadow: 0 0 0 2px rgba(190, 242, 100, 0.35), 0 22px 45px rgba(22, 78, 99, 0.8);
      color: #021207;
    }

    @media (min-width: 720px) {
      body[data-page-id="dyslexia"] .breathing-session-area {
        grid-template-columns: minmax(0, 1.2fr) 0.8fr;
      }

      body[data-page-id="dyslexia"] .modal-actions .btn {
        flex: 0 0 auto;
      }
    }

    .site-header .menu-toggle:hover,
    .site-header .menu-toggle:focus-visible {
      color: #e0e7ff;
    }

    /* Base page container – creates a unified, gap‑free background just for this hub */
    main#dlxPage.container {
      position: relative;
      max-width: 1120px;
      margin-inline: auto;
      padding: clamp(1.75rem, 3vw, 2.5rem) clamp(1.25rem, 3vw, 2.5rem) clamp(3rem, 4vw, 3.25rem);
      border-radius: 24px;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.22), transparent 58%),
        radial-gradient(circle at bottom right, rgba(52, 211, 153, 0.18), transparent 55%),
        #020617;
      box-shadow: 0 24px 70px rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      overflow: hidden;
      isolation: isolate;
    }

    main#dlxPage.container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top, rgba(15, 23, 42, 0.92), transparent 60%),
        radial-gradient(circle at bottom, rgba(15, 23, 42, 0.88), transparent 60%);
      opacity: 0.8;
      pointer-events: none;
      z-index: -1;
    }

    main#dlxPage.container > * {
      position: relative;
      z-index: 1;
    }

    /* Typography inside the hub */
    #dlxPage h1,
    #dlxPage h2,
    #dlxPage h3,
    #dlxPage h4 {
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: #f9fafb;
    }

    #dlxPage h1 {
      font-size: clamp(2.05rem, 3vw, 2.6rem);
      line-height: 1.05;
    }

    #dlxPage h2 {
      font-size: clamp(1.35rem, 2.2vw, 1.7rem);
      line-height: 1.15;
    }

    #dlxPage h3 {
      font-size: 1.05rem;
      line-height: 1.3;
    }

    #dlxPage p {
      margin: 0.35rem 0 0.35rem;
      font-size: 0.97rem;
      line-height: 1.6;
    }

    #dlxPage .muted {
      color: #9ca3af;
    }

    #dlxPage .small {
      font-size: 0.86rem;
    }

    #dlxPage .kicker {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #a5b4fc;
      margin-bottom: 0.15rem;
    }

    #dlxPage a {
      color: #7dd3fc;
    }

    #dlxPage a:hover {
      color: #bae6fd;
    }

    /* Sections – remove stray white gaps and unify background */
    #dlxPage .dlx-section {
      margin: 0;
      margin-top: clamp(1.75rem, 3vw, 2.5rem);
      padding: clamp(1.6rem, 3vw, 2.3rem);
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 48px rgba(15, 23, 42, 0.85);
    }

    #dlxPage .dlx-section:first-of-type {
      margin-top: 0;
    }

    /* Hero layout */
    #dlxHero.dlx-section {
      background:
        radial-gradient(circle at top left, rgba(191, 219, 254, 0.26), transparent 55%),
        radial-gradient(circle at bottom right, rgba(52, 211, 153, 0.2), transparent 55%),
        rgba(15, 23, 42, 0.98);
      border-color: rgba(191, 219, 254, 0.45);
    }

    #dlxPage .dlx-hero__grid {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.1fr);
      gap: clamp(1.6rem, 3vw, 2.4rem);
      align-items: stretch;
    }

    #dlxPage .dlx-hero__main {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    #dlxPage .dlx-hero__pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    #dlxPage .dlx-hero__score-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      align-items: center;
      padding: 0.7rem 0.95rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.16), transparent 60%);
      font-size: 0.82rem;
      color: #e5e7eb;
    }

    #dlxPage .dlx-hero__score-strip strong {
      color: #a5b4fc;
    }

    #dlxPage .dlx-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.28rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.85);
      font-size: 0.78rem;
      color: #e5e7eb;
      white-space: nowrap;
    }

    #dlxPage .dlx-pill--soft {
      background: rgba(37, 99, 235, 0.2);
      border-color: rgba(129, 140, 248, 0.7);
      color: #e0e7ff;
    }

    #dlxPage .dlx-pill span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #dlxPage .dlx-keyline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem 1.2rem;
      align-items: center;
      font-size: 0.86rem;
      color: #cbd5f5;
    }

    #dlxPage .dlx-keyline span {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
    }

    #dlxPage .dlx-keyline-icon {
      width: 1.05rem;
      height: 1.05rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.16);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    #dlxPage .dlx-hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-top: 0.8rem;
    }

    #dlxPage .dlx-hero-actions .small {
      opacity: 0.9;
    }

    #dlxPage .dlx-hero__intent-card {
      height: 100%;
      border-radius: 18px;
      padding: 1rem 1.1rem;
      background:
        radial-gradient(circle at top, rgba(30, 64, 175, 0.85), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(191, 219, 254, 0.55);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    #dlxPage .dlx-hero__intent-card header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem 0.9rem;
      align-items: baseline;
      justify-content: space-between;
    }

    #dlxPage .dlx-tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    #dlxPage .dlx-tag {
      border-radius: 999px;
      padding: 0.16rem 0.6rem;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(191, 219, 254, 0.35);
      color: #e5e7eb;
    }

    #dlxPage .dlx-intent-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      margin-top: 0.6rem;
    }

    #dlxPage .dlx-intent-block {
      border-radius: 0.9rem;
      padding: 0.7rem 0.75rem;
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    #dlxPage .dlx-intent-block strong {
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    /* Generic layout helpers */
    #dlxPage .dlx-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.75rem 1.25rem;
      align-items: baseline;
      margin-bottom: 0.85rem;
    }

    #dlxPage .dlx-row__title {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    #dlxPage .dlx-row__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      align-items: center;
      font-size: 0.86rem;
    }

    #dlxPage .dlx-grid {
      display: grid;
      gap: 1.3rem;
    }

    #dlxPage .dlx-grid--two {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    #dlxPage .dlx-grid--three {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    #dlxPage .dlx-grid--autofit {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    #dlxPage .dlx-slab {
      border-radius: 1.1rem;
      padding: 1rem 1.1rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.45);
    }

    /* Cards */
    #dlxPage .card,
    #dlxPage .dlx-card,
    #dlxPage .dlx-training-card {
      border-radius: 1rem;
      padding: 1rem 1.1rem;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.85);
    }

    #dlxPage .dlx-training-card--compact {
      padding: 0.85rem 0.95rem;
    }

    #dlxPage .dlx-training-card__head {
      display: flex;
      justify-content: space-between;
      gap: 0.65rem;
      align-items: flex-start;
      margin-bottom: 0.55rem;
    }

    #dlxPage .dlx-training-card__body {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.92rem;
    }

    #dlxPage .dlx-training-card__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
      margin-top: 0.4rem;
      font-size: 0.82rem;
      color: #9ca3af;
    }

    #dlxPage .dlx-chip {
      border-radius: 999px;
      padding: 0.16rem 0.65rem;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    #dlxPage .dlx-chip--green {
      background: rgba(22, 163, 74, 0.16);
      border-color: rgba(74, 222, 128, 0.65);
      color: #bbf7d0;
    }

    #dlxPage .dlx-chip--amber {
      background: rgba(234, 179, 8, 0.16);
      border-color: rgba(250, 204, 21, 0.7);
      color: #fef9c3;
    }

    #dlxPage .dlx-chip-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
      background: currentColor;
      opacity: 0.85;
    }

    /* Buttons */
    #dlxPage .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.55rem 0.95rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition:
        background 0.2s ease,
        border-color 0.2s ease,
        box-shadow 0.2s ease,
        transform 0.1s ease,
        color 0.2s ease;
    }

    #dlxPage .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: rgba(74, 222, 128, 0.9);
      color: #052e16;
      box-shadow: 0 14px 36px rgba(22, 163, 74, 0.7);
    }

    #dlxPage .btn-secondary {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), rgba(30, 64, 175, 0.95));
      border-color: rgba(129, 140, 248, 0.8);
      color: #e0f2fe;
    }

    #dlxPage .btn-outline {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
    }

    #dlxPage .btn-ghost {
      background: rgba(15, 23, 42, 0.6);
      border-color: transparent;
      color: #e5e7eb;
    }

    #dlxPage .btn-sm {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
    }

    #dlxPage .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
    }

    #dlxPage .btn-primary:hover {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }

    #dlxPage .btn-secondary:hover {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.28), rgba(30, 64, 175, 1));
    }

    #dlxPage .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.9);
    }

    /* Celebration Studio hero */
    #dlxPage .dlx-phonics-hero {
      position: relative;
      margin: 0.6rem 0 1rem;
      padding: clamp(1.25rem, 3vw, 1.9rem);
      border-radius: 1.4rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background:
        radial-gradient(circle at 10% 10%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(244, 114, 182, 0.16), transparent 45%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(3, 7, 18, 0.96));
      box-shadow: 0 18px 48px rgba(2, 6, 23, 0.78);
      overflow: hidden;
    }

    #dlxPage .dlx-phonics-hero__glow {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 30% 30%, rgba(129, 140, 248, 0.25), transparent 60%),
        radial-gradient(circle at 70% 10%, rgba(45, 212, 191, 0.18), transparent 55%);
      filter: blur(6px);
      opacity: 0.8;
      pointer-events: none;
    }

    #dlxPage .dlx-phonics-hero__layout {
      position: relative;
      z-index: 1;
      display: grid;
      gap: clamp(1rem, 2.5vw, 1.4rem);
    }

    #dlxPage .dlx-phonics-hero__copy,
    #dlxPage .dlx-phonics-hero__content,
    #dlxPage .dlx-phonics-hero__milestone-shell,
    #dlxPage .dlx-phonics-hero__feature-shell {
      position: relative;
      z-index: 1;
    }

    #dlxPage .dlx-phonics-hero__content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #dlxPage .dlx-phonics-hero__copy {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    #dlxPage .dlx-phonics-hero__tags {
      list-style: none;
      margin: 0.4rem 0 0;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.82rem;
      color: #cbd5f5;
    }

    #dlxPage .dlx-phonics-hero__tags li {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
    }

    #dlxPage .dlx-phonics-hero__kicker {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #a5b4fc;
      margin: 0;
    }

    #dlxPage .dlx-phonics-hero__title {
      font-size: clamp(1.1rem, 2vw, 1.35rem);
      margin: 0;
    }

    #dlxPage .dlx-phonics-hero__body {
      margin: 0;
      color: #e2e8f0;
      font-size: 0.94rem;
      line-height: 1.5;
    }

    #dlxPage .dlx-phonics-hero__cta-card {
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 1rem;
      background: rgba(15, 23, 42, 0.72);
      box-shadow: inset 0 0 0 1px rgba(2, 6, 23, 0.5);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-width: 420px;
    }

    #dlxPage .dlx-phonics-hero__cta-card .btn {
      width: fit-content;
      min-width: 220px;
    }

    #dlxPage .dlx-phonics-hero__cta-flags {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      font-size: 0.84rem;
      color: #cbd5f5;
    }

    #dlxPage .dlx-phonics-hero__cta-flags li {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    #dlxPage .dlx-phonics-hero__cta-flags strong {
      font-size: 0.9rem;
      color: #fefce8;
      font-weight: 600;
    }

    #dlxPage .dlx-phonics-hero__feature-shell {
      border-radius: 1.1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.9rem 1rem;
      background: rgba(5, 9, 26, 0.65);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.3);
    }

    #dlxPage .dlx-phonics-hero__feature-heading {
      margin: 0 0 0.6rem;
      font-size: 0.86rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #94a3b8;
    }

    #dlxPage .dlx-phonics-hero__feature-grid {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    #dlxPage .dlx-phonics-hero__feature-grid li {
      display: flex;
      gap: 0.7rem;
      align-items: flex-start;
      border-radius: 0.9rem;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    #dlxPage .dlx-phonics-hero__feature-icon {
      font-size: 1.3rem;
      line-height: 1;
      filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.45));
    }

    #dlxPage .dlx-phonics-hero__feature-title {
      margin: 0;
      font-size: 0.92rem;
      color: #fefce8;
      font-weight: 600;
    }

    #dlxPage .dlx-phonics-hero__feature-note {
      margin: 0.15rem 0 0;
      font-size: 0.82rem;
      color: #cbd5f5;
      line-height: 1.4;
    }

    #dlxPage .dlx-phonics-hero__milestone-shell {
      border-radius: 1.1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.8rem 0.9rem;
      background: rgba(2, 6, 23, 0.5);
    }

    #dlxPage .dlx-phonics-hero__milestone-heading {
      margin: 0 0 0.5rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #94a3b8;
    }

    #dlxPage .dlx-phonics-hero__milestones {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      counter-reset: dlx-phonics-tier;
    }

    #dlxPage .dlx-phonics-hero__milestones li {
      position: relative;
      border-radius: 0.95rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
      padding: 0.75rem 0.85rem 0.75rem 2.4rem;
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.45);
    }

    #dlxPage .dlx-phonics-hero__milestones li::before {
      counter-increment: dlx-phonics-tier;
      content: counter(dlx-phonics-tier);
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      width: 1.2rem;
      height: 1.2rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #fdf4ff;
    }

    #dlxPage .dlx-phonics-hero__milestones li[data-tier="bronze"]::before {
      background: rgba(234, 179, 8, 0.35);
    }

    #dlxPage .dlx-phonics-hero__milestones li[data-tier="gold"]::before {
      background: rgba(250, 204, 21, 0.55);
    }

    #dlxPage .dlx-phonics-hero__milestones li[data-tier="platinum"]::before {
      background: rgba(148, 163, 184, 0.65);
    }

    #dlxPage .dlx-phonics-hero__milestone-title {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fef9c3;
    }

    #dlxPage .dlx-phonics-hero__milestone-note {
      margin: 0.1rem 0 0;
      font-size: 0.82rem;
      color: #cbd5f5;
    }

    @media (min-width: 900px) {
      #dlxPage .dlx-phonics-hero {
        padding: clamp(1.5rem, 3vw, 2.4rem);
      }

      #dlxPage .dlx-phonics-hero__layout {
        grid-template-columns: minmax(0, 1fr);
        align-items: start;
      }

      #dlxPage .dlx-phonics-hero__content,
      #dlxPage .dlx-phonics-hero__feature-shell,
      #dlxPage .dlx-phonics-hero__milestone-shell,
      #dlxPage .dlx-phonics-hero__cta-card {
        grid-column: 1 / -1;
        width: 100%;
      }
    }

    /* Alpha grid, lists & lanes */
    #dlxPage .dlx-alpha-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
    }

    #dlxPage .dlx-alpha-pill {
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.65);
      font-size: 0.86rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.7rem;
    }

    #dlxPage .dlx-alpha-pill span:first-child {
      font-weight: 600;
      color: #e5e7eb;
    }

    #dlxPage .dlx-alpha-pill span:last-child {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    #dlxPage .dlx-list {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.92rem;
    }

    #dlxPage .dlx-list li::before {
      content: "•";
      margin-right: 0.4rem;
      color: #4ade80;
    }

    #dlxPage .dlx-lane {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      border-radius: 1rem;
      padding: 0.85rem 0.95rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.95);
    }

    #dlxPage .dlx-lane__header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem 0.8rem;
      align-items: center;
      justify-content: space-between;
    }

    #dlxPage .dlx-lane__title {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    /* Progress and strip components */
    #dlxPage .dlx-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      align-items: center;
      padding: 0.65rem 0.9rem;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.55);
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.18), rgba(15, 23, 42, 0.98));
      font-size: 0.82rem;
    }

    #dlxPage .dlx-strip__label {
      font-weight: 500;
      color: #e5e7eb;
    }

    #dlxPage .dlx-dot-row {
      display: inline-flex;
      gap: 0.18rem;
      align-items: center;
    }

    #dlxPage .dlx-dot {
      width: 0.35rem;
      height: 0.35rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
    }

    /* Rewards bar */
    #dlxRewardsShell {
      margin-top: clamp(1.5rem, 3vw, 2.2rem);
    }

    #dlxRewardsShell .dlx-rewards-shell__inner {
      border-radius: 1rem;
      padding: 0.75rem 0.9rem;
      background: radial-gradient(circle at left, rgba(252, 211, 77, 0.22), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(250, 204, 21, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    #dlxRewardsBar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    #dlxPage .dlx-reward-chip {
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: #e5e7eb;
    }

    #dlxPage .dlx-reward-chip__dot {
      width: 0.45rem;
      height: 0.45rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.95);
    }

    #dlxPage .dlx-reward-chip--lit {
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.3), rgba(234, 179, 8, 0.15));
      border-color: rgba(250, 204, 21, 0.9);
      color: #fef9c3;
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.4), 0 18px 40px rgba(250, 204, 21, 0.4);
    }

    #dlxPage .dlx-rewards-shell__hint {
      font-size: 0.8rem;
      color: #fbbf24;
    }

    /* Certificate overlay */
    .dlx-cert-backdrop {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.98));
      -webkit-backdrop-filter: blur(18px); /* Safari 9+ */
      backdrop-filter: blur(18px);
      z-index: 80;
    }

    .dlx-cert-panel {
      width: min(640px, 100%);
      max-height: min(540px, 100%);
      border-radius: 1.5rem;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow: 0 28px 80px rgba(15, 23, 42, 0.95);
      padding: 1.4rem 1.4rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      overflow: hidden;
    }

    .dlx-cert-panel header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 0.9rem;
      align-items: center;
      justify-content: space-between;
    }

    .dlx-cert-badge {
      border-radius: 999px;
      padding: 0.18rem 0.65rem;
      font-size: 0.78rem;
      background: rgba(22, 163, 74, 0.18);
      border: 1px solid rgba(74, 222, 128, 0.85);
      color: #bbf7d0;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .dlx-cert-body {
      flex: 1;
      border-radius: 1rem;
      padding: 0.9rem 1rem;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 60%),
        radial-gradient(circle at bottom right, rgba(52, 211, 153, 0.18), transparent 60%),
        #020617;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.1fr);
      gap: 1.1rem;
      align-items: flex-start;
      font-size: 0.9rem;
    }

    .dlx-cert-body h3 {
      margin-bottom: 0.25rem;
      font-size: 1rem;
    }

    .dlx-cert-body ul {
      margin: 0.4rem 0 0;
      padding-left: 1rem;
      display: grid;
      gap: 0.25rem;
    }

    .dlx-cert-body li {
      font-size: 0.86rem;
      color: #e5e7eb;
    }

    .dlx-cert-body li::marker {
      color: #4ade80;
    }

    .dlx-cert-preview {
      border-radius: 0.9rem;
      padding: 0.75rem 0.85rem;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.82rem;
    }

    .dlx-cert-preview__title {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .dlx-cert-preview__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem 0.75rem;
      color: #9ca3af;
    }

    .dlx-cert-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.55rem;
      font-size: 0.82rem;
    }

    .dlx-cert-actions-main {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .dlx-cert-hint {
      color: #9ca3af;
      font-size: 0.8rem;
    }

    .dlx-cert-close {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .dlx-cert-close:hover {
      background: rgba(30, 64, 175, 0.8);
    }

    /* Prevent accidental text selection on interactive controls */
    .btn,
    .dlx-pill,
    .dlx-sound-btn,
    .dlx-alpha-chip,
    .dlx-stage2-letter-card button,
    .dlx-routine-options .btn {
      -ms-user-select: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* Utility */
    #dlxPage .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }

    #dlxPage .badge--green {
      background: rgba(22, 163, 74, 0.2);
      border-color: rgba(74, 222, 128, 0.9);
      color: #bbf7d0;
    }

    #dlxPage .badge--blue {
      background: rgba(37, 99, 235, 0.2);
      border-color: rgba(129, 140, 248, 0.85);
      color: #e0e7ff;
    }

    #dlxPage .badge-dot {
      width: 0.42rem;
      height: 0.42rem;
      border-radius: 999px;
      background: currentColor;
    }

    #dlxPage .eyebrow {
      font-size: 0.78rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #a5b4fc;
    }

    #dlxPage .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      main#dlxPage.container {
        border-radius: 0;
        box-shadow: none;
        padding-inline: 1.25rem;
      }

      #dlxPage .dlx-hero__grid {
        grid-template-columns: minmax(0, 1fr);
      }

      #dlxPage .dlx-intent-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .dlx-cert-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 768px) {
      main#dlxPage.container {
        padding-inline: 1rem;
        padding-block: 1.5rem 2.25rem;
      }

      #dlxPage .dlx-section {
        padding: 1.25rem 1rem;
        border-radius: 16px;
      }

      #dlxPage .dlx-grid--two,
      #dlxPage .dlx-grid--three {
        grid-template-columns: minmax(0, 1fr);
      }

      #dlxPage .dlx-hero__intent-card {
        order: -1;
      }

      .dlx-cert-panel {
        padding-inline: 1rem;
      }
    }

    @media (max-width: 480px) {
      main#dlxPage.container {
        padding-inline: 0.75rem;
      }

      #dlxPage .dlx-strip {
        border-radius: 0.9rem;
      }

      #dlxPage .dlx-hero-actions {
        flex-direction: column;
        align-items: flex-start;
      }

      .dlx-cert-backdrop {
        padding: 0.75rem;
      }
    }

    /* Stage 1 calibrate layout */
    #dlxStage1 .dlx-stage1-layout {
      display: flex;
      flex-direction: column;
      gap: clamp(1rem, 2vw, 1.5rem);
    }

    #dlxStage1 .dlx-stage1-panel__grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1.25fr);
      gap: clamp(1rem, 2vw, 1.5rem);
      align-items: stretch;
    }

    #dlxStage1 .dlx-stage1-panel__copy {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #dlxStage1 .dlx-stage1-pill-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    #dlxStage1 .dlx-stage1-pill-list li {
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 0.45rem 0.65rem;
    }

    #dlxStage1 .btn-inline {
      padding: 0.15rem 0.6rem;
      font-size: 0.8rem;
    }

    #dlxStage1 .dlx-stage1-profile {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    #dlxStage1 .dlx-chip-fieldset {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 1rem;
      padding: 0.85rem;
      background: rgba(15, 23, 42, 0.55);
    }

    #dlxStage1 .dlx-chip-fieldset legend {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #f8fafc;
    }

    #dlxStage1 .dlx-chip-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr));
      gap: 0.5rem;
    }

    #dlxStage1 .dlx-chip-option {
      position: relative;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 0.95rem;
      padding: 0.55rem 0.65rem 0.6rem;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      cursor: pointer;
      min-height: 3.5rem;
    }

    #dlxStage1 .dlx-chip-option input {
      position: absolute;
      inset: 0;
      opacity: 0;
    }

    #dlxStage1 .dlx-chip-option span {
      font-weight: 600;
    }

    #dlxStage1 .dlx-chip-option small {
      font-size: 0.75rem;
      color: #aeb9d8;
    }

    #dlxStage1 .dlx-chip-option.is-active {
      border-color: rgba(56, 189, 248, 0.85);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
      background: rgba(8, 25, 53, 0.85);
      color: #e0f2fe;
    }

    #dlxStage1 .dlx-stage1-note textarea {
      width: 100%;
      min-height: 3rem;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #f8fafc;
      padding: 0.55rem;
    }

    #dlxStage1 .dlx-stage1-profile__summary {
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 0.9rem;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.4);
      font-size: 0.9rem;
    }

    #dlxStage1 .dlx-stage1-subgrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(17rem, 1fr));
      gap: clamp(0.9rem, 2vw, 1.25rem);
    }

    #dlxStage1 .dlx-stage1-trend__body,
    #dlxStage1 .dlx-stage1-calm__body,
    #dlxStage1 .dlx-stage1-report__body {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #dlxStage1 .dlx-stage1-range-label {
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #dlxStage1 .dlx-stage1-range-scale {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      font-size: 0.74rem;
      color: #9ca3af;
    }

    #dlxStage1 .dlx-stage1-driver-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr));
      gap: 0.45rem;
    }

    #dlxStage1 .dlx-stage1-driver-grid label {
      border: 1px dashed rgba(148, 163, 184, 0.35);
      border-radius: 0.65rem;
      padding: 0.4rem 0.5rem;
      font-size: 0.82rem;
      background: rgba(15, 23, 42, 0.35);
    }

    #dlxStage1 .dlx-stage1-history {
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      padding-top: 0.65rem;
    }

    #dlxStage1 .dlx-stage1-history__list {
      list-style: none;
      margin: 0;
      padding-left: 0;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    #dlxStage1 .dlx-stage1-history__list li {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.8rem;
      padding: 0.5rem 0.6rem;
      background: rgba(15, 23, 42, 0.35);
      font-size: 0.82rem;
    }

    #dlxStage1 .dlx-stage1-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    #dlxStage1 .dlx-stage1-pill-row .btn {
      flex: 1 1 7rem;
      border-color: rgba(148, 163, 184, 0.3);
    }

    #dlxStage1 .dlx-stage1-pill-row .btn.is-active {
      border-color: rgba(56, 189, 248, 0.8);
      color: #fef3c7;
      background: rgba(8, 47, 73, 0.8);
    }

    #dlxStage1 .dlx-stage1-effect {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.9rem;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.4);
      display: grid;
      gap: 0.4rem;
    }

    #dlxStage1 .dlx-stage1-effect legend {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    #dlxStage1 .dlx-stage1-report__preview {
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 1rem;
      padding: 0.85rem;
      background: rgba(8, 25, 53, 0.65);
      min-height: 6rem;
      white-space: pre-line;
    }

    #dlxStage1 .dlx-stage1-calm__tip {
      border-left: 2px solid rgba(56, 189, 248, 0.4);
      padding-left: 0.5rem;
    }

    @media (max-width: 960px) {
      #dlxStage1 .dlx-stage1-panel__grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Stage 2 layout */
    #dlxStage2 .dlx-stage2-layout {
      gap: clamp(1rem, 2vw, 1.75rem);
    }

    #dlxStage2 .dlx-stage2-hero__grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: clamp(1rem, 2vw, 1.5rem);
      align-items: stretch;
    }

    #dlxStage2 .dlx-stage2-hero__stack {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    #dlxStage2 .dlx-stage2-hero__actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(13rem, 1fr));
      gap: 0.85rem;
    }

    #dlxStage2 .dlx-stage2-hero__action {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.95rem;
      padding: 0.85rem;
      background: rgba(15, 23, 42, 0.55);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.3);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    #dlxStage2 .dlx-stage2-hero__letters {
      display: flex;
      align-items: stretch;
    }

    #dlxStage2 .dlx-stage2-letter-card {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 1rem;
      padding: 1rem;
      background: rgba(15, 23, 42, 0.5);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.35);
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    #dlxStage2 .dlx-stage2-letter-card .dlx-inline-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    #dlxStage2 .dlx-stage2-map-embed {
      margin-top: clamp(1rem, 2vw, 1.5rem);
      padding-top: clamp(1rem, 2vw, 1.5rem);
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    #dlxStage2 .dlx-voice-speed > span {
      color: #aeb9d8;
    }

    #dlxAlphaGrid {
      display: grid;
      grid-template-columns: repeat(6, minmax(2.4rem, 1fr));
      gap: 0.5rem 0.75rem;
    }

    #dlxPage .dlx-vowel-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    #dlxPage .dlx-vowel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem 1.25rem;
    }

    #dlxPage .dlx-vowel-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.75rem 0;
    }

    #dlxStage2 .dlx-stage2-map__body,
    #dlxStage2 .dlx-stage2-tool__body {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #dlxStage2 .dlx-stage2-map .dlx-vowel-map-grid {
      grid-template-columns: repeat(auto-fit, minmax(13rem, 1fr));
    }

    @media (max-width: 960px) {
      #dlxStage1 .dlx-stage1-panel__grid,
      #dlxStage2 .dlx-stage2-hero__grid {
        grid-template-columns: minmax(0, 1fr);
      }

      #dlxStage2 .dlx-stage2-hero__actions {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* === Stage 3: Core drills & vowel studios (2025) === */
    .dlx-stage--coreDrills {
      display: flex;
      flex-direction: column;
      gap: clamp(1.5rem, 3vw, 2.5rem);
      border-radius: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: clamp(1.3rem, 2.6vw, 2.3rem);
      background:
        radial-gradient(circle at top, rgba(56, 189, 248, 0.2), rgba(15, 23, 42, 0.95) 70%),
        rgba(2, 6, 23, 0.9);
      box-shadow: 0 25px 80px rgba(15, 23, 42, 0.55);
      scroll-margin-top: 5rem;
    }

    .dlx-stage__intro {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 70ch;
    }

    .dlx-stage__eyebrow {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #a5b4fc;
      font-weight: 600;
    }

    .dlx-stage__heading {
      margin: 0;
      font-size: clamp(1.5rem, 1rem + 2vw, 2.4rem);
      line-height: 1.25;
      color: #f8fafc;
    }

    .dlx-stage__lede {
      margin: 0;
      font-size: 1rem;
      color: #cbd5f5;
    }

    .dlx-phase-summary {
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .dlx-phase-summary__header {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
    }

    .dlx-phase-summary__kicker {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      margin: 0;
    }

    .dlx-phase-summary__title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e5e7eb;
      margin: 0;
    }

    .dlx-phase-summary__hint {
      font-size: 0.85rem;
      color: #9ca3af;
      margin: 0;
    }

    .dlx-phase-summary__chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .dlx-phase-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .dlx-phase-chip__label {
      font-weight: 500;
    }

    .dlx-phase-chip__counts {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .dlx-phase-chip__status {
      font-size: 0.7rem;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      color: #cbd5e1;
    }

    .dlx-phase-chip--active {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    .dlx-phase-chip--active .dlx-phase-chip__status {
      background: rgba(56, 189, 248, 0.25);
      color: #e0f2fe;
    }

    .dlx-stage3-section {
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.32);
      padding: clamp(1.2rem, 2.4vw, 2rem);
      background: rgba(2, 6, 23, 0.8);
      display: flex;
      flex-direction: column;
      gap: clamp(0.9rem, 1.9vw, 1.4rem);
    }

    .dlx-stage3-section + .dlx-stage3-section {
      margin-top: clamp(1.5rem, 2.8vw, 2.25rem);
    }

    .dlx-stage3-section__head {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .dlx-stage3-section__head h3 {
      margin: 0;
      font-size: clamp(1.2rem, 0.6rem + 1.5vw, 1.8rem);
    }

    .dlx-stage3-grid {
      display: grid;
      gap: clamp(1rem, 2vw, 1.5rem);
      grid-template-columns: repeat(auto-fit, minmax(18rem, 1fr));
    }

    .dlx-stage3-grid--games {
      grid-template-columns: repeat(auto-fit, minmax(17rem, 1fr));
    }

    .dlx-stage3-grid--studios {
      grid-template-columns: repeat(auto-fit, minmax(19rem, 1fr));
    }

    .dlx-drill-card .dlx-training-card__body,
    .dlx-studio-card .dlx-training-card__body {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .dlx-drill-levels {
      margin: 0.75rem 0 1rem;
      padding-left: 1rem;
      display: grid;
      gap: 0.35rem;
    }

    .dlx-drill-levels strong {
      color: #fde68a;
    }

    .dlx-drill-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(5.5rem, 1fr));
      gap: 0.65rem;
      margin: 0.25rem 0 0.5rem;
    }

    .dlx-drill-metric {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 0.45rem 0.6rem;
      background: rgba(15, 23, 42, 0.7);
    }

    .dlx-drill-metric__label {
      display: block;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .dlx-drill-metric__value {
      font-size: 1.15rem;
      font-weight: 600;
      color: #fef9c3;
    }

    .dlx-drill-hint,
    .dlx-studio-hint,
    .dlx-studio-tip {
      margin: 0;
      color: #94a3b8;
    }

    .dlx-drill-actions,
    .dlx-drill-footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .dlx-drill-actions--strip {
      justify-content: space-between;
    }

    .dlx-drill-durations {
      border: 1px dashed rgba(148, 163, 184, 0.4);
      border-radius: 1rem;
      padding: 0.75rem 0.85rem;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      margin-top: 0.25rem;
    }

    .dlx-drill-durations__buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .dlx-drill-timer {
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .dlx-drill-timer__display {
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      padding: 0.6rem 0.8rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.7);
      text-align: center;
    }

    .dlx-drill-pace-pills {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.6);
      padding: 0.2rem;
      gap: 0.15rem;
    }

    .dlx-pill {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 0.2rem 0.9rem;
      background: transparent;
      color: #cbd5f5;
    }

    .dlx-pill--active {
      background: rgba(56, 189, 248, 0.12);
      border-color: rgba(56, 189, 248, 0.8);
      color: #e0f2fe;
    }

    .dlx-studio-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
      gap: 0.75rem;
      margin: 0.5rem 0 0.25rem;
    }

    .dlx-studio-metric {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 0.5rem 0.65rem;
      background: rgba(15, 23, 42, 0.72);
    }

    .dlx-studio-metric__label {
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .dlx-studio-metric__value {
      font-size: 1.3rem;
      font-weight: 600;
      color: #f0fdf4;
    }

    .dlx-studio-steps {
      list-style: none;
      margin: 0.75rem 0 0;
      padding-left: 0;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .dlx-studio-step {
      border: 1px dashed rgba(148, 163, 184, 0.35);
      border-radius: 1rem;
      padding: 0.75rem 0.85rem;
      background: rgba(15, 23, 42, 0.45);
      cursor: pointer;
    }

    .dlx-studio-step__row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      gap: 0.6rem;
      align-items: flex-start;
    }

    .dlx-studio-step__index {
      font-weight: 600;
      color: #fef3c7;
    }

    .dlx-studio-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .dlx-studio-progress {
      margin: 0;
      font-weight: 600;
    }

    .dlx-stage3-minigames {
      border-radius: 1rem;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      padding: 0.9rem 1rem;
      background: rgba(15, 23, 42, 0.5);
    }

    @media (max-width: 720px) {
      .dlx-drill-actions,
      .dlx-drill-footer-links,
      .dlx-studio-footer {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Focus breathing buttons */
    .dlx-focus-plan__buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      margin-top: 0.4rem;
    }

    .dlx-focus-plan__buttons .btn {
      flex: 1 1 clamp(9rem, 45%, 14rem);
      background: rgba(8, 25, 53, 0.95);
      color: #e2e8f0;
      border-color: rgba(59, 130, 246, 0.25);
      box-shadow: 0 12px 28px rgba(2, 6, 23, 0.7);
    }

    .dlx-focus-plan__buttons .btn:hover {
      background: rgba(15, 23, 42, 0.9);
      color: #f8fafc;
    }

    .dlx-focus-plan__buttons .btn.is-active {
      border-color: rgba(14, 165, 233, 0.85);
      color: #fef3c7;
      background: linear-gradient(145deg, rgba(2, 132, 199, 0.38), rgba(8, 47, 73, 0.95));
      box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.35), 0 22px 38px rgba(2, 6, 23, 0.65);
    }

    /* Stage 3 – focus mode highlight */
    #dlxStage3.dlx-stage3--focus {
      position: relative;
      outline: 2px solid rgba(56, 189, 248, 0.85);
      outline-offset: 4px;
    }

    #dlxStage3.dlx-stage3--focus::before {
      content: "";
      position: absolute;
      inset: -0.25rem;
      border-radius: inherit;
      background: radial-gradient(
        circle at top,
        rgba(56, 189, 248, 0.12),
        transparent 55%
      );
      pointer-events: none;
    }

    /* Studio steps – completed state */
    .dlx-studio-step--done .dlx-studio-step__row {
      border-style: solid;
      border-color: rgba(34, 197, 94, 0.85);
      background: radial-gradient(
        circle at left,
        rgba(34, 197, 94, 0.18),
        rgba(15, 23, 42, 0.95)
      );
    }

    .dlx-studio-step--done .dlx-studio-step__status {
      color: #4ade80;
    }

    /* Active “block” button for calm timer */
    .dlx-drill-durations__buttons .btn.is-active-block {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.55);
    }

    /* Simple toast / snackbar for hints & explains */
    .dlx-toast {
      position: fixed;
      left: 50%;
      bottom: 1.25rem;
      transform: translateX(-50%) translateY(120%);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.75);
      box-shadow: 0 14px 38px rgba(15, 23, 42, 0.7);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: transform 0.22s ease-out, opacity 0.22s ease-out;
    }

    .dlx-toast--visible {
      transform: translateX(-50%) translateY(0%);
      opacity: 1;
    }

  </style>
</head>

<body data-page-id="dyslexia">
  <div id="top"></div>
  <a class="skip-link" href="#main">Skip to content</a>
  <header class="site-header">
    <div class="container navbar">
      <a id="brandLink" class="brand" href="index.html">
        <span class="logo" aria-hidden="true"></span><span class="brand-text">NeuroBreath</span>
      </a>
      <nav class="main-nav" id="mainNav" role="navigation" aria-label="Primary">
        <div class="menu-group">
          <button type="button" class="menu-toggle" aria-expanded="false">Conditions ▾</button>
          <div class="submenu">
            <div class="menu-label" aria-hidden="true">Neurodevelopmental</div>
            <a href="autism.html" data-href="autism.html">Autism</a>
            <a href="autism-parent.html" data-href="autism-parent.html">Autism Parent</a>
            <a href="adhd.html" data-href="adhd.html">ADHD</a>
            <a href="dyslexia-reading-training.html" data-href="dyslexia-reading-training.html">Dyslexia</a>
            <div class="menu-label" aria-hidden="true">Mental Health</div>
            <a href="anxiety.html" data-href="anxiety.html">Anxiety</a>
            <a href="depression.html" data-href="depression.html">Depression</a>
            <a href="stress.html" data-href="stress.html">Stress</a>
            <a href="sleep.html" data-href="sleep.html">Sleep</a>
          </div>
        </div>
        <div class="menu-group">
          <button type="button" class="menu-toggle" aria-expanded="false">Breathing &amp; Focus ▾</button>
          <div class="submenu">
            <div class="menu-label" aria-hidden="true">Guides</div>
            <a href="breath.html" data-href="breath.html">Breath (how-to)</a>
            <a href="focus.html" data-href="focus.html">Focus</a>
            <a href="mindfulness.html" data-href="mindfulness.html">Mindfulness</a>
            <div class="menu-label" aria-hidden="true">Techniques</div>
            <a href="sos-60.html" data-href="sos-60.html">🆘 60-second SOS</a>
            <a href="box-breathing.html" data-href="box-breathing.html">🟩 Box Breathing</a>
            <a href="4-7-8-breathing.html" data-href="4-7-8-breathing.html">🟦 4-7-8 Breathing</a>
            <a href="coherent-5-5.html" data-href="coherent-5-5.html">🟪 Coherent 5-5</a>
          </div>
        </div>
        <div class="menu-group">
          <button type="button" class="menu-toggle" aria-expanded="false">Tools ▾</button>
          <div class="submenu">
            <a href="sleep-tools.html" data-href="sleep-tools.html">Sleep Tools</a>
            <a href="breath-tools.html" data-href="breath-tools.html">Breath Tools</a>
            <a href="mood-tools.html" data-href="mood-tools.html">Mood Tools</a>
            <a href="adhd-tools.html" data-href="adhd-tools.html">ADHD Tools</a>
            <a href="autism-tools.html" data-href="autism-tools.html">Autism Tools</a>
            <a href="anxiety-tools.html" data-href="anxiety-tools.html">Anxiety Tools</a>
            <a href="stress-tools.html" data-href="stress-tools.html">Stress Tools</a>
            <div class="menu-label" aria-hidden="true">Symptom Guides</div>
            <a href="stress-anxiety.html" data-href="stress-anxiety.html">Stress &amp; General Anxiety</a>
            <a href="panic-symptoms.html" data-href="panic-symptoms.html">Panic Symptoms</a>
            <a href="sleep-onset-insomnia.html" data-href="sleep-onset-insomnia.html">Sleep-Onset Insomnia</a>
            <a href="focus-test-anxiety.html" data-href="focus-test-anxiety.html">Focus &amp; Test Anxiety</a>
            <a href="ptsd-regulation.html" data-href="ptsd-regulation.html">PTSD Regulation*</a>
            <a href="low-mood-burnout.html" data-href="low-mood-burnout.html">Low Mood &amp; Burnout</a>
          </div>
        </div>
        <div class="menu-group">
          <button type="button" class="menu-toggle" aria-expanded="false">About ▾</button>
          <div class="submenu">
            <a href="about.html" data-href="about.html">About</a>
            <a href="aims-objectives.html" data-href="aims-objectives.html">Aims &amp; Stories</a>
            <a href="coffee.html" data-href="coffee.html">Support Us</a>
            <a href="contact.html" data-href="contact.html">Contact</a>
          </div>
        </div>
      </nav>
      <button type="button" id="navToggle" class="nav-toggle" aria-label="Menu" aria-expanded="false" aria-controls="mainNav">☰</button>
    </div>
  </header>

  <a id="topAnchor" hidden></a>
  <div id="main"></div>

  <main class="container dlx-page" id="dlxPage" aria-label="Dyslexia reading training hub">
    <section id="dlxHero" class="dlx-section dlx-hero" aria-labelledby="dlxHeroTitle">
      <div class="dlx-hero__grid">
        <div class="dlx-hero__main">
          <p class="dlx-kicker">Dyslexia Reading Training • NeuroBreath</p>
          <h1 id="dlxHeroTitle">Train reading, protect energy, and stay calm — in one place.</h1>
          <p class="dlx-hero__lead">
            Structured literacy drills, calm breathing, games, scratch rewards and rights guidance. Designed for children, teens and adults in school, university or work.
          </p>
          <div class="dlx-hero__actions">
            <button type="button" class="btn btn-quick-start" id="openQuickStart">&#9889; Click here for a quick start</button>
            <button type="button" class="btn btn-secondary" id="dlxDailyRouteBtn" data-scroll="#dlxQuestModes">🎮 Today’s Reading Quest</button>
            <button type="button" class="btn btn-ghost" id="dlxViewResearchBtn" data-scroll="#dlxResearchSources">🔍 View expert sources &amp; research</button>
          </div>
          <p class="muted dlx-hero__meta">No login, no cloud storage. Everything saves privately on this device.</p>
        </div>
        <aside class="dlx-hero__side" aria-label="Your dyslexia reading snapshot">
          <div class="card dlx-hero-card">
            <h2 class="mt-0">Your journey today</h2>
            <dl class="dlx-stat-list">
              <div>
                <dt>Focus streak</dt>
                <dd><span id="dlxStreakDays">0</span> days</dd>
              </div>
              <div>
                <dt>Reading minutes</dt>
                <dd><span id="dlxMinutesToday">0</span> min today</dd>
              </div>
              <div>
                <dt>Games completed</dt>
                <dd><span id="dlxGamesCompleted">0</span> games</dd>
              </div>
            </dl>
            <div class="dlx-session-feed">
              <p class="muted small">Recent sessions</p>
              <ol id="dlxSessionJournal" class="dlx-session-journal" aria-live="polite">
                <li>No sessions logged yet.</li>
              </ol>
            </div>
            <div class="dlx-game-highlight" id="dlxGameHighlights" aria-live="polite">
              <p class="muted small">Complete any drill to see highlights.</p>
            </div>
            <button type="button" class="btn btn-outline" id="dlxOpenProfileBtn">🙂 Personalise rewards</button>
            <p class="muted dlx-hero__note">Add a 60-second calm reset before any session to lower stress hormones and protect working memory.</p>
          </div>
        </aside>
      </div>
    </section>

    <section id="dlxStage1" class="dlx-section" aria-labelledby="dlxStage1H">
      <header class="dlx-section__head">
        <h2 id="dlxStage1H">Stage 1 · Calibrate: understand your profile and environment</h2>
        <p class="muted">Stage 1 is about clarity. Map the dyslexia profile, note weekly friction, track calm resets and share a quick report so every adult uses the same language.</p>
      </header>
      <div class="dlx-stage1-layout">
        <article class="card dlx-training-card dlx-stage1-panel" id="dlxStage1Calibrate">
          <header class="dlx-training-card__head">
            <p class="dlx-training-card__kicker">Orientation + profile builder</p>
            <h3>Calibrate the learner’s current reality</h3>
          </header>
          <div class="dlx-stage1-panel__grid">
            <div class="dlx-stage1-panel__copy">
              <p class="muted">Dyslexia lives in the pathways between sound, symbol and working memory. We keep confidence intact by pairing challenges with strengths, and by writing down what regulation or environmental tweaks actually help.</p>
              <ul class="dlx-stage1-pill-list">
                <li>🎯 <strong>Clarity</strong> — agree on the dominant reading profile so interventions stay aligned.</li>
                <li>🧠 <strong>Strength lens</strong> — record creative, spatial or problem-solving wins every week.</li>
                <li>🤝 <strong>Shared script</strong> — hand this to teachers, SENCOs, tutors, managers or family.</li>
              </ul>
              <p class="muted small">Need an audio primer? <button type="button" class="btn btn-ghost btn-inline coach-explain" data-coach-id="whatIsDyslexia">🎧 Play teacher explanation</button></p>
            </div>
            <form class="dlx-stage1-profile" id="dlxStage1ProfileForm" aria-label="Profile builder">
              <fieldset class="dlx-chip-fieldset">
                <legend id="dlxProfileCoreLabel">Reading focus anchor</legend>
                <div class="dlx-chip-grid" role="radiogroup" aria-labelledby="dlxProfileCoreLabel">
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileCore" value="phonological" data-dlx-profile-field="core" />
                    <span>Phonological decoding</span>
                    <small>Needs explicit sound-to-symbol drills.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileCore" value="naming" data-dlx-profile-field="core" />
                    <span>Rapid naming &amp; processing</span>
                    <small>Supports for pacing, timing, confidence.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileCore" value="working" data-dlx-profile-field="core" />
                    <span>Working-memory load</span>
                    <small>Chunking, scaffolds, repetition needed.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileCore" value="sensory" data-dlx-profile-field="core" />
                    <span>Visual stress / sensory</span>
                    <small>Lighting, contrast, motion sensitivity.</small>
                  </label>
                </div>
              </fieldset>
              <fieldset class="dlx-chip-fieldset">
                <legend id="dlxProfileEnvLabel">Learning environment</legend>
                <div class="dlx-chip-grid" role="radiogroup" aria-labelledby="dlxProfileEnvLabel">
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileEnv" value="school" data-dlx-profile-field="environment" />
                    <span>Primary / secondary</span>
                    <small>Timetabled lessons + SEN support.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileEnv" value="college" data-dlx-profile-field="environment" />
                    <span>College / university</span>
                    <small>Lecture capture + assistive tech.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileEnv" value="work" data-dlx-profile-field="environment" />
                    <span>Workplace / apprenticeship</span>
                    <small>Manager briefings + task design.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="radio" name="dlxProfileEnv" value="hybrid" data-dlx-profile-field="environment" />
                    <span>Hybrid / portfolio</span>
                    <small>Mix of home, online, community.</small>
                  </label>
                </div>
              </fieldset>
              <fieldset class="dlx-chip-fieldset">
                <legend id="dlxOverlayLabel">Layers to remember</legend>
                <div class="dlx-chip-grid" role="group" aria-labelledby="dlxOverlayLabel">
                  <label class="dlx-chip-option">
                    <input type="checkbox" value="adhd" data-dlx-profile-overlay />
                    <span>Attention / ADHD</span>
                    <small>Needs movement + shorter bursts.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="checkbox" value="dyspraxia" data-dlx-profile-overlay />
                    <span>Dyspraxia / DCD</span>
                    <small>Motor planning + pacing support.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="checkbox" value="language" data-dlx-profile-overlay />
                    <span>Language difference</span>
                    <small>ESL / multilingual, vocabulary load.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="checkbox" value="anxiety" data-dlx-profile-overlay />
                    <span>Anxiety / burnout</span>
                    <small>Needs calm starts + wins.</small>
                  </label>
                  <label class="dlx-chip-option">
                    <input type="checkbox" value="auditory" data-dlx-profile-overlay />
                    <span>Auditory processing</span>
                    <small>Slower instructions, visuals.</small>
                  </label>
                </div>
              </fieldset>
              <label class="dlx-stage1-note">
                Learner voice / environmental notes
                <textarea id="dlxProfileContext" data-dlx-profile-note rows="3" placeholder="Example: needs tinted overlay + headphones after lunch."></textarea>
              </label>
              <div class="dlx-stage1-profile__summary" aria-live="polite" id="dlxStage1ProfileSentence">
                Choose a profile focus to generate a shared script.
              </div>
            </form>
          </div>
        </article>

        <div class="dlx-stage1-subgrid">
          <article class="card dlx-training-card dlx-stage1-trend" id="dlxStage1Trend">
            <header class="dlx-training-card__head">
              <p class="dlx-training-card__kicker">Weekly friction meter</p>
              <h3>Track load + triggers</h3>
            </header>
            <div class="dlx-stage1-trend__body">
              <label for="dlxFrictionScale" class="dlx-stage1-range-label">Current friction <span id="dlxFrictionScoreLabel">0 / 10</span></label>
              <input type="range" id="dlxFrictionScale" min="0" max="10" step="1" value="0" />
              <div class="dlx-stage1-range-scale" aria-hidden="true">
                <span>Calm</span>
                <span>Manageable</span>
                <span>Spiky</span>
                <span>Overloaded</span>
              </div>
              <p class="muted small">Tick drivers that showed up this week.</p>
              <div class="dlx-stage1-driver-grid">
                <label><input type="checkbox" value="fatigue" data-dlx-friction-driver /> Fatigue / late nights</label>
                <label><input type="checkbox" value="transitions" data-dlx-friction-driver /> Transitions / timetable changes</label>
                <label><input type="checkbox" value="sensory" data-dlx-friction-driver /> Sensory overload</label>
                <label><input type="checkbox" value="motivation" data-dlx-friction-driver /> Motivation dip</label>
                <label><input type="checkbox" value="support" data-dlx-friction-driver /> Support not in place</label>
                <label><input type="checkbox" value="health" data-dlx-friction-driver /> Health / medication change</label>
              </div>
              <label class="dlx-stage1-note">
                Quick friction note
                <textarea id="dlxFrictionNotes" rows="2" placeholder="Example: exam week + noisy classroom made reading drills stall."></textarea>
              </label>
              <div class="dlx-inline-actions">
                <button type="button" class="btn btn-outline" id="dlxSaveFriction">💾 Save weekly snapshot</button>
                <p id="dlxFrictionSnapshot" class="muted small" aria-live="polite">No weekly snapshot yet.</p>
              </div>
              <div class="dlx-stage1-history">
                <p class="muted small">Recent trend</p>
                <ol id="dlxFrictionTrendList" class="dlx-stage1-history__list">
                  <li>No history yet. Log the first week to unlock trend view.</li>
                </ol>
              </div>
            </div>
          </article>

          <article class="card dlx-training-card dlx-stage1-calm" id="dlxCalmResetTracker">
            <header class="dlx-training-card__head">
              <p class="dlx-training-card__kicker">Calm reset tracker</p>
              <h3>Protect the nervous system</h3>
            </header>
            <div class="dlx-stage1-calm__body">
              <label>Breath pattern in use
                <select id="dlxCalmPatternSelect">
                  <option value="">Select a pattern</option>
                  <option value="sos">SOS-60 calm reset</option>
                  <option value="box">Box breathing 4-4-4-4</option>
                  <option value="478">4-7-8 regulation</option>
                  <option value="coherent">Coherent 5-5</option>
                  <option value="roll">Physiological sigh / roll breathing</option>
                </select>
              </label>
              <div class="dlx-stage1-pill-row" role="group" aria-label="When the reset happens" id="dlxCalmTimeRow">
                <button type="button" class="btn btn-ghost" data-dlx-calm-time="before">Before reading</button>
                <button type="button" class="btn btn-ghost" data-dlx-calm-time="mid">Mid-session pause</button>
                <button type="button" class="btn btn-ghost" data-dlx-calm-time="after">After session recovery</button>
              </div>
              <fieldset class="dlx-stage1-effect" aria-label="Calm effect rating">
                <legend>How did it land?</legend>
                <label><input type="radio" name="dlxCalmEffect" value="steady" checked /> Steady + present</label>
                <label><input type="radio" name="dlxCalmEffect" value="lighter" /> Lighter but still alert</label>
                <label><input type="radio" name="dlxCalmEffect" value="sleepy" /> Sleepy / drained</label>
              </fieldset>
              <button type="button" class="btn btn-primary" id="dlxLogCalmReset">➕ Log this calm reset</button>
              <p id="dlxCalmResetStats" class="muted small" aria-live="polite">No calm resets logged yet.</p>
              <div class="dlx-stage1-calm__tip muted small">Tip: pair the calm reset with the SOS-60 button or box breathing quick start above.</div>
            </div>
          </article>

          <article class="card dlx-training-card dlx-stage1-report" id="dlxStage1Report">
            <header class="dlx-training-card__head">
              <p class="dlx-training-card__kicker">Shareable snapshot</p>
              <h3>Export-ready briefing</h3>
            </header>
            <div class="dlx-stage1-report__body">
              <p class="muted">Use this text for SENCO updates, EHCP evidence, employer adjustments or tutor briefings. It blends the profile, friction score and calm data.</p>
              <div class="dlx-stage1-report__preview" id="dlxStage1ReportOutput" role="region" aria-live="polite">
                Build the profile above, then tap “Generate summary.”
              </div>
              <div class="dlx-inline-actions">
                <button type="button" class="btn btn-success" id="dlxStage1ReportBtn">🧾 Generate summary</button>
                <button type="button" class="btn btn-ghost" id="dlxStage1ReportCopy">📋 Copy text</button>
              </div>
              <p id="dlxStage1ReportStatus" class="muted small" aria-live="polite"></p>
            </div>
          </article>
        </div>
      </div>
    </section>

    <section id="dlxStage2" class="dlx-section dlx-section--stage2" aria-labelledby="dlxStage2H">
      <header class="dlx-section__head">
        <h2 id="dlxStage2H">Stage 2 · Map skills: shared visuals and realistic routines</h2>
        <p class="muted">Use the same language across lessons, games and conversations to reduce working-memory load.</p>
      </header>
      <div class="dlx-stage2-layout dlx-grid--stage2">
        <article class="card dlx-training-card" id="alphabetAtlas" aria-labelledby="alphabetAtlasH">
          <header class="dlx-training-card__head">
            <div>
              <p class="dlx-training-card__kicker">Foundation</p>
              <h3 id="alphabetAtlasH">Alphabet Atlas (26-letter map)</h3>
            </div>
          </header>

          <div class="dlx-training-card__body">
            <p class="muted">
              Use these quick taps to reinforce the same sound language across lessons, games and conversations.
              Each chip plays the phonetic teacher script so learners hear every sound option clearly.
            </p>

            <!-- Voice speed controls (keeps existing JS hooks) -->
            <div class="dlx-voice-speed" role="group" aria-label="Coach voice speed controls">
              <span>Voice speed</span>
              <div class="dlx-voice-speed__buttons">
                <button type="button" class="btn btn-ghost is-active" data-speech-speed="slow">Calm</button>
                <button type="button" class="btn btn-ghost" data-speech-speed="coach">Coach</button>
                <button type="button" class="btn btn-ghost" data-speech-speed="quick">Quick</button>
              </div>
              <label class="dlx-voice-speed__slider">
                <span class="sr-only">Adjust speech rate</span>
                <input
                  type="range"
                  min="0.7"
                  max="1.2"
                  step="0.05"
                  value="0.82"
                  id="dlxSpeechSlider"
                />
                <span id="dlxSpeechValue">0.82×</span>
              </label>
            </div>

            <p class="muted small">
              Pick the pace that matches the learner, then tap the chips.
            </p>

            <!-- Quick routes section -->
            <h4>Quick routes</h4>

            <button
              type="button"
              class="btn btn-outline"
              id="dlxSoundQuestLaunch"
              data-track="dlx_sound_memory_quest"
            >
              ▶ Sound Memory Quest
            </button>
            <p class="muted small">
              Climb 26 micro-levels using picture and sound clues until you graduate.
            </p>

            <button
              type="button"
              class="btn btn-outline"
              id="dlxPhonicsSongBtn"
              data-track="dlx_phonics_song"
            >
              🎵 A–Z Phonics Sounds
            </button>
            <p class="muted small">
              Coach will sing the letter name, main sound and anchor phrase for every letter.
            </p>

            <section class="dlx-phonics-hero" aria-labelledby="dlxPhonicsHeroTitle">
              <div class="dlx-phonics-hero__glow" aria-hidden="true"></div>
              <div class="dlx-phonics-hero__layout">
                <div class="dlx-phonics-hero__content">
                  <header class="dlx-phonics-hero__copy">
                    <p class="dlx-phonics-hero__kicker">Celebration Studio</p>
                    <h4 class="dlx-phonics-hero__title" id="dlxPhonicsHeroTitle">Phonics Sounds · Letters Only</h4>
                    <p class="dlx-phonics-hero__body">
                      Tap once to open the full-screen phonics studio. Coach Dorothy lights the current letter, models the phoneme,
                      and pauses for calm celebrations after each milestone so the nervous system stays regulated.
                    </p>
                  </header>
                  <div class="dlx-phonics-hero__cta-card" aria-label="Launch the phonics studio">
                    <a
                      class="btn btn-primary"
                      href="phonics-sounds-lab.html"
                      data-track="dlx_letter_sounds_only"
                    >
                      Start phonics sounds
                    </a>
                    <ul class="dlx-phonics-hero__cta-flags">
                      <li>
                        <strong>Coach Dorothy guide</strong>
                        <span>Lights mark every repeat cue so learners stay in sync.</span>
                      </li>
                      <li>
                        <strong>Flexible playback</strong>
                        <span>Works with headphones, speakers or classroom displays.</span>
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="dlx-phonics-hero__feature-shell" aria-label="Studio highlights">
                  <p class="dlx-phonics-hero__feature-heading">Studio highlights</p>
                  <ul class="dlx-phonics-hero__feature-grid">
                    <li>
                      <div class="dlx-phonics-hero__feature-icon" aria-hidden="true">🎙️</div>
                      <div>
                        <p class="dlx-phonics-hero__feature-title">Live pace lights</p>
                        <p class="dlx-phonics-hero__feature-note">Stage lights track the phoneme tempo so pacing stays calm.</p>
                      </div>
                    </li>
                    <li>
                      <div class="dlx-phonics-hero__feature-icon" aria-hidden="true">💡</div>
                      <div>
                        <p class="dlx-phonics-hero__feature-title">Mouth-shape coaching</p>
                        <p class="dlx-phonics-hero__feature-note">Animated head shows the jaw, lips and breath cues for each letter.</p>
                      </div>
                    </li>
                    <li>
                      <div class="dlx-phonics-hero__feature-icon" aria-hidden="true">🎉</div>
                      <div>
                        <p class="dlx-phonics-hero__feature-title">Breath-led celebrations</p>
                        <p class="dlx-phonics-hero__feature-note">Built-in pauses guide 10-second breath breaks after every milestone.</p>
                      </div>
                    </li>
                  </ul>
                </div>

                <div class="dlx-phonics-hero__milestone-shell" aria-label="Celebration ladder">
                  <p class="dlx-phonics-hero__milestone-heading">Celebration ladder</p>
                  <ol class="dlx-phonics-hero__milestones">
                    <li data-tier="bronze">
                      <p class="dlx-phonics-hero__milestone-title">Bronze breath break</p>
                      <p class="dlx-phonics-hero__milestone-note">Letters A–F checkpoint + calm breathing countdown.</p>
                    </li>
                    <li data-tier="gold">
                      <p class="dlx-phonics-hero__milestone-title">Gold glide</p>
                      <p class="dlx-phonics-hero__milestone-note">M–R sparkle lights, buzz panel + tactile applause.</p>
                    </li>
                    <li data-tier="platinum">
                      <p class="dlx-phonics-hero__milestone-title">Platinum spotlight</p>
                      <p class="dlx-phonics-hero__milestone-note">Full-screen celebration + printable certificate.</p>
                    </li>
                  </ol>
                </div>
              </div>
            </section>

            <!-- Alphabet grid (6-across layout via inline grid style) -->
            <div
              class="dlx-alpha-grid"
              id="dlxAlphaGrid"
              aria-live="off"
              aria-label="Alphabet sound chips"
            ></div>

            <p class="muted small" id="dlxAlphaOutput" aria-live="polite">
              Tap a letter to hear it.
            </p>

            <ul
              class="dlx-alpha-sound-list"
              id="dlxAlphaSoundList"
              aria-label="Letter to phoneme mapping (debug list)"
              hidden
            ></ul>

            <p class="muted small" id="dlxAlphaLowerNote">
              Each chip shows uppercase + lowercase so handwriting cues stay aligned.
            </p>

            <div class="dlx-inline-actions">
              <button type="button" class="btn btn-outline" data-alpha-group="vowels">
                Highlight vowels
              </button>
              <button type="button" class="btn btn-outline" data-alpha-group="consonants">
                Highlight consonants
              </button>
              <button type="button" class="btn btn-outline" data-alpha-group="reset">
                Reset
              </button>
            </div>
          </div>
        </article>

        <article class="card dlx-training-card" id="vowelUniverse" aria-labelledby="vowelUniverseH">
          <header class="dlx-training-card__head">
            <div>
              <p class="dlx-training-card__kicker">Grapheme–phoneme mapping</p>
              <h3 id="vowelUniverseH">Vowel Universe map</h3>
            </div>
          </header>

          <div class="dlx-training-card__body">
            <p class="muted">
              Short Street · Skyline Towers · Team Bridge · R-River · Slide Park.
              Keep the story consistent across lessons, games and conversations so learners don’t have to relearn the rules.
            </p>

            <!-- Legend / high-level overview -->
            <div class="dlx-vowel-legend">
              <span class="badge">Levels 1–3 · Short Street</span>
              <span class="badge">Levels 4–6 · Skyline Towers</span>
              <span class="badge">Levels 5–7 · Team Bridge</span>
              <span class="badge">Levels 7–8 · R-River</span>
              <span class="badge">Levels 9–10 · Slide Park</span>
            </div>

            <!-- Main grid for the five “streets” -->
            <div class="dlx-vowel-grid">

              <!-- Short Street -->
              <section class="dlx-vowel-card" aria-labelledby="shortStreetH">
                <header class="dlx-vowel-card__head">
                  <p class="dlx-vowel-card__level muted small">Levels 1–3</p>
                  <h4 id="shortStreetH">Short Street</h4>
                </header>
                <p class="muted small">
                  Short vowels (<strong>a, e, i, o, u</strong>). Keep sounds clipped and calm.
                  Build CVC + VC words with lots of repetition.
                </p>
                <div class="dlx-vowel-chips">
                  <button type="button" class="btn btn-chip" data-vowel="a">a</button>
                  <button type="button" class="btn btn-chip" data-vowel="e">e</button>
                  <button type="button" class="btn btn-chip" data-vowel="i">i</button>
                  <button type="button" class="btn btn-chip" data-vowel="o">o</button>
                  <button type="button" class="btn btn-chip" data-vowel="u">u</button>
                </div>
                <div class="dlx-inline-actions">
                  <button type="button" class="btn btn-outline" data-vowel-map="short-street">
                    ▶ Load Short Street plan
                  </button>
                  <button type="button" class="btn btn-ghost" data-vowel-explain="short-street">
                    🎧 Explain this map
                  </button>
                </div>
              </section>

              <!-- Skyline Towers -->
              <section class="dlx-vowel-card" aria-labelledby="skylineTowersH">
                <header class="dlx-vowel-card__head">
                  <p class="dlx-vowel-card__level muted small">Levels 4–6</p>
                  <h4 id="skylineTowersH">Skyline Towers</h4>
                </header>
                <p class="muted small">
                  Long vowels + common digraphs. Use tower visuals and tracing to store each team.
                </p>
                <div class="dlx-vowel-chips">
                  <button type="button" class="btn btn-chip" data-vowel="ai">ai</button>
                  <button type="button" class="btn btn-chip" data-vowel="ee">ee</button>
                  <button type="button" class="btn btn-chip" data-vowel="oa">oa</button>
                  <button type="button" class="btn btn-chip" data-vowel="ie">ie</button>
                  <button type="button" class="btn btn-chip" data-vowel="ue">ue</button>
                </div>
                <div class="dlx-inline-actions">
                  <button type="button" class="btn btn-outline" data-vowel-map="skyline-towers">
                    ▶ Load Skyline Towers plan
                  </button>
                  <button type="button" class="btn btn-ghost" data-vowel-explain="skyline-towers">
                    🎧 Explain this map
                  </button>
                </div>
              </section>

              <!-- Team Bridge -->
              <section class="dlx-vowel-card" aria-labelledby="teamBridgeH">
                <header class="dlx-vowel-card__head">
                  <p class="dlx-vowel-card__level muted small">Levels 5–7</p>
                  <h4 id="teamBridgeH">Team Bridge</h4>
                </header>
                <p class="muted small">
                  Vowel teams + diphthongs. Explain who “talks” and who “walks” each time.
                </p>
                <div class="dlx-vowel-chips">
                  <button type="button" class="btn btn-chip" data-vowel="au">au</button>
                  <button type="button" class="btn btn-chip" data-vowel="aw">aw</button>
                  <button type="button" class="btn btn-chip" data-vowel="oi">oi</button>
                  <button type="button" class="btn btn-chip" data-vowel="oy">oy</button>
                  <button type="button" class="btn btn-chip" data-vowel="ew">ew</button>
                </div>
                <div class="dlx-inline-actions">
                  <button type="button" class="btn btn-outline" data-vowel-map="team-bridge">
                    ▶ Load Team Bridge plan
                  </button>
                  <button type="button" class="btn btn-ghost" data-vowel-explain="team-bridge">
                    🎧 Explain this map
                  </button>
                </div>
              </section>

              <!-- R-River -->
              <section class="dlx-vowel-card" aria-labelledby="rRiverH">
                <header class="dlx-vowel-card__head">
                  <p class="dlx-vowel-card__level muted small">Levels 7–8</p>
                  <h4 id="rRiverH">R-River</h4>
                </header>
                <p class="muted small">
                  R-controlled patterns. Keep the tongue relaxed and stretch the /r/ gently.
                </p>
                <div class="dlx-vowel-chips">
                  <button type="button" class="btn btn-chip" data-vowel="ar">ar</button>
                  <button type="button" class="btn btn-chip" data-vowel="er">er</button>
                  <button type="button" class="btn btn-chip" data-vowel="ir">ir</button>
                  <button type="button" class="btn btn-chip" data-vowel="or">or</button>
                  <button type="button" class="btn btn-chip" data-vowel="ur">ur</button>
                </div>
                <div class="dlx-inline-actions">
                  <button type="button" class="btn btn-outline" data-vowel-map="r-river">
                    ▶ Load R-River plan
                  </button>
                  <button type="button" class="btn btn-ghost" data-vowel-explain="r-river">
                    🎧 Explain this map
                  </button>
                </div>
              </section>

              <!-- Slide Park -->
              <section class="dlx-vowel-card" aria-labelledby="slideParkH">
                <header class="dlx-vowel-card__head">
                  <p class="dlx-vowel-card__level muted small">Levels 9–10</p>
                  <h4 id="slideParkH">Slide Park</h4>
                </header>
                <p class="muted small">
                  Rare spellings and flexible patterns. Slide between spellings and meanings.
                </p>
                <div class="dlx-vowel-chips">
                  <button type="button" class="btn btn-chip" data-vowel="ough">ough</button>
                  <button type="button" class="btn btn-chip" data-vowel="augh">augh</button>
                  <button type="button" class="btn btn-chip" data-vowel="eigh">eigh</button>
                  <button type="button" class="btn btn-chip" data-vowel="ie">ie</button>
                  <button type="button" class="btn btn-chip" data-vowel="oi">oi</button>
                </div>
                <div class="dlx-inline-actions">
                  <button type="button" class="btn btn-outline" data-vowel-map="slide-park">
                    ▶ Load Slide Park plan
                  </button>
                  <button type="button" class="btn btn-ghost" data-vowel-explain="slide-park">
                    🎧 Explain this map
                  </button>
                </div>
              </section>
            </div>

            <div class="dlx-vowel-map-detail is-empty" id="dlxVowelMapDetail" aria-live="polite">
              <div class="dlx-vowel-map-detail__meta">
                <p class="dlx-kicker" id="dlxVowelMapEyebrow">Map planner</p>
                <h4 id="dlxVowelMapTitle">Choose a map</h4>
                <p class="muted small" id="dlxVowelMapSummary">
                  Tap any “Load plan” button to pull in the minutes, story cues and matching Stage 3 drills.
                </p>
              </div>
              <dl class="dlx-vowel-map-detail__stats">
                <div>
                  <dt>Levels</dt>
                  <dd id="dlxVowelMapLevels">—</dd>
                </div>
                <div>
                  <dt>Minutes</dt>
                  <dd id="dlxVowelMapMinutes">—</dd>
                </div>
                <div>
                  <dt>Stage 3 link</dt>
                  <dd id="dlxVowelMapPhaseLabel">—</dd>
                </div>
              </dl>
              <p class="muted small" id="dlxVowelMapTip">Map guidance appears here once you select a street.</p>
              <div class="dlx-inline-actions dlx-vowel-map-detail__actions">
                <button type="button" class="btn btn-primary" id="dlxVowelMapLaunch" disabled>⚡ Calm reset + map</button>
                <button type="button" class="btn btn-outline" id="dlxVowelMapPhase" disabled>↳ Use Stage 3 drills</button>
              </div>
            </div>

            <div class="dlx-vowel-support" aria-label="Support tools">
              <section class="dlx-vowel-support__card" id="pronunciationLab" aria-labelledby="pronunciationLabTitle">
                <div class="dlx-vowel-support__head">
                  <p class="dlx-training-card__kicker">Tool</p>
                  <h4 id="pronunciationLabTitle">Pronunciation Lab (TTS)</h4>
                </div>
                <div class="dlx-stage2-tool__body">
                  <p class="muted">Tap a sound to hear examples. Use headphones in class or quiet offices.</p>
                  <div class="dlx-sound-grid" aria-label="Sound buttons for pronunciation practice">
                    <button type="button" class="dlx-sound-btn" data-tts="Short a">a – apple</button>
                    <button type="button" class="dlx-sound-btn" data-tts="Long ee">ee – tree</button>
                    <button type="button" class="dlx-sound-btn" data-tts="Long igh">igh – night</button>
                    <button type="button" class="dlx-sound-btn" data-tts="Or">or – storm</button>
                  </div>
                </div>
              </section>

              <section class="dlx-vowel-support__card" id="routineMap" aria-labelledby="routineMapTitle">
                <div class="dlx-vowel-support__head">
                  <p class="dlx-training-card__kicker">Routine</p>
                  <h4 id="routineMapTitle">Plan tiny, repeatable slots</h4>
                </div>
                <div class="dlx-stage2-tool__body">
                  <p class="muted">Pick what fits your week. You can always add more later.</p>
                  <div class="dlx-routine-options" aria-label="Select routine length">
                    <button type="button" class="btn btn-outline" data-routine="5">5 min × 2</button>
                    <button type="button" class="btn btn-outline" data-routine="10">10 min × 1</button>
                    <button type="button" class="btn btn-outline" data-routine="15">15 min mix</button>
                  </div>
                  <p class="muted small" id="dlxRoutineSummary" aria-live="polite"></p>
                  <div class="dlx-stage2-tool__actions dlx-vowel-support__actions">
                    <button type="button" class="btn btn-ghost coach-explain" data-coach-id="routineMap">🎧 How to pick</button>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </article>
      </div>
    </section>

    <section id="dlxStage3" class="dlx-stage dlx-stage--coreDrills">
      <header class="dlx-stage__intro">
        <p class="dlx-stage__eyebrow">Stage 3 · Core drills</p>
        <h2 class="dlx-stage__heading">
          Stage 3 · Core drills: calm practice and pacing
        </h2>
        <p class="dlx-stage__lede muted">
          Short, repeatable drills grounded in structured literacy and steady pacing.
        </p>
      </header>

      <!-- Stage 3 Phase summary strip -->
      <section class="dlx-phase-summary" aria-label="Stage 3 phase overview">
        <header class="dlx-phase-summary__header">
          <p class="dlx-phase-summary__kicker">Stage 3 · Core drills</p>
          <h2 class="dlx-phase-summary__title">Phase overview</h2>
          <p class="dlx-phase-summary__hint">
            Choose a phase to focus the drills. You can still change the phase inside each game.
          </p>
        </header>

        <div class="dlx-phase-summary__chips" data-phase-summary-chips>
          <!-- Chips will be injected by JavaScript -->
        </div>
      </section>

      <!-- Core drills · game cards -->
      <section class="dlx-stage3-section" aria-labelledby="coreDrillsH">
        <header class="dlx-stage3-section__head">
          <h3 id="coreDrillsH">Core drills · Games</h3>
          <p class="muted small">
            Accuracy, expression and calm timing before speed. Use one focused game at a time.
          </p>
        </header>

        <div class="dlx-stage3-grid dlx-stage3-grid--games">
          <!-- Game · Vowel Quest -->
          <article
            id="vowelQuestCard"
            class="card dlx-training-card dlx-drill-card"
            aria-labelledby="vowelQuestH"
          >
            <header class="dlx-training-card__head">
              <div>
                <p class="dlx-training-card__kicker">Game · Phonics</p>
                <h3 id="vowelQuestH">Vowel Quest</h3>
              </div>
            </header>
            <div class="dlx-training-card__body">
              <p class="muted small">
                See a vowel sound prompt, tap the spelling that matches and keep your breath steady.
                Accuracy first, then gentle speed.
              </p>

              <ul class="dlx-drill-levels muted small">
                <li><strong>1–3:</strong> Short vowels in CVC / VC words with picture-style clues.</li>
                <li>
                  <strong>4–7:</strong> Long vowels, magic-e and common teams
                  (ai, ee, oa, ie, ue).
                </li>
                <li>
                  <strong>8–10:</strong> Mixed review with diphthongs, r-controlled patterns and
                  flexible patterns.
                </li>
              </ul>

              <p class="muted small">
                Tap the answer that best matches the sound. One calm round at a time.
              </p>

              <div class="dlx-toolbar dlx-toolbar--tight">
                <div class="dlx-field">
                  <label for="vqPhaseSelect" class="dlx-label">Phase</label>
                  <select id="vqPhaseSelect" class="dlx-select" data-vq-phase-select>
                    <option value="all">All phases</option>
                    <option value="Phase 2">Phase 2 – Early short vowels</option>
                    <option value="Phase 3">Phase 3 – Vowel teams</option>
                    <option value="Phase 5">Phase 5 – Alternative spellings</option>
                  </select>
                </div>

                <button type="button" class="btn btn-ghost" data-vq-play-sound>
                  🔊 Play sound
                </button>
              </div>

              <p class="dlx-vq-prompt muted" data-vq-prompt aria-live="polite">
                Tap “Start round” to see your first sound prompt.
              </p>

              <div class="dlx-vq-level-meta muted small">
                <span data-vq-phase-label></span>
                <span data-vq-level-label></span>
              </div>

              <div class="dlx-vq-options" data-vq-options role="group" aria-label="Vowel Quest options"></div>

              <div class="dlx-drill-metrics" aria-label="Vowel Quest stats">
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Round</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="vowel-quest"
                    data-field="round"
                  >–</span>
                </div>
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Level</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="vowel-quest"
                    data-field="level"
                  >1</span>
                </div>
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Streak</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="vowel-quest"
                    data-field="streak"
                  >0</span>
                </div>
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Score</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="vowel-quest"
                    data-field="score"
                  >0</span>
                </div>
              </div>

              <p class="muted x-small dlx-drill-hint">
                Tap <strong>“Start round”</strong> to see your first sound prompt.
              </p>

              <div class="dlx-drill-actions">
                <button
                  type="button"
                  class="btn btn-primary"
                  data-game-start="vowel-quest"
                  data-vq-start
                >
                  ▶ Start round
                </button>
                <button
                  type="button"
                  class="btn btn-ghost"
                  data-game-hint="vowel-quest"
                >
                  💡 Hint
                </button>
              </div>

              <div class="dlx-drill-durations">
                <span class="muted x-small">Try a calm block:</span>
                <div class="dlx-drill-durations__buttons">
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game-block="1"
                    data-game="vowel-quest"
                  >
                    ▶ 1 min
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game-block="3"
                    data-game="vowel-quest"
                  >
                    ▶ 3 min
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game-block="5"
                    data-game="vowel-quest"
                  >
                    ▶ 5 min
                  </button>
                </div>
              </div>

              <div class="dlx-drill-footer-links">
                <button
                  type="button"
                  class="btn btn-ghost x-small"
                  data-game-explain="vowel-quest"
                >
                  🎧 Explain this game
                </button>
                <button
                  type="button"
                  class="btn btn-ghost x-small"
                  data-focus-mode="vowel-quest"
                >
                  🌙 Focus mode
                </button>
              </div>
            </div>
          </article>

          <!-- Game · Fluency Pacer -->
          <article
            id="fluencyPacerCard"
            class="card dlx-training-card dlx-drill-card"
            aria-labelledby="fluencyPacerH"
          >
            <header class="dlx-training-card__head">
              <div>
                <p class="dlx-training-card__kicker">Game · Fluency</p>
                <h3 id="fluencyPacerH">Fluency Pacer</h3>
              </div>
            </header>
            <div class="dlx-training-card__body">
              <p class="muted small">
                Read short sentences with a gentle bar that moves from left to right.
                Focus on expression, punctuation and smooth breathing.
              </p>
              <p class="muted small">
                Choose a pace, start the bar and read aloud in time with the movement.
              </p>

              <div class="dlx-drill-metrics" aria-label="Fluency Pacer stats">
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Sentences</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="fluency-pacer"
                    data-field="sentences"
                  >0</span>
                </div>
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Pace</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="fluency-pacer"
                    data-field="pace"
                  >Medium</span>
                </div>
              </div>

              <div class="dlx-toolbar dlx-toolbar--tight">
                <div class="dlx-field">
                  <label for="fpPhaseSelect" class="dlx-label">Phase</label>
                  <select id="fpPhaseSelect" class="dlx-select" data-fp-phase-select>
                    <option value="all">All phases</option>
                    <option value="Phase 2">Phase 2 – CVC / early sentences</option>
                    <option value="Phase 3">Phase 3 – Digraphs / teams</option>
                    <option value="Phase 5">Phase 5 – Mixed spellings</option>
                  </select>
                </div>

                <button type="button" class="btn btn-ghost" data-fp-play-sound>
                  🔊 Play sentence
                </button>
              </div>

              <p class="dlx-fp-meta muted small">
                <span data-fp-phase-label></span>
                <span data-fp-set-label></span>
                <span data-fp-wpm-target></span>
              </p>

              <p class="dlx-fp-sentence" data-fp-sentence aria-live="polite">
                Tap “Start pacer” to see your first sentence.
              </p>

              <p class="muted x-small dlx-drill-hint">
                The calm reader takes a gentle breath at every full stop.
              </p>

              <div class="dlx-drill-timer">
                <div class="dlx-drill-timer__display" data-game="fluency-pacer" data-field="timer">
                  00s
                </div>
                <div class="dlx-drill-pace-pills" role="radiogroup" aria-label="Fluency pace">
                  <button
                    type="button"
                    class="dlx-pill x-small"
                    data-game="fluency-pacer"
                    data-pace="slow"
                  >
                    Slow
                  </button>
                  <button
                    type="button"
                    class="dlx-pill dlx-pill--active x-small"
                    data-game="fluency-pacer"
                    data-pace="medium"
                  >
                    Medium
                  </button>
                  <button
                    type="button"
                    class="dlx-pill x-small"
                    data-game="fluency-pacer"
                    data-pace="fast"
                  >
                    Fast
                  </button>
                </div>
              </div>

              <div class="dlx-drill-actions">
                <button
                  type="button"
                  class="btn btn-primary"
                  data-game-start="fluency-pacer"
                  data-fp-start
                >
                  ▶ Start pacer
                </button>
                <button
                  type="button"
                  class="btn btn-outline"
                  data-game-next="fluency-pacer"
                  data-fp-next
                >
                  Next sentence
                </button>
              </div>

              <p class="muted x-small dlx-drill-hint">
                Read all the way through, pause for punctuation, then take a calm breath before the
                next sentence.
              </p>

              <div class="dlx-drill-durations">
                <span class="muted x-small">Try a calm block:</span>
                <div class="dlx-drill-durations__buttons">
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game="fluency-pacer"
                    data-game-block="3"
                  >
                    ▶ 3 min
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game="fluency-pacer"
                    data-game-block="5"
                  >
                    ▶ 5 min
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game="fluency-pacer"
                    data-game-block="10"
                  >
                    ▶ 10 min
                  </button>
                </div>
              </div>

              <div class="dlx-drill-footer-links">
                <button
                  type="button"
                  class="btn btn-ghost x-small"
                  data-game-explain="fluency-pacer"
                >
                  🎧 Explain this game
                </button>
                <button
                  type="button"
                  class="btn btn-ghost x-small"
                  data-focus-mode="fluency-pacer"
                >
                  🌙 Focus mode
                </button>
              </div>
            </div>
          </article>

          <!-- Game · Rapid Naming Strip -->
          <article
            id="rapidNamingStripCard"
            class="card dlx-training-card dlx-drill-card"
            aria-labelledby="rapidNamingH"
          >
            <header class="dlx-training-card__head">
              <div>
                <p class="dlx-training-card__kicker">Game · RAN / working memory</p>
                <h3 id="rapidNamingH">Rapid Naming Strip</h3>
              </div>
            </header>
            <div class="dlx-training-card__body">
              <p class="muted small">
                Name colours, symbols or short words from left to right. Aim for a steady rhythm and
                add a calm breath between strips.
              </p>
              <p class="muted small">
                Tap <strong>“New strip”</strong>, then name each item across the band.
                Use the calm timer as a gentle guide.
              </p>

              <div class="dlx-drill-metrics" aria-label="Rapid Naming Strip stats">
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Strips today</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="rapid-strip"
                    data-field="strips"
                  >0</span>
                </div>
                <div class="dlx-drill-metric">
                  <span class="dlx-drill-metric__label small muted">Best calm time</span>
                  <span
                    class="dlx-drill-metric__value"
                    data-game="rapid-strip"
                    data-field="best-time"
                  >—</span>
                </div>
              </div>

              <div class="dlx-drill-timer">
                <div
                  class="dlx-drill-timer__display"
                  data-game="rapid-strip"
                  data-field="timer"
                >
                  00s
                </div>
              </div>

              <div class="dlx-drill-actions dlx-drill-actions--strip">
                <button
                  type="button"
                  class="btn btn-outline"
                  data-strip-new="rapid-strip"
                >
                  🔁 New strip
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  data-game-start="rapid-strip"
                >
                  ▶ Start calm timer
                </button>
                <button
                  type="button"
                  class="btn btn-ghost"
                  data-strip-finished="rapid-strip"
                >
                  ✅ Strip finished
                </button>
              </div>

              <p class="muted x-small dlx-drill-hint">
                When you tap <strong>“Strip finished”</strong>, we log your calm time so you can
                notice how consistent your rhythm feels.
              </p>

              <div class="dlx-drill-durations">
                <span class="muted x-small">Try a calm block:</span>
                <div class="dlx-drill-durations__buttons">
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game="rapid-strip"
                    data-game-block="2"
                  >
                    ▶ 2 min
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game="rapid-strip"
                    data-game-block="4"
                  >
                    ▶ 4 min
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost x-small"
                    data-game="rapid-strip"
                    data-game-block="6"
                  >
                    ▶ 6 min
                  </button>
                </div>
              </div>

              <div class="dlx-drill-footer-links">
                <button
                  type="button"
                  class="btn btn-ghost x-small"
                  data-game-explain="rapid-strip"
                >
                  🎧 Explain this game
                </button>
                <button
                  type="button"
                  class="btn btn-ghost x-small"
                  data-focus-mode="rapid-strip"
                >
                  🌙 Focus mode
                </button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- Short & long vowel studios -->
      <section
        class="dlx-stage3-section dlx-stage3-section--studios"
        aria-labelledby="vowelStudiosH"
      >
        <header class="dlx-stage3-section__head">
          <h3 id="vowelStudiosH">Short and long vowel studios</h3>
          <p class="muted small">
            Three calm studios that turn your phonics teaching sequence into a predictable daily
            playlist. Check off steps as you go and notice how rhythm, not rushing, builds skill.
          </p>
        </header>

        <div class="card dlx-training-card dlx-studio-guide" aria-labelledby="vowelStudiosGuideH">
          <header class="dlx-training-card__head">
            <p class="dlx-training-card__kicker">Playbook</p>
            <h4 id="vowelStudiosGuideH">How this block works &amp; how to level it up</h4>
          </header>
          <div class="dlx-training-card__body muted small">
            <p>
              Each studio uses the same four-step tracker, streak counter and ✅ complete button. Tap a
              step to light it up, pause for breathing whenever needed, then mark the studio complete
              so the next day starts where you left off.
            </p>
            <ul class="dlx-list">
              <li>
                <strong>Connect the dots:</strong> Pair today’s studio with the matching Stage 2 map
                or vowel card so the vocabulary, breathing cue and Dorothy clip all tell the same
                story.
              </li>
              <li>
                <strong>Show evidence easily:</strong> The streak + steps counter doubles as a quick
                log for tutors, families or SEND paperwork—take a screenshot when all four lamps are
                green.
              </li>
              <li>
                <strong>Adjust without chaos:</strong> Need more challenge? Duplicate a step,
                substitute a higher-level text or drop in a calm mini-game between steps 2 and 3
                without rewriting the whole routine.
              </li>
              <li>
                <strong>Spot trends:</strong> If one step keeps getting skipped, turn it into its own
                micro-goal for the week or swap it with a breath tool so the loop stays gentle.
              </li>
            </ul>
          </div>
        </div>

        <div class="dlx-studio-howto muted small" aria-label="How to use the vowel studios">
          <p><strong>How to use these studios:</strong> Pick just one studio (Short, Long or Mixed) per day. If time is tight, choose one or two steps, mark them, and end with a calm reward.</p>
          <p>After each studio, jot a quick Strength note and trigger Scratch &amp; Shine so progress feels visible even on lighter days.</p>
        </div>

        <div class="dlx-stage3-grid dlx-stage3-grid--studios">
          <!-- Studio · Short vowels -->
          <article
            id="shortVowelStudio"
            class="card dlx-training-card dlx-studio-card dlx-studio-panel"
            aria-labelledby="shortVowelStudioH"
            data-studio-key="short"
          >
            <header class="dlx-training-card__head">
              <div>
                <p class="dlx-training-card__kicker">Studio · Short vowels</p>
                <h3 id="shortVowelStudioH">Short Vowel Studio</h3>
              </div>
            </header>
            <div class="dlx-training-card__body">
              <p class="muted small">
                A predictable loop for <strong>/a/ /e/ /i/ /o/ /u/</strong> with pictures,
                mouth cues and quick word building.
              </p>
              <p class="muted small">
                Work through today’s four steps. You can pause between any two steps for a breathing
                break.
              </p>

              <div class="dlx-studio-quickfacts muted small">
                <p>
                  <strong>Total time:</strong> 6–10 minutes · <strong>Built-in calm time:</strong> 1–2
                  minutes of box/coherent breathing.
                </p>
                <p>
                  <strong>You’ll need:</strong> letter tiles or cards, 3–5 short-vowel picture cards,
                  sentence strip template, timer or breathing video.
                </p>
                <p>
                  <strong>Body check:</strong> rate calm vs. wiggles (0–5) before you start. Check
                  again after step 4 to notice shifts.
                </p>
              </div>

              <div class="dlx-studio-metrics" role="group" aria-label="Studio stats">
                <div class="dlx-studio-metric">
                  <span class="dlx-studio-metric__label small muted">Steps today</span>
                  <span
                    class="dlx-studio-metric__value"
                    data-studio="short"
                    data-field="steps"
                    data-studio-steps
                  >0</span>
                  <span class="dlx-studio-metric__suffix muted x-small">of 4</span>
                </div>
                <div class="dlx-studio-metric">
                  <span class="dlx-studio-metric__label small muted">Studio streak</span>
                  <span
                    class="dlx-studio-metric__value"
                    data-studio="short"
                    data-field="streak"
                    data-studio-streak
                  >1</span>
                  <span class="dlx-studio-metric__suffix muted x-small">days</span>
                </div>
              </div>

              <p class="muted x-small dlx-studio-hint">
                Steps today: tap each step chip to toggle it on/off. Progress saves locally so you
                can pick up tomorrow.
              </p>
              <progress class="dlx-studio-progress" value="0" max="4" data-studio-progress></progress>
              <p class="muted x-small" data-studio-progress-label>0/4</p>

              <ol class="dlx-studio-steps">
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="short-step-1">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">1.</span>
                      Hear sounds &amp; air-trace letters
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="short-step-2">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">2.</span>
                      Build 3–5 CVC words with tiles or cards
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="short-step-3">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">3.</span>
                      Read a sentence strip out loud
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="short-step-4">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">4.</span>
                      1-minute box breathing while looking at words
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
              </ol>

              <p class="muted x-small" data-studio-feedback>
                Start with one step only. It is better to do 1–2 strong steps than rush all four.
              </p>

              <div class="dlx-studio-footer">
                <button
                  type="button"
                  class="btn btn-outline btn-block x-small"
                  data-studio-complete-day
                >
                  ✅ Mark today’s short vowel studio complete
                </button>
              </div>

              <p class="muted x-small dlx-studio-tip">
                <strong>Adjust:</strong> Easier → only 2 CVC words plus picture-backed sentence strip.
                Harder → 5–7 CVC words and two sentences, or a short decodable passage.
              </p>
              <p class="muted x-small dlx-studio-tip">
                <strong>Success sign:</strong> learner can explain one short-vowel word in their own
                words and name where the vowel “lives”.
              </p>
            </div>
          </article>

          <!-- Studio · Long vowels -->
          <article
            id="longVowelStudio"
            class="card dlx-training-card dlx-studio-card dlx-studio-panel"
            aria-labelledby="longVowelStudioH"
            data-studio-key="long"
          >
            <header class="dlx-training-card__head">
              <div>
                <p class="dlx-training-card__kicker">Studio · Long vowels</p>
                <h3 id="longVowelStudioH">Long Vowel Studio</h3>
              </div>
            </header>
            <div class="dlx-training-card__body">
              <p class="muted small">
                Turn “magic-e” and vowel teams into a calm routine instead of a guessing game.
              </p>
              <p class="muted small">
                Keep the same four-step rhythm, but swap the stories and word lists to match your
                current pattern.
              </p>

              <div class="dlx-studio-quickfacts muted small">
                <p>
                  <strong>Total time:</strong> 8–12 minutes · <strong>Built-in calm time:</strong>
                  1–3 minutes of breathing and pattern pausing.
                </p>
                <p>
                  <strong>You’ll need:</strong> pattern story card, word cards for today’s pattern,
                  simple sorting mat/columns, timer or breathing app.
                </p>
                <p>
                  <strong>Body check:</strong> rate calm vs. wiggles (0–5) before/after to document
                  self-regulation for SEND or home notes.
                </p>
              </div>

              <div class="dlx-studio-metrics" role="group" aria-label="Studio stats">
                <div class="dlx-studio-metric">
                  <span class="dlx-studio-metric__label small muted">Steps today</span>
                  <span
                    class="dlx-studio-metric__value"
                    data-studio="long"
                    data-field="steps"
                    data-studio-steps
                  >0</span>
                  <span class="dlx-studio-metric__suffix muted x-small">of 4</span>
                </div>
                <div class="dlx-studio-metric">
                  <span class="dlx-studio-metric__label small muted">Studio streak</span>
                  <span
                    class="dlx-studio-metric__value"
                    data-studio="long"
                    data-field="streak"
                    data-studio-streak
                  >1</span>
                  <span class="dlx-studio-metric__suffix muted x-small">days</span>
                </div>
              </div>

              <p class="muted x-small dlx-studio-hint">
                Steps today: tap each step chip to toggle it. When all four glow, take one deep
                breath in, one slow breath out, then Scratch &amp; Shine.
              </p>
              <progress class="dlx-studio-progress" value="0" max="4" data-studio-progress></progress>
              <p class="muted x-small" data-studio-progress-label>0/4</p>

              <ol class="dlx-studio-steps">
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="long-step-1">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">1.</span>
                      Review the pattern story (magic-e / team / r-controlled)
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="long-step-2">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">2.</span>
                      Sort 6–10 words into the correct pattern column
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="long-step-3">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">3.</span>
                      Read 2–3 connected sentences that use today’s pattern
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="long-step-4">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">4.</span>
                      Ask: “Where did this vowel live?” after each tricky word
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
              </ol>

              <p class="muted x-small" data-studio-feedback>
                Tap each step as you complete it with your chosen long vowel pattern for today.
              </p>

              <div class="dlx-studio-footer">
                <button
                  type="button"
                  class="btn btn-outline btn-block x-small"
                  data-studio-complete-day
                >
                  ✅ Mark today’s long vowel studio complete
                </button>
              </div>

              <p class="muted x-small dlx-studio-tip">
                <strong>Adjust:</strong> Easier → only compare two columns (e.g., magic-e vs. team).
                Harder → add odd-one-out spellings or a “prove it” word that breaks the rule.
              </p>
              <p class="muted x-small dlx-studio-tip">
                <strong>Success sign:</strong> learner can explain a vowel team/magic-e example and
                spot at least one pattern in connected text.
              </p>
            </div>
          </article>

          <!-- Studio · Mixed review -->
          <article
            id="mixedVowelStudio"
            class="card dlx-training-card dlx-studio-card dlx-studio-panel"
            aria-labelledby="mixedVowelStudioH"
            data-studio-key="mixed"
          >
            <header class="dlx-training-card__head">
              <div>
                <p class="dlx-training-card__kicker">Studio · Mixed review</p>
                <h3 id="mixedVowelStudioH">Mixed Vowel Studio</h3>
              </div>
            </header>
            <div class="dlx-training-card__body">
              <p class="muted small">
                Combine short, long and r-controlled vowels in one calm review, ready for assessments
                and real-world text.
              </p>
              <p class="muted small">
                Use this once or twice a week only — it is a check-up studio to see what has really
                stuck.
              </p>

              <div class="dlx-studio-quickfacts muted small">
                <p>
                  <strong>Total time:</strong> 10–15 minutes (once or twice a week) ·
                  <strong>Built-in calm time:</strong> 2–3 minutes of paced breathing inside steps 1
                  and 3.
                </p>
                <p>
                  <strong>You’ll need:</strong> mixed word cards/list, sentence or short paragraph,
                  reward token or Scratch &amp; Shine, timer or calm audio.
                </p>
                <p>
                  <strong>Body check:</strong> record a quick 0–5 calm score before/after to show how
                  review impacts regulation.
                </p>
              </div>

              <div class="dlx-studio-metrics" role="group" aria-label="Studio stats">
                <div class="dlx-studio-metric">
                  <span class="dlx-studio-metric__label small muted">Steps today</span>
                  <span
                    class="dlx-studio-metric__value"
                    data-studio="mixed"
                    data-field="steps"
                    data-studio-steps
                  >0</span>
                  <span class="dlx-studio-metric__suffix muted x-small">of 4</span>
                </div>
                <div class="dlx-studio-metric">
                  <span class="dlx-studio-metric__label small muted">Studio streak</span>
                  <span
                    class="dlx-studio-metric__value"
                    data-studio="mixed"
                    data-field="streak"
                    data-studio-streak
                  >1</span>
                  <span class="dlx-studio-metric__suffix muted x-small">days</span>
                </div>
              </div>

              <p class="muted x-small dlx-studio-hint">
                Steps today: pick a tiny set of mixed words + sentences, then tap each chip when
                you’ve finished that layer.
              </p>
              <progress class="dlx-studio-progress" value="0" max="4" data-studio-progress></progress>
              <p class="muted x-small" data-studio-progress-label>0/4</p>

              <ol class="dlx-studio-steps">
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="mixed-step-1">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">1.</span>
                      Warm-up: 6–8 mixed words on cards or screen
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="mixed-step-2">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">2.</span>
                      Spot and label the vowel pattern in each word
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="mixed-step-3">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">3.</span>
                      Read a short paragraph with two calm breaths built in
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dlx-step-chip" data-step-id="mixed-step-4">
                    <span class="dlx-step-chip-label">
                      <span class="dlx-step-chip-index">4.</span>
                      Scratch &amp; Shine or other small reward moment
                    </span>
                    <span class="dlx-step-chip-status">Not done</span>
                  </button>
                </li>
              </ol>

              <p class="muted x-small" data-studio-feedback>
                Pick a small set of mixed words and sentences. Use the same four steps to keep it
                familiar.
              </p>

              <div class="dlx-studio-footer">
                <button
                  type="button"
                  class="btn btn-outline btn-block x-small"
                  data-studio-complete-day
                >
                  ✅ Mark mixed review studio complete
                </button>
              </div>

              <p class="muted x-small dlx-studio-tip">
                <strong>Adjust:</strong> Easier → 4–5 highly controlled words + short, picture-supported
                paragraph. Harder → use a slightly less controlled paragraph closer to the learner’s
                real reading book.
              </p>
              <p class="muted x-small dlx-studio-tip">
                <strong>Success sign:</strong> learner can label at least one tricky vowel pattern and
                link it to a calm breath strategy.
              </p>
            </div>
          </article>
        </div>
      </section>

      <!-- Placeholder for future mini games / calm boosters strip -->
      <section class="dlx-stage3-minigames" aria-label="Mini games calm boosters">
        <p class="muted x-small">
          <strong>Mini games · calm boosters</strong> — small, light-touch games that can be dropped
          between drills to reset attention without adding extra load.
        </p>
      </section>
    </section>

    <section id="dlxGlowRewards" class="dlx-section" aria-labelledby="dlxGlowRewardsH">
      <header class="dlx-section__head">
        <h2 id="dlxGlowRewardsH">Scratch &amp; Shine + calm streaks</h2>
        <p class="muted">Motivation without shame. Rewards highlight effort, strategy and self-trust.</p>
      </header>
      <div class="dlx-grid dlx-grid--2">
        <article class="card dlx-reward-card" id="dlxGlowCard">
          <h3>Glow-Up scratch card</h3>
          <p class="muted">Completing a focus session unlocks a gentle message. Tap to reveal and screenshot if you want to share.</p>
          <p class="muted small"><strong>Message ideas:</strong></p>
          <ul class="dlx-list small">
            <li><strong>Effort:</strong> “You stuck with it even when it felt tricky.”</li>
            <li><strong>Strategy:</strong> “You used the pattern story to help you.”</li>
            <li><strong>Self-trust:</strong> “You trusted your mouth and ears more than guessing.”</li>
          </ul>
          <p class="muted small">Keep messages to 1–2 sentences. Describe what the learner did, not who they are, so the praise feels doable again tomorrow.</p>
          <button type="button" class="btn btn-success" id="dlxScratchBtn" disabled>Scratch card unlocks after your next session</button>
          <p class="small muted" id="dlxScratchHint">Complete any quest or mini game to unlock.</p>
        </article>
        <article class="card dlx-reward-card">
          <h3>Healthy reward stack</h3>
          <ul class="dlx-list">
            <li><strong>Calm streaks:</strong> earn badges for any day you complete at least one studio step. Missing a day does not reset progress—we just pause and restart the next calm streak when you’re ready.</li>
            <li><strong>Quiet cheer stats:</strong> track total calm minutes this week plus how many sessions were short vs. long vs. mixed. Stats stay private unless you choose to share.</li>
            <li><strong>Strength notes:</strong> jot one line such as “One thing that helped me today: I traced the vowel before reading.”</li>
            <li><strong>Circle of support:</strong> share a quick summary for families, SENCos or therapists—e.g., “Maya completed 3 calm short-vowel studios this week and is spotting magic-e in home books.”</li>
          </ul>
        </article>
      </div>
    </section>

    <section id="dlxStage4" class="dlx-section" aria-labelledby="dlxStage4H">
      <header class="dlx-section__head">
        <h2 id="dlxStage4H">Stage 4 · Support &amp; rights (UK + US)</h2>
        <p class="muted">Pair calm practice with the adjustments you are legally entitled to.</p>
      </header>
      <div class="dlx-grid dlx-grid--2">
        <article class="card dlx-training-card">
          <header class="dlx-training-card__head">
            <p class="dlx-training-card__kicker">UK</p>
            <h3>Key adjustments &amp; routes</h3>
          </header>
          <div class="dlx-training-card__body">
            <ul class="dlx-list">
              <li><strong>Equality Act 2010:</strong> reasonable adjustments in school, college, work.</li>
              <li>SEND support · EHCPs · Disabled Students Allowance.</li>
              <li>Assistive tech: text-to-speech, speech-to-text, scanning pens.</li>
              <li>Extra time, rest breaks, alternative formats, calm rooms.</li>
            </ul>
            <a class="btn btn-outline" href="https://www.bdadyslexia.org.uk/" target="_blank" rel="noopener">British Dyslexia Association</a>
          </div>
        </article>
        <article class="card dlx-training-card">
          <header class="dlx-training-card__head">
            <p class="dlx-training-card__kicker">US</p>
            <h3>Rights &amp; advocacy</h3>
          </header>
          <div class="dlx-training-card__body">
            <ul class="dlx-list">
              <li><strong>IDEA &amp; Section 504:</strong> IEPs, 504 plans, accommodations.</li>
              <li>ADA in college/work: assistive tech, extended time, quiet rooms.</li>
              <li>Document needs with recent evaluations; highlight strengths.</li>
              <li>Use calm breaks during exams — breath tools count.</li>
            </ul>
            <a class="btn btn-outline" href="https://dyslexiaida.org/" target="_blank" rel="noopener">International Dyslexia Association</a>
          </div>
        </article>
      </div>
    </section>

    <section id="dlxResourceHub" class="dlx-section" aria-labelledby="dlxResourceHubH">
      <header class="dlx-section__head">
        <h2 id="dlxResourceHubH">Stage 5 · Resource stack &amp; downloads</h2>
        <p class="muted">Save, download and share without digging across tabs.</p>
      </header>
      <div class="dlx-grid dlx-grid--2">
        <article class="card">
          <h3>Trusted UK + US organisations</h3>
          <ul class="dlx-list">
            <li>British Dyslexia Association · Dyslexia Scotland · NHS.</li>
            <li>International Dyslexia Association · Yale Center for Dyslexia &amp; Creativity.</li>
            <li>Reading Rockets · Understood.org · National Center on Improving Literacy.</li>
            <li>Local SENDIASS / Parent Training &amp; Information Centers.</li>
          </ul>
        </article>
        <article class="card">
          <h3>Downloads</h3>
          <ul class="dlx-list">
            <li><a href="assets/downloads/dyslexia-reading-checklist.pdf" download>Reading friction checklist (PDF)</a></li>
            <li><a href="assets/downloads/dyslexia-routine-planner.pdf" download>Routine planner (PDF)</a></li>
            <li><button type="button" class="btn btn-outline" id="downloadResourcesPdf">Download adult support pack</button></li>
          </ul>
          <p class="muted small">Downloads are lightweight and print-ready.</p>
        </article>
      </div>
    </section>

    <section id="dlxResearchSources" class="dlx-section" aria-labelledby="dlxResearchH">
      <header class="dlx-section__head">
        <h2 id="dlxResearchH">Research and expert guidance informing this page</h2>
        <p class="muted">Educational information only — always pair with personal assessment and professional advice.</p>
      </header>
      <div class="dlx-grid dlx-grid--2">
        <article class="card">
          <h3>Structured literacy &amp; dyslexia science</h3>
          <ul class="dlx-list">
            <li>British Dyslexia Association · Dyslexia Action · Dyslexia Scotland.</li>
            <li>Reading Rockets · National Center on Improving Literacy.</li>
            <li>Yale Center for Dyslexia &amp; Creativity (strengths-based research).</li>
            <li>Understood.org — executive function + emotional wellbeing.</li>
          </ul>
        </article>
        <article class="card">
          <h3>Legal frameworks &amp; adjustments</h3>
          <ul class="dlx-list">
            <li>UK Equality Act 2010 · SEND Code of Practice · Disabled Students Allowance guidance.</li>
            <li>US IDEA, Section 504, Americans with Disabilities Act.</li>
            <li>Assistive technology: text-to-speech, speech-to-text, scanning pens.</li>
            <li>Anxiety regulation: breath tools are adjuncts, not replacements for teaching.</li>
          </ul>
        </article>
      </div>
      <p class="muted small">In a crisis or safeguarding emergency seek local emergency help immediately.</p>
    </section>

    <!-- Certificate / badge panel (opens when a reward chip is clicked) -->
    <div id="dlxCertBackdrop" class="dlx-cert-backdrop" hidden></div>

    <section
      id="dlxCertPanel"
      class="dlx-cert-panel"
      role="dialog"
      aria-modal="true"
      aria-labelledby="dlxCertTitle"
      hidden>
      <header class="dlx-cert-header">
        <div>
          <h3 id="dlxCertTitle" class="dlx-cert-title">
            Celebration certificate
            <span data-cert-badge></span>
          </h3>
          <p class="dlx-cert-tagline" data-cert-tagline>
            You have unlocked a new NeuroBreath reading milestone. Add a name and print a
            certificate to celebrate effort, not perfection.
          </p>
        </div>
        <button
          type="button"
          class="dlx-cert-close-btn"
          data-cert-close
          aria-label="Close certificate panel">
          ✕
        </button>
      </header>

      <form class="dlx-cert-form" onsubmit="return false;">
        <div class="dlx-cert-field">
          <label for="dlxCertNameInput">Learner name</label>
          <input
            id="dlxCertNameInput"
            type="text"
            autocomplete="name"
            placeholder="First name or nickname" />
        </div>
        <div class="dlx-cert-field">
          <label for="dlxCertAdultInput">Signed by</label>
          <input
            id="dlxCertAdultInput"
            type="text"
            autocomplete="organization-title"
            placeholder="Parent, carer or teacher" />
        </div>
        <div class="dlx-cert-field">
          <label for="dlxCertDateInput">Date</label>
          <input id="dlxCertDateInput" type="date" />
        </div>
      </form>

      <div class="dlx-cert-preview dlx-cert-printable" id="dlxCertPrintable">
        <div class="dlx-cert-preview-heading">NeuroBreath · Reading Celebration</div>
        <div class="dlx-cert-preview-badge" data-cert-badge-line>Milestone badge</div>
        <div class="dlx-cert-preview-name">
          Awarded to <span data-cert-name>Your learner</span>
        </div>
        <p class="dlx-cert-preview-body">
          For steady, focused effort in this reading milestone. This certificate marks effort,
          not perfection – every small step counts.
        </p>
        <div class="dlx-cert-preview-meta">
          <span data-cert-signed-line>Signed: Coach / Teacher</span>
          <span>Date: <span data-cert-date></span></span>
        </div>
      </div>

      <div class="dlx-cert-actions">
        <button type="button" id="dlxCertPrintBtn" class="dlx-cert-btn-primary">
          Print / Save as PDF
        </button>
        <button type="button" id="dlxCertOpenFullBtn" class="dlx-cert-btn-ghost" hidden>
          Open full certificate generator
        </button>
      </div>
    </section>
  </main>

  <!-- Quick Start Breathing Technique Dialog -->
  <div id="quickStartDialog" class="modal-overlay home-modal-overlay">
    <div tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="quick-start-technique-title" aria-describedby="quick-start-technique-desc" class="card modal-card card-share-theme home-modal-card">
      <p class="quick-start-lede">Start 1–3 minute quick warm-up</p>
      <header class="modal-header">
        <h3 id="quick-start-technique-title">Choose a breathing technique</h3>
        <button type="button" class="btn-close" id="closeQuickStart" aria-label="Close dialog">&times;</button>
      </header>

      <!-- Instruction narration controls -->
      <section class="modal-voice-card" aria-label="Instruction narration controls">
        <div class="modal-voice-card__header">
          <span class="voice-icon" aria-hidden="true" title="Voice narration">🎧</span>
          <div>
            <p class="modal-voice-card__eyebrow">Narration voice</p>
            <p class="modal-voice-card__title">Choose narration voice</p>
          </div>
        </div>
        <div class="modal-voice-controls">
          <label class="sr-only" for="quick-voice-gender">Choose narration voice</label>
          <select id="quick-voice-gender" class="btn voice-select" aria-label="Choose narration voice">
            <option value="uk-male" selected>British male</option>
            <option value="female">British female</option>
          </select>
          <button type="button" class="btn" id="quickTtsStart">Read instructions</button>
          <button type="button" class="btn" id="quickTtsStop" aria-label="Stop narration">Stop</button>
          <button type="button" class="btn" id="quickTtsTest" aria-label="Test narration voice">Voice test</button>
        </div>
        <p id="quick-voice-status" class="muted voice-status">Google UK English Voice • en-GB (simulated)</p>
      </section>

      <p id="quick-start-technique-desc" class="muted modal-desc">Pick a warm‑up technique and duration. We will start your session with voice guidance.</p>

      <section class="quick-start-next" aria-label="Recommended training sequence">
        <p class="quick-start-next__lede">Next steps after your calm reset</p>
        <ol class="quick-start-next__list">
          <li class="quick-start-next__item">
            <p class="quick-start-next__label">State 1 · Ready the nervous system</p>
            <a class="quick-start-next__btn" href="#dlxStage1">Go to Stage 1 – Calm warm-ups</a>
          </li>
          <li class="quick-start-next__item">
            <p class="quick-start-next__label">State 2 · Map the sounds + routines</p>
            <a class="quick-start-next__btn" href="#dlxStage2">Open Stage 2 – Skill maps</a>
          </li>
          <li class="quick-start-next__item">
            <p class="quick-start-next__label">State 3 · Launch the focus mission</p>
            <a class="quick-start-next__btn" href="#dlxStage3">Jump to Stage 3 – Training labs</a>
          </li>
        </ol>
      </section>

      <div class="technique-options" role="group" aria-label="Breathing techniques">
        <button type="button" class="btn technique-option" data-tech-option="box" aria-pressed="false">
          <span class="technique-option__icon" aria-hidden="true">🟩</span>
          <span class="technique-option__copy">
            <strong>Box breathing</strong>
            <small>Equal 4-4-4-4 pacing</small>
          </span>
        </button>

        <button type="button" class="btn technique-option selected" data-tech-option="478" aria-pressed="true">
          <span class="technique-option__icon" aria-hidden="true">🟨</span>
          <span class="technique-option__copy">
            <strong>4‑7‑8 breathing</strong>
            <small>Slow exhale wind-down</small>
          </span>
          <span class="badge selected-badge">Selected</span>
        </button>

        <button type="button" class="btn technique-option" data-tech-option="coherent" aria-pressed="false">
          <span class="technique-option__icon" aria-hidden="true">🟪</span>
          <span class="technique-option__copy">
            <strong>Coherent 5‑5</strong>
            <small>HRV-friendly resonance</small>
          </span>
        </button>

        <button type="button" class="btn technique-option" data-tech-option="sos" aria-pressed="false">
          <span class="technique-option__icon" aria-hidden="true">🆘</span>
          <span class="technique-option__copy">
            <strong>60‑second SOS</strong>
            <small>Rapid calm cue</small>
          </span>
        </button>
      </div>

      <!-- Duration selector -->
      <div class="duration-selector card-share-theme" role="group" aria-label="Session duration">
        <div class="duration-label-group">
          <label for="session-duration" class="duration-label">Session duration</label>
          <p class="duration-subtext">Tap a timing that feels doable today.</p>
        </div>
        <div class="duration-buttons">
          <button type="button" class="btn duration-btn selected" data-duration="1" aria-pressed="true">1 min</button>
          <button type="button" class="btn duration-btn" data-duration="2" aria-pressed="false">2 min</button>
          <button type="button" class="btn duration-btn" data-duration="3" aria-pressed="false">3 min</button>
          <button type="button" class="btn duration-btn" data-duration="4" aria-pressed="false">4 min</button>
          <button type="button" class="btn duration-btn" data-duration="5" aria-pressed="false">5 min</button>
        </div>
      </div>

      <!-- Breathing visualization area (hidden initially) -->
      <div id="breathing-session-area" class="breathing-session-area hidden">
        <div class="breathing-viz-container">
          <svg id="breathing-viz" viewBox="-110 -110 220 220" width="100%" height="100%"></svg>
        </div>
        <div class="breathing-controls-panel">
          <p id="breathing-phase-label" class="phase-label">Ready</p>
          <progress id="breathing-progress" max="1" value="0" class="breathing-progress"></progress>
          <div id="breathing-legend" class="breathing-legend"></div>
        </div>
      </div>

      <div class="actions modal-actions">
        <button type="button" class="btn" id="cancelQuickStart" aria-label="Cancel">Cancel</button>
        <button type="button" class="btn cta" id="confirmQuickStart">Start breathing</button>
        <button type="button" class="btn hidden" id="breathing-restart">Restart</button>
        <button type="button" class="btn btn-ok hidden" id="breathing-toggle">Pause</button>
        <button type="button" class="btn btn-danger hidden" id="breathing-stop">Stop</button>
      </div>
    </div>
  </div>

  <section id="dlxSongScreen" class="dlx-focus-screen dlx-song-screen" aria-live="polite" hidden>
    <div class="dlx-focus-screen__backdrop" data-song-close></div>
    <div class="dlx-song-panel" role="dialog" aria-modal="true" aria-labelledby="dlxSongTitle">
      <header class="dlx-song-panel__head">
        <p class="dlx-kicker">Phonics focus</p>
        <h3 id="dlxSongTitle">A–Z Phonics Sound Song</h3>
        <p id="dlxSongSubtitle" class="muted">Coach Dorothy talks around 105 BPM. Watch the letters pulse as you recite.</p>
      </header>
      <div class="dlx-song-visual" aria-live="polite">
        <div class="dlx-song-letter-card" id="dlxSongLetterCard">
          <span class="dlx-song-letter" id="dlxSongLetter">A</span>
          <span class="dlx-song-icon" id="dlxSongIcon">🍎</span>
          <p class="dlx-song-word" id="dlxSongWord">apple</p>
        </div>
        <p class="dlx-song-lyric" id="dlxSongLyric">Let’s sing the sounds that letters make. Ready? Here we go!</p>
      </div>
      <div class="dlx-song-wave" id="dlxSongWave" aria-hidden="true"></div>
      <div class="dlx-song-controls">
        <div class="dlx-song-progress">
          <input type="range" min="0" max="1000" value="0" id="dlxSongProgress" aria-label="Phonics song progress">
          <span id="dlxSongTime">00:00</span>
        </div>
        <div class="dlx-song-actions">
          <button type="button" class="btn btn-primary" id="dlxSongStart">Start</button>
          <button type="button" class="btn" id="dlxSongPause">Pause</button>
          <button type="button" class="btn btn-ghost" id="dlxSongRestart">↺ Restart</button>
          <button type="button" class="btn btn-ghost" id="dlxSongClose" data-song-close>Close</button>
        </div>
      </div>
      <audio id="dlxPhonicsAudio" preload="auto" src="assets/tts/eleven-labs-phonics-alphabet-sounds-dorothy.mp3"></audio>
    </div>
  </section>

  <section id="dlxLetterSoundScreen" class="dlx-focus-screen dlx-letter-sound-screen" aria-live="polite" hidden>
    <div class="dlx-focus-screen__backdrop" data-letter-sound-close></div>
    <div class="dlx-letter-sound-panel" role="dialog" aria-modal="true" aria-labelledby="dlxLetterSoundTitle">
      <div class="dlx-letter-sound-lights" aria-hidden="true">
        <span data-light="gold"></span>
        <span data-light="rose"></span>
        <span data-light="aqua"></span>
        <span data-light="violet"></span>
      </div>
      <div class="dlx-letter-sound-confetti" aria-hidden="true">
        <div class="dlx-letter-sound-confetti__layer" data-speed="base"></div>
        <div class="dlx-letter-sound-confetti__layer" data-speed="slow"></div>
        <div class="dlx-letter-sound-confetti__layer" data-speed="sparkle"></div>
        <div class="dlx-letter-sound-confetti__ribbons">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="dlx-letter-sound-confetti__shapes">
          <span data-shape="star"></span>
          <span data-shape="star"></span>
          <span data-shape="diamond"></span>
          <span data-shape="diamond"></span>
          <span data-shape="spark"></span>
          <span data-shape="spark"></span>
        </div>
      </div>
      <div class="dlx-letter-sound-buzz" id="dlxLetterSoundBuzz" aria-live="assertive" hidden>
        <div class="dlx-letter-sound-buzz__rays" aria-hidden="true"></div>
        <div class="dlx-letter-sound-buzz__content">
          <p class="dlx-letter-sound-buzz__label" id="dlxLetterSoundBuzzLabel">Golden Buzz</p>
          <p class="dlx-letter-sound-buzz__message"><span id="dlxLetterSoundBuzzLetter">Z / z</span><br><span id="dlxLetterSoundBuzzWord" aria-hidden="true">🦓 zebra</span></p>
          <p class="dlx-letter-sound-buzz__tip" id="dlxLetterSoundBuzzTip">Keep lips relaxed and repeat the phoneme twice with steady airflow.</p>
          <div class="dlx-letter-sound-buzz__controls">
            <div class="dlx-letter-sound-buzz__clock dlx-letter-sound-celebration__clock" id="dlxLetterSoundCelebrationClock" aria-hidden="true">
              <div class="dlx-letter-sound-celebration__clock-ring">
                <span class="dlx-letter-sound-celebration__clock-value" id="dlxLetterSoundCelebrationClockValue">40</span>
              </div>
            </div>
            <div class="dlx-letter-sound-buzz__cta">
              <p class="dlx-letter-sound-buzz__prompt">Do you want to continue learning?</p>
              <p class="dlx-letter-sound-celebration__timer" id="dlxLetterSoundCelebrationTimer" aria-live="polite">Celebration spotlight warming up…</p>
              <button type="button" class="btn btn-success" id="dlxLetterSoundContinue">Continue learning</button>
            </div>
          </div>
        </div>
      </div>
      <div class="dlx-letter-sound-overview">
        <header class="dlx-letter-sound-head">
          <p class="dlx-kicker">Phoneme studio</p>
          <h3 id="dlxLetterSoundTitle">Phonics Sounds · Letters Only</h3>
          <p class="muted" id="dlxLetterSoundSubtitle">Watch the mouth shapes while Coach Dorothy speaks every letter sound.</p>
        </header>
        <div class="dlx-letter-sound-actions" aria-label="Letter sound controls">
          <button type="button" class="btn btn-primary" id="dlxLetterSoundStart">Start</button>
          <button type="button" class="btn" id="dlxLetterSoundPause">Pause</button>
          <button type="button" class="btn btn-outline" id="dlxLetterSoundRandomHead">Shuffle head</button>
          <button type="button" class="btn btn-ghost" id="dlxLetterSoundRestart">↺ Restart</button>
          <button type="button" class="btn btn-ghost" id="dlxLetterSoundClose" data-letter-sound-close>Close</button>
        </div>
      </div>
      <div class="dlx-letter-sound-body">
        <div class="dlx-letter-sound-layout">
          <div class="dlx-letter-sound-layout__left">
            <div class="dlx-mouth-stage" aria-live="polite">
              <div class="dlx-mouth-head" id="dlxMouthHead" data-variant="sunrise" data-mouth-shape="open-round" aria-hidden="true">
                <span class="dlx-mouth-eyes" aria-hidden="true"></span>
                <span class="dlx-mouth-mouth" aria-hidden="true"></span>
                <span class="dlx-mouth-accessory" id="dlxMouthAccessory" aria-hidden="true">⭐</span>
              </div>
              <div class="dlx-mouth-info">
                <p class="dlx-mouth-letter" id="dlxMouthLetter">A</p>
                <p class="dlx-mouth-word" id="dlxMouthWord">apple</p>
                <p class="dlx-mouth-tip" id="dlxMouthTip">Relax the jaw for short /ă/.</p>
              </div>
            </div>
            <div class="dlx-letter-sound-progress">
              <input type="range" min="0" max="1000" value="0" id="dlxLetterSoundProgress" aria-label="Letter sound progress">
              <span id="dlxLetterSoundTime">00:00</span>
            </div>
          </div>
          <div class="dlx-letter-sound-layout__right">
            <div class="dlx-letter-sound-grid" id="dlxLetterSoundGrid" aria-label="Tap any letter to jump to its mouth-shape demo"></div>
          </div>
        </div>
        <div class="dlx-letter-sound-celebration" id="dlxLetterSoundCelebration" aria-live="assertive" hidden>
          <div class="dlx-letter-sound-celebration__halo" aria-hidden="true"></div>
          <div class="dlx-letter-sound-celebration__content" id="dlxLetterSoundCelebrationContent">
            <p class="dlx-letter-sound-celebration__medal" id="dlxLetterSoundMedal" hidden></p>
            <div class="dlx-letter-sound-celebration__message">
              <p class="dlx-letter-sound-celebration__title" id="dlxLetterSoundCelebrationTitle">Golden Buzz achieved!</p>
              <p class="dlx-letter-sound-celebration__body" id="dlxLetterSoundCelebrationBody">Outstanding achievement! You have now mastered all the phonemes and accurately matched every mouth cue. Your dedication, focus, and practice have truly paid off. This is a powerful step forward in your learning journey — well done. A well-deserved round of applause for you! 👏👏👏</p>
            </div>
            <div class="dlx-letter-sound-celebration__certificate" id="dlxLetterSoundCertificate" hidden>
              <p class="dlx-letter-sound-celebration__certificate-prompt" id="dlxLetterSoundCertificatePrompt">Platinum spotlight complete — enter the learner name (required) plus any optional details to personalize their official NeuroBreath certificate.</p>
              <div class="dlx-letter-sound-certificate-shell">
                <form class="dlx-letter-sound-certificate-form" id="dlxLetterSoundCertificateForm">
                  <label>
                    <span>Full name<span class="sr-only"> (required)</span></span>
                    <input type="text" name="certificateName" id="dlxCertificateNameInput" required minlength="2" autocomplete="name" placeholder="e.g. Maya Solanke" />
                  </label>
                  <label>
                    <span>Gender <small>(optional)</small></span>
                    <select name="certificateGender" id="dlxCertificateGenderInput">
                      <option value="Prefer not to say" selected>Prefer not to say</option>
                      <option value="Female">Female</option>
                      <option value="Male">Male</option>
                      <option value="Non-binary">Non-binary</option>
                    </select>
                  </label>
                  <label>
                    <span>Age <small>(optional)</small></span>
                    <input type="number" name="certificateAge" id="dlxCertificateAgeInput" min="3" max="120" inputmode="numeric" placeholder="10" />
                  </label>
                  <label>
                    <span>Faith tradition <small>(optional)</small></span>
                    <input type="text" name="certificateReligion" id="dlxCertificateReligionInput" minlength="2" placeholder="e.g. Christianity" />
                  </label>
                  <p class="dlx-letter-sound-certificate-note">Only the official NeuroBreath details and the learner’s name appear on the certificate. Optional fields guide the tone of the award.</p>
                  <p class="dlx-letter-sound-certificate-buffer" id="dlxCertificateBufferNote">Print note: the certificate keeps a clamp(32px,10vh,120px) top/bottom buffer so PDF exports never crop the border.</p>
                  <button type="submit" class="btn btn-primary">Design certificate</button>
                </form>
                <div class="dlx-letter-sound-certificate-preview" id="dlxLetterSoundCertificatePreview" hidden>
                  <article class="dlx-certificate-card" aria-label="Printable NeuroBreath Academy certificate">
                    <div class="dlx-certificate-brand" aria-hidden="true">
                      <span class="dlx-certificate-logo">NB</span>
                      <p class="dlx-certificate-issuer">NeuroBreath Academy</p>
                    </div>
                    <header>
                      <p class="dlx-certificate-title" id="dlxCertificateTitle">Platinum Letter Sound Mastery</p>
                      <h4 class="dlx-certificate-name" id="dlxCertificateAwardee">Learner Name</h4>
                      <p class="dlx-certificate-medal" id="dlxCertificateMedal">Calm Focus Laureate</p>
                    </header>
                    <p class="dlx-certificate-message" id="dlxCertificateMessage">This certifies that the learner completed the full phoneme circuit with Platinum mastery.</p>
                    <ul class="dlx-certificate-meta">
                      <li>
                        <span>Certificate ID</span>
                        <strong id="dlxCertificateId">NB-00000</strong>
                      </li>
                      <li>
                        <span>Issued</span>
                        <strong id="dlxCertificateIssued">—</strong>
                      </li>
                      <li>
                        <span>Awarded By</span>
                        <strong>NeuroBreath Lead Faculty</strong>
                      </li>
                    </ul>
                  </article>
                  <div class="dlx-letter-sound-certificate-actions">
                    <button type="button" class="btn btn-success" id="dlxCertificatePrintBtn">🖨️ Print certificate</button>
                    <button type="button" class="btn btn-ghost" id="dlxCertificateEditBtn">✏️ Edit details</button>
                  </div>
                  <div class="dlx-letter-sound-nav" aria-label="Certificate navigation">
                    <button type="button" class="btn btn-outline" id="dlxCertificateBackToHub" data-letter-sound-close>← Back to Dyslexia hub</button>
                    <a class="btn btn-ghost" id="dlxCertificateHomeLink" href="index.html">🏠 NeuroBreath home</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <audio id="dlxLetterSoundAudio" preload="auto" src="assets/tts/letters-sounds-only-eleven-labs-phonics-alphabet-sounds-dorothy.mp3"></audio>
      <audio id="dlxVowelAudio" preload="auto" src="assets/tts/dorothy-vowels-join.wav"></audio>
    </div>
  </section>

  <section id="dlxSoundQuestScreen" class="dlx-focus-screen" aria-live="polite" hidden>
    <div class="dlx-focus-screen__backdrop" data-soundquest-close></div>
    <div class="dlx-focus-panel dlx-soundquest-panel" role="dialog" aria-modal="true" aria-labelledby="dlxSoundQuestTitle">
      <header class="dlx-focus-panel__head">
        <p class="dlx-kicker">Sound Memory Quest</p>
        <div class="dlx-soundquest-headline">
          <h3 id="dlxSoundQuestTitle">Genius memory lab</h3>
          <span id="dlxSoundQuestLevel">Level 0 / 26</span>
        </div>
      </header>
      <div class="dlx-soundquest-body">
        <div class="dlx-soundquest-progress">
          <progress id="dlxSoundQuestProgress" max="26" value="0"></progress>
          <p class="muted" id="dlxSoundQuestStatus">Tap play to unlock your first mnemonic.</p>
        </div>
        <div class="dlx-memory-card" id="dlxMemoryCard">
          <div class="dlx-memory-emoji" id="dlxMemoryEmoji">🔤</div>
          <div class="dlx-memory-letter" id="dlxMemoryLetter">Upper / lower</div>
          <p class="dlx-memory-clue" id="dlxMemoryClue">Press play to see the genius image + clue pairing.</p>
        </div>
        <div class="dlx-soundquest-timer">
          <progress id="dlxSoundQuestTimerBar" max="18" value="0"></progress>
          <span id="dlxSoundQuestTimer">00s</span>
        </div>
        <div class="dlx-soundquest-actions">
          <button type="button" class="btn btn-success" id="dlxSoundQuestPlay">Play</button>
          <button type="button" class="btn btn-outline" id="dlxSoundQuestPause">Pause</button>
          <button type="button" class="btn btn-outline" id="dlxSoundQuestStop">Stop</button>
          <button type="button" class="btn btn-outline" id="dlxSoundQuestReset">Reset</button>
          <button type="button" class="btn btn-ghost" id="dlxSoundQuestClose" data-soundquest-close>Back to hub</button>
        </div>
        <div class="dlx-soundquest-cta">
          <button type="button" class="btn btn-primary" id="dlxSoundQuestLock">I locked this sound</button>
          <button type="button" class="btn btn-ghost" id="dlxSoundQuestSkip">Show new clue</button>
        </div>
        <p class="muted small" id="dlxSoundQuestReward">Every level gives a tailored reward once you lock the sound.</p>
      </div>
    </div>
  </section>

  <section id="dlxScratchModal" class="dlx-scratch-modal" hidden>
    <div class="dlx-scratch-modal__backdrop" data-scratch-close></div>
    <div class="dlx-scratch-modal__panel" role="dialog" aria-modal="true" aria-labelledby="dlxScratchTitle">
      <h3 id="dlxScratchTitle">Scratch &amp; Shine</h3>
      <div class="dlx-scratch-award" id="dlxScratchAward">
        <div class="dlx-scratch-award__crest" id="dlxScratchBadgeCrest">🌟</div>
        <div class="dlx-scratch-award__copy">
          <p class="dlx-scratch-award__title" id="dlxScratchBadgeTitle">Empower Award</p>
          <p class="muted" id="dlxScratchBadgeNote">Every tap grows brain pathways.</p>
          <p class="dlx-scratch-award__level" id="dlxScratchBadgeLevel">LV 0</p>
        </div>
      </div>
      <p id="dlxScratchMessage">You earned a calm badge! Take a breath to enjoy it.</p>
      <div class="actions">
        <button type="button" class="btn btn-success" id="dlxScratchCopy">Copy message</button>
        <button type="button" class="btn" data-scratch-close>Close</button>
      </div>
    </div>
  </section>

  <aside id="dlxProfilePanel" class="dlx-profile-panel" hidden aria-labelledby="dlxProfileTitle">
    <div class="dlx-profile-panel__backdrop" data-profile-close></div>
    <div class="dlx-profile-panel__card" role="dialog" aria-modal="true">
      <header class="dlx-profile-panel__head">
        <h3 id="dlxProfileTitle">Personalise rewards</h3>
        <button type="button" class="btn btn-ghost" data-profile-close aria-label="Close profile panel">×</button>
      </header>
      <form id="dlxProfileForm" class="dlx-profile-form">
        <label>Preferred name
          <input type="text" id="dlxProfileName" autocomplete="off" />
        </label>
        <label>Reward tone
          <select id="dlxProfileReward">
            <option value="calm">Calm &amp; steady</option>
            <option value="celebrate">Big celebration</option>
            <option value="data">Data &amp; stats</option>
          </select>
        </label>
        <label>Coach narration voice
          <select id="dlxProfileVoice">
            <option value="uk-male">British male</option>
            <option value="uk-female">British female</option>
            <option value="neutral">Neutral</option>
          </select>
        </label>
        <label>Age or school year
          <input type="number" id="dlxProfileAge" min="4" max="120" />
        </label>
        <label>Gender identity
          <select id="dlxProfileGender">
            <option value="">Prefer not to say</option>
            <option value="girl">Girl / woman</option>
            <option value="boy">Boy / man</option>
            <option value="nonbinary">Non-binary</option>
            <option value="genderqueer">Gender diverse</option>
          </select>
        </label>
        <label>Where do you feel most rooted?
          <input type="text" id="dlxProfileOrigin" placeholder="City, culture or region" />
        </label>
        <label class="dlx-profile-checkbox">
          <input type="checkbox" id="dlxProfileReminder" /> Add a calm reminder before every session
        </label>
      </form>
      <footer class="dlx-profile-panel__footer">
        <button type="button" class="btn btn-success" id="dlxProfileSave">Save preferences</button>
        <button type="button" class="btn" data-profile-close>Close</button>
      </footer>
    </div>
  </aside>

  <script id="dlx-page-logic">
    (() => {
      const trackerKey = 'nb.dlx.focusState.v2';
      const todayKey = () => new Date().toISOString().slice(0, 10);
      const weekAnchorKey = (input = new Date()) => {
        const d = new Date(input);
        const day = d.getDay() || 7;
        if (day !== 1) d.setDate(d.getDate() - (day - 1));
        d.setHours(0, 0, 0, 0);
        return d.toISOString().slice(0, 10);
      };
      const defaultSpeechSpeed = 0.82;
      const createStage1Defaults = () => ({
        profile: {
          core: 'phonological',
          environment: 'school',
          overlays: [],
          context: ''
        },
        friction: {
          score: 0,
          weekAnchor: weekAnchorKey(),
          drivers: [],
          note: '',
          lastUpdated: null,
          history: []
        },
        calm: {
          lastPattern: '',
          lastEffect: 'steady',
          lastTime: 'before',
          weekAnchor: weekAnchorKey(),
          lastLogged: null,
          totalResets: 0,
          weeklyResets: 0
        },
        summary: ''
      });

      const hydrateStage1State = incoming => {
        const defaults = createStage1Defaults();
        const source = incoming && typeof incoming === 'object' ? incoming : {};
        return {
          ...defaults,
          ...source,
          profile: { ...defaults.profile, ...(source.profile || {}) },
          friction: {
            ...defaults.friction,
            ...(source.friction || {}),
            history: Array.isArray(source?.friction?.history) ? source.friction.history.slice(0, 6) : []
          },
          calm: { ...defaults.calm, ...(source.calm || {}) },
          summary: typeof source.summary === 'string' ? source.summary : defaults.summary
        };
      };

      const defaultState = {
        minutesToday: 0,
        minutesDate: todayKey(),
        streakDays: 0,
        lastSessionDate: null,
        gamesCompleted: 0,
        profile: { name: '', reward: 'calm', voice: 'uk-male', reminder: false, age: '', gender: '', origin: '' },
        speechSpeed: defaultSpeechSpeed,
        speechSpeedMode: 'slow',
        soundQuest: { level: 0, rounds: 0, lastCard: null },
        miniGames: {
          short: { rounds: 0, stars: 0 },
          long: { rounds: 0, stars: 0 },
          team: { rounds: 0, stars: 0 }
        },
        scratchReady: false,
        sessions: [],
        gameStats: {},
        stage1: createStage1Defaults()
      };

      const readState = () => {
        try {
          const raw = localStorage.getItem(trackerKey);
          if (!raw) return { ...defaultState };
          const parsed = JSON.parse(raw);
          const merged = {
            ...defaultState,
            ...parsed,
            miniGames: { ...defaultState.miniGames, ...(parsed?.miniGames || {}) },
            profile: { ...defaultState.profile, ...(parsed?.profile || {}) }
          };
          merged.stage1 = hydrateStage1State(parsed?.stage1 || merged.stage1);
          return merged;
        } catch (err) {
          console.warn('State load failed', err);
          return { ...defaultState };
        }
      };

      let state = readState();
      if (!Array.isArray(state.sessions)) state.sessions = [];
      if (!state.gameStats || typeof state.gameStats !== 'object') state.gameStats = {};
      if (!state.stage1) state.stage1 = createStage1Defaults();
      if (!state.soundQuest) state.soundQuest = { level: 0, rounds: 0, lastCard: null };

      const persist = () => {
        try {
          localStorage.setItem(trackerKey, JSON.stringify(state));
        } catch (err) {
          console.warn('State save failed', err);
        }
      };

      const resetDailyMinutes = () => {
        const today = todayKey();
        if (state.minutesDate !== today) {
          state.minutesDate = today;
          state.minutesToday = 0;
          Object.values(state.miniGames).forEach(stats => { stats.rounds = 0; });
        }
      };

      const ensureStage1Anchors = () => {
        if (!state.stage1) state.stage1 = createStage1Defaults();
        const anchor = weekAnchorKey();
        if (state.stage1.friction?.weekAnchor !== anchor) {
          state.stage1.friction.weekAnchor = anchor;
        }
        if (state.stage1.calm?.weekAnchor !== anchor) {
          state.stage1.calm.weekAnchor = anchor;
          state.stage1.calm.weeklyResets = 0;
        }
      };

      resetDailyMinutes();
      ensureStage1Anchors();

      const el = selector => document.querySelector(selector);
      const els = selector => Array.from(document.querySelectorAll(selector));

      const streakEl = el('#dlxStreakDays');
      const minutesEl = el('#dlxMinutesToday');
      const gamesEl = el('#dlxGamesCompleted');
      const scratchBtn = el('#dlxScratchBtn');
      const scratchHint = el('#dlxScratchHint');
      const sessionJournalEl = el('#dlxSessionJournal');
      const gameHighlightsEl = el('#dlxGameHighlights');
      const focusLookup = {
        'dlx-quick-warmup': { title: '3-minute calm warm-up', tip: 'Inhale for 4, pause for 2, exhale for 6. Then read a short paragraph.', label: 'Warm-up' },
        'dlx-breath-reset': { title: 'SOS-60 calm', tip: 'Square breathing: in 4, hold 4, out 4, hold 4. Keep shoulders relaxed.', label: 'Calm reset' },
        boxBreathing: { title: 'Box breathing loop', tip: 'Trace a square: inhale 4, hold 4, exhale 4, hold 4. Repeat calmly.', label: 'Calm reset' },
        breathing478: { title: '4-7-8 breathing', tip: 'Inhale quietly for 4, hold for 7, exhale softly for 8. Melt tension in the jaw.', label: 'Calm pattern' },
        coherent55: { title: 'Coherent 5-5 breathing', tip: 'Inhale for 5 and exhale for 5 to steady heart rate and focus.', label: 'Coherence breath' },
        vowelUniverse: { title: 'Vowel Universe mission', tip: 'Focus on one vowel area. Trace, say, read, then map new words.', label: 'Structured phonics' },
        vowelQuest: { title: 'Vowel Quest round', tip: 'Hear the vowel, tap the matching spelling, then read it in a calm sentence. Accuracy beats speed every time.', label: 'Phonics drill' },
        fluencyPacer: { title: 'Fluency pacer', tip: 'Read with expression. Tiny pause at commas, reset breath every sentence.', label: 'Fluency' },
        rapidNaming: { title: 'Rapid naming strip', tip: 'Soft gaze, glide across the strip. Celebrate steady pacing.', label: 'RAN drill' },
        dlxQuestModes: { title: 'Quest modes & badges', tip: 'Warm-up, run your drill, then unlock rewards. Short bursts beat marathons.', label: 'Quest mode' },
        questCalm: { title: 'Calm kick-off', tip: 'Breath reset + phonics round + reflection. Keep it gentle.', label: 'Quest mode' },
        questLadder: { title: 'Level-up ladder', tip: 'Phonics + fluency. Use the same vowel family across both.', label: 'Quest mode' },
        questExpress: { title: 'Express mode', tip: 'Two-minute RAN + scratch reward. Perfect when time is short.', label: 'Quest mode' },
        calmRapid: { title: 'Breath + Rapid 5', tip: 'Breathe, read five words, name the rule you used. Repeat.', label: 'Booster' },
        lightChase: { title: 'Letter Light Chase', tip: 'Spot target letters calmly. Reset your shoulders every round.', label: 'Booster' },
        prefixBuilder: { title: 'Prefix builder', tip: 'Add prefixes/suffixes, read aloud, jot the meaning.', label: 'Morphology' },
        shortStreet: { title: 'Short Street sounds', tip: 'Clip vowels quickly. Jaw relaxed, airflow steady.', label: 'Vowel studio' },
        skylineTowers: { title: 'Skyline Towers', tip: 'Stretch long vowels. Trace the tower while you say it.', label: 'Vowel studio' },
        teamBridge: { title: 'Team Bridge', tip: 'Two letters cooperate. Say who talks, who walks.', label: 'Vowel studio' },
        rRiver: { title: 'R-River', tip: 'Let the vowel flow into /r/. Keep tongue relaxed.', label: 'Vowel studio' },
        slidePark: { title: 'Slide Park', tip: 'Test flexible patterns like ough, eigh slowly before speeding up.', label: 'Vowel studio' }
      };

      const stage1ProfileSentence = el('#dlxStage1ProfileSentence');
      const stage1ProfileContext = el('#dlxProfileContext');
      const stage1ProfileInputs = els('[data-dlx-profile-field]');
      const stage1OverlayInputs = els('[data-dlx-profile-overlay]');
      const stage1FrictionScale = el('#dlxFrictionScale');
      const stage1FrictionScoreLabel = el('#dlxFrictionScoreLabel');
      const stage1FrictionDrivers = els('[data-dlx-friction-driver]');
      const stage1FrictionNotes = el('#dlxFrictionNotes');
      const stage1FrictionSnapshot = el('#dlxFrictionSnapshot');
      const stage1FrictionTrendList = el('#dlxFrictionTrendList');
      const stage1FrictionSaveBtn = el('#dlxSaveFriction');
      const stage1CalmPatternSelect = el('#dlxCalmPatternSelect');
      const stage1CalmTimeButtons = els('[data-dlx-calm-time]');
      const stage1CalmEffectRadios = els('input[name="dlxCalmEffect"]');
      const stage1CalmStats = el('#dlxCalmResetStats');
      const stage1LogCalmBtn = el('#dlxLogCalmReset');
      const stage1ReportOutput = el('#dlxStage1ReportOutput');
      const stage1ReportBtn = el('#dlxStage1ReportBtn');
      const stage1ReportCopy = el('#dlxStage1ReportCopy');
      const stage1ReportStatus = el('#dlxStage1ReportStatus');
      const stage1HistoryLimit = 6;

      const stage1CoreMap = {
        phonological: {
          label: 'phonological decoding',
          focus: 'explicit sound-to-symbol mapping with cumulative blending',
          next: 'Keep Short Street or Vowel Universe visible while reading.'
        },
        naming: {
          label: 'rapid naming / processing speed',
          focus: 'paced drills, chanting and confidence-first fluency',
          next: 'Use Rapid Naming strips + calm starts to desensitise timed work.'
        },
        working: {
          label: 'working-memory and sequencing',
          focus: 'chunking, repetition, multi-sensory prompts and note scaffolds',
          next: 'Give 2-step instructions max and recap with icons or gestures.'
        },
        sensory: {
          label: 'visual stress / sensory regulation',
          focus: 'lighting, contrast, motion control and nervous-system regulation',
          next: 'Prepare overlays, tinted paper and headphones before lessons.'
        }
      };

      const stage1EnvMap = {
        school: { label: 'structured school timetable', summary: 'timetabled lessons + SEN staff' },
        college: { label: 'college / university setting', summary: 'lectures, seminars and assistive tech' },
        work: { label: 'workplace or apprenticeship', summary: 'manager briefings + task design' },
        hybrid: { label: 'hybrid / portfolio learning', summary: 'mix of home, online and community spaces' }
      };

      const stage1OverlayMap = {
        adhd: 'attention / ADHD',
        dyspraxia: 'dyspraxia / DCD',
        language: 'language difference',
        anxiety: 'anxiety / burnout',
        auditory: 'auditory processing'
      };

      const stage1DriverLabels = {
        fatigue: 'fatigue / late nights',
        transitions: 'timetable changes',
        sensory: 'sensory overload',
        motivation: 'motivation dip',
        support: 'support gaps',
        health: 'health / medication'
      };

      const stage1CalmPatternMap = {
        sos: 'SOS-60 calm reset',
        box: 'Box breathing 4-4-4-4',
        '478': '4-7-8 regulation',
        coherent: 'Coherent 5-5 breathing',
        roll: 'Physiological sigh'
      };

      const stage1CalmEffectLabels = {
        steady: 'steady and present',
        lighter: 'lighter but alert',
        sleepy: 'sleepy / drained'
      };

      const stage1CalmTimeLabels = {
        before: 'before reading starts',
        mid: 'mid-session pause',
        after: 'after the session'
      };

      const formatShortDate = iso => {
        if (!iso) return 'recently';
        const date = new Date(iso);
        if (Number.isNaN(date.getTime())) return 'recently';
        return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      };

      const formatDateTime = iso => {
        if (!iso) return 'recently';
        const date = new Date(iso);
        if (Number.isNaN(date.getTime())) return 'recently';
        const day = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        const time = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        return `${day} ${time}`;
      };

      const describeFrictionScore = score => {
        if (score <= 2) return 'calm';
        if (score <= 4) return 'steady';
        if (score <= 7) return 'spiky';
        return 'overloaded';
      };

      const setStage1FrictionLabel = score => {
        if (!stage1FrictionScoreLabel) return;
        stage1FrictionScoreLabel.textContent = `${score} / 10 · ${describeFrictionScore(score)}`;
      };

      const buildStage1ProfileSummary = () => {
        const profile = state.stage1?.profile || {};
        const learnerName = state.profile?.name?.trim() || 'This learner';
        const coreMeta = stage1CoreMap[profile.core] || stage1CoreMap.phonological;
        const envMeta = stage1EnvMap[profile.environment] || stage1EnvMap.school;
        const overlays = (profile.overlays || []).map(key => stage1OverlayMap[key]).filter(Boolean);
        const overlaySentence = overlays.length ? `Overlay factors: ${overlays.join(', ')}.` : 'No additional overlays flagged.';
        const context = profile.context?.trim();
        const voice = context ? `Learner voice: “${context}”.` : '';
        return `${learnerName} shows a ${coreMeta.label} dyslexia profile, so we prioritise ${coreMeta.focus}. Setting: ${envMeta.label}. ${overlaySentence} ${voice}`.trim();
      };

      const updateStage1ProfileSelections = () => {
        const profile = state.stage1?.profile || {};
        stage1ProfileInputs.forEach(input => {
          const field = input.getAttribute('data-dlx-profile-field');
          if (!field) return;
          const isActive = profile[field] === input.value;
          if (input.type === 'radio') input.checked = isActive;
          input.parentElement?.classList.toggle('is-active', isActive);
        });
        const overlays = new Set(profile.overlays || []);
        stage1OverlayInputs.forEach(input => {
          const isActive = overlays.has(input.value);
          input.checked = isActive;
          input.parentElement?.classList.toggle('is-active', isActive);
        });
        if (stage1ProfileContext) {
          stage1ProfileContext.value = typeof profile.context === 'string' ? profile.context : '';
        }
      };

      const updateStage1ProfileSummary = () => {
        if (!stage1ProfileSentence) return;
        const summary = buildStage1ProfileSummary();
        stage1ProfileSentence.textContent = summary || 'Choose a profile focus to generate a shared script.';
      };

      const renderStage1FrictionHistory = () => {
        if (!stage1FrictionTrendList) return;
        const history = state.stage1?.friction?.history || [];
        stage1FrictionTrendList.innerHTML = '';
        if (!history.length) {
          const li = document.createElement('li');
          li.textContent = 'No history yet. Log the first week to unlock trend view.';
          stage1FrictionTrendList.appendChild(li);
          return;
        }
        const frag = document.createDocumentFragment();
        history.slice(0, stage1HistoryLimit).forEach(entry => {
          const li = document.createElement('li');
          const drivers = (entry.drivers || []).map(key => stage1DriverLabels[key] || key).join(', ') || 'no drivers tagged';
          const note = entry.note ? ` — ${entry.note.slice(0, 140)}` : '';
          li.textContent = `${formatShortDate(entry.updated)} · ${entry.score}/10 (${describeFrictionScore(entry.score)} · ${drivers})${note}`;
          frag.appendChild(li);
        });
        stage1FrictionTrendList.appendChild(frag);
      };

      const updateStage1FrictionUI = () => {
        if (!stage1FrictionScale) return;
        const friction = state.stage1?.friction || {};
        const score = Number(friction.score) || 0;
        stage1FrictionScale.value = String(score);
        setStage1FrictionLabel(score);
        const drivers = friction.drivers || [];
        stage1FrictionDrivers.forEach(input => {
          const isChecked = drivers.includes(input.value);
          input.checked = isChecked;
        });
        if (stage1FrictionNotes) stage1FrictionNotes.value = friction.note || '';
        if (stage1FrictionSnapshot) {
          stage1FrictionSnapshot.textContent = friction.lastUpdated
            ? `Last logged ${formatDateTime(friction.lastUpdated)} (${score}/10 · ${describeFrictionScore(score)})`
            : 'No weekly snapshot yet.';
        }
        renderStage1FrictionHistory();
      };

      const getStage1CalmEffect = () => {
        for (const radio of stage1CalmEffectRadios) {
          if (radio.checked) return radio.value;
        }
        return 'steady';
      };

      const getStage1CalmTime = () => {
        const calm = state.stage1?.calm;
        return calm?.lastTime || 'before';
      };

      const updateStage1CalmUI = () => {
        if (!stage1CalmPatternSelect) return;
        const calm = state.stage1?.calm || {};
        stage1CalmPatternSelect.value = calm.lastPattern || '';
        const currentTime = calm.lastTime || 'before';
        stage1CalmTimeButtons.forEach(btn => {
          const value = btn.getAttribute('data-dlx-calm-time');
          btn.classList.toggle('is-active', value === currentTime);
        });
        stage1CalmEffectRadios.forEach(radio => {
          radio.checked = radio.value === (calm.lastEffect || 'steady');
        });
        if (stage1CalmStats) {
          stage1CalmStats.textContent = calm.totalResets
            ? `${calm.weeklyResets || 0} calm reset${(calm.weeklyResets || 0) === 1 ? '' : 's'} logged this week (${calm.totalResets} total).`
            : 'No calm resets logged yet.';
        }
      };

      const buildStage1Report = () => {
        const profile = state.stage1?.profile || {};
        const friction = state.stage1?.friction || {};
        const calm = state.stage1?.calm || {};
        const learnerName = state.profile?.name?.trim() || 'Learner';
        const coreMeta = stage1CoreMap[profile.core] || stage1CoreMap.phonological;
        const envMeta = stage1EnvMap[profile.environment] || stage1EnvMap.school;
        const overlays = (profile.overlays || []).map(key => stage1OverlayMap[key]).filter(Boolean);
        const overlayText = overlays.length ? overlays.join(', ') : 'none flagged';
        const frictionScore = Number(friction.score) || 0;
        const driverText = (friction.drivers || []).map(key => stage1DriverLabels[key] || key).join(', ') || 'no drivers tagged';
        const frictionNote = friction.note?.trim();
        const calmPattern = stage1CalmPatternMap[calm.lastPattern] || 'no calm reset logged yet';
        const calmEffect = stage1CalmEffectLabels[calm.lastEffect] || stage1CalmEffectLabels.steady;
        const calmTime = stage1CalmTimeLabels[calm.lastTime] || stage1CalmTimeLabels.before;
        const profileLine = `${learnerName} profile: ${coreMeta.label}. Focus: ${coreMeta.focus}`;
        const envLine = `Environment: ${envMeta.label} (${envMeta.summary}). Overlays: ${overlayText}.`;
        const frictionLine = `Weekly friction: ${frictionScore}/10 (${describeFrictionScore(frictionScore)}) logged ${friction.lastUpdated ? formatShortDate(friction.lastUpdated) : 'not yet logged'} | Drivers: ${driverText}${frictionNote ? ` · ${frictionNote}` : ''}`;
        const calmLine = calm.totalResets
          ? `Calm resets: ${calm.weeklyResets || 0} this week (${calm.totalResets} total) using ${calmPattern} ${calmTime} — feels ${calmEffect}.`
          : 'Calm resets: not logged yet.';
        const contextLine = profile.context?.trim() ? `Learner voice: “${profile.context.trim()}”.` : '';
        const nextLine = `Immediate next step: ${coreMeta.next}`;
        return [profileLine, envLine, frictionLine, calmLine, contextLine, nextLine].filter(Boolean).join('\n');
      };

      const updateStage1ReportPreview = () => {
        if (!stage1ReportOutput) return;
        const summary = state.stage1?.summary?.trim();
        stage1ReportOutput.textContent = summary || 'Build the profile above, then tap “Generate summary.”';
      };

      const refreshStage1UI = () => {
        updateStage1ProfileSelections();
        updateStage1ProfileSummary();
        updateStage1FrictionUI();
        updateStage1CalmUI();
        updateStage1ReportPreview();
      };

      const updateStatsUI = () => {
        minutesEl && (minutesEl.textContent = state.minutesToday.toString());
        streakEl && (streakEl.textContent = state.streakDays.toString());
        gamesEl && (gamesEl.textContent = state.gamesCompleted.toString());
        if (scratchBtn) {
          if (state.scratchReady) {
            scratchBtn.disabled = false;
            scratchBtn.textContent = 'Scratch & Shine – tap to reveal';
            scratchHint.textContent = 'Reward unlocked from your last session.';
          } else {
            scratchBtn.disabled = true;
            scratchBtn.textContent = 'Scratch card unlocks after your next session';
            scratchHint.textContent = 'Complete any quest or mini game to unlock.';
          }
        }
        updateSessionJournal();
        updateGameHighlights();
      };

      const HISTORY_LIMIT = 6;

      const labelForTarget = targetId => (focusLookup[targetId]?.title || 'Focus session');

      const formatRelativeTime = iso => {
        const timestamp = Date.parse(iso);
        if (Number.isNaN(timestamp)) return '';
        const diff = Date.now() - timestamp;
        const minutes = Math.max(1, Math.floor(diff / 60000));
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
      };

      const updateSessionJournal = () => {
        if (!sessionJournalEl) return;
        if (!state.sessions.length) {
          sessionJournalEl.innerHTML = '<li>No sessions logged yet.</li>';
          return;
        }
        sessionJournalEl.innerHTML = state.sessions
          .map(entry => `<li><strong>${labelForTarget(entry.id)}</strong> · ${entry.minutes} min · <span class="muted small">${formatRelativeTime(entry.timestamp)}</span></li>`)
          .join('');
      };

      const updateGameHighlights = () => {
        if (!gameHighlightsEl) return;
        const entries = Object.entries(state.gameStats || {});
        if (!entries.length) {
          gameHighlightsEl.innerHTML = '<p class="muted small">Complete any drill to see highlights.</p>';
          return;
        }
        entries.sort(([, a], [, b]) => (b.sessions - a.sessions) || (b.totalMinutes - a.totalMinutes));
        const [topId, stats] = entries[0];
        const label = labelForTarget(topId);
        const minutesText = `${stats.totalMinutes} min total`;
        const sessionsText = `${stats.sessions} session${stats.sessions === 1 ? '' : 's'}`;
        const lastPlayed = stats.lastPlayed ? ` • last ${formatRelativeTime(stats.lastPlayed)}` : '';
        gameHighlightsEl.innerHTML = `<p><strong>${label}</strong><br><span class="small">${sessionsText} • ${minutesText}${lastPlayed}</span></p>`;
      };

      const registerSessionOutcome = (targetId, minutes) => {
        const rounded = Math.max(1, Math.round(minutes));
        const stamp = new Date().toISOString();
        state.sessions = [{ id: targetId, minutes: rounded, timestamp: stamp }, ...state.sessions].slice(0, HISTORY_LIMIT);
        const current = state.gameStats[targetId] || { sessions: 0, totalMinutes: 0, lastPlayed: null };
        current.sessions += 1;
        current.totalMinutes += rounded;
        current.lastPlayed = stamp;
        state.gameStats[targetId] = current;
      };

      updateStatsUI();

      let lastQuickStartOrigin = null;
      const QUICK_START_TECH_MAP = {
        'dlx-breath-reset': 'box',
        boxBreathing: 'box',
        breathing478: '478',
        coherent55: 'coherent',
        coherent: 'coherent',
        'dlx-quick-warmup': 'coherent',
        sos: 'sos',
        'sos-60': 'sos'
      };
      const resolveQuickStartTechnique = id => {
        if (!id) return null;
        if (['box', '478', 'coherent', 'sos'].includes(id)) return id;
        return QUICK_START_TECH_MAP[id] || null;
      };

      const openQuickStartModal = (options = {}) => {
        lastQuickStartOrigin = options?.targetId || null;
        const trigger = document.getElementById('openQuickStart') || document.querySelector('[data-open-quick-start]');
        if (!trigger) return false;
        trigger.dispatchEvent(new Event('click', { bubbles: true }));
        const preferredTech = resolveQuickStartTechnique(options?.targetId);
        const preferredMinutes = Number.isFinite(Number(options?.minutes)) ? Number(options.minutes) : null;
        if (preferredTech || preferredMinutes) {
          window.setTimeout(() => {
            const dialog = document.getElementById('quickStartDialog');
            if (!dialog) return;
            if (preferredTech) {
              dialog.querySelector(`.technique-option[data-tech-option="${preferredTech}"]`)?.click();
            }
            if (preferredMinutes) {
              const rounded = Math.min(5, Math.max(1, Math.round(preferredMinutes)));
              dialog.querySelector(`.duration-btn[data-duration="${rounded}"]`)?.click();
            }
          }, 60);
        }
        return true;
      };

      const recordQuickStartSession = (targetId = 'dlx-quick-start', minutes = 1) => {
        const roundedMinutes = Math.max(1, Math.round(Number(minutes) || 1));
        state.minutesToday += roundedMinutes;
        state.gamesCompleted += 1;
        state.scratchReady = true;
        registerSessionOutcome(targetId, roundedMinutes);
        const last = state.lastSessionDate;
        const today = todayKey();
        if (last) {
          const diffDays = Math.floor((Date.parse(today) - Date.parse(last)) / 86400000);
          if (diffDays === 1) {
            state.streakDays += 1;
          } else if (diffDays > 1) {
            state.streakDays = 1;
          }
        } else {
          state.streakDays = 1;
        }
        state.lastSessionDate = today;
        persist();
        updateStatsUI();
      };

      const quickStartConfirmBtn = document.getElementById('confirmQuickStart');
      quickStartConfirmBtn?.addEventListener('click', () => {
        const modal = document.getElementById('quickStartDialog');
        const selectedTech = modal?.querySelector('.technique-option.selected');
        const selectedDuration = modal?.querySelector('.duration-btn.selected');
        const techniqueId = selectedTech?.getAttribute('data-tech-option') || lastQuickStartOrigin || 'dlx-quick-start';
        const minutes = Number(selectedDuration?.getAttribute('data-duration')) || 1;
        recordQuickStartSession(techniqueId, minutes);
      });

      if (typeof window !== 'undefined') {
        window.__dlxOpenFocus = (targetId, minutes) => openQuickStartModal({ targetId, minutes });
      }

      const SOUND_GRAD_LEVEL = 26;

      const scratchModal = el('#dlxScratchModal');
      const scratchMessage = el('#dlxScratchMessage');
      const scratchCopy = el('#dlxScratchCopy');
      const scratchBadgeTitle = el('#dlxScratchBadgeTitle');
      const scratchBadgeNote = el('#dlxScratchBadgeNote');
      const scratchBadgeLevel = el('#dlxScratchBadgeLevel');
      const scratchBadgeCrest = el('#dlxScratchBadgeCrest');
      const rewardMessages = {
        calm: [
          'Steady breathing, steady reading. Your calm focus paid off.',
          'You kept words gentle even when they were tricky. That is progress.',
          'Short bursts, big gains. Keep stacking victories.'
        ],
        celebrate: [
          'Boom! You smashed that session. Victory dance time.',
          'Reading hero alert – your focus streak just grew.',
          'Level unlocked! Screenshot this win if you want to share it.'
        ],
        data: [
          'Session logged. Minutes added, strategy banked.',
          'Your brain just built stronger pathways – evidence saved locally.',
          'Consistent reps create measurable change. Keep tracking.'
        ]
      };

      const empoweringFallbacks = [
        'Your curiosity is growing new neural paths every session.',
        'Level up logged. Patience plus strategy is your superpower.',
        'Every sound you lock is a tool you own forever.',
        'Calm focus today becomes confident reading tomorrow.',
        'You are building a map no one can take away from you.'
      ];

      const genderAffirmations = {
        girl: 'brilliant reader',
        boy: 'focused reader',
        nonbinary: 'inventive navigator',
        genderqueer: 'courageous learner'
      };

      const soundQuestAwardBands = [
        { min: SOUND_GRAD_LEVEL, crest: '🎓', title: 'Genius Laureate Award', note: 'Graduation unlocked. Design a celebration ritual tonight.' },
        { min: 22, crest: '🚀', title: 'Neuro Trailblazer Badge', note: 'Letters now launch ideas at rocket speed. Keep orbiting the deck.' },
        { min: 18, crest: '🛡️', title: 'Memory Guardian Seal', note: 'You built a shield of recall. Review cards to keep it glowing.' },
        { min: 12, crest: '💡', title: 'Clarity Architect Ribbon', note: 'You construct sound pictures faster every round.' },
        { min: 6, crest: '🔥', title: 'Momentum Spark Medal', note: 'Consistency is heating up your pathways. Keep the flame steady.' },
        { min: 1, crest: '🌱', title: 'Growth Starter Token', note: 'Every rep plants confident reading roots. Let them grow.' },
        { min: 0, crest: '✨', title: 'Warm-Up Badge', note: 'Warm fingers, calm brain, ready to earn levels.' }
      ];

      const getAwardForLevel = (level = 0) => {
        const match = soundQuestAwardBands.find(band => level >= band.min) || soundQuestAwardBands[soundQuestAwardBands.length - 1];
        return match;
      };

      const buildPersonalizedReward = (level, context = 'soundQuest') => {
        const profile = state.profile || {};
        const name = profile.name?.trim();
        const age = profile.age?.toString().trim();
        const gender = profile.gender?.trim();
        const origin = profile.origin?.trim();
        const pieces = [];
        if (name) pieces.push(name);
        if (age) pieces.push(`${age}-year-old`);
        if (gender && genderAffirmations[gender]) pieces.push(genderAffirmations[gender]);
        if (origin) pieces.push(`from ${origin}`);
        const levelLabel = level >= SOUND_GRAD_LEVEL ? `Graduation Level ${SOUND_GRAD_LEVEL} unlocked` : `Level ${level} locked in`;
        const contextLabel = context === 'soundQuest' ? 'Sound Memory Quest' : 'session';
        if (!pieces.length) {
          const fallback = empoweringFallbacks[Math.floor(Math.random() * empoweringFallbacks.length)];
          return `${levelLabel} in the ${contextLabel}. ${fallback}`;
        }
        let message = `${pieces.join(' ')} — ${levelLabel} inside the ${contextLabel}.`;
        if (level >= SOUND_GRAD_LEVEL) {
          message += ' Graduation unlocked! Design a ritual to celebrate this mastery tonight.';
        } else {
          message += ' Keep pairing images with sounds; your memory palace is expanding.';
        }
        return message;
      };

      const showScratchModal = (customMessage = '', force = false, meta = {}) => {
        if (!force && !state.scratchReady) return;
        const tone = state.profile.reward || 'calm';
        const pool = rewardMessages[tone] || rewardMessages.calm;
        const fallback = pool[Math.floor(Math.random() * pool.length)];
        const msg = customMessage || fallback;
        const awardLevel = Number(meta.level ?? state.soundQuest.level ?? 0) || 0;
        const { crest, title, note } = getAwardForLevel(awardLevel);
        if (scratchBadgeTitle) scratchBadgeTitle.textContent = title;
        if (scratchBadgeNote) scratchBadgeNote.textContent = note;
        if (scratchBadgeLevel) scratchBadgeLevel.textContent = `LV ${String(Math.max(0, awardLevel)).padStart(2, '0')}`;
        if (scratchBadgeCrest) scratchBadgeCrest.textContent = crest;
        scratchMessage.textContent = state.profile.name ? `${state.profile.name}, ${msg}` : msg;
        scratchModal.removeAttribute('hidden');
        state.scratchReady = false;
        updateStatsUI();
        persist();
      };

      const SOUND_ROUND_SECONDS = 18;
      let soundQuestTimerId = null;
      let soundQuestRemaining = SOUND_ROUND_SECONDS;
      let currentSoundQuestCard = null;
      let soundQuestActive = false;

      const soundQuestLaunchBtn = el('#dlxSoundQuestLaunch');
      const soundQuestScreen = el('#dlxSoundQuestScreen');
      const soundQuestLevelLabel = el('#dlxSoundQuestLevel');
      const soundQuestStatus = el('#dlxSoundQuestStatus');
      const soundQuestProgress = el('#dlxSoundQuestProgress');
      const soundQuestTimerBar = el('#dlxSoundQuestTimerBar');
      const soundQuestTimer = el('#dlxSoundQuestTimer');
      const soundQuestReward = el('#dlxSoundQuestReward');
      const memoryEmoji = el('#dlxMemoryEmoji');
      const memoryLetter = el('#dlxMemoryLetter');
      const memoryClue = el('#dlxMemoryClue');
      const soundQuestPlayBtn = el('#dlxSoundQuestPlay');
      const soundQuestPauseBtn = el('#dlxSoundQuestPause');
      const soundQuestStopBtn = el('#dlxSoundQuestStop');
      const soundQuestResetBtn = el('#dlxSoundQuestReset');
      const soundQuestLockBtn = el('#dlxSoundQuestLock');
      const soundQuestSkipBtn = el('#dlxSoundQuestSkip');
      const phonicsSongBtn = el('#dlxPhonicsSongBtn');
      const focusSongBtn = el('#dlxFocusSongBtn');
      const phonicsSongScreen = el('#dlxSongScreen');
      const phonicsSongLetterCard = el('#dlxSongLetterCard');
      const phonicsSongLetter = el('#dlxSongLetter');
      const phonicsSongIcon = el('#dlxSongIcon');
      const phonicsSongWord = el('#dlxSongWord');
      const phonicsSongLyric = el('#dlxSongLyric');
      const phonicsSongWave = el('#dlxSongWave');
      const phonicsSongProgress = el('#dlxSongProgress');
      const phonicsSongTime = el('#dlxSongTime');
      const phonicsSongStartBtn = el('#dlxSongStart');
      const phonicsSongPauseBtn = el('#dlxSongPause');
      const phonicsSongRestartBtn = el('#dlxSongRestart');
      const phonicsSongCloseBtns = els('[data-song-close]');
      const phonicsAudio = el('#dlxPhonicsAudio');
      const phonicsHeroBtn = el('#openPhonicsBtn');
      const letterSoundScreen = el('#dlxLetterSoundScreen');
      const letterSoundHead = el('#dlxMouthHead');
      if (letterSoundHead) letterSoundHead.dataset.mouthPhase = 'rest';
      const letterSoundLetter = el('#dlxMouthLetter');
      const letterSoundWord = el('#dlxMouthWord');
      const letterSoundTip = el('#dlxMouthTip');
      const letterSoundGrid = el('#dlxLetterSoundGrid');
      const letterSoundProgress = el('#dlxLetterSoundProgress');
      const letterSoundTime = el('#dlxLetterSoundTime');
      const letterSoundStartBtn = el('#dlxLetterSoundStart');
      const letterSoundPauseBtn = el('#dlxLetterSoundPause');
      const letterSoundRestartBtn = el('#dlxLetterSoundRestart');
      const letterSoundRandomHeadBtn = el('#dlxLetterSoundRandomHead');
      const letterSoundCloseBtns = els('[data-letter-sound-close]');
      const letterSoundAudio = el('#dlxLetterSoundAudio');
      const vowelClipAudio = el('#dlxVowelAudio');
      const letterSoundAccessory = el('#dlxMouthAccessory');
      const letterSoundPanel = el('.dlx-letter-sound-panel');
      const letterSoundCelebration = el('#dlxLetterSoundCelebration');
      const letterSoundCelebrationContent = el('#dlxLetterSoundCelebrationContent');
      const letterSoundMedalLabel = el('#dlxLetterSoundMedal');
      const letterSoundCelebrationTitle = el('#dlxLetterSoundCelebrationTitle');
      const letterSoundCelebrationBody = el('#dlxLetterSoundCelebrationBody');
      const letterSoundCelebrationTimerLabel = el('#dlxLetterSoundCelebrationTimer');
      const letterSoundCelebrationClock = el('#dlxLetterSoundCelebrationClock');
      const letterSoundCelebrationClockValue = el('#dlxLetterSoundCelebrationClockValue');
      const letterSoundCertificate = el('#dlxLetterSoundCertificate');
      const letterSoundCertificatePrompt = el('#dlxLetterSoundCertificatePrompt');
      const letterSoundCertificateForm = el('#dlxLetterSoundCertificateForm');
      const letterSoundCertificatePreview = el('#dlxLetterSoundCertificatePreview');
      const letterSoundCertificateTitle = el('#dlxCertificateTitle');
      const letterSoundCertificateName = el('#dlxCertificateAwardee');
      const letterSoundCertificateMedal = el('#dlxCertificateMedal');
      const letterSoundCertificateMessage = el('#dlxCertificateMessage');
      const letterSoundCertificateIssued = el('#dlxCertificateIssued');
      const letterSoundCertificateId = el('#dlxCertificateId');
      const letterSoundCertificatePrintBtn = el('#dlxCertificatePrintBtn');
      const letterSoundCertificateEditBtn = el('#dlxCertificateEditBtn');
      const letterSoundCertificateNameInput = el('#dlxCertificateNameInput');
      const letterSoundCertificateGenderInput = el('#dlxCertificateGenderInput');
      const letterSoundCertificateAgeInput = el('#dlxCertificateAgeInput');
      const letterSoundCertificateReligionInput = el('#dlxCertificateReligionInput');
      const letterSoundContinueBtn = el('#dlxLetterSoundContinue');
      const letterSoundContinueDefaultLabel = letterSoundContinueBtn?.textContent?.trim() || 'Continue learning';
      const letterSoundBuzz = el('#dlxLetterSoundBuzz');
      const letterSoundBuzzLabel = el('#dlxLetterSoundBuzzLabel');
      const letterSoundBuzzLetter = el('#dlxLetterSoundBuzzLetter');
      const letterSoundBuzzWord = el('#dlxLetterSoundBuzzWord');
      const letterSoundBuzzTip = el('#dlxLetterSoundBuzzTip');
      const LETTER_SOUND_COMPLETION_SECS = 225;
      const LETTER_SOUND_CELEBRATION_DURATION = 40000;
      const MIN_CELEBRATION_DURATION_MS = 4000;
      const letterSoundState = {
        currentLetter: 'A',
        currentPhase: 'rest',
        isPaused: true,
        variantOffset: 0,
        gridButtons: {},
        speakingTimeout: null,
        hasCompletedCelebration: false,
        completionCount: 0,
        lastCelebrationIndex: -1,
        activeCelebration: null
      };
      const certificateState = { data: null };
      const letterSoundCueState = { ready: false, cues: [], map: {} };
      const letterSoundMilestones = [
        {
          id: 'segmentAF',
          label: 'Letters A–F checkpoint',
          triggerLetter: 'F',
          resumeLetter: 'G',
          pauseDelay: 0.15,
          durationMs: 20000,
          medal: { name: 'Bronze Medal', icon: '🥉', theme: 'bronze', tagline: 'Letters A–F' },
          copy: {
            title: 'Bronze breath break achieved',
            body: 'You just wrapped the A–F repeats with perfect pacing. Hold this bronze pause for a sip of air, then tap Continue to glide into the G crew.'
          }
        },
        {
          id: 'segmentGL',
          label: 'Letters G–L checkpoint',
          triggerLetter: 'L',
          resumeLetter: 'M',
          pauseDelay: 0.2,
          durationMs: 20000,
          medal: { name: 'Silver Medal', icon: '🥈', theme: 'silver', tagline: 'Letters G–L' },
          copy: {
            title: 'Silver focus spotlight',
            body: 'Every consonant from G through L stayed locked with your cues. Enjoy this silver shimmer, then tap Continue to start the “now from M through R” verse.'
          }
        },
        {
          id: 'segmentMR',
          label: 'Letters M–R checkpoint',
          triggerLetter: 'R',
          resumeLetter: 'S',
          pauseDelay: 0.25,
          durationMs: 20000,
          medal: { name: 'Gold Medal', icon: '🥇', theme: 'gold', tagline: 'Letters M–R' },
          copy: {
            title: 'Gold momentum locked',
            body: 'M to R sounded confident and steady. Bask in this gold glow, then tap Continue so you can guide the sprint from S to Z.'
          }
        }
      ];
      const letterSoundFinalCelebrationConfig = {
        id: 'segmentFinale',
        durationMs: 30000,
        final: true,
        medal: { name: 'Platinum Medal', icon: '🏆', theme: 'platinum', tagline: 'Full Alphabet' }
      };
      const reachedLetterSoundMilestones = new Set();
      const letterSoundMilestoneMap = letterSoundMilestones.reduce((acc, milestone) => {
        if (milestone.triggerLetter) acc[milestone.triggerLetter] = milestone;
        return acc;
      }, {});
      let letterSoundCelebrationUnlockTimer = null;
      let celebrationAudioCtx = null;
      let celebrationNoiseBuffer = null;
      let crowdBedBuffer = null;
      let snareNoiseBuffer = null;
      let letterSoundCelebrationInterval = null;
      let activeCelebrationTotalMs = 0;
      let activeCelebrationRemainingMs = 0;
      let celebrationCountdownSettled = false;
      const completionLetter = 'Z';
      const completionWord = '🦓 zebra';
      const completionTip = 'Keep lips relaxed and repeat the phoneme twice with steady airflow.';
      const LETTER_CLIP_OFFSET = 0.02;
      const LETTER_CLIP_MIN_DURATION = 0.95;
      const VOWEL_CLIP_MIN_DURATION = 1.15;
      const SHORT_STREET_LETTERS = new Set(['A', 'E', 'I', 'O', 'U']);
      const VOWEL_TEAM_CLIP_MIN_DURATION = 0.45;
      const VOWEL_TEAM_CLIP_OFFSET = 0.02;
      const VOWEL_CARD_ALIAS_PREFIX = {
        skylineTowers: 'skyline',
        teamBridge: 'team',
        rRiver: 'river',
        slidePark: 'slide'
      };
      const slugifyKey = value =>
        value
          ? String(value)
              .trim()
              .replace(/([a-z0-9])([A-Z])/g, '$1-$2')
              .replace(/[^a-z0-9]+/gi, '-')
              .replace(/^-+|-+$/g, '')
              .toLowerCase()
          : '';
      const DOROTHY_VOWEL_CLIP_DATA = [
        { key: 'skyline-ai', labels: ['ai'], map: 'skylineTowers', start: 0.09, end: 0.73 },
        { key: 'skyline-ee', labels: ['ee'], map: 'skylineTowers', start: 1.17, end: 1.79 },
        { key: 'skyline-oa', labels: ['oa'], map: 'skylineTowers', start: 2.16, end: 2.88 },
        { key: 'skyline-ie', labels: ['ie'], map: 'skylineTowers', start: 3.18, end: 3.75 },
        { key: 'skyline-ue', labels: ['ue'], map: 'skylineTowers', start: 4.17, end: 4.84 },
        { key: 'team-au', labels: ['au'], map: 'teamBridge', start: 5.96, end: 6.15 },
        { key: 'team-aw', labels: ['aw'], map: 'teamBridge', start: 6.54, end: 7.16 },
        { key: 'team-oi', labels: ['oi'], map: 'teamBridge', start: 7.68, end: 8.31 },
        { key: 'team-oy', labels: ['oy'], map: 'teamBridge', start: 8.72, end: 9.32 },
        { key: 'team-ew', labels: ['ew'], map: 'teamBridge', start: 9.75, end: 10.27 },
        { key: 'river-ar', labels: ['ar'], map: 'rRiver', start: 12.13, end: 12.77 },
        { key: 'river-er', labels: ['er'], map: 'rRiver', start: 13.2, end: 13.83 },
        { key: 'river-ir', labels: ['ir'], map: 'rRiver', start: 14.28, end: 14.93 },
        { key: 'river-or', labels: ['or'], map: 'rRiver', start: 15.38, end: 16.01 },
        { key: 'river-ur', labels: ['ur'], map: 'rRiver', start: 16.46, end: 17.05 },
        { key: 'slide-ough', labels: ['ough'], map: 'slidePark', start: 18.64, end: 19.2 },
        { key: 'slide-augh', labels: ['augh'], map: 'slidePark', start: 19.7, end: 20.41 },
        { key: 'slide-eigh', labels: ['eigh'], map: 'slidePark', start: 20.84, end: 21.5 },
        { key: 'slide-ie', labels: ['ie'], map: 'slidePark', start: 21.79, end: 22.47 },
        { key: 'slide-oi', labels: ['oi'], map: 'slidePark', start: 22.97, end: 23.63 }
      ];
      const vowelClipCueMap = {};
      const vowelClipAliasMap = {};
      const registerVowelClipAlias = (label, clipKey, mapId) => {
        const normalized = String(label || '').trim().toLowerCase();
        if (!normalized) return;
        if (!vowelClipAliasMap[normalized]) vowelClipAliasMap[normalized] = clipKey;
        if (mapId) {
          const base = VOWEL_CARD_ALIAS_PREFIX[mapId] || mapId;
          const prefix = (base || '').toLowerCase();
          const slug = slugifyKey(base);
          const mapSlug = slugifyKey(mapId);
          if (prefix) vowelClipAliasMap[`${prefix}:${normalized}`] = clipKey;
          if (slug && slug !== prefix) vowelClipAliasMap[`${slug}:${normalized}`] = clipKey;
          if (mapSlug && mapSlug !== slug) vowelClipAliasMap[`${mapSlug}:${normalized}`] = clipKey;
        }
      };
      DOROTHY_VOWEL_CLIP_DATA.forEach(clip => {
        const start = Number(clip.start) || 0;
        const end = Number(clip.end);
        vowelClipCueMap[clip.key] = {
          key: clip.key,
          start,
          end,
          duration: Number.isFinite(end) ? Math.max(0, end - start) : null
        };
        const labels = Array.isArray(clip.labels) ? clip.labels : [clip.label || clip.key];
        labels.filter(Boolean).forEach(label => registerVowelClipAlias(label, clip.key, clip.map));
        (clip.aliases || []).forEach(alias => registerVowelClipAlias(alias, clip.key, clip.map));
      });
      const letterClipState = {
        activeLetter: null,
        stopTime: null,
        activeButton: null,
        source: null,
        stopTimerId: null
      };

      const setLetterClipActiveButton = btn => {
        if (letterClipState.activeButton === btn) return;
        if (letterClipState.activeButton) {
          letterClipState.activeButton.classList.remove('is-speaking');
          letterClipState.activeButton.removeAttribute('data-vowel-playing');
        }
        letterClipState.activeButton = btn || null;
        if (btn) {
          btn.classList.add('is-speaking');
          btn.setAttribute('data-vowel-playing', 'true');
        }
      };

      const resetLetterClipState = () => {
        if (letterClipState.stopTimerId) {
          clearTimeout(letterClipState.stopTimerId);
          letterClipState.stopTimerId = null;
        }
        letterClipState.stopTime = null;
        letterClipState.activeLetter = null;
        letterClipState.source = null;
        setLetterClipActiveButton(null);
      };

      const scheduleLetterClipStop = endTime => {
        if (letterClipState.stopTimerId) {
          clearTimeout(letterClipState.stopTimerId);
          letterClipState.stopTimerId = null;
        }
        if (!Number.isFinite(endTime)) {
          letterClipState.stopTime = null;
          return;
        }
        letterClipState.stopTime = Math.max(0, endTime - 0.03);
        if (letterSoundAudio) {
          const delay = Math.max(0, (letterClipState.stopTime - letterSoundAudio.currentTime) * 1000);
          letterClipState.stopTimerId = window.setTimeout(() => {
            letterClipState.stopTimerId = null;
            if (!letterClipState.stopTime) return;
            const clipStop = letterClipState.stopTime;
            pauseLetterSoundAudio();
            if (Number.isFinite(clipStop)) {
              letterSoundAudio.currentTime = clipStop;
            }
          }, delay);
        }
      };

      const vowelClipState = {
        activeKey: null,
        stopTime: null,
        stopTimerId: null,
        source: null,
        activeButton: null
      };

      const resolveVowelClipEntry = (label, mapId) => {
        if (!label) return null;
        const normalized = String(label).trim().toLowerCase();
        if (!normalized) return null;
        const attempts = [];
        if (mapId) {
          const mapKey = String(mapId).trim();
          if (mapKey) {
            const base = VOWEL_CARD_ALIAS_PREFIX[mapKey] || mapKey;
            const prefix = (base || '').toLowerCase();
            const slug = slugifyKey(base);
            const mapSlug = slugifyKey(mapKey);
            if (prefix) attempts.push(`${prefix}:${normalized}`);
            if (slug && slug !== prefix) attempts.push(`${slug}:${normalized}`);
            if (mapSlug && mapSlug !== slug) attempts.push(`${mapSlug}:${normalized}`);
          }
        }
        attempts.push(normalized);
        for (const key of attempts) {
          const clipKey = vowelClipAliasMap[key];
          if (clipKey && vowelClipCueMap[clipKey]) {
            return vowelClipCueMap[clipKey];
          }
        }
        return null;
      };

      const setVowelClipActiveButton = btn => {
        if (vowelClipState.activeButton === btn) return;
        if (vowelClipState.activeButton) {
          vowelClipState.activeButton.classList.remove('is-speaking');
        }
        vowelClipState.activeButton = btn || null;
        if (btn) btn.classList.add('is-speaking');
      };

      const resetVowelClipState = () => {
        if (vowelClipState.stopTimerId) {
          clearTimeout(vowelClipState.stopTimerId);
          vowelClipState.stopTimerId = null;
        }
        vowelClipState.stopTime = null;
        vowelClipState.activeKey = null;
        vowelClipState.source = null;
        setVowelClipActiveButton(null);
      };

      const pauseVowelClipAudio = () => {
        if (vowelClipAudio) {
          vowelClipAudio.pause();
        }
        resetVowelClipState();
      };

      const scheduleVowelClipStop = stopTime => {
        if (!vowelClipAudio || !Number.isFinite(stopTime)) {
          vowelClipState.stopTime = null;
          return;
        }
        if (vowelClipState.stopTimerId) {
          clearTimeout(vowelClipState.stopTimerId);
          vowelClipState.stopTimerId = null;
        }
        const clampEnd = vowelClipAudio.duration ? Math.min(stopTime, vowelClipAudio.duration) : stopTime;
        const delay = Math.max(0, (clampEnd - (vowelClipAudio.currentTime || 0)) * 1000);
        vowelClipState.stopTime = clampEnd;
        vowelClipState.stopTimerId = window.setTimeout(() => {
          vowelClipState.stopTimerId = null;
          pauseVowelClipAudio();
        }, delay);
      };

      const seekAndPlayVowelClip = (start, stop) => {
        if (!vowelClipAudio) return false;
        const safeStart = Math.max(0, start);
        const applyPlayback = () => {
          const maxSeek = vowelClipAudio.duration ? Math.max(0, vowelClipAudio.duration - 0.05) : safeStart;
          const targetTime = Math.min(safeStart, maxSeek);
          vowelClipAudio.currentTime = targetTime;
          const playPromise = vowelClipAudio.play();
          if (playPromise?.catch) {
            playPromise.catch(err => console.warn('Vowel audio blocked', err));
          }
          scheduleVowelClipStop(stop);
        };
        if (vowelClipAudio.readyState >= 1) {
          applyPlayback();
        } else {
          const handleReady = () => {
            vowelClipAudio.removeEventListener('loadedmetadata', handleReady);
            applyPlayback();
          };
          vowelClipAudio.addEventListener('loadedmetadata', handleReady);
          vowelClipAudio.load();
        }
        return true;
      };

      const playDorothyVowelClip = (label, options = {}) => {
        if (!label || !vowelClipAudio) return false;
        const clip = resolveVowelClipEntry(label, options.mapId);
        if (!clip) return false;
        pauseVowelClipAudio();
        const normalized = String(label).trim().toLowerCase();
        vowelClipState.activeKey = normalized;
        vowelClipState.source = options.source || 'vowel-chip';
        if (options.button) setVowelClipActiveButton(options.button);
        const offset = Number.isFinite(options.offset) ? options.offset : VOWEL_TEAM_CLIP_OFFSET;
        const startBase = Number.isFinite(clip.start) ? clip.start : 0;
        const start = Math.max(0, startBase + offset);
        const baseEnd = Number.isFinite(clip.end) ? clip.end : null;
        const fallbackDuration = clip.duration || VOWEL_TEAM_CLIP_MIN_DURATION;
        const tentativeStop = baseEnd ?? startBase + fallbackDuration;
        const stop = Math.max(start + VOWEL_TEAM_CLIP_MIN_DURATION, tentativeStop);
        const played = seekAndPlayVowelClip(start, stop);
        if (!played) {
          resetVowelClipState();
        }
        return played;
      };

      vowelClipAudio?.addEventListener('ended', resetVowelClipState);

      const getDefaultLetterSoundBuzzContent = () => ({
        label: 'Golden Buzz',
        message: `${completionLetter.toUpperCase()} / ${completionLetter.toLowerCase()}`,
        subMessage: completionWord,
        tip: completionTip
      });
      const setLetterSoundBuzzContent = content => {
        const defaults = getDefaultLetterSoundBuzzContent();
        const payload = {
          label: content?.label ?? defaults.label,
          message: content?.message ?? defaults.message,
          subMessage: content?.subMessage ?? defaults.subMessage,
          tip: content?.tip ?? defaults.tip
        };
        if (letterSoundBuzzLabel) letterSoundBuzzLabel.textContent = payload.label;
        if (letterSoundBuzzLetter) letterSoundBuzzLetter.textContent = payload.message;
        if (letterSoundBuzzWord) {
          letterSoundBuzzWord.textContent = payload.subMessage || '';
          if (payload.subMessage) {
            letterSoundBuzzWord.removeAttribute('aria-hidden');
          } else {
            letterSoundBuzzWord.setAttribute('aria-hidden', 'true');
          }
        }
        if (letterSoundBuzzTip) letterSoundBuzzTip.textContent = payload.tip;
      };
      const buildBuzzContentForCelebration = (copy, medal) => {
        const defaults = getDefaultLetterSoundBuzzContent();
        const labelParts = [];
        if (medal?.icon) labelParts.push(medal.icon);
        if (medal?.name) labelParts.push(medal.name);
        if (medal?.tagline) labelParts.push(`· ${medal.tagline}`);
        const label = labelParts.join(' ').replace(/\s+/g, ' ').trim();
        return {
          label: label || copy?.title || defaults.label,
          message: copy?.title || defaults.message,
          subMessage: medal?.tagline || '',
          tip: copy?.body || defaults.tip
        };
      };
      const phonicsSongState = { currentIndex: 0, lastLetter: 'A', isPaused: true };
      const phonicsCueUrl = 'assets/tts/cues/phonics-song-cues.json';
      setLetterSoundBuzzContent();
        const setPhonicsPauseState = isPaused => {
              phonicsSongState.isPaused = Boolean(isPaused);
              if (!phonicsSongPauseBtn) return;
              const label = phonicsSongState.isPaused ? 'Continue' : 'Pause';
              phonicsSongPauseBtn.textContent = label;
              phonicsSongPauseBtn.setAttribute('aria-label', phonicsSongState.isPaused ? 'Continue phonics song' : 'Pause phonics song');
            };

      const phonicsCueState = {
        ready: false,
        letters: [],
        map: {},
        intro: { start: 0, end: 0 },
        timeline: [],
        loading: null
      };

      const inlinePhonicsCueData = {
        version: 1,
        generatedAt: '2025-11-24T20:55:40.139Z',
        audio: 'assets/tts/eleven-labs-phonics-alphabet-sounds-dorothy.mp3',
        intro: { start: 0, end: 8.04, duration: 8.04 },
        letters: [
          { letter: 'A', start: 8.04, callEnd: 11.38, repeatStart: 11.38, repeatEnd: 15.08, end: 15.08, duration: 7.04 },
          { letter: 'B', start: 15.08, callEnd: 18.36, repeatStart: 18.36, repeatEnd: 21.88, end: 21.88, duration: 6.8 },
          { letter: 'C', start: 21.88, callEnd: 24.8, repeatStart: 24.8, repeatEnd: 28.36, end: 28.36, duration: 6.48 },
          { letter: 'D', start: 28.36, callEnd: 31.24, repeatStart: 31.24, repeatEnd: 34.52, end: 34.52, duration: 6.16 },
          { letter: 'E', start: 34.52, callEnd: 37.4, repeatStart: 37.4, repeatEnd: 40.88, end: 40.88, duration: 6.36 },
          { letter: 'F', start: 40.88, callEnd: 43.76, repeatStart: 43.76, repeatEnd: 47.12, end: 65, duration: 24.12 },
          { letter: 'G', start: 65, callEnd: 67.96, repeatStart: 67.96, repeatEnd: 71.2, end: 71.2, duration: 6.2 },
          { letter: 'H', start: 71.2, callEnd: 74.12, repeatStart: 74.12, repeatEnd: 77.12, end: 77.12, duration: 5.92 },
          { letter: 'I', start: 77.12, callEnd: 80.2, repeatStart: 80.2, repeatEnd: 82.96, end: 82.96, duration: 5.84 },
          { letter: 'J', start: 82.96, callEnd: 85.76, repeatStart: 85.76, repeatEnd: 88.8, end: 88.8, duration: 5.84 },
          { letter: 'K', start: 88.8, callEnd: 91.52, repeatStart: 91.52, repeatEnd: 94.36, end: 94.36, duration: 5.56 },
          { letter: 'L', start: 94.36, callEnd: 97.16, repeatStart: 97.16, repeatEnd: 100.08, end: 118.28, duration: 23.92 },
          { letter: 'M', start: 118.28, callEnd: 121.08, repeatStart: 121.08, repeatEnd: 124.16, end: 124.16, duration: 5.88 },
          { letter: 'N', start: 124.16, callEnd: 126.96, repeatStart: 126.96, repeatEnd: 129.96, end: 129.96, duration: 5.8 },
          { letter: 'O', start: 129.96, callEnd: 132.88, repeatStart: 132.88, repeatEnd: 135.92, end: 135.92, duration: 5.96 },
          { letter: 'P', start: 135.92, callEnd: 138.68, repeatStart: 138.68, repeatEnd: 141.8, end: 141.8, duration: 5.88 },
          { letter: 'Q', start: 141.8, callEnd: 144.72, repeatStart: 144.72, repeatEnd: 147.76, end: 147.76, duration: 5.96 },
          { letter: 'R', start: 147.76, callEnd: 149.76, repeatStart: null, repeatEnd: null, end: 174.72, duration: 26.96 },
          { letter: 'S', start: 168.06, callEnd: 170.42, repeatStart: 171.12, repeatEnd: 172.5, end: 173.78, duration: 5.72 },
          { letter: 'T', start: 173.78, callEnd: 176.12, repeatStart: 176.82, repeatEnd: 178.14, end: 179.52, duration: 5.74 },
          { letter: 'U', start: 179.52, callEnd: 182, repeatStart: 182.82, repeatEnd: 184.2, end: 185.42, duration: 5.9 },
          { letter: 'V', start: 185.42, callEnd: 187.96, repeatStart: 188.7, repeatEnd: 190.02, end: 190.88, duration: 5.46 },
          { letter: 'W', start: 190.88, callEnd: 193.66, repeatStart: 194.4, repeatEnd: 195.72, end: 196.8, duration: 5.92 },
          { letter: 'X', start: 196.8, callEnd: 199.14, repeatStart: 199.7, repeatEnd: 201.12, end: 202.3, duration: 5.5 },
          { letter: 'Y', start: 202.3, callEnd: 204.8, repeatStart: 205.36, repeatEnd: 206.94, end: 208.24, duration: 5.94 },
          { letter: 'Z', start: 208.24, callEnd: 210.48, repeatStart: 211.02, repeatEnd: 212.62, end: 225.8, duration: 17.56 }
        ]
      };

      const findInlinePhonicsCue = letter => {
        if (!inlinePhonicsCueData?.letters?.length) return null;
        const normalized = String(letter || '').toUpperCase();
        if (!normalized) return null;
        return inlinePhonicsCueData.letters.find(entry => String(entry.letter || '').toUpperCase() === normalized) || null;
      };

      const getPhonicsCueDurationMs = (letter, fallbackMs = LETTER_SOUND_CELEBRATION_DURATION) => {
        const safetyFallback = Math.max(MIN_CELEBRATION_DURATION_MS, Number(fallbackMs) || 0);
        if (!letter) return safetyFallback;
        const normalized = String(letter).toUpperCase();
        const cueFromState = phonicsCueState?.map?.[normalized];
        const stateDuration = Number(cueFromState?.duration);
        if (Number.isFinite(stateDuration) && stateDuration > 0) {
          return Math.max(MIN_CELEBRATION_DURATION_MS, Math.round(stateDuration * 1000));
        }
        const inlineCue = findInlinePhonicsCue(normalized);
        const inlineDuration = Number(inlineCue?.duration ?? ((inlineCue?.end ?? 0) - (inlineCue?.start ?? 0)));
        if (Number.isFinite(inlineDuration) && inlineDuration > 0) {
          return Math.max(MIN_CELEBRATION_DURATION_MS, Math.round(inlineDuration * 1000));
        }
        return safetyFallback;
      };

      const syncCelebrationDurationsWithCues = () => {
        letterSoundMilestones.forEach(milestone => {
          if (!milestone?.triggerLetter) return;
          milestone.durationMs = getPhonicsCueDurationMs(milestone.triggerLetter, milestone.durationMs || LETTER_SOUND_CELEBRATION_DURATION);
        });
        letterSoundFinalCelebrationConfig.durationMs = getPhonicsCueDurationMs(
          completionLetter,
          letterSoundFinalCelebrationConfig.durationMs || LETTER_SOUND_CELEBRATION_DURATION
        );
      };

      syncCelebrationDurationsWithCues();

      const letterSoundInlineCues = [
        { letter: 'A', start: 7.92, callEnd: 11.4, repeatStart: 11.4, repeatEnd: 15.56, end: 15.56 },
        { letter: 'B', start: 15.56, callEnd: 18.56, repeatStart: 18.56, repeatEnd: 22.12, end: 22.12 },
        { letter: 'C', start: 22.12, callEnd: 25.08, repeatStart: 25.08, repeatEnd: 28.2, end: 28.2 },
        { letter: 'D', start: 28.28, callEnd: 31.04, repeatStart: 31.04, repeatEnd: 34.12, end: 34.12 },
        { letter: 'E', start: 34.12, callEnd: 37.16, repeatStart: 37.16, repeatEnd: 40.16, end: 40.16 },
        { letter: 'F', start: 40.16, callEnd: 43.2, repeatStart: 43.2, repeatEnd: 46.2, end: 46.2 },
        { letter: 'G', start: 62.48, callEnd: 65.44, repeatStart: 65.44, repeatEnd: 68.72, end: 68.72 },
        { letter: 'H', start: 68.72, callEnd: 71.64, repeatStart: 71.64, repeatEnd: 74.64, end: 74.64 },
        { letter: 'I', start: 74.64, callEnd: 77.92, repeatStart: 77.92, repeatEnd: 80.92, end: 80.92 },
        { letter: 'J', start: 80.92, callEnd: 83.92, repeatStart: 84, repeatEnd: 86.84, end: 86.84 },
        { letter: 'K', start: 86.84, callEnd: 89.8, repeatStart: 89.8, repeatEnd: 92.6, end: 92.6 },
        { letter: 'L', start: 92.6, callEnd: 95.6, repeatStart: 95.6, repeatEnd: 98.4, end: 98.4 },
        { letter: 'M', start: 114.92, callEnd: 118.16, repeatStart: 118.16, repeatEnd: 121.08, end: 121.08 },
        { letter: 'N', start: 121.08, callEnd: 124.28, repeatStart: 124.28, repeatEnd: 127.52, end: 127.52 },
        { letter: 'O', start: 127.52, callEnd: 130.56, repeatStart: 130.56, repeatEnd: 133.4, end: 133.4 },
        { letter: 'P', start: 133.4, callEnd: 136.16, repeatStart: 136.16, repeatEnd: 138.92, end: 138.92 },
        { letter: 'Q', start: 138.92, callEnd: 141.76, repeatStart: 141.76, repeatEnd: 144.6, end: 144.6 },
        { letter: 'R', start: 144.6, callEnd: 148.04, repeatStart: 148.04, repeatEnd: 151.04, end: 151.04 },
        { letter: 'S', start: 168, callEnd: 171.08, repeatStart: 171.08, repeatEnd: 173.96, end: 173.96 },
        { letter: 'T', start: 173.96, callEnd: 176.84, repeatStart: 176.84, repeatEnd: 179.64, end: 179.64 },
        { letter: 'U', start: 179.64, callEnd: 182.84, repeatStart: 182.84, repeatEnd: 185.56, end: 185.56 },
        { letter: 'V', start: 185.56, callEnd: 188.68, repeatStart: 188.68, repeatEnd: 191.32, end: 191.32 },
        { letter: 'W', start: 191.32, callEnd: 194.32, repeatStart: 194.32, repeatEnd: 196.92, end: 196.92 },
        { letter: 'X', start: 196.92, callEnd: 199.76, repeatStart: 199.76, repeatEnd: 202.6, end: 202.6 },
        { letter: 'Y', start: 202.6, callEnd: 205.52, repeatStart: 205.52, repeatEnd: 208.2, end: 208.2 },
        { letter: 'Z', start: 208.2, callEnd: 211.2, repeatStart: 211.2, repeatEnd: 213.88, end: 213.88 }
      ];

      const applyPhonicsCueData = data => {
        if (!data) return false;
        const intro = data.intro || {};
        const letters = Array.isArray(data.letters) ? data.letters : [];
        const normalizedLetters = letters
          .map(item => {
            const letter = String(item.letter || '').toUpperCase();
            if (!letter) return null;
            const rawStart = Number(item.start ?? 0);
            const start = Number.isFinite(rawStart) ? rawStart : 0;
            const fallbackEnd = Number(item.end ?? item.repeatEnd ?? item.callEnd ?? start);
            const endSource = Number.isFinite(fallbackEnd) ? fallbackEnd : start;
            const callEnd = Number.isFinite(Number(item.callEnd)) ? Number(item.callEnd) : null;
            const repeatStart = Number.isFinite(Number(item.repeatStart)) ? Number(item.repeatStart) : null;
            const repeatEnd = Number.isFinite(Number(item.repeatEnd)) ? Number(item.repeatEnd) : null;
            const explicitDuration = Number(item.duration);
            return {
              letter,
              start,
              end: endSource,
              callEnd,
              repeatStart,
              repeatEnd,
              duration: Number.isFinite(explicitDuration) ? explicitDuration : Math.max(0, (repeatEnd ?? endSource) - start)
            };
          })
          .filter(Boolean);
        phonicsCueState.intro = {
          start: Number(intro.start || 0),
          end: Number(intro.end || 0)
        };
        phonicsCueState.letters = normalizedLetters;
        phonicsCueState.map = phonicsCueState.letters.reduce((acc, cue) => {
          if (cue.letter) acc[cue.letter] = cue;
          return acc;
        }, {});
        const timeline = [];
        if (Number.isFinite(phonicsCueState.intro.start) && Number.isFinite(phonicsCueState.intro.end)) {
          timeline.push({ type: 'intro', start: phonicsCueState.intro.start, end: phonicsCueState.intro.end });
        }
        phonicsCueState.letters.forEach(cue => {
          if (!Number.isFinite(cue.start) || !Number.isFinite(cue.end)) return;
          timeline.push(Object.assign({ type: 'letter' }, cue));
        });
        phonicsCueState.timeline = timeline;
        phonicsCueState.ready = true;
        return true;
      };

      const useInlinePhonicsCues = () => {
        if (!inlinePhonicsCueData) return false;
        const hydrated = applyPhonicsCueData(inlinePhonicsCueData);
        if (hydrated) {
          phonicsCueState.loading = Promise.resolve(phonicsCueState);
          phonicsCueState.source = 'inline';
        }
        return hydrated;
      };

      const ensureLetterSoundCues = () => {
        if (letterSoundCueState.ready) return letterSoundCueState;
        letterSoundCueState.cues = letterSoundInlineCues.map(entry => {
          const upper = String(entry.letter || '').toUpperCase();
          const rawStart = Number(entry.start);
          const rawEnd = Number(entry.end);
          const start = Number.isFinite(rawStart) ? rawStart : 0;
          const end = Number.isFinite(rawEnd) ? rawEnd : start;
          const rawCallEnd = Number(entry.callEnd);
          const rawRepeatStart = Number(entry.repeatStart);
          const rawRepeatEnd = Number(entry.repeatEnd);
          return {
            letter: upper,
            start,
            end,
            duration: Math.max(0, end - start),
            callEnd: Number.isFinite(rawCallEnd) ? rawCallEnd : end,
            repeatStart: Number.isFinite(rawRepeatStart) ? rawRepeatStart : null,
            repeatEnd: Number.isFinite(rawRepeatEnd) ? rawRepeatEnd : null
          };
        });
        letterSoundCueState.map = letterSoundCueState.cues.reduce((acc, cue) => {
          if (cue.letter) acc[cue.letter] = cue;
          return acc;
        }, {});
        letterSoundCueState.ready = true;
        return letterSoundCueState;
      };

      const getLetterSoundCueForTime = secs => {
        if (!letterSoundCueState.ready) return null;
        return letterSoundCueState.cues.find(entry => secs >= entry.start && secs < entry.end) || null;
      };

      const showLetterSoundCompletionMessage = () => {
        const displayLetter = `${completionLetter.toUpperCase()} / ${completionLetter.toLowerCase()}`;
        if (letterSoundLetter) letterSoundLetter.textContent = displayLetter;
        if (letterSoundWord) letterSoundWord.textContent = completionWord;
        if (letterSoundTip) letterSoundTip.textContent = completionTip;
        setLetterSoundBuzzContent({
          label: 'Golden Buzz',
          message: displayLetter,
          subMessage: completionWord,
          tip: completionTip
        });
      };

      const showLetterSoundBuzz = content => {
        if (!letterSoundBuzz) return;
        if (content) setLetterSoundBuzzContent(content);
        letterSoundBuzz.removeAttribute('hidden');
        requestAnimationFrame(() => letterSoundBuzz.classList.add('is-visible'));
      };

      const hideLetterSoundBuzz = () => {
        if (!letterSoundBuzz) return;
        letterSoundBuzz.classList.remove('is-visible');
        letterSoundBuzz.setAttribute('hidden', 'hidden');
      };

      const highlightCelebrationMessage = isActive => {
        letterSoundCelebrationContent?.classList.toggle('is-animated', Boolean(isActive));
      };

      const calmCelebrationVisuals = () => {
        applyCelebrationAtmosphere('calm');
        highlightCelebrationMessage(false);
        setCelebrationState('awaiting');
      };

      const resetCelebrationVisuals = () => {
        applyCelebrationAtmosphere(false);
        highlightCelebrationMessage(false);
        setCelebrationState('');
      };

      const isActiveCelebrationFinal = () => Boolean(letterSoundState.activeCelebration?.milestone?.final);

      const setCertificateFocusMode = isActive => {
        letterSoundCelebration?.classList.toggle('is-certificate-focus', Boolean(isActive));
      };

      const resetCertificateSection = () => {
        certificateState.data = null;
        letterSoundCertificate?.setAttribute('hidden', 'hidden');
        letterSoundCertificateForm?.removeAttribute('hidden');
        letterSoundCertificatePreview?.setAttribute('hidden', 'hidden');
        letterSoundCertificateForm?.reset();
        setCertificateFocusMode(false);
      };

      const populateCertificateFormFields = data => {
        if (!data) return;
        const source = data.details || data;
        if (letterSoundCertificateNameInput) letterSoundCertificateNameInput.value = source.name || '';
        if (letterSoundCertificateGenderInput) letterSoundCertificateGenderInput.value = source.gender || '';
        if (letterSoundCertificateAgeInput) letterSoundCertificateAgeInput.value = source.age || '';
        if (letterSoundCertificateReligionInput) letterSoundCertificateReligionInput.value = source.religion || '';
      };

      const showCertificateCollection = (options = {}) => {
        if (!letterSoundCertificate) return;
        const preserveValues = Boolean(options.preserveValues && certificateState.data);
        letterSoundCertificate.removeAttribute('hidden');
        letterSoundCertificatePreview?.setAttribute('hidden', 'hidden');
        letterSoundCertificateForm?.removeAttribute('hidden');
        if (preserveValues) {
          populateCertificateFormFields(certificateState.data);
        } else {
          certificateState.data = null;
          letterSoundCertificateForm?.reset();
        }
        if (letterSoundCertificatePrompt) {
          const promptText = options.prompt || 'Enter the learner name (required) plus optional details to personalize their official NeuroBreath certificate.';
          letterSoundCertificatePrompt.textContent = promptText;
        }
        setTimeout(() => letterSoundCertificateNameInput?.focus(), 50);
        setCertificateFocusMode(true);
      };

      const getActiveCelebrationSummary = () => ({
        title: letterSoundCelebrationTitle?.textContent || 'Platinum mastery',
        body: letterSoundCelebrationBody?.textContent || 'Completed every phoneme with control and confidence.',
        medal: letterSoundState.activeCelebration?.milestone?.medal || letterSoundFinalCelebrationConfig.medal || {}
      });

      const renderCertificatePreview = data => {
        if (!letterSoundCertificatePreview) return;
        certificateState.data = data;
        if (letterSoundCertificateTitle) letterSoundCertificateTitle.textContent = data.title || 'Platinum Letter Sound Mastery';
        if (letterSoundCertificateName) letterSoundCertificateName.textContent = data.name;
        if (letterSoundCertificateMedal) letterSoundCertificateMedal.textContent = data.medalTitle;
        if (letterSoundCertificateMessage) letterSoundCertificateMessage.textContent = data.message;
        if (letterSoundCertificateIssued) letterSoundCertificateIssued.textContent = data.issuedDisplay;
        if (letterSoundCertificateId) letterSoundCertificateId.textContent = data.certificateId;
        letterSoundCertificatePreview.removeAttribute('hidden');
        letterSoundCertificateForm?.setAttribute('hidden', 'hidden');
        if (letterSoundCertificatePrompt) {
          letterSoundCertificatePrompt.textContent = 'Certificate ready — print or edit your details before continuing.';
        }
        if (letterSoundCelebrationTimerLabel) {
          letterSoundCelebrationTimerLabel.textContent = 'Certificate minted — print it or tap Continue to reset for another run.';
        }
        setCelebrationContinueAvailability(true, 'Restart mastery run');
        letterSoundCertificatePreview?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setCertificateFocusMode(true);
      };

      const formatCertificateIssuedDate = date => {
        try {
          return new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).format(date);
        } catch (err) {
          console.warn('Certificate date formatting failed', err);
          return date.toLocaleDateString();
        }
      };

      const generateCertificateId = () => {
        const base = Date.now().toString(36).toUpperCase();
        const random = Math.floor(1000 + Math.random() * 9000);
        return `NB-${base.slice(-4)}-${random}`;
      };

      const buildCertificateMedalTitle = medal => {
        if (!medal) return 'Platinum Letter Sound Mastery';
        const parts = [];
        if (medal.icon) parts.push(medal.icon);
        if (medal.name) parts.push(medal.name);
        if (medal.tagline) parts.push(`· ${medal.tagline}`);
        const title = parts.join(' ').replace(/\s+/g, ' ').trim();
        return title || 'Platinum Letter Sound Mastery';
      };

      const clampCertificateAge = value => {
        const num = Number(value);
        if (!Number.isFinite(num)) return null;
        return Math.min(120, Math.max(3, Math.round(num)));
      };

      const getCertificateAgeBand = ageValue => {
        if (!Number.isFinite(ageValue)) return null;
        if (ageValue <= 12) return 'junior';
        if (ageValue <= 17) return 'teen';
        if (ageValue <= 24) return 'apprentice';
        if (ageValue <= 45) return 'adult';
        return 'mentor';
      };

      const normalizeCertificateGender = gender => {
        const value = String(gender || '').trim().toLowerCase();
        if (!value) return null;
        if (value.startsWith('f')) return 'female';
        if (value.startsWith('m')) return 'male';
        if (value.includes('non')) return 'non-binary';
        return 'unspecified';
      };

      const buildCertificateTitle = (details, summary) => {
        const band = getCertificateAgeBand(details.ageNumber);
        if (band === 'junior') return 'Junior Resonance Laureate';
        if (band === 'teen') return 'Youth Focus Laureate';
        if (band === 'apprentice') return 'Emerging Voice Laureate';
        if (band === 'adult') return 'Mastery Citation Laureate';
        if (band === 'mentor') return 'Lifelong Focus Citation';
        return summary.title || 'Platinum Letter Sound Mastery';
      };

      const buildCertificateMessage = (summary, details) => {
        const base = summary.body || 'Completed the full phoneme circuit with Platinum mastery.';
        const fragments = [];
        const band = getCertificateAgeBand(details.ageNumber);
        if (band === 'junior') {
          fragments.push('Celebrated for playful curiosity and fearless repetition across the full alphabet.');
        } else if (band === 'teen') {
          fragments.push('Recognized for teen-level discipline, balancing calm energy with confident articulation.');
        } else if (band === 'apprentice') {
          fragments.push('Commended for emerging leadership in focus labs and steady vowel control.');
        } else if (band === 'adult') {
          fragments.push('Awarded for professional-grade consistency, mirroring every cue with calm authority.');
        } else if (band === 'mentor') {
          fragments.push('Honors lifelong dedication to breath-guided learning and community inspiration.');
        }

        const gender = details.genderNormalized;
        if (gender === 'female') {
          fragments.push('Her calm leadership anchored each tone throughout the Platinum spotlight.');
        } else if (gender === 'male') {
          fragments.push('His steady presence kept every phoneme aligned with the coaching cadence.');
        } else if (gender === 'non-binary') {
          fragments.push('Their adaptive focus showcased inclusive mastery across every consonant and vowel.');
        } else if (gender === 'unspecified') {
          fragments.push('This learner maintained purposeful poise across the entire recital.');
        }

        if (details.hasReligion) {
          fragments.push('Guided by personal faith and mindful breath, they modelled respectful excellence.');
        }

        if (!fragments.length) {
          fragments.push('This certificate affirms Platinum-level articulation discipline.');
        }

        return `${base} ${fragments.join(' ')}`.trim();
      };

      const createCertificatePayload = details => {
        const summary = getActiveCelebrationSummary();
        const issued = new Date();
        const ageNumber = clampCertificateAge(details.age);
        const genderNormalized = normalizeCertificateGender(details.gender);
        const hasReligion = Boolean(String(details.religion || '').trim());
        const normalizedDetails = {
          ageNumber,
          genderNormalized,
          hasReligion
        };
        return {
          name: details.name,
          title: buildCertificateTitle(normalizedDetails, summary),
          medalTitle: buildCertificateMedalTitle(summary.medal),
          message: buildCertificateMessage(summary, normalizedDetails),
          issuedDisplay: formatCertificateIssuedDate(issued),
          issuedDate: issued.toISOString(),
          certificateId: generateCertificateId(),
          details: {
            name: details.name,
            gender: details.gender || '',
            age: details.age || '',
            religion: details.religion || ''
          }
        };
      };

      const handleCertificateFormSubmit = evt => {
        evt.preventDefault();
        if (!letterSoundCertificateForm) return;
        if (!letterSoundCertificateForm.checkValidity()) {
          letterSoundCertificateForm.reportValidity();
          return;
        }
        const formData = new FormData(letterSoundCertificateForm);
        const name = String(formData.get('certificateName') || '').trim();
        const gender = String(formData.get('certificateGender') || '').trim();
        const rawAge = String(formData.get('certificateAge') ?? '').trim();
        const ageValue = rawAge ? Number(rawAge) : NaN;
        const religion = String(formData.get('certificateReligion') || '').trim();
        if (!name) {
          letterSoundCertificateForm.reportValidity();
          return;
        }
        const age = Number.isFinite(ageValue) ? String(Math.min(120, Math.max(3, Math.round(ageValue)))) : '';
        const payload = createCertificatePayload({ name, gender, age, religion });
        renderCertificatePreview(payload);
      };

      const handleCertificateEditClick = () => {
        const prompt = certificateState.data
          ? 'Update any detail and regenerate your certificate when ready.'
          : 'Add your details below to mint a NeuroBreath Academy certificate.';
        showCertificateCollection({ preserveValues: Boolean(certificateState.data), prompt });
      };

      const handleCertificatePrintClick = () => {
        if (!certificateState.data) {
          showCertificateCollection();
          return;
        }
        window.print();
      };

      const applyCelebrationMedalTheme = medal => {
        if (letterSoundCelebration) {
          if (medal) {
            letterSoundCelebration.dataset.medal = medal.theme || 'default';
          } else {
            letterSoundCelebration.dataset.medal = 'default';
          }
        }
        if (letterSoundMedalLabel) {
          if (medal?.name) {
            const tagline = medal.tagline ? ` · ${medal.tagline}` : '';
            letterSoundMedalLabel.textContent = `${medal.icon || ''} ${medal.name}${tagline}`.trim();
            letterSoundMedalLabel.removeAttribute('hidden');
          } else {
            letterSoundMedalLabel.textContent = '';
            letterSoundMedalLabel.setAttribute('hidden', 'hidden');
          }
        }
      };

      const resetLetterSoundMilestoneProgress = () => {
        reachedLetterSoundMilestones.clear();
        letterSoundState.activeCelebration = null;
      };

      const setCelebrationContinueAvailability = (isEnabled, label) => {
        if (!letterSoundContinueBtn) return;
        letterSoundContinueBtn.disabled = !isEnabled;
        const nextLabel = label || (isEnabled ? letterSoundContinueDefaultLabel : 'Celebrating…');
        letterSoundContinueBtn.textContent = nextLabel;
      };

      const setCelebrationState = state => {
        if (!letterSoundCelebration) return;
        if (!state) {
          letterSoundCelebration.removeAttribute('data-state');
          return;
        }
        letterSoundCelebration.dataset.state = state;
      };

      const updateCelebrationClock = (remainingMs, totalMs) => {
        if (!letterSoundCelebrationClock) return;
        const total = Math.max(0, totalMs || 0);
        const remaining = Math.max(0, remainingMs || 0);
        const ratio = total > 0 ? remaining / total : 0;
        letterSoundCelebrationClock.style.setProperty('--clock-progress', ratio);
        if (letterSoundCelebrationClockValue) {
          letterSoundCelebrationClockValue.textContent = remaining > 0 ? String(Math.ceil(remaining / 1000)) : '0';
        }
      };

      const resetCelebrationClock = totalMs => {
        const total = Math.max(0, totalMs || 0);
        activeCelebrationTotalMs = total;
        activeCelebrationRemainingMs = total;
        updateCelebrationClock(total, total);
      };
      resetCelebrationClock(0);

      const speakCelebrationCopy = (copy, medal) => {
        if (!copy) return;
        const payload = [medal?.name ? `${medal.icon || ''} ${medal.name}` : '', copy.title, copy.body].filter(Boolean).join('. ');
        if (payload) speak(payload);
      };

      const releaseCelebrationLock = () => {
        if (letterSoundCelebrationUnlockTimer) {
          clearTimeout(letterSoundCelebrationUnlockTimer);
          letterSoundCelebrationUnlockTimer = null;
        }
        if (!letterSoundState.activeCelebration) {
          letterSoundState.activeCelebration = { milestone: null, locked: false };
        }
        if (!letterSoundState.activeCelebration.locked) {
          setCelebrationContinueAvailability(true);
          return;
        }
        letterSoundState.activeCelebration.locked = false;
        setCelebrationContinueAvailability(true);
      };

      const hideLetterSoundCelebration = () => {
        if (letterSoundCelebration) {
          letterSoundCelebration.classList.remove('is-visible');
          letterSoundCelebration.setAttribute('hidden', 'hidden');
        }
        hideLetterSoundBuzz();
        resetCelebrationVisuals();
        resetCertificateSection();
        applyCelebrationMedalTheme(null);
        if (letterSoundCelebrationUnlockTimer) {
          clearTimeout(letterSoundCelebrationUnlockTimer);
          letterSoundCelebrationUnlockTimer = null;
        }
        if (letterSoundCelebrationInterval) {
          clearInterval(letterSoundCelebrationInterval);
          letterSoundCelebrationInterval = null;
        }
        updateCelebrationTimerDisplay(0, 0);
        resetCelebrationClock(0);
        setCelebrationContinueAvailability(true);
        letterSoundState.activeCelebration = null;
        celebrationCountdownSettled = false;
        letterSoundState.hasCompletedCelebration = false;
      };

      const getCelebrationAudioCtx = () => {
        if (celebrationAudioCtx) {
          if (celebrationAudioCtx.state === 'suspended') celebrationAudioCtx.resume();
          return celebrationAudioCtx;
        }
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return null;
        celebrationAudioCtx = new AudioCtx();
        return celebrationAudioCtx;
      };

      const buildCelebrationNoiseBuffer = ctx => {
        const duration = 0.35;
        const buffer = ctx.createBuffer(1, Math.ceil(ctx.sampleRate * duration), ctx.sampleRate);
        const channel = buffer.getChannelData(0);
        for (let i = 0; i < channel.length; i += 1) {
          const decay = 1 - i / channel.length;
          channel[i] = (Math.random() * 2 - 1) * decay;
        }
        return buffer;
      };

      const buildCrowdBedBuffer = (ctx, duration = 3.5) => {
        const buffer = ctx.createBuffer(1, Math.ceil(ctx.sampleRate * duration), ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i += 1) {
          const t = i / data.length;
          const env = Math.pow(1 - t * 0.6, 2);
          const grain = (Math.random() * 2 - 1) * env;
          const mod = Math.sin(i / 30) * 0.08 + Math.sin(i / 90) * 0.12;
          data[i] = (grain * 0.65) + mod;
        }
        return buffer;
      };

      const getSnareNoiseBuffer = ctx => {
        if (snareNoiseBuffer) return snareNoiseBuffer;
        const duration = 0.25;
        const buffer = ctx.createBuffer(1, Math.ceil(ctx.sampleRate * duration), ctx.sampleRate);
        const channel = buffer.getChannelData(0);
        for (let i = 0; i < channel.length; i += 1) {
          const decay = 1 - i / channel.length;
          channel[i] = (Math.random() * 2 - 1) * decay;
        }
        snareNoiseBuffer = buffer;
        return buffer;
      };

      const playGoldenBuzz = () => {
        const ctx = getCelebrationAudioCtx();
        if (!ctx) return;
        const start = ctx.currentTime + 0.05;
        const osc = ctx.createOscillator();
        osc.type = 'sawtooth';
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0.0001, start);
        gain.gain.exponentialRampToValueAtTime(0.25, start + 0.28);
        gain.gain.exponentialRampToValueAtTime(0.0001, start + 1.25);
        osc.frequency.setValueAtTime(320, start);
        osc.frequency.exponentialRampToValueAtTime(720, start + 1.25);
        osc.connect(gain).connect(ctx.destination);
        osc.start(start);
        osc.stop(start + 1.3);
      };

      const playApplauseBurst = offset => {
        const ctx = getCelebrationAudioCtx();
        if (!ctx) return;
        celebrationNoiseBuffer = celebrationNoiseBuffer || buildCelebrationNoiseBuffer(ctx);
        const source = ctx.createBufferSource();
        source.buffer = celebrationNoiseBuffer;
        const gain = ctx.createGain();
        const t0 = ctx.currentTime + offset;
        gain.gain.setValueAtTime(0.0001, t0);
        gain.gain.linearRampToValueAtTime(0.18, t0 + 0.04);
        gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.38);
        source.connect(gain).connect(ctx.destination);
        source.start(t0);
        source.stop(t0 + 0.4);
      };

      const playApplauseSwell = () => {
        const ctx = getCelebrationAudioCtx();
        if (!ctx) return;
        celebrationNoiseBuffer = celebrationNoiseBuffer || buildCelebrationNoiseBuffer(ctx);
        const source = ctx.createBufferSource();
        source.buffer = celebrationNoiseBuffer;
        source.loop = true;
        source.loopEnd = celebrationNoiseBuffer.duration;
        const gain = ctx.createGain();
        const start = ctx.currentTime + 0.2;
        const end = start + 2.6;
        gain.gain.setValueAtTime(0.0001, start);
        gain.gain.linearRampToValueAtTime(0.12, start + 0.4);
        gain.gain.linearRampToValueAtTime(0.08, start + 1.8);
        gain.gain.exponentialRampToValueAtTime(0.0001, end);
        source.connect(gain).connect(ctx.destination);
        source.start(start);
        source.stop(end);
      };

      const playCrowdApplauseBed = () => {
        const ctx = getCelebrationAudioCtx();
        if (!ctx) return;
        crowdBedBuffer = crowdBedBuffer || buildCrowdBedBuffer(ctx);
        const source = ctx.createBufferSource();
        source.buffer = crowdBedBuffer;
        source.loop = true;
        const filter = ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.setValueAtTime(1300, ctx.currentTime);
        filter.Q = 1.2;
        const gain = ctx.createGain();
        const start = ctx.currentTime + 0.18;
        const end = start + 4.4;
        gain.gain.setValueAtTime(0.0001, start);
        gain.gain.linearRampToValueAtTime(0.24, start + 0.7);
        gain.gain.linearRampToValueAtTime(0.18, start + 2.8);
        gain.gain.exponentialRampToValueAtTime(0.0001, end);
        source.connect(filter).connect(gain).connect(ctx.destination);
        source.start(start);
        source.stop(end);
      };

      const playDrumHit = (type, offset = 0) => {
        const ctx = getCelebrationAudioCtx();
        if (!ctx) return;
        const start = ctx.currentTime + offset;
        if (type === 'kick') {
          const osc = ctx.createOscillator();
          osc.type = 'sine';
          const gain = ctx.createGain();
          osc.frequency.setValueAtTime(150, start);
          osc.frequency.exponentialRampToValueAtTime(45, start + 0.32);
          gain.gain.setValueAtTime(0.0001, start);
          gain.gain.exponentialRampToValueAtTime(0.8, start + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + 0.5);
          osc.connect(gain).connect(ctx.destination);
          osc.start(start);
          osc.stop(start + 0.5);
          return;
        }
        if (type === 'snare') {
          const noiseSource = ctx.createBufferSource();
          noiseSource.buffer = getSnareNoiseBuffer(ctx);
          const filter = ctx.createBiquadFilter();
          filter.type = 'highpass';
          filter.frequency.setValueAtTime(1200, start);
          const gain = ctx.createGain();
          gain.gain.setValueAtTime(0.0001, start);
          gain.gain.linearRampToValueAtTime(0.6, start + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + 0.25);
          noiseSource.connect(filter).connect(gain).connect(ctx.destination);
          noiseSource.start(start);
          noiseSource.stop(start + 0.3);
          return;
        }
        if (type === 'floor-tom') {
          const osc = ctx.createOscillator();
          osc.type = 'sine';
          const gain = ctx.createGain();
          osc.frequency.setValueAtTime(220, start);
          osc.frequency.exponentialRampToValueAtTime(90, start + 0.4);
          gain.gain.setValueAtTime(0.0001, start);
          gain.gain.linearRampToValueAtTime(0.7, start + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + 0.6);
          osc.connect(gain).connect(ctx.destination);
          osc.start(start);
          osc.stop(start + 0.6);
        }
      };

      const playCelebrationDrums = () => {
        playDrumHit('kick', 0.3);
        playDrumHit('snare', 0.85);
        playDrumHit('kick', 1.4);
        playDrumHit('snare', 1.95);
        playDrumHit('floor-tom', 2.6);
      };

      const playApplauseSequence = () => {
        [0.15, 0.35, 0.55, 0.8, 1.1, 1.45, 1.85, 2.3, 2.8].forEach(delay => playApplauseBurst(delay));
        playApplauseSwell();
        playCrowdApplauseBed();
        playCelebrationDrums();
      };

      const triggerLetterSoundCelebration = (celebrationCopy, options = {}) => {
        if (letterSoundState.hasCompletedCelebration) return;
        const durationMs = options.durationMs ?? LETTER_SOUND_CELEBRATION_DURATION;
        const medal = options.medal || null;
        const copy = celebrationCopy || buildLetterSoundCelebrationCopy(Math.max(1, letterSoundState.completionCount || 1));
        letterSoundState.hasCompletedCelebration = true;
        letterSoundState.activeCelebration = { milestone: options.milestone || null, locked: true };
        applyCelebrationMedalTheme(medal);
        if (letterSoundCelebrationTitle && copy?.title) letterSoundCelebrationTitle.textContent = copy.title;
        if (letterSoundCelebrationBody && copy?.body) letterSoundCelebrationBody.textContent = copy.body;
        if (letterSoundCelebration) {
          letterSoundCelebration.removeAttribute('hidden');
          requestAnimationFrame(() => letterSoundCelebration.classList.add('is-visible'));
        }
        showLetterSoundBuzz(buildBuzzContentForCelebration(copy, medal));
        applyCelebrationAtmosphere('active');
        highlightCelebrationMessage(true);
        setCelebrationState('active');
        setCelebrationContinueAvailability(false);
        startCelebrationCountdown(durationMs);
        speakCelebrationCopy(copy, medal);
        playGoldenBuzz();
        setTimeout(playApplauseSequence, 220);
      };

      const completeLetterSoundSequence = () => {
        if (letterSoundState.hasCompletedCelebration) return;
        letterSoundState.completionCount = (letterSoundState.completionCount || 0) + 1;
        syncLetterSoundProgress();
        if (letterSoundAudio && !letterSoundAudio.paused) {
          letterSoundAudio.pause();
        }
        resetLetterClipState();
        setLetterSoundPauseState(true);
        setLetterSoundVisual(completionLetter, 'rest', { forceShape: true });
        showLetterSoundCompletionMessage();
        const celebrationCopy = buildLetterSoundCelebrationCopy(letterSoundState.completionCount);
        triggerLetterSoundCelebration(celebrationCopy, { durationMs: letterSoundFinalCelebrationConfig.durationMs, milestone: letterSoundFinalCelebrationConfig });
      };

      const formatSeconds = secs => `${String(Math.max(0, secs)).padStart(2, '0')}s`;

      const formatOrdinal = value => {
        const num = Math.max(1, Math.floor(Number(value) || 0));
        const mod100 = num % 100;
        if (mod100 >= 11 && mod100 <= 13) return `${num}th`;
        const mod10 = num % 10;
        if (mod10 === 1) return `${num}st`;
        if (mod10 === 2) return `${num}nd`;
        if (mod10 === 3) return `${num}rd`;
        return `${num}th`;
      };

      const celebrationTemplates = [
        {
          title: '{ordinal} Golden Buzz secured',
          body: 'Your articulation lab just finished its {ordinal} glide through every phoneme. Breath, jaw, and rhythm stayed perfectly aligned.'
        },
        {
          title: 'Sound scientist level {count}',
          body: 'Run #{count} proves you can mirror every mouth cue with calm focus. That’s the kind of mastery coaches celebrate.'
        },
        {
          title: 'All-mouth mastery unlocked',
          body: 'From A to Z you kept the buzz steady and the vowels silky. Lock this {ordinal} win in your memory—then go again when ready.'
        },
        {
          title: 'Coach-approved brilliance',
          body: 'Coach Dorothy logged your {ordinal} flawless recital. Take a bow, hydrate, and let the applause soak in before the next rep.'
        },
        {
          title: '{ordinal} circuit complete',
          body: 'Every consonant pop and vowel glide stayed on tempo. That consistency is the superpower that carries into reading aloud.'
        }
      ];

      const fillCelebrationTemplate = (template, data) => template.replace(/\{(\w+)\}/g, (_, key) => data[key] ?? '');

      const pickCelebrationTemplate = () => {
        if (!celebrationTemplates.length) return null;
        let index = Math.floor(Math.random() * celebrationTemplates.length);
        if (celebrationTemplates.length > 1 && index === letterSoundState.lastCelebrationIndex) {
          index = (index + 1) % celebrationTemplates.length;
        }
        letterSoundState.lastCelebrationIndex = index;
        return celebrationTemplates[index];
      };

      const buildLetterSoundCelebrationCopy = count => {
        const template = pickCelebrationTemplate() || celebrationTemplates[0];
        const ordinal = formatOrdinal(count);
        const data = { count, ordinal };
        return {
          title: fillCelebrationTemplate(template.title, data),
          body: fillCelebrationTemplate(template.body, data)
        };
      };

      const updateCelebrationTimerDisplay = (remainingMs, totalMs) => {
        if (!letterSoundCelebrationTimerLabel) return;
        const totalSeconds = Math.max(0, Math.round((totalMs || 0) / 1000));
        const remainingSeconds = Math.max(0, Math.ceil((remainingMs || 0) / 1000));
        if (!totalSeconds || remainingSeconds <= 0) {
          letterSoundCelebrationTimerLabel.textContent = 'Celebration pause finished — tap Continue when you are ready.';
          return;
        }
        letterSoundCelebrationTimerLabel.textContent = `Celebration pause: ${remainingSeconds}s of ${totalSeconds}s remaining.`;
      };

      const finishCelebrationCountdown = () => {
        if (celebrationCountdownSettled) return;
        celebrationCountdownSettled = true;
        if (letterSoundCelebrationInterval) {
          clearInterval(letterSoundCelebrationInterval);
          letterSoundCelebrationInterval = null;
        }
        if (letterSoundCelebrationUnlockTimer) {
          clearTimeout(letterSoundCelebrationUnlockTimer);
          letterSoundCelebrationUnlockTimer = null;
        }
        const isFinalCelebration = isActiveCelebrationFinal();
        activeCelebrationRemainingMs = 0;
        updateCelebrationTimerDisplay(0, activeCelebrationTotalMs);
        updateCelebrationClock(0, activeCelebrationTotalMs);
        calmCelebrationVisuals();
        if (isFinalCelebration) {
          showCertificateCollection();
          if (letterSoundCelebrationTimerLabel) {
            letterSoundCelebrationTimerLabel.textContent = 'Platinum spotlight complete — enter your details to mint the certificate or tap Continue to reset.';
          }
        }
        releaseCelebrationLock();
        if (isFinalCelebration) {
          setCelebrationContinueAvailability(true, 'Skip certificate & restart');
        }
      };

      const startCelebrationCountdown = (durationMs = LETTER_SOUND_CELEBRATION_DURATION) => {
        if (letterSoundCelebrationInterval) {
          clearInterval(letterSoundCelebrationInterval);
          letterSoundCelebrationInterval = null;
        }
        if (letterSoundCelebrationUnlockTimer) {
          clearTimeout(letterSoundCelebrationUnlockTimer);
          letterSoundCelebrationUnlockTimer = null;
        }
        celebrationCountdownSettled = false;
        const totalMs = Math.max(0, durationMs);
        resetCelebrationClock(totalMs);
        if (totalMs === 0) {
          updateCelebrationTimerDisplay(0, 0);
          calmCelebrationVisuals();
          releaseCelebrationLock();
          return;
        }
        activeCelebrationRemainingMs = totalMs;
        updateCelebrationTimerDisplay(activeCelebrationRemainingMs, activeCelebrationTotalMs);
        letterSoundCelebrationInterval = setInterval(() => {
          activeCelebrationRemainingMs = Math.max(0, activeCelebrationRemainingMs - 1000);
          updateCelebrationTimerDisplay(activeCelebrationRemainingMs, activeCelebrationTotalMs);
          updateCelebrationClock(activeCelebrationRemainingMs, activeCelebrationTotalMs);
          if (activeCelebrationRemainingMs <= 0) {
            finishCelebrationCountdown();
          }
        }, 1000);
        letterSoundCelebrationUnlockTimer = setTimeout(() => {
          letterSoundCelebrationUnlockTimer = null;
          finishCelebrationCountdown();
        }, totalMs);
      };

      const applyCelebrationAtmosphere = mode => {
        const normalized = mode === 'calm' ? 'calm' : mode ? 'active' : 'off';
        const isActive = normalized === 'active' || normalized === 'calm';
        const isCalm = normalized === 'calm';
        letterSoundPanel?.classList.toggle('is-celebrating', isActive);
        letterSoundPanel?.classList.toggle('is-celebration-calm', isCalm);
        letterSoundScreen?.classList.toggle('is-celebrating', isActive);
      };

      const resetLetterSoundSequenceToStart = () => {
        ensureLetterSoundCues();
        if (letterSoundAudio) {
          letterSoundAudio.pause();
          letterSoundAudio.currentTime = 0;
          resetLetterClipState();
        }
        resetLetterSoundMilestoneProgress();
        resetCelebrationVisuals();
        resetCertificateSection();
        applyCelebrationMedalTheme(null);
        setLetterSoundBuzzContent();
        letterSoundState.currentLetter = 'A';
        letterSoundState.currentPhase = 'rest';
        letterSoundState.hasCompletedCelebration = false;
        celebrationCountdownSettled = false;
        resetCelebrationClock(0);
        setLetterSoundPauseState(true);
        setLetterSoundVisual('A', 'rest', { forceShape: true });
        updateLetterSoundGridHighlight('A');
        syncLetterSoundProgress();
      };

      const ensurePhonicsCues = () => {
        if (phonicsCueState.ready) {
          if (!phonicsCueState.loading) {
            phonicsCueState.loading = Promise.resolve(phonicsCueState);
          }
          return phonicsCueState.loading;
        }
        if (phonicsCueState.loading) return phonicsCueState.loading;
        const isFileProtocol = typeof window !== 'undefined' && window.location?.protocol === 'file:';
        if (isFileProtocol && useInlinePhonicsCues()) {
          return phonicsCueState.loading;
        }
        phonicsCueState.loading = fetch(phonicsCueUrl)
          .then(resp => {
            if (!resp.ok) throw new Error(`Cue load failed: ${resp.status}`);
            return resp.json();
          })
          .then(data => {
            applyPhonicsCueData(data);
            phonicsCueState.source = 'remote';
            return phonicsCueState;
          })
          .catch(err => {
            console.warn('Phonics cues unavailable', err);
            if (!phonicsCueState.ready && !useInlinePhonicsCues()) {
              throw err;
            }
            return phonicsCueState;
          });
        return phonicsCueState.loading;
      };

      ensurePhonicsCues();

      const updateSoundQuestUI = () => {
        const level = state.soundQuest.level || 0;
        if (soundQuestLevelLabel) soundQuestLevelLabel.textContent = `Level ${level} / ${SOUND_GRAD_LEVEL}`;
        if (soundQuestProgress) {
          soundQuestProgress.max = SOUND_GRAD_LEVEL;
          soundQuestProgress.value = Math.min(SOUND_GRAD_LEVEL, level);
        }
        if (soundQuestStatus) {
          if (level >= SOUND_GRAD_LEVEL) {
            soundQuestStatus.textContent = 'Graduation level complete. Keep revisiting clues for mastery.';
          } else {
            soundQuestStatus.textContent = `Working toward Level ${level + 1}. Lock a sound to climb.`;
          }
        }
        if (soundQuestReward) {
          if (level >= SOUND_GRAD_LEVEL) {
            soundQuestReward.textContent = 'Graduation unlocked. Re-run clues anytime to keep mastery polished.';
          } else {
            soundQuestReward.textContent = 'Every level triggers a custom scratch reward. Lock a sound when you feel ready.';
          }
        }
      };

      const setSoundQuestTimerDisplay = () => {
        if (soundQuestTimerBar) {
          soundQuestTimerBar.max = SOUND_ROUND_SECONDS;
          soundQuestTimerBar.value = SOUND_ROUND_SECONDS - soundQuestRemaining;
        }
        if (soundQuestTimer) soundQuestTimer.textContent = formatSeconds(soundQuestRemaining);
      };

      const pickSoundQuestCard = () => {
        const pool = soundMemoryDeck;
        if (!pool.length) return null;
        let card = pool[Math.floor(Math.random() * pool.length)];
        const lastLetter = state.soundQuest.lastCard;
        if (pool.length > 1) {
          let safety = 0;
          while (card.letter === lastLetter && safety < 10) {
            card = pool[Math.floor(Math.random() * pool.length)];
            safety += 1;
          }
        }
        return card;
      };

      const renderSoundQuestCard = (card, silent = false) => {
        if (!card) return;
        currentSoundQuestCard = card;
        state.soundQuest.lastCard = card.letter;
        if (memoryEmoji) memoryEmoji.textContent = card.emoji || '🔤';
        if (memoryLetter) memoryLetter.textContent = `${card.letter} / ${card.letter.toLowerCase()}`;
        if (memoryClue) memoryClue.textContent = card.clue;
        soundQuestRemaining = SOUND_ROUND_SECONDS;
        setSoundQuestTimerDisplay();
        if (!silent && card.speech) speak(card.speech);
        persist();
      };

      const loadSoundQuestCard = (silent = false) => {
        const card = pickSoundQuestCard();
        renderSoundQuestCard(card, silent);
      };

      const clearSoundQuestTimer = () => {
        if (soundQuestTimerId) {
          clearInterval(soundQuestTimerId);
          soundQuestTimerId = null;
        }
      };

      const handleLetterChipTap = letter => {
        if (!letter) return;
        pausePhonicsSong();
        resetPhonicsSongToLetter(letter);
        const script = phonicsLetterVisuals[letter]?.lyric || `${letter} makes its phonics sound.`;
        speak(script);
      };

      const buildPhonicsSongWave = () => {
        if (!phonicsSongWave) return;
        phonicsSongWave.innerHTML = '';
        const fragment = document.createDocumentFragment();
        phonicsSongSequence.filter(item => item.type === 'letter').forEach(item => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.textContent = item.letter;
          chip.className = 'dlx-song-chip';
          chip.dataset.songLetterChip = item.letter;
          chip.addEventListener('click', () => handleLetterChipTap(item.letter));
          fragment.appendChild(chip);
        });
        phonicsSongWave.appendChild(fragment);
      };

      const updatePhonicsSongVisual = index => {
        const entry = phonicsSongSequence[index] || phonicsSongSequence[0];
        phonicsSongState.currentIndex = index;
        if (!entry) return;
        if (phonicsSongLetter) {
          phonicsSongLetter.classList.toggle('is-letter-animated', entry.type === 'letter');
        }
        if (phonicsSongLyric) phonicsSongLyric.textContent = entry.type === 'letter' ? phonicsLetterVisuals[entry.letter]?.lyric || '' : entry.text;
        if (!phonicsSongLetterCard) return;
        phonicsSongLetterCard.classList.remove('is-vowel', 'is-consonant', 'is-pulsing');
        if (entry.type === 'letter' && phonicsLetterVisuals[entry.letter]) {
          const data = phonicsLetterVisuals[entry.letter];
          phonicsSongState.lastLetter = entry.letter;
          phonicsSongLetterCard.classList.add(`is-${data.type}`);
          phonicsSongLetterCard.classList.add('is-pulsing');
          if (phonicsSongLetter) phonicsSongLetter.textContent = entry.letter;
          if (phonicsSongIcon) phonicsSongIcon.textContent = data.icon || '🎵';
          if (phonicsSongWord) phonicsSongWord.textContent = data.word;
        } else {
          const heldLetter = phonicsSongState.lastLetter || 'A';
          const fallback = phonicsLetterVisuals[heldLetter] || phonicsLetterVisuals.A;
          if (fallback) {
            phonicsSongLetterCard.classList.add(`is-${fallback.type}`);
            phonicsSongLetterCard.classList.add('is-pulsing');
            if (phonicsSongLetter) phonicsSongLetter.textContent = heldLetter;
            if (phonicsSongIcon) phonicsSongIcon.textContent = fallback.icon || '🎵';
            if (phonicsSongWord) phonicsSongWord.textContent = fallback.word;
          }
        }
        els('[data-song-letter-chip]').forEach(chip => {
          chip.classList.toggle('is-active', entry.type === 'letter' && chip.dataset.songLetterChip === entry.letter);
        });
      };

      const setPhonicsVisualForLetter = letter => {
        if (!letter) return false;
        const index = phonicsLetterIndex[letter.toUpperCase()];
        if (typeof index !== 'number') return false;
        phonicsSongState.lastLetter = letter.toUpperCase();
        if (index === phonicsSongState.currentIndex) return true;
        updatePhonicsSongVisual(index);
        return true;
      };

      const getPhonicsCueForTime = secs => {
        if (!phonicsCueState.ready) return null;
        return phonicsCueState.timeline.find(entry => secs >= entry.start && secs < entry.end) || null;
      };

      const resetPhonicsSongToLetter = (letter = 'A', autoplay = false) => {
        if (!phonicsAudio) return;
        const cue = phonicsCueState.map[letter.toUpperCase()] || null;
        const targetTime = cue ? cue.start : (letter.toUpperCase() === 'A' ? (phonicsCueState.intro.end || 0) : 0);
        phonicsAudio.currentTime = Math.max(0, targetTime);
        if (!setPhonicsVisualForLetter(letter)) {
          const fallbackIndex = phonicsLetterIndex[letter.toUpperCase()];
          if (typeof fallbackIndex === 'number') {
            updatePhonicsSongVisual(fallbackIndex);
          } else {
            updatePhonicsSongVisual(0);
          }
        }
        syncPhonicsSongProgress();
        if (autoplay) playPhonicsSong();
      };

      

      const syncPhonicsSongProgress = () => {
        if (!phonicsAudio) return;
        const duration = phonicsAudio.duration || 0;
        const current = phonicsAudio.currentTime || 0;
        if (phonicsSongProgress && duration) {
          phonicsSongProgress.value = String(Math.min(1000, Math.round((current / duration) * 1000)));
        }
        if (phonicsSongTime) phonicsSongTime.textContent = formatTime(Math.floor(current));
        if (!phonicsSongSequence.length) return;
        let visualSynced = false;
        if (phonicsCueState.ready) {
          const cue = getPhonicsCueForTime(current);
          if (cue?.type === 'letter') {
            visualSynced = setPhonicsVisualForLetter(cue.letter);
          } else if (cue?.type === 'intro' && phonicsSongState.currentIndex !== 0) {
            updatePhonicsSongVisual(0);
            visualSynced = true;
          }
        }
        if (!visualSynced && duration) {
          const index = Math.min(phonicsSongSequence.length - 1, Math.floor((current / duration) * phonicsSongSequence.length));
          if (index !== phonicsSongState.currentIndex) {
            updatePhonicsSongVisual(index);
          }
        }
      };

      const playPhonicsSong = () => {
        if (!phonicsAudio) return;
        setPhonicsPauseState(false);
        const playPromise = phonicsAudio.play();
        if (playPromise?.catch) {
          playPromise.catch(err => {
            console.warn('Audio blocked', err);
            setPhonicsPauseState(true);
          });
        }
      };

      const pausePhonicsSong = () => {
        if (!phonicsAudio) return;
        phonicsAudio.pause();
        setPhonicsPauseState(true);
      };

      const togglePhonicsSongPause = () => {
        if (!phonicsAudio) return;
        if (!phonicsSongState.isPaused) {
          pausePhonicsSong();
          return;
        }
        if (phonicsAudio.currentTime >= (phonicsAudio.duration || 0) && phonicsAudio.duration) {
          phonicsAudio.currentTime = Math.max(0, phonicsAudio.duration - 0.05);
        }
        playPhonicsSong();
      };

      const openPhonicsSongScreen = () => {
        if (!phonicsSongScreen) return;
        phonicsSongScreen.removeAttribute('hidden');
        if (!phonicsSongWave?.childElementCount) {
          buildPhonicsSongWave();
        }
        phonicsSongState.currentIndex = 0;
        phonicsSongState.lastLetter = 'A';
        if (phonicsAudio) phonicsAudio.currentTime = 0;
        updatePhonicsSongVisual(0);
        syncPhonicsSongProgress();
      };

      const closePhonicsSongScreen = () => {
        phonicsSongScreen?.setAttribute('hidden', 'hidden');
        pausePhonicsSong();
      };

      const restartPhonicsSong = () => {
        resetPhonicsSongToLetter('A', true);
      };

      const LETTER_SOUND_FALLBACK_SPACING = 2.3;

      const getMouthShapeForLetter = letter => {
        const upper = (letter || '').toUpperCase();
        return letterMouthShapeMap[upper] || (['A', 'E', 'I', 'O', 'U'].includes(upper) ? 'open-round' : 'neutral');
      };

      const getHeadVariantForLetter = letter => {
        if (!letter) return talkingHeadVariants[0].id;
        const index = alphabetLetters.indexOf(letter.toUpperCase());
        if (index === -1) return talkingHeadVariants[0].id;
        const variantIndex = (index + letterSoundState.variantOffset + talkingHeadVariants.length * 3) % talkingHeadVariants.length;
        return talkingHeadVariants[variantIndex].id;
      };

      const getVariantAccessory = id => (talkingHeadVariants.find(item => item.id === id)?.accessory) || '⭐';

      const setLetterSoundPauseState = isPaused => {
        letterSoundState.isPaused = Boolean(isPaused);
        if (!letterSoundPauseBtn) return;
        const label = letterSoundState.isPaused ? 'Continue' : 'Pause';
        letterSoundPauseBtn.textContent = label;
        letterSoundPauseBtn.setAttribute('aria-label', letterSoundState.isPaused ? 'Continue letter sounds' : 'Pause letter sounds');
      };

      const updateLetterSoundGridHighlight = letter => {
        Object.entries(letterSoundState.gridButtons).forEach(([key, btn]) => {
          if (!btn) return;
          const isActive = key === letter;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-pressed', String(isActive));
        });
      };

      const setLetterSoundVisual = (letter, phase = 'call', options = {}) => {
        const upper = (letter || 'A').toUpperCase();
        const previousLetter = letterSoundState.currentLetter;
        const previousPhase = letterSoundState.currentPhase;
        const letterChanged = previousLetter !== upper;
        const phaseChanged = previousPhase !== phase;
        letterSoundState.currentLetter = upper;
        letterSoundState.currentPhase = phase;
        const variant = getHeadVariantForLetter(upper);
        const shape = getPhaseShapeForLetter(upper, phase);
        if (letterSoundHead && (letterChanged || phaseChanged || options.forceShape)) {
          letterSoundHead.dataset.variant = variant;
          letterSoundHead.dataset.mouthShape = shape;
          letterSoundHead.dataset.mouthPhase = phase;
          const shouldAnimate = letterChanged || (phaseChanged && phase === 'call');
          if (shouldAnimate) {
            letterSoundHead.classList.remove('is-speaking');
            if (letterSoundState.speakingTimeout) clearTimeout(letterSoundState.speakingTimeout);
            requestAnimationFrame(() => {
              letterSoundHead.classList.add('is-speaking');
              const duration = phase === 'repeat' ? 750 : 950;
              letterSoundState.speakingTimeout = setTimeout(() => {
                letterSoundHead.classList.remove('is-speaking');
              }, duration);
            });
          }
        } else if (letterSoundHead && (letterChanged || phaseChanged)) {
          letterSoundHead.dataset.variant = variant;
          letterSoundHead.dataset.mouthShape = shape;
          letterSoundHead.dataset.mouthPhase = phase;
        }
        if (letterSoundAccessory && letterChanged) letterSoundAccessory.textContent = getVariantAccessory(variant);
        if (letterSoundLetter && letterChanged) letterSoundLetter.textContent = `${upper} / ${upper.toLowerCase()}`;
        const visual = phonicsLetterVisuals[upper];
        if (letterSoundWord && letterChanged) letterSoundWord.textContent = visual ? `${visual.icon || ''} ${visual.word}`.trim() : 'Phonics focus';
        if (letterSoundTip && (letterChanged || phaseChanged)) {
          letterSoundTip.textContent = mouthShapeTips[shape] || mouthShapeTips.neutral;
        }
        if (letterChanged) updateLetterSoundGridHighlight(upper);
      };

      const playDorothyLetterClip = (letter, options = {}) => {
        if (!letterSoundAudio || !letter) return false;
        ensureLetterSoundCues();
        const upper = String(letter).toUpperCase();
        const cue = letterSoundCueState.map[upper];
        if (!cue) return false;
        const start = Number.isFinite(cue.start) ? cue.start : 0;
        const cueEnd = Number.isFinite(cue.repeatEnd) ? cue.repeatEnd : Number.isFinite(cue.end) ? cue.end : null;
        const minDuration = Number.isFinite(options.minDuration)
          ? options.minDuration
          : vowelLetters.has(upper)
            ? VOWEL_CLIP_MIN_DURATION
            : LETTER_CLIP_MIN_DURATION;
        const fallbackEnd = Number.isFinite(cueEnd) ? cueEnd : start + minDuration;
        const offset = Number.isFinite(options.offset) ? options.offset : LETTER_CLIP_OFFSET;
        letterSoundAudio.pause();
        letterSoundAudio.currentTime = Math.max(0, start + offset);
        letterClipState.activeLetter = upper;
        letterClipState.source = options.source || 'letter-chip';
        scheduleLetterClipStop(fallbackEnd);
        if (options.button) setLetterClipActiveButton(options.button);
        setLetterSoundVisual(upper, 'call', { forceShape: true });
        playLetterSoundAudio();
        return true;
      };

      const syncLetterSoundProgress = () => {
        if (!letterSoundAudio) return;
        const duration = letterSoundAudio.duration || 0;
        const current = letterSoundAudio.currentTime || 0;
        if (letterSoundProgress && duration) {
          letterSoundProgress.value = String(Math.min(1000, Math.round((current / duration) * 1000)));
        }
        if (letterSoundTime) letterSoundTime.textContent = formatTime(Math.floor(current));
      };

      const playLetterSoundAudio = () => {
        if (!letterSoundAudio) return;
        setLetterSoundPauseState(false);
        const playPromise = letterSoundAudio.play();
        if (playPromise?.catch) {
          playPromise.catch(err => {
            console.warn('Letter sound audio blocked', err);
            setLetterSoundPauseState(true);
          });
        }
      };

      const pauseLetterSoundAudio = () => {
        if (!letterSoundAudio) return;
        letterSoundAudio.pause();
        resetLetterClipState();
        setLetterSoundPauseState(true);
      };

      const toggleLetterSoundPause = () => {
        if (!letterSoundAudio) return;
        if (letterSoundState.isPaused) {
          playLetterSoundAudio();
        } else {
          pauseLetterSoundAudio();
        }
      };

      const getLetterCueStart = letter => {
        const upper = (letter || 'A').toUpperCase();
        ensureLetterSoundCues();
        const cue = letterSoundCueState.map[upper];
        if (cue) return cue.start;
        const index = alphabetLetters.indexOf(upper);
        if (index === -1) return 0;
        if (letterSoundAudio?.duration) {
          const spacing = letterSoundAudio.duration / alphabetLetters.length;
          return spacing * index;
        }
        return index * LETTER_SOUND_FALLBACK_SPACING;
      };

      const getLetterSoundPhase = (letter, absoluteTime) => {
        const upper = (letter || 'A').toUpperCase();
        ensureLetterSoundCues();
        const cue = letterSoundCueState.map[upper];
        if (!cue) return 'call';
        const time = Number(absoluteTime);
        if (Number.isFinite(cue.repeatStart) && time >= cue.repeatStart && time < (cue.repeatEnd ?? cue.end)) {
          return 'repeat';
        }
        if (Number.isFinite(cue.callEnd) && time >= cue.callEnd && (!cue.repeatStart || time < cue.repeatStart)) {
          return 'hold';
        }
        if (time >= (cue.end || cue.start)) return 'rest';
        return 'call';
      };

      const jumpLetterSoundTo = (letter, autoplay = false) => {
        if (!letterSoundAudio) return;
        hideLetterSoundCelebration();
        ensureLetterSoundCues();
        const targetTime = getLetterCueStart(letter);
        letterSoundAudio.currentTime = Math.max(0, targetTime);
        const phase = getLetterSoundPhase(letter, letterSoundAudio.currentTime);
        setLetterSoundVisual(letter, phase, { forceShape: true });
        syncLetterSoundProgress();
        if (autoplay) playLetterSoundAudio();
      };

      const getLetterSoundMilestone = letter => letterSoundMilestoneMap[(letter || '').toUpperCase()] || null;

      const resumeLetterSoundFromMilestone = milestone => {
        if (!letterSoundAudio || !milestone) return;
        const resumeTime = Number.isFinite(milestone.resumeTime) ? milestone.resumeTime : getLetterCueStart(milestone.resumeLetter);
        if (Number.isFinite(resumeTime)) {
          letterSoundAudio.currentTime = Math.max(0, resumeTime);
        }
        if (milestone.resumeLetter) {
          setLetterSoundVisual(milestone.resumeLetter, 'call', { forceShape: true });
          letterSoundState.currentLetter = milestone.resumeLetter;
        }
        syncLetterSoundProgress();
        playLetterSoundAudio();
      };

      const evaluateLetterSoundMilestones = (letter, currentTime) => {
        const evaluationLetter = (letter || letterSoundState.currentLetter || '').toUpperCase();
        if (!evaluationLetter) return;
        const milestone = getLetterSoundMilestone(evaluationLetter);
        if (!milestone || reachedLetterSoundMilestones.has(milestone.id)) return;
        ensureLetterSoundCues();
        const cue = letterSoundCueState.map[evaluationLetter];
        const repeatEnd = Number.isFinite(cue?.repeatEnd) ? cue.repeatEnd : null;
        const cueEnd = repeatEnd ?? (Number.isFinite(cue?.end) ? cue.end : Number.isFinite(cue?.callEnd) ? cue.callEnd : null);
        const fallbackEnd = Number.isFinite(cueEnd)
          ? cueEnd
          : getLetterCueStart(evaluationLetter) + LETTER_SOUND_FALLBACK_SPACING;
        const requestedPause = Number.isFinite(Number(milestone.pauseTime)) ? Number(milestone.pauseTime) : null;
        const pauseDelay = Number.isFinite(Number(milestone.pauseDelay)) ? Number(milestone.pauseDelay) : 0;
        const triggerPoint = (requestedPause ?? fallbackEnd) + pauseDelay;
        const finalTrigger = Math.max(triggerPoint || 0, fallbackEnd || 0);
        if (currentTime >= finalTrigger) {
          reachedLetterSoundMilestones.add(milestone.id);
          pauseLetterSoundAudio();
          const copy = milestone.copy || {
            title: `${milestone.label} complete`,
            body: 'Take a short celebration pause, then continue when you are ready.'
          };
          triggerLetterSoundCelebration(copy, { durationMs: milestone.durationMs, milestone });
        }
      };

      const buildLetterSoundGrid = () => {
        if (!letterSoundGrid) return;
        letterSoundGrid.innerHTML = '';
        letterSoundState.gridButtons = {};
        alphabetLetters.forEach(letter => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'dlx-letter-sound-chip';
          btn.dataset.letterSoundChip = letter;
          btn.setAttribute('aria-pressed', 'false');
          btn.innerHTML = `<span class="dlx-letter-sound-chip__upper">${letter}</span><span class="dlx-letter-sound-chip__lower">${letter.toLowerCase()}</span>`;
          btn.addEventListener('click', () => {
            ensureLetterSoundCues();
            jumpLetterSoundTo(letter, true);
          });
          letterSoundState.gridButtons[letter] = btn;
          letterSoundGrid.appendChild(btn);
        });
        updateLetterSoundGridHighlight(letterSoundState.currentLetter);
      };

      const startLetterSoundSequence = () => {
        hideLetterSoundCelebration();
        ensureLetterSoundCues();
        jumpLetterSoundTo('A');
        playLetterSoundAudio();
      };

      const restartLetterSoundSequence = () => {
        hideLetterSoundCelebration();
        jumpLetterSoundTo('A');
        playLetterSoundAudio();
      };

      const shuffleLetterSoundHead = () => {
        letterSoundState.variantOffset = (letterSoundState.variantOffset + 1) % talkingHeadVariants.length;
        setLetterSoundVisual(letterSoundState.currentLetter, letterSoundState.currentPhase || 'call', { forceShape: true });
        letterSoundHead?.classList.add('is-shuffling');
        setTimeout(() => letterSoundHead?.classList.remove('is-shuffling'), 600);
      };

      const openLetterSoundScreen = () => {
        if (!letterSoundScreen) return;
        hideLetterSoundCelebration();
        ensureLetterSoundCues();
        if (!letterSoundGrid?.childElementCount) buildLetterSoundGrid();
        setLetterSoundVisual(letterSoundState.currentLetter || 'A', 'rest', { forceShape: true });
        if (letterSoundAudio) {
          letterSoundAudio.currentTime = getLetterCueStart(letterSoundState.currentLetter);
        }
        syncLetterSoundProgress();
        setLetterSoundPauseState(true);
        pauseLetterSoundAudio();
        letterSoundScreen.removeAttribute('hidden');
      };

      const closeLetterSoundScreen = () => {
        pauseLetterSoundAudio();
        letterSoundScreen?.setAttribute('hidden', 'hidden');
        hideLetterSoundCelebration();
        setLetterSoundVisual(letterSoundState.currentLetter, 'rest', { forceShape: true });
      };

      const startSoundQuestTimer = () => {
        clearSoundQuestTimer();
        soundQuestActive = true;
        soundQuestTimerId = setInterval(() => {
          soundQuestRemaining -= 1;
          setSoundQuestTimerDisplay();
          if (soundQuestRemaining <= 0) {
            loadSoundQuestCard();
          }
        }, 1000);
      };

      const pauseSoundQuest = () => {
        soundQuestActive = false;
        clearSoundQuestTimer();
        if (soundQuestStatus) soundQuestStatus.textContent = 'Paused. Tap play to keep the mnemonic tour going.';
      };

      const stopSoundQuest = () => {
        pauseSoundQuest();
        currentSoundQuestCard = null;
        if (memoryEmoji) memoryEmoji.textContent = '🔤';
        if (memoryLetter) memoryLetter.textContent = 'Upper / lower';
        if (memoryClue) memoryClue.textContent = 'Tap play for a fresh genius pairing.';
        soundQuestRemaining = SOUND_ROUND_SECONDS;
        setSoundQuestTimerDisplay();
      };

      const resetSoundQuest = () => {
        pauseSoundQuest();
        state.soundQuest.level = 0;
        state.soundQuest.rounds = 0;
        state.soundQuest.lastCard = null;
        currentSoundQuestCard = null;
        if (memoryEmoji) memoryEmoji.textContent = '🔤';
        if (memoryLetter) memoryLetter.textContent = 'Upper / lower';
        if (memoryClue) memoryClue.textContent = 'Reset complete. Press play for a brand-new clue.';
        persist();
        updateSoundQuestUI();
        if (soundQuestReward) soundQuestReward.textContent = 'Progress reset. When you are ready, press play to rebuild your ladder.';
        soundQuestRemaining = SOUND_ROUND_SECONDS;
        setSoundQuestTimerDisplay();
      };

      const handleSoundQuestSuccess = () => {
        if (!currentSoundQuestCard) return;
        state.soundQuest.rounds = (state.soundQuest.rounds || 0) + 1;
        if (state.soundQuest.level < SOUND_GRAD_LEVEL) {
          state.soundQuest.level += 1;
        }
        persist();
        updateSoundQuestUI();
        const level = state.soundQuest.level;
        const personalMessage = buildPersonalizedReward(level, 'Sound Memory Quest');
        if (soundQuestReward) soundQuestReward.textContent = personalMessage;
        showScratchModal(personalMessage, true, { level });
        if (level >= SOUND_GRAD_LEVEL) {
          pauseSoundQuest();
        }
        loadSoundQuestCard();
        if (soundQuestActive) startSoundQuestTimer();
      };

      const skipSoundQuestCard = () => {
        loadSoundQuestCard();
        if (soundQuestActive) startSoundQuestTimer();
      };

      const openSoundQuest = () => {
        updateSoundQuestUI();
        if (!currentSoundQuestCard) loadSoundQuestCard(true);
        soundQuestScreen?.removeAttribute('hidden');
        setSoundQuestTimerDisplay();
      };

      const closeSoundQuest = () => {
        pauseSoundQuest();
        soundQuestScreen?.setAttribute('hidden', 'hidden');
      };

      soundQuestLaunchBtn?.addEventListener('click', openSoundQuest);
      els('[data-soundquest-close]').forEach(btn => btn.addEventListener('click', closeSoundQuest));
      soundQuestPlayBtn?.addEventListener('click', () => {
        if (!currentSoundQuestCard) {
          loadSoundQuestCard();
        } else if (currentSoundQuestCard.speech) {
          speak(currentSoundQuestCard.speech);
        }
        startSoundQuestTimer();
        if (soundQuestStatus) soundQuestStatus.textContent = 'Live round in progress. Pair the image and sound.';
      });
      soundQuestPauseBtn?.addEventListener('click', pauseSoundQuest);
      soundQuestStopBtn?.addEventListener('click', stopSoundQuest);
      soundQuestResetBtn?.addEventListener('click', resetSoundQuest);
      soundQuestLockBtn?.addEventListener('click', handleSoundQuestSuccess);
      soundQuestSkipBtn?.addEventListener('click', skipSoundQuestCard);
      const startPhonicsSongFromBeginning = () => {
        if (!phonicsAudio) return;
        phonicsSongState.lastLetter = 'A';
        phonicsSongState.currentIndex = 0;
        phonicsAudio.currentTime = 0;
        updatePhonicsSongVisual(0);
        syncPhonicsSongProgress();
        playPhonicsSong();
      };

      phonicsSongBtn?.addEventListener('click', () => {
        openPhonicsSongScreen();
        resetPhonicsSongToLetter('A');
        playPhonicsSong();
      });
      focusSongBtn?.addEventListener('click', () => {
        openPhonicsSongScreen();
        resetPhonicsSongToLetter('A');
        playPhonicsSong();
      });
      phonicsSongStartBtn?.addEventListener('click', startPhonicsSongFromBeginning);
      phonicsSongPauseBtn?.addEventListener('click', togglePhonicsSongPause);
      phonicsSongRestartBtn?.addEventListener('click', restartPhonicsSong);
      phonicsSongProgress?.addEventListener('input', evt => {
        if (!phonicsAudio?.duration) return;
        const pct = Number(evt.target.value) / 1000;
        phonicsAudio.currentTime = pct * phonicsAudio.duration;
        syncPhonicsSongProgress();
      });
      phonicsSongCloseBtns.forEach(btn => btn.addEventListener('click', closePhonicsSongScreen));
      phonicsAudio?.addEventListener('loadedmetadata', syncPhonicsSongProgress);
      phonicsAudio?.addEventListener('timeupdate', syncPhonicsSongProgress);
      phonicsAudio?.addEventListener('ended', () => {
        syncPhonicsSongProgress();
        pausePhonicsSong();
        phonicsSongState.currentIndex = phonicsSongSequence.length - 1;
        updatePhonicsSongVisual(phonicsSongState.currentIndex);
      });
      phonicsHeroBtn?.addEventListener('click', openLetterSoundScreen);
      letterSoundStartBtn?.addEventListener('click', startLetterSoundSequence);
      letterSoundPauseBtn?.addEventListener('click', toggleLetterSoundPause);
      letterSoundRestartBtn?.addEventListener('click', restartLetterSoundSequence);
      letterSoundRandomHeadBtn?.addEventListener('click', shuffleLetterSoundHead);
      letterSoundCertificateForm?.addEventListener('submit', handleCertificateFormSubmit);
      letterSoundCertificateEditBtn?.addEventListener('click', handleCertificateEditClick);
      letterSoundCertificatePrintBtn?.addEventListener('click', handleCertificatePrintClick);
      letterSoundContinueBtn?.addEventListener('click', () => {
        const context = letterSoundState.activeCelebration;
        if (context?.locked) return;
        const milestone = context?.milestone;
        hideLetterSoundCelebration();
        if (milestone) {
          if (milestone.final) {
            resetLetterSoundSequenceToStart();
          } else {
            resumeLetterSoundFromMilestone(milestone);
          }
        } else {
          resetLetterSoundSequenceToStart();
        }
      });
      letterSoundProgress?.addEventListener('input', evt => {
        if (!letterSoundAudio?.duration) return;
        hideLetterSoundCelebration();
        const pct = Number(evt.target.value) / 1000;
        letterSoundAudio.currentTime = pct * letterSoundAudio.duration;
        syncLetterSoundProgress();
        ensureLetterSoundCues();
        const cue = getLetterSoundCueForTime(letterSoundAudio.currentTime);
        const letter = cue?.letter || letterSoundState.currentLetter;
        const phase = getLetterSoundPhase(letter, letterSoundAudio.currentTime);
        setLetterSoundVisual(letter, phase, { forceShape: true });
      });
      letterSoundCloseBtns.forEach(btn => btn.addEventListener('click', closeLetterSoundScreen));
      letterSoundAudio?.addEventListener('loadedmetadata', () => {
        syncLetterSoundProgress();
        setLetterSoundVisual(letterSoundState.currentLetter, letterSoundState.currentPhase || 'rest', { forceShape: true });
      });
      letterSoundAudio?.addEventListener('timeupdate', () => {
        syncLetterSoundProgress();
        if (letterClipState.stopTime && letterSoundAudio.currentTime >= letterClipState.stopTime) {
          const clipStop = letterClipState.stopTime;
          pauseLetterSoundAudio();
          if (Number.isFinite(clipStop)) {
            letterSoundAudio.currentTime = clipStop;
          }
          return;
        }
        ensureLetterSoundCues();
        const cue = getLetterSoundCueForTime(letterSoundAudio.currentTime);
        let detectedLetter = cue?.letter || null;
        if (!detectedLetter && letterSoundAudio.duration) {
          const bucket = Math.min(alphabetLetters.length - 1, Math.floor((letterSoundAudio.currentTime / letterSoundAudio.duration) * alphabetLetters.length));
          detectedLetter = alphabetLetters[bucket];
        }
        if (detectedLetter) {
          const phase = getLetterSoundPhase(detectedLetter, letterSoundAudio.currentTime);
          setLetterSoundVisual(detectedLetter, phase);
        }
        const evaluationLetter = detectedLetter || letterSoundState.currentLetter;
        if (!letterSoundState.hasCompletedCelebration) {
          evaluateLetterSoundMilestones(evaluationLetter, letterSoundAudio.currentTime);
        }
        if (!letterSoundState.hasCompletedCelebration) {
          const duration = Number(letterSoundAudio.duration) || LETTER_SOUND_COMPLETION_SECS;
          const targetTime = Math.min(duration, LETTER_SOUND_COMPLETION_SECS);
          if (letterSoundAudio.currentTime >= targetTime) {
            completeLetterSoundSequence();
          }
        }
      });
      letterSoundAudio?.addEventListener('ended', completeLetterSoundSequence);
      document.addEventListener('keydown', evt => {
        if (evt.key !== 'Escape') return;
        if (!phonicsSongScreen?.hasAttribute('hidden')) closePhonicsSongScreen();
        if (!letterSoundScreen?.hasAttribute('hidden')) closeLetterSoundScreen();
      });

      scratchBtn?.addEventListener('click', () => {
        if (!state.scratchReady) return;
        showScratchModal('', false, { level: state.soundQuest.level });
      });

      scratchCopy?.addEventListener('click', async () => {
        try {
          await navigator.clipboard?.writeText?.(scratchMessage.textContent || '');
          scratchCopy.textContent = 'Copied!';
          setTimeout(() => { scratchCopy.textContent = 'Copy message'; }, 1500);
        } catch (err) {
          console.warn('Copy failed', err);
        }
      });

      els('[data-scratch-close]').forEach(btn => btn.addEventListener('click', () => scratchModal.setAttribute('hidden', 'hidden')));

      els('[data-routine]').forEach(btn => {
        btn.addEventListener('click', () => {
          els('[data-routine]').forEach(other => other.classList.remove('is-active'));
          btn.classList.add('is-active');
          const minutes = Number(btn.getAttribute('data-routine'));
          const summary = minutes === 5 ? 'Two mini slots. Morning + evening works well.' : minutes === 10 ? 'One 10-minute block. Tie it to homework or lunch.' : 'Mix of calm warm-up + reading + reward.';
          el('#dlxRoutineSummary').textContent = summary;
        });
      });

      els('[data-scroll]').forEach(btn => {
        const targetSelector = btn.getAttribute('data-scroll');
        if (!targetSelector) return;
        btn.addEventListener('click', evt => {
          const target = document.querySelector(targetSelector);
          if (!target) return;
          evt.preventDefault();
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });

      stage1ProfileInputs.forEach(input => {
        input.addEventListener('change', () => {
          if (input.type === 'radio' && !input.checked) return;
          const field = input.getAttribute('data-dlx-profile-field');
          if (!field) return;
          state.stage1.profile[field] = input.value;
          persist();
          updateStage1ProfileSelections();
          updateStage1ProfileSummary();
          updateStage1ReportPreview();
        });
      });

      stage1OverlayInputs.forEach(input => {
        input.addEventListener('change', () => {
          const overlays = new Set(state.stage1.profile.overlays || []);
          if (input.checked) overlays.add(input.value); else overlays.delete(input.value);
          state.stage1.profile.overlays = Array.from(overlays);
          persist();
          updateStage1ProfileSelections();
          updateStage1ProfileSummary();
          updateStage1ReportPreview();
        });
      });

      stage1ProfileContext?.addEventListener('input', evt => {
        const text = evt.target.value.slice(0, 400);
        if (evt.target.value !== text) evt.target.value = text;
        state.stage1.profile.context = text;
        persist();
        updateStage1ProfileSummary();
        updateStage1ReportPreview();
      });

      stage1FrictionScale?.addEventListener('input', evt => {
        const score = Number(evt.target.value) || 0;
        state.stage1.friction.score = score;
        setStage1FrictionLabel(score);
        persist();
      });

      stage1FrictionDrivers.forEach(input => {
        input.addEventListener('change', () => {
          const drivers = new Set(state.stage1.friction.drivers || []);
          if (input.checked) drivers.add(input.value); else drivers.delete(input.value);
          state.stage1.friction.drivers = Array.from(drivers);
          persist();
        });
      });

      stage1FrictionNotes?.addEventListener('input', evt => {
        const note = evt.target.value.slice(0, 220);
        if (evt.target.value !== note) evt.target.value = note;
        state.stage1.friction.note = note;
        persist();
      });

      stage1FrictionSaveBtn?.addEventListener('click', () => {
        const friction = state.stage1.friction;
        const now = new Date().toISOString();
        const entry = {
          score: Number(friction.score) || 0,
          drivers: Array.from(friction.drivers || []),
          note: friction.note?.trim() || '',
          updated: now,
          weekAnchor: weekAnchorKey()
        };
        friction.lastUpdated = now;
        friction.weekAnchor = entry.weekAnchor;
        const history = Array.isArray(friction.history) ? friction.history : [];
        friction.history = [entry, ...history].slice(0, stage1HistoryLimit);
        persist();
        updateStage1FrictionUI();
        updateStage1ReportPreview();
        if (stage1FrictionSnapshot) {
          stage1FrictionSnapshot.textContent = `Saved ${formatDateTime(now)} (${entry.score}/10 · ${describeFrictionScore(entry.score)})`;
        }
      });

      stage1CalmPatternSelect?.addEventListener('change', evt => {
        state.stage1.calm.lastPattern = evt.target.value;
        persist();
      });

      stage1CalmTimeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const value = btn.getAttribute('data-dlx-calm-time');
          if (!value) return;
          state.stage1.calm.lastTime = value;
          stage1CalmTimeButtons.forEach(other => other.classList.toggle('is-active', other === btn));
          persist();
        });
      });

      stage1CalmEffectRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (!radio.checked) return;
          state.stage1.calm.lastEffect = radio.value;
          persist();
        });
      });

      stage1LogCalmBtn?.addEventListener('click', () => {
        const pattern = stage1CalmPatternSelect?.value;
        if (!pattern) {
          if (stage1CalmStats) stage1CalmStats.textContent = 'Select a breath pattern before logging.';
          return;
        }
        const calm = state.stage1.calm;
        const anchor = weekAnchorKey();
        if (calm.weekAnchor !== anchor) {
          calm.weekAnchor = anchor;
          calm.weeklyResets = 0;
        }
        calm.totalResets = (calm.totalResets || 0) + 1;
        calm.weeklyResets = (calm.weeklyResets || 0) + 1;
        calm.lastPattern = pattern;
        calm.lastEffect = getStage1CalmEffect();
        calm.lastTime = getStage1CalmTime();
        calm.lastLogged = new Date().toISOString();
        persist();
        updateStage1CalmUI();
        updateStage1ReportPreview();
        if (stage1ReportStatus) {
          stage1ReportStatus.textContent = 'Calm reset logged.';
          setTimeout(() => {
            if (stage1ReportStatus?.textContent === 'Calm reset logged.') stage1ReportStatus.textContent = '';
          }, 2600);
        }
      });

      stage1ReportBtn?.addEventListener('click', () => {
        const summary = buildStage1Report();
        state.stage1.summary = summary;
        persist();
        updateStage1ReportPreview();
        if (stage1ReportStatus) {
          stage1ReportStatus.textContent = 'Summary updated.';
          setTimeout(() => {
            if (stage1ReportStatus?.textContent === 'Summary updated.') stage1ReportStatus.textContent = '';
          }, 3200);
        }
      });

      stage1ReportCopy?.addEventListener('click', async () => {
        const text = stage1ReportOutput?.textContent?.trim();
        if (!text) {
          if (stage1ReportStatus) stage1ReportStatus.textContent = 'No summary to copy yet.';
          return;
        }
        try {
          await navigator.clipboard?.writeText?.(text);
          if (stage1ReportStatus) stage1ReportStatus.textContent = 'Summary copied to clipboard.';
        } catch (err) {
          if (stage1ReportStatus) stage1ReportStatus.textContent = 'Copy not available on this device.';
        }
        setTimeout(() => {
          if (stage1ReportStatus) stage1ReportStatus.textContent = '';
        }, 3200);
      });

      refreshStage1UI();

      const synth = window.speechSynthesis;
      const speechSpeedMap = { slow: 0.82, coach: 0.95, quick: 1.1 };
      let speechRate = state.speechSpeed || defaultSpeechSpeed;
      const sanitizeSpeech = text => {
        if (!text) return '';
        return text
          .replace(/[^a-zA-Z\s.,!?…]/g, ' ')
          .replace(/\s+([.,!?])/g, '$1')
          .replace(/([.,!?])(\S)/g, '$1 $2')
          .replace(/\s+/g, ' ')
          .trim();
      };
      const speak = text => {
        if (!text || !synth) return;
        const cleaned = sanitizeSpeech(text);
        if (!cleaned) return;
        const utter = new SpeechSynthesisUtterance(cleaned);
        utter.rate = speechRate;
        utter.pitch = 1;
        if (state.profile.voice === 'uk-female') utter.voice = synth.getVoices().find(v => v.name?.toLowerCase().includes('female')) || null;
        if (state.profile.voice === 'neutral') utter.voice = synth.getVoices().find(v => /neutral|allison|david/i.test(v.name)) || utter.voice;
        synth.cancel();
        synth.speak(utter);
      };

      const coachScripts = {
        whatIsDyslexia: 'Dyslexia is a difference in how your brain maps sounds to letters. It needs structured support, not more effort.',
        calmIntro: 'Short breathing resets reduce cortisol, so reading feels less threatening.',
        routineMap: 'Plan practice around energy. Two five-minute bursts often beat one long session.',
        vowelUniverse: 'Use the Vowel Universe story every time so the learner knows where each pattern lives.',
        shortVowels: 'Short vowels are quick and central. Keep the jaw relaxed and the sound short.',
        longVowels: 'Long vowels say their name. Link them to magic-e, open syllables and vowel teams.',
        vowelTeams: 'When two vowels go walking, explain who does the talking and why.',
        vowelQuest: 'Guide accuracy first. Praise strategy, not speed.',
        fluencyPacer: 'Model expression, then echo-read. Focus on smooth pacing.',
        rapidNaming: 'Keep eyes soft, glide across the strip, breathe between rows and celebrate steady pacing.',
        pronLab: 'Tap sounds, read the example, trace the shape if needed.'
      };

      els('.coach-explain').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-coach-id');
          speak(coachScripts[id] || 'Keep it calm, short and structured.');
        });
      });

      els('.dlx-sound-btn').forEach(btn => btn.addEventListener('click', () => speak(btn.getAttribute('data-tts') || btn.textContent)));

      const wordBank = {
        short: ['cat', 'bed', 'fish', 'mop', 'sun', 'bag', 'leg', 'dig', 'cot', 'cup'],
        long: ['cake', 'team', 'light', 'home', 'cube', 'rain', 'steam'],
        team: ['boat', 'snow', 'coin', 'loud', 'hawk', 'cheer']
      };

      const phonicsLetterVisuals = {
        A: { word: 'apple', icon: '🍎', type: 'vowel', lyric: 'A says /a/ like apple, /a/ /a/ apple, A.' },
        B: { word: 'ball', icon: '⚽', type: 'consonant', lyric: 'B says /b/ like ball, /b/ /b/ ball, B.' },
        C: { word: 'cat', icon: '🐱', type: 'consonant', lyric: 'C says /k/ like cat, /k/ /k/ cat, C.' },
        D: { word: 'dog', icon: '🐶', type: 'consonant', lyric: 'D says /d/ like dog, /d/ /d/ dog, D.' },
        E: { word: 'egg', icon: '🥚', type: 'vowel', lyric: 'E says /e/ like egg, /e/ /e/ egg, E.' },
        F: { word: 'fish', icon: '🐟', type: 'consonant', lyric: 'F says /f/ like fish, /f/ /f/ fish, F.' },
        G: { word: 'goat', icon: '🐐', type: 'consonant', lyric: 'G says /g/ like goat, /g/ /g/ goat, G.' },
        H: { word: 'hat', icon: '🎩', type: 'consonant', lyric: 'H says /h/ like hat, /h/ /h/ hat, H.' },
        I: { word: 'igloo', icon: '🏔️', type: 'vowel', lyric: 'I says /i/ like igloo, /i/ /i/ igloo, I.' },
        J: { word: 'jam', icon: '🍓', type: 'consonant', lyric: 'J says /j/ like jam, /j/ /j/ jam, J.' },
        K: { word: 'kite', icon: '🪁', type: 'consonant', lyric: 'K says /k/ like kite, /k/ /k/ kite, K.' },
        L: { word: 'lion', icon: '🦁', type: 'consonant', lyric: 'L says /l/ like lion, /l/ /l/ lion, L.' },
        M: { word: 'milk', icon: '🥛', type: 'consonant', lyric: 'M says /m/ like milk, /m/ /m/ milk, M.' },
        N: { word: 'net', icon: '🎣', type: 'consonant', lyric: 'N says /n/ like net, /n/ /n/ net, N.' },
        O: { word: 'orange', icon: '🍊', type: 'vowel', lyric: 'O says /o/ like orange, /o/ /o/ orange, O.' },
        P: { word: 'pen', icon: '🖊️', type: 'consonant', lyric: 'P says /p/ like pen, /p/ /p/ pen, P.' },
        Q: { word: 'queen', icon: '👑', type: 'consonant', lyric: 'Q says /kw/ like queen, /kw/ /kw/ queen, Q.' },
        R: { word: 'rabbit', icon: '🐇', type: 'consonant', lyric: 'R says /r/ like rabbit, /r/ /r/ rabbit, R.' },
        S: { word: 'sun', icon: '☀️', type: 'consonant', lyric: 'S says /s/ like sun, /s/ /s/ sun, S.' },
        T: { word: 'top', icon: '🧢', type: 'consonant', lyric: 'T says /t/ like top, /t/ /t/ top, T.' },
        U: { word: 'umbrella', icon: '🌂', type: 'vowel', lyric: 'U says /u/ like umbrella, /u/ /u/ umbrella, U.' },
        V: { word: 'van', icon: '🚐', type: 'consonant', lyric: 'V says /v/ like van, /v/ /v/ van, V.' },
        W: { word: 'web', icon: '🕸️', type: 'consonant', lyric: 'W says /w/ like web, /w/ /w/ web, W.' },
        X: { word: 'box', icon: '📦', type: 'consonant', lyric: 'X says /ks/ in box, /ks/ /ks/ box, X.' },
        Y: { word: 'yo-yo', icon: '🪀', type: 'consonant', lyric: 'Y says /y/ like yo-yo, /y/ /y/ yo-yo, Y.' },
        Z: { word: 'zebra', icon: '🦓', type: 'consonant', lyric: 'Z says /z/ like zebra, /z/ /z/ zebra, Z.' }
      };

      const alphabetLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

      const letterMouthShapeMap = {
        A: 'open-round',
        B: 'lip-press',
        C: 'smile-wide',
        D: 'tongue-tap',
        E: 'open-round',
        F: 'lip-bite',
        G: 'tongue-tap',
        H: 'open-round',
        I: 'open-round',
        J: 'smile-wide',
        K: 'tongue-tap',
        L: 'tongue-tap',
        M: 'lip-press',
        N: 'tongue-tap',
        O: 'oval-rounded',
        P: 'lip-press',
        Q: 'oval-rounded',
        R: 'oval-rounded',
        S: 'smile-wide',
        T: 'tongue-tap',
        U: 'oval-rounded',
        V: 'lip-bite',
        W: 'oval-rounded',
        X: 'smile-wide',
        Y: 'rounded-glide',
        Z: 'smile-wide'
      };

      const mouthShapeTips = {
        'open-round': 'Relax your jaw, drop the tongue, and let air glide through an open oval.',
        'oval-rounded': 'Round the lips gently and keep airflow long like /ō/ or /oo/.',
        'rounded-glide': 'Slide the lips into a gentle circle, then smile as you glide like /w/ or /y/.',
        'lip-press': 'Press lips together, build gentle air, then release for pop sounds like /p/ /b/ /m/.',
        'lip-bite': 'Rest top teeth on the bottom lip and blow softly for /f/ and /v/.',
        'tongue-tap': 'Tap the tongue on the ridge behind teeth for /t/ /d/ /n/ /l/. Keep it quick.',
        'smile-wide': 'Pull the corners of your mouth back slightly and channel air for hissing/buzzing sounds.',
        neutral: 'Keep lips relaxed and repeat the phoneme twice with steady airflow.'
      };

      const stopReleaseLetters = new Set(['B', 'P', 'M', 'T', 'D', 'N', 'K', 'G', 'Q', 'L']);
      const vowelLetters = new Set(['A', 'E', 'I', 'O', 'U', 'Y']);
      const sustainLetters = new Set(['F', 'V', 'S', 'Z', 'H', 'J', 'W']);
      const letterPhonemeShapePlan = {
        A: { hold: 'open-round', repeat: 'open-round' },
        E: { hold: 'open-round', repeat: 'open-round' },
        I: { hold: 'open-round', repeat: 'neutral' },
        O: { hold: 'oval-rounded', repeat: 'oval-rounded' },
        U: { hold: 'oval-rounded', repeat: 'oval-rounded' },
        B: { repeat: 'neutral' },
        P: { repeat: 'neutral' },
        M: { repeat: 'lip-press' },
        T: { repeat: 'neutral' },
        D: { repeat: 'neutral' },
        N: { repeat: 'neutral' },
        L: { repeat: 'tongue-tap' },
        K: { repeat: 'tongue-tap' },
        G: { repeat: 'tongue-tap' },
        Q: { repeat: 'oval-rounded' },
        R: { hold: 'oval-rounded', repeat: 'oval-rounded' },
        F: { repeat: 'lip-bite' },
        V: { repeat: 'lip-bite' },
        H: { repeat: 'open-round' },
        S: { repeat: 'smile-wide' },
        Z: { repeat: 'smile-wide' },
        C: { repeat: 'smile-wide' },
        J: { repeat: 'rounded-glide' },
        W: { repeat: 'oval-rounded' },
        Y: { repeat: 'rounded-glide' },
        X: { repeat: 'smile-wide' }
      };

      const getPhaseShapeForLetter = (letter, phase = 'call') => {
        const upper = (letter || 'A').toUpperCase();
        const plan = letterPhonemeShapePlan[upper] || {};
        if (phase === 'rest') return 'neutral';
        if (plan[phase]) return plan[phase];
        if (phase === 'hold' && plan.call) return plan.call;
        if (phase === 'hold' && vowelLetters.has(upper)) return letterMouthShapeMap[upper] || 'open-round';
        if (phase === 'repeat' && plan.repeat) return plan.repeat;
        if (phase === 'repeat' && sustainLetters.has(upper)) return letterMouthShapeMap[upper] || 'neutral';
        if (phase === 'repeat' && stopReleaseLetters.has(upper)) return 'neutral';
        return plan.call || letterMouthShapeMap[upper] || 'neutral';
      };

      const talkingHeadVariants = [
        { id: 'sunrise', accessory: '⭐' },
        { id: 'forest', accessory: '🍃' },
        { id: 'ocean', accessory: '🌊' },
        { id: 'galaxy', accessory: '✨' },
        { id: 'citrus', accessory: '🍊' },
        { id: 'onyx', accessory: '💎' }
      ];

      const phonicsSongSequence = [
        { type: 'intro-spoken', label: 'Intro', text: 'Let’s sing the sounds that letters make. Ready? Here we go!' },
        { type: 'intro-sung', label: 'Intro', text: 'These are the sounds that letters say, sing along and sound the way.' },
        { type: 'chorus', label: 'Chorus', text: 'Letter, letter, what do you say? I make a sound in my own way. Listen closely, sing with me, phonics sounds from A to Z.' },
        { type: 'letter', letter: 'A' },
        { type: 'letter', letter: 'B' },
        { type: 'letter', letter: 'C' },
        { type: 'letter', letter: 'D' },
        { type: 'letter', letter: 'E' },
        { type: 'letter', letter: 'F' },
        { type: 'chorus', label: 'Chorus', text: 'Letter, letter, what do you say? I make a sound in my own way. Listen closely, sing with me, phonics sounds from A to Z.' },
        { type: 'letter', letter: 'G' },
        { type: 'letter', letter: 'H' },
        { type: 'letter', letter: 'I' },
        { type: 'letter', letter: 'J' },
        { type: 'letter', letter: 'K' },
        { type: 'letter', letter: 'L' },
        { type: 'chorus', label: 'Chorus', text: 'Letter, letter, what do you say? I make a sound in my own way. Listen closely, sing with me, phonics sounds from A to Z.' },
        { type: 'letter', letter: 'M' },
        { type: 'letter', letter: 'N' },
        { type: 'letter', letter: 'O' },
        { type: 'letter', letter: 'P' },
        { type: 'letter', letter: 'Q' },
        { type: 'letter', letter: 'R' },
        { type: 'chorus', label: 'Chorus', text: 'Letter, letter, what do you say? I make a sound in my own way. Listen closely, sing with me, phonics sounds from A to Z.' },
        { type: 'letter', letter: 'S' },
        { type: 'letter', letter: 'T' },
        { type: 'letter', letter: 'U' },
        { type: 'letter', letter: 'V' },
        { type: 'letter', letter: 'W' },
        { type: 'letter', letter: 'X' },
        { type: 'letter', letter: 'Y' },
        { type: 'letter', letter: 'Z' },
        { type: 'chorus', label: 'Final chorus', text: 'Letter, letter, what do you say? I make a sound in my own way. A to Z, you’ve sung with me. That’s the way to read with ease.' },
        { type: 'outro', label: 'Outro', text: 'Well done! You’ve sung the sounds from A to Z. Every letter has a sound. Sing it again with me next time!' }
      ];

      const phonicsLetterIndex = phonicsSongSequence.reduce((acc, entry, index) => {
        if (entry.type === 'letter' && entry.letter) {
          acc[entry.letter.toUpperCase()] = index;
        }
        return acc;
      }, {});

      const alphabetSoundbank = [
        { letter: 'A', say: 'ay', phonemeIntro: 'A or ah', explain: 'A flexes between long /ā/ and short /ă/ depending on the syllable type.', otherSounds: ['Short /ă/ — apple', 'Long /ā/ — acorn', 'Schwa /ə/ — about', 'Broad /aw/ — ball'] },
        { letter: 'B', say: 'bee', phonemeIntro: 'Ba', explain: 'B is a voiced stop. Lips press then release quickly.', otherSounds: ['/b/ — ball'] },
        { letter: 'C', say: 'see', phonemeIntro: 'Ca or k', explain: 'C is hard /k/ before a, o, u and soft /s/ before e, i, y.', otherSounds: ['Hard /k/ — cat', 'Soft /s/ — cent', 'Sh /ʃ/ — special (cia/tion)'] },
        { letter: 'D', say: 'dee', phonemeIntro: 'Da', explain: 'D taps the ridge for /d/ and past tense -ed can sound like /t/.', otherSounds: ['/d/ — dog', '/t/ — packed (ed ending)'] },
        { letter: 'E', say: 'ee', phonemeIntro: 'Ee or eh', explain: 'E handles /ē/, /ĕ/ and the relaxed schwa in unstressed syllables.', otherSounds: ['Short /ĕ/ — bed', 'Long /ē/ — he', 'Schwa /ə/ — problem'] },
        { letter: 'F', say: 'ef', phonemeIntro: 'Fa or fff', explain: 'F bites the lip for /f/. Keep airflow steady.', otherSounds: ['/f/ — fish', '/v/ — of (voiced)'] },
        { letter: 'G', say: 'jee', phonemeIntro: 'Ga or juh', explain: 'G is hard /g/ before a, o, u and soft /j/ before e, i, y.', otherSounds: ['Hard /g/ — goat', 'Soft /j/ — gem'] },
        { letter: 'H', say: 'aitch', phonemeIntro: 'Ha or huh', explain: 'H is a whisper /h/ but can fall silent in honest/hour.', otherSounds: ['/h/ — hat', 'Silent — honest, hour'] },
        { letter: 'I', say: 'eye', phonemeIntro: 'I or ih', explain: 'I flips between /ĭ/, /ī/ and even /ē/ in open syllables.', otherSounds: ['Short /ĭ/ — igloo', 'Long /ī/ — ice', 'Long /ē/ — ski'] },
        { letter: 'J', say: 'jay', phonemeIntro: 'Ja or juh', explain: 'J hums /j/ like jump. Keep lips rounded slightly.', otherSounds: ['/j/ — jam'] },
        { letter: 'K', say: 'kay', phonemeIntro: 'Ka', explain: 'K is the hard /k/ twin for C and stays silent before n.', otherSounds: ['/k/ — kite', 'Silent — knee'] },
        { letter: 'L', say: 'el', phonemeIntro: 'La', explain: 'L makes light /l/ at the start and dark /əl/ at the end.', otherSounds: ['Light /l/ — leaf', 'Dark /əl/ — ball'] },
        { letter: 'M', say: 'em', phonemeIntro: 'Ma or mm', explain: 'M hums /m/ with lips closed and airflow through the nose.', otherSounds: ['/m/ — moon'] },
        { letter: 'N', say: 'en', phonemeIntro: 'Na or nn', explain: 'N says /n/ but blends to /ŋ/ before k or g.', otherSounds: ['/n/ — nest', '/ŋ/ — bank'] },
        { letter: 'O', say: 'oh', phonemeIntro: 'O or aw', explain: 'O ranges from /ŏ/ to /ō/ plus /oo/ and schwa sounds.', otherSounds: ['Short /ŏ/ — hot', 'Long /ō/ — open', 'Long /oo/ — do', 'Schwa /ə/ — love'] },
        { letter: 'P', say: 'pee', phonemeIntro: 'Pa or puh', explain: 'P is a quiet burst /p/ and teams with h to make /f/.', otherSounds: ['/p/ — pen', '/f/ — phone (ph)'] },
        { letter: 'Q', say: 'cue', phonemeIntro: 'Qua', explain: 'Q sticks with u to say /kw/ or /k/ in French borrowings.', otherSounds: ['/kw/ — queen', '/k/ — antique'] },
        { letter: 'R', say: 'ar', phonemeIntro: 'Ra or rr', explain: 'R keeps the tongue pulled back and often controls vowels.', otherSounds: ['/r/ — river'] },
        { letter: 'S', say: 'ess', phonemeIntro: 'Sa or za', explain: 'S hisses /s/, buzzes /z/ and sometimes shushes /sh/.', otherSounds: ['/s/ — sun', '/z/ — rose', '/sh/ — sure'] },
        { letter: 'T', say: 'tee', phonemeIntro: 'Ta or tuh', explain: 'T is a quick stop /t/ and shifts to /sh/ or /ch/ in some endings.', otherSounds: ['/t/ — tap', '/sh/ — nation', '/ch/ — creature'] },
        { letter: 'U', say: 'you', phonemeIntro: 'Uh or yoo', explain: 'U can be /ŭ/, /ū/, /oo/ or /ʊ/ depending on the word.', otherSounds: ['Short /ŭ/ — up', 'Long /yoo/ — unicorn', 'Long /oo/ — rule', 'Short /ʊ/ — push'] },
        { letter: 'V', say: 'vee', phonemeIntro: 'Va or vvv', explain: 'V vibrates every time. Upper teeth rest on the lip.', otherSounds: ['/v/ — vine'] },
        { letter: 'W', say: 'double you', phonemeIntro: 'Wa or woo', explain: 'W glides into vowels or teams up to change their sound.', otherSounds: ['/w/ — wave', 'Helper — snow / aw'] },
        { letter: 'X', say: 'eks', phonemeIntro: 'Ex or gz', explain: 'X rarely leads words. It likes /ks/, /gz/ or even /z/.', otherSounds: ['/ks/ — fox', '/gz/ — exam', '/z/ — xylophone'] },
        { letter: 'Y', say: 'why', phonemeIntro: 'Ya or ee', explain: 'Y is /y/ at the start and vowel sounds at the end.', otherSounds: ['/y/ — yes', '/ī/ — sky', '/ē/ — happy', '/ĭ/ — gym'] },
        { letter: 'Z', say: 'zee', phonemeIntro: 'Za or zh', explain: 'Z buzzes /z/ and softly /zh/ in words like azure.', otherSounds: ['/z/ — zoom', '/zh/ — azure'] }
      ];

      const soundMemoryDeck = [
        { letter: 'A', emoji: '🍎', clue: 'Apple astronaut slides from short /ă/ to long /ā/. Taste both sounds as you bite and glide.', memory: 'Picture an apple helmet switching between apple and acorn modes.', speech: 'Apple astronaut anchors the letter A. Short a apple, long a acorn.' },
        { letter: 'B', emoji: '🥁', clue: 'Boom drum taps /b/ with a soft bounce. Lips pop like a drum membrane.', memory: 'See a drum beater spelling B.', speech: 'Boom drum for letter B. Lips tap to make /b/.' },
        { letter: 'C', emoji: '🧊', clue: 'Crystal cube cracks for /k/ and frosts into /s/. Switch the texture in your mind.', memory: 'Hard cube for hard C, soft snow for soft C.', speech: 'Crystal cube shows C saying /k/ or /s/ depending on the light.' },
        { letter: 'D', emoji: '🛶', clue: 'Drum canoe dips and taps /d/. Feel the paddle knock the water ridge.', memory: 'Tap the canoe rail to remember d.', speech: 'Drum canoe reminds you D is a quick /d/ tap.' },
        { letter: 'E', emoji: '🎈', clue: 'Elastic balloon stretches to long /ē/ then snaps to short /ĕ/.', memory: 'Balloon air length = vowel length.', speech: 'Elastic balloon helps E float from /ē/ to /ĕ/ to schwa.' },
        { letter: 'F', emoji: '🪁', clue: 'Feathered kite rubs the wind for /f/. Teeth graze lip like kite string.', memory: 'Feathers = quiet /f/.', speech: 'Feathered kite whispers the /f/ sound for F.' },
        { letter: 'G', emoji: '🐲', clue: 'Gem dragon guards hard /g/ then gently says /j/ when calm.', memory: 'Green dragon for /g/, gentle dragon for /j/.', speech: 'Gem dragon guides G between /g/ and /j/.' },
        { letter: 'H', emoji: '🌬️', clue: 'Horizon breeze pushes a whisper /h/. Imagine fog on a window.', memory: 'Hand on mouth feeling airy H.', speech: 'Horizon breeze is the /h/ hush for H.' },
        { letter: 'I', emoji: '🕯️', clue: 'Ink candle glows short /ĭ/ then stretches to long /ī/ like rising flame.', memory: 'Candle wick = short, flame = long.', speech: 'Ink candle shows I flipping from /ĭ/ to /ī/ (and even /ē/).' },
        { letter: 'J', emoji: '🧃', clue: 'Jelly juice jiggles the /j/ sound. See the straw jump.', memory: 'Juice box = /j/.', speech: 'Jelly juice box keeps J humming /j/.' },
        { letter: 'K', emoji: '🥋', clue: 'Karate kick pops /k/ with exact timing. Hear the crisp break.', memory: 'Karate chop = /k/.', speech: 'Karate kick keeps K delivering the hard /k/ sound.' },
        { letter: 'L', emoji: '🌿', clue: 'Leaf lantern bends for light /l/ then melts into dark /əl/.', memory: 'Leaf tip touching teeth.', speech: 'Leaf lantern teaches L to glide from light to dark /l/.' },
        { letter: 'M', emoji: '🍯', clue: 'Honey hum warms the /m/ sound. Lips seal like a jar lid.', memory: 'Honey hum = /m/.', speech: 'Honey hum shows M is a cozy /m/ through the nose.' },
        { letter: 'N', emoji: '🧭', clue: 'North needle points /n/, then leans into /ŋ/ when backpack hits k.', memory: 'Needle straight vs angled.', speech: 'North needle keeps N steady /n/ or sliding to /ŋ/.' },
        { letter: 'O', emoji: '🌀', clue: 'Orbit portal circles through /ŏ/, /ō/, and /oo/. Spin the wheel to hear each.', memory: 'Orbit ring = vowel wheel.', speech: 'Orbit portal reminds O of every shape it can make.' },
        { letter: 'P', emoji: '🎯', clue: 'Pop dart puffs a quiet /p/. Feel the air kiss your palm.', memory: 'Dart tip pops like /p/.', speech: 'Pop dart shows P is a soft burst /p/.' },
        { letter: 'Q', emoji: '👑', clue: 'Queen quest pairs Q + U like a royal duo saying /kw/.', memory: 'Crown + wand = /kw/.', speech: 'Queen quest keeps Q loyal to U for /kw/ or /k/.' },
        { letter: 'R', emoji: '🌈', clue: 'River rainbow rolls /r/ while keeping the tongue pulled back.', memory: 'Rainbow ribbon curled for /r/.', speech: 'River rainbow helps R stay smooth and controlled.' },
        { letter: 'S', emoji: '🐍', clue: 'Sun snake hisses /s/, then buzzes /z/ when warmed.', memory: 'Snake vs bee for S.', speech: 'Sun snake teaches S both /s/ and /z/ roles.' },
        { letter: 'T', emoji: '⏱️', clue: 'Ticking timer taps /t/. A tiny burst pushes the hand forward.', memory: 'Timer tick = /t/.', speech: 'Ticking timer shows T is a precise /t/ tap.' },
        { letter: 'U', emoji: '🛸', clue: 'UFO lifts between /ŭ/, /yoo/, and /oo/. Tilt the disc to change sounds.', memory: 'Spaceship tilt = vowel shift.', speech: 'UFO shows U saying uh, yoo, or oo depending on tilt.' },
        { letter: 'V', emoji: '🎻', clue: 'Vibrating violin lets teeth kiss lip for /v/. Hear the string sing.', memory: 'Violin bow buzzing.', speech: 'Vibrating violin keeps V buzzing /v/.' },
        { letter: 'W', emoji: '🌊', clue: 'Wave wand glides /w/ into every vowel. Trace the wave.', memory: 'Wave opener for vowels.', speech: 'Wave wand helps W glide + shift vowels.' },
        { letter: 'X', emoji: '⚔️', clue: 'Crossing blades make /ks/, turn to /gz/ when powered, or solo /z/.', memory: 'Blades cross = /ks/.', speech: 'Cross blades show X mixing /ks/, /gz/, or /z/.' },
        { letter: 'Y', emoji: '🪀', clue: 'Yo-yo string starts as /y/ then becomes vowel endings /ī/ and /ē/.', memory: 'Yo-yo high vs low.', speech: 'Yo-yo string reminds Y of consonant and vowel jobs.' },
        { letter: 'Z', emoji: '⚡', clue: 'Zigzag lightning buzzes /z/ and glows /zh/ in azure skies.', memory: 'Lightning + laser for Z.', speech: 'Zigzag lightning keeps Z buzzing strong or soft.' }
      ];

      const vowelCardData = {
        shortStreet: {
          level: 'Levels 1–3',
          description: 'Short vowels (a, e, i, o, u). Keep sounds clipped and calm. Build CVC + VC words.',
          defaultMinutes: 2,
          reason: 'Short Street keeps vowels clipped and central. Relax the jaw and let the sound end quickly.',
          sounds: [
            { label: 'a', say: 'ă', explain: 'A for apple.' },
            { label: 'e', say: 'ĕ', explain: 'E for elephant.' },
            { label: 'i', say: 'ĭ', explain: 'I for igloo.' },
            { label: 'o', say: 'ŏ', explain: 'O for orange.' },
            { label: 'u', say: 'ŭ', explain: 'U for umbrella.' }
          ]
        },
        skylineTowers: {
          level: 'Levels 4–6',
          description: 'Long vowels + common digraphs (ai, ee, oa, ue). Use tower visuals + tracing.',
          defaultMinutes: 3,
          reason: 'Skyline Towers stretches vowels until they say their name. Pair with tracing or air-writing.',
          sounds: [
            { label: 'ai', say: 'ay', explain: 'ai makes the /ā/ sound as in rain.' },
            { label: 'ee', say: 'ee', explain: 'ee makes the /ē/ sound as in tree.' },
            { label: 'oa', say: 'oh', explain: 'oa makes the /ō/ sound as in boat.' },
            { label: 'ie', say: 'eye', explain: 'ie makes /ī/ as in pie.' },
            { label: 'ue', say: 'yoo', explain: 'ue often says /yoo/ as in blue.' }
          ]
        },
        teamBridge: {
          level: 'Levels 5–7',
          description: 'Vowel teams + diphthongs. Explain who “talks” and who “walks” each time.',
          defaultMinutes: 3,
          reason: 'Team Bridge teaches who talks and who walks so vowel teams feel predictable.',
          sounds: [
            { label: 'au', say: 'aw', explain: 'au sounds like /aw/ in cause.' },
            { label: 'aw', say: 'aw', explain: 'aw also says /aw/ like claw.' },
            { label: 'oi', say: 'oy', explain: 'oi makes /oy/ as in coin.' },
            { label: 'oy', say: 'oy', explain: 'oy makes /oy/ at word endings like boy.' },
            { label: 'ew', say: 'you', explain: 'ew makes /yoo/ as in few.' }
          ]
        },
        rRiver: {
          level: 'Levels 7–8',
          description: 'R-controlled patterns (ar, er, ir, or, ur). Keep tongue relaxed, stretch the /r/ gently.',
          defaultMinutes: 3,
          reason: 'R-River blends the vowel straight into /r/ so the sound feels like one connected stream.',
          sounds: [
            { label: 'ar', say: 'ar', explain: 'ar says /ar/ like car.' },
            { label: 'er', say: 'er', explain: 'er says /ər/ like fern.' },
            { label: 'ir', say: 'er', explain: 'ir also says /ər/ like bird.' },
            { label: 'or', say: 'or', explain: 'or says /or/ like storm.' },
            { label: 'ur', say: 'er', explain: 'ur says /ər/ like turn.' }
          ]
        },
        slidePark: {
          level: 'Levels 9–10',
          description: 'Rare spellings + flexible patterns (ough, eigh). Slide between spellings + meanings.',
          defaultMinutes: 4,
          reason: 'Slide Park covers flexible spellings. Move slowly between patterns before speeding up.',
          sounds: [
            { label: 'ough', say: 'uff', explain: 'ough can say /uff/ like rough.' },
            { label: 'augh', say: 'aw', explain: 'augh can say /aw/ like caught.' },
            { label: 'eigh', say: 'ay', explain: 'eigh often says /ā/ like eight.' },
            { label: 'ie', say: 'ee', explain: 'ie can say /ē/ like chief.' },
            { label: 'oi', say: 'oy', explain: 'oi/oy stay loyal even in tricky words.' }
          ]
        }
      };

      const vowelSlugLookup = Object.keys(vowelCardData).reduce((acc, key) => {
        const slug = key
          .replace(/([a-z0-9])([A-Z])/g, '$1-$2')
          .replace(/^-+|-+$/g, '')
          .toLowerCase();
        acc[slug] = key;
        return acc;
      }, {});

      const resolveVowelCardId = raw => {
        if (!raw) return null;
        if (vowelCardData[raw]) return raw;
        const slug = String(raw)
          .trim()
          .replace(/([a-z0-9])([A-Z])/g, '$1-$2')
          .replace(/[^a-z0-9]+/gi, '-')
          .replace(/^-+|-+$/g, '')
          .toLowerCase();
        return vowelCardData[slug] ? slug : vowelSlugLookup[slug] || null;
      };

      const pickWords = topic => {
        const list = wordBank[topic] || [];
        const selection = [...list].sort(() => 0.5 - Math.random()).slice(0, 3);
        const target = el(`[data-words-display="${topic}"]`);
        if (target) target.textContent = selection.join(' · ');
      };

      const initAlphaGrid = () => {
        const grid = el('#dlxAlphaGrid');
        const output = el('#dlxAlphaOutput');
        const soundList = el('#dlxAlphaSoundList');
        const allChipsSelector = '.dlx-alpha-chip';

        const clearSoundList = () => {
          if (!soundList) return;
          soundList.hidden = true;
          soundList.innerHTML = '';
        };

        const speakPhonetics = (item, label) => {
          const segments = [];
          const intro = item.phonemeIntro || item.say || label;
          segments.push(`${label}. ${intro}`);
          segments.push('... ...');
          segments.push(`${intro}. ${item.explain}`);
          if (item.otherSounds?.length) segments.push(...item.otherSounds);
          speak(segments.filter(Boolean).join('. '));
        };

        const handleAlphaClick = (item, chip) => {
          const label = `${item.letter} / ${item.letter.toLowerCase()}`;
          const usedDorothy = playDorothyLetterClip(item.letter, { button: chip, source: 'alpha-grid' });
          if (!usedDorothy) {
            if (letterClipState.activeLetter) pauseLetterSoundAudio();
            speakPhonetics(item, label);
          }
          if (output) output.textContent = `${label} — ${item.explain}`;
          if (soundList) {
            if (item.otherSounds?.length) {
              soundList.hidden = false;
              soundList.innerHTML = '';
              item.otherSounds.forEach(note => {
                const li = document.createElement('li');
                li.textContent = note;
                soundList.appendChild(li);
              });
            } else {
              clearSoundList();
            }
          }
          document.querySelectorAll(allChipsSelector).forEach(btn => btn.classList.remove('is-highlighted'));
          chip.classList.add('is-highlighted');
          setTimeout(() => chip.classList.remove('is-highlighted'), 1200);
        };

        if (grid) {
          grid.innerHTML = '';
          alphabetSoundbank.forEach(item => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'dlx-alpha-chip';
            chip.dataset.alphaChip = item.letter;
            chip.dataset.isVowel = String('AEIOU'.includes(item.letter));
            if (chip.dataset.isVowel === 'true') chip.classList.add('is-vowel');
            const upper = document.createElement('span');
            upper.className = 'dlx-alpha-chip__upper';
            upper.textContent = item.letter;
            const lower = document.createElement('span');
            lower.className = 'dlx-alpha-chip__lower';
            lower.textContent = item.letter.toLowerCase();
            chip.append(upper, lower);
            chip.addEventListener('click', () => handleAlphaClick(item, chip));
            grid.appendChild(chip);
          });
        }

        els('[data-alpha-group]').forEach(btn => {
          btn.addEventListener('click', () => {
            const mode = btn.getAttribute('data-alpha-group');
            const chips = document.querySelectorAll(allChipsSelector);
            chips.forEach(chip => chip.classList.remove('is-highlighted'));
            if (mode === 'vowels') {
              chips.forEach(chip => {
                if (chip.dataset.isVowel === 'true') chip.classList.add('is-highlighted');
              });
              clearSoundList();
              output && (output.textContent = 'Vowels highlighted: A, E, I, O, U (upper + lower).');
            } else if (mode === 'consonants') {
              chips.forEach(chip => {
                if (chip.dataset.isVowel !== 'true') chip.classList.add('is-highlighted');
              });
              clearSoundList();
              output && (output.textContent = 'Consonants highlighted: tap to hear every extra sound.');
            } else {
              clearSoundList();
              output && (output.textContent = 'Tap any letter to hear it.');
            }
          });
        });
      };

      const initSpeechSpeedControls = () => {
        const buttons = els('[data-speech-speed]');
        const slider = el('#dlxSpeechSlider');
        const sliderValue = el('#dlxSpeechValue');
        if (!buttons.length && !slider) return;

        const clampRate = val => Math.min(1.2, Math.max(0.7, Number(val)));
        const updateSliderValue = val => {
          const fixed = clampRate(val).toFixed(2);
          if (slider) slider.value = fixed;
          if (sliderValue) sliderValue.textContent = `${fixed}×`;
        };

        const applyRate = rate => {
          speechRate = clampRate(rate) || defaultSpeechSpeed;
          state.speechSpeed = speechRate;
          updateSliderValue(speechRate);
          persist();
        };

        const setActiveMode = mode => {
          buttons.forEach(btn => {
            const isActive = btn.getAttribute('data-speech-speed') === mode;
            btn.classList.toggle('is-active', isActive);
          });
          state.speechSpeedMode = mode;
        };

        const setSpeed = mode => {
          if (!mode || !speechSpeedMap[mode]) return;
          setActiveMode(mode);
          applyRate(speechSpeedMap[mode]);
        };

        buttons.forEach(btn => {
          btn.addEventListener('click', () => setSpeed(btn.getAttribute('data-speech-speed')));
        });

        slider?.addEventListener('input', () => {
          setActiveMode('custom');
          applyRate(slider.value);
        });

        const closestPreset = Object.entries(speechSpeedMap).find(([, rate]) => Math.abs(rate - speechRate) < 0.001)?.[0];
        if (state.speechSpeedMode === 'custom' || (!closestPreset && state.speechSpeedMode !== 'slow')) {
          setActiveMode('custom');
          applyRate(state.speechSpeed || speechRate);
        } else {
          setSpeed(state.speechSpeedMode && speechSpeedMap[state.speechSpeedMode] ? state.speechSpeedMode : (closestPreset || 'slow'));
        }
      };

      const initVowelCards = () => {
        const mapDetail = el('#dlxVowelMapDetail');
        const mapEyebrow = el('#dlxVowelMapEyebrow');
        const mapTitleEl = el('#dlxVowelMapTitle');
        const mapSummaryEl = el('#dlxVowelMapSummary');
        const mapLevelsEl = el('#dlxVowelMapLevels');
        const mapMinutesEl = el('#dlxVowelMapMinutes');
        const mapPhaseLabelEl = el('#dlxVowelMapPhaseLabel');
        const mapTipEl = el('#dlxVowelMapTip');
        const mapLaunchBtn = el('#dlxVowelMapLaunch');
        const mapPhaseBtn = el('#dlxVowelMapPhase');
        const quickDesc = el('#quick-start-technique-desc');
        if (quickDesc && !quickDesc.dataset.baseDesc) {
          quickDesc.dataset.baseDesc = quickDesc.textContent || '';
        }

        const mapPhaseLookup = {
          shortStreet: 'Phase 2',
          skylineTowers: 'Phase 3',
          teamBridge: 'Phase 3',
          rRiver: 'Phase 3',
          slidePark: 'Phase 5'
        };

        let activeVowelMap = null;

        const markCardActive = card => {
          document.querySelectorAll('.dlx-vowel-card.is-active').forEach(node => node.classList.remove('is-active'));
          card?.classList.add('is-active');
        };

        const pulseDetail = () => {
          if (!mapDetail) return;
          mapDetail.classList.remove('dlx-map-pulse');
          void mapDetail.offsetWidth;
          mapDetail.classList.add('dlx-map-pulse');
        };

        const updateMapDetail = (cardId, card, data) => {
          if (!mapDetail || !data) return;
          activeVowelMap = cardId;
          mapDetail.classList.remove('is-empty');
          markCardActive(card);
          const title = card?.querySelector('h4')?.textContent?.trim() || data.description || 'Vowel map';
          const summary = data.description || card?.querySelector('p.muted')?.textContent?.trim();
          const levelLabel = card?.querySelector('.dlx-vowel-card__level')?.textContent?.trim() || data.level;
          const minutesLabel = data.defaultMinutes ? `${data.defaultMinutes} min focus` : '—';
          const phaseLabel = mapPhaseLookup[cardId] || 'Phase 3';
          mapEyebrow && (mapEyebrow.textContent = 'Map planner');
          mapTitleEl && (mapTitleEl.textContent = title);
          mapSummaryEl && (mapSummaryEl.textContent = summary || 'Ready to launch this map.');
          mapLevelsEl && (mapLevelsEl.textContent = levelLabel || '—');
          mapMinutesEl && (mapMinutesEl.textContent = minutesLabel);
          mapPhaseLabelEl && (mapPhaseLabelEl.textContent = phaseLabel);
          mapTipEl && (mapTipEl.textContent = data.reason || 'Pair this story with calm breathing, then move into Stage 3 drills.');
          if (mapLaunchBtn) {
            mapLaunchBtn.disabled = false;
            mapLaunchBtn.dataset.vowelLabel = title;
            mapLaunchBtn.dataset.vowelMinutes = data.defaultMinutes || 2;
          }
          if (mapPhaseBtn) {
            mapPhaseBtn.disabled = false;
            mapPhaseBtn.dataset.vowelPhase = phaseLabel;
          }
          pulseDetail();
        };

        const ensureFeedbackZone = card => {
          let zone = card.querySelector('[data-vowel-feedback]');
          if (!zone) {
            zone = document.createElement('p');
            zone.className = 'muted small dlx-vowel-feedback';
            zone.setAttribute('data-vowel-feedback', 'true');
            zone.setAttribute('aria-live', 'polite');
            zone.hidden = true;
            const actionRow = card.querySelector('.dlx-inline-actions');
            if (actionRow) {
              actionRow.insertAdjacentElement('afterend', zone);
            } else {
              card.appendChild(zone);
            }
          }
          return zone;
        };

        els('.dlx-vowel-card').forEach(card => {
          const primaryId = card.dataset.vowelId || card.getAttribute('data-vowel-id');
          const mapSlug = card.querySelector('[data-vowel-map]')?.getAttribute('data-vowel-map');
          const headingText = card.querySelector('h4')?.textContent;
          const cardId = resolveVowelCardId(primaryId || mapSlug || card.id || headingText);
          const data = cardId ? vowelCardData[cardId] : null;
          if (!cardId || !data) return;
          card.dataset.vowelId = cardId;

          const soundLookup = (data.sounds || []).reduce((acc, sound) => {
            if (sound?.label) acc[sound.label.toLowerCase()] = sound;
            return acc;
          }, {});
          const feedbackZone = ensureFeedbackZone(card);
          const showFeedback = message => {
            if (!feedbackZone) return;
            if (message) {
              feedbackZone.hidden = false;
              feedbackZone.textContent = message;
            } else {
              feedbackZone.hidden = true;
              feedbackZone.textContent = '';
            }
          };

          const isShortStreetCard = cardId === 'shortStreet';
          card.querySelectorAll('[data-vowel]').forEach(btn => {
            btn.addEventListener('click', evt => {
              evt.stopPropagation();
              const rawLabel = (btn.getAttribute('data-vowel') || btn.textContent || '').trim();
              const key = rawLabel.toLowerCase();
              const sound = soundLookup[key] || { label: rawLabel };
              let clipHandled = false;
              const isShortStreetLetter = SHORT_STREET_LETTERS.has(rawLabel.toUpperCase());
              pauseVowelClipAudio();
              if (isShortStreetCard && isShortStreetLetter) {
                clipHandled = playDorothyLetterClip(rawLabel, { button: btn, source: 'short-street', minDuration: VOWEL_CLIP_MIN_DURATION });
                if (!clipHandled && letterClipState.activeLetter) {
                  pauseLetterSoundAudio();
                }
                if (!clipHandled) setLetterClipActiveButton(null);
              } else {
                if (letterClipState.activeLetter) {
                  pauseLetterSoundAudio();
                }
                setLetterClipActiveButton(null);
                clipHandled = playDorothyVowelClip(rawLabel, { button: btn, source: cardId, mapId: cardId });
              }
              if (!clipHandled) {
                narrateVowelSound(sound);
              }
              showFeedback(sound?.explain || `Practise the ${rawLabel} sound.`);
            });
          });

          const handleMapSelection = () => updateMapDetail(cardId, card, data);

          const explainBtn = card.querySelector('[data-vowel-explain]');
          explainBtn?.addEventListener('click', evt => {
            evt.stopPropagation();
            const script = data.reason || data.description;
            showFeedback(script);
            if (script) speak(data.reasonVoice || script);
            if (activeVowelMap === cardId && script && mapTipEl) {
              mapTipEl.textContent = script;
            }
          });

          const mapBtn = card.querySelector('[data-vowel-map]');
          mapBtn?.addEventListener('click', evt => {
            evt.stopPropagation();
            handleMapSelection();
          });

          card.addEventListener('click', evt => {
            if (evt.target.closest('button')) return;
            handleMapSelection();
          });
        });

        mapLaunchBtn?.addEventListener('click', () => {
          if (mapLaunchBtn.disabled) return;
          const minutes = Number(mapLaunchBtn.dataset.vowelMinutes) || 2;
          openQuickStartModal({ targetId: 'dlx-breath-reset', minutes });
          if (quickDesc) {
            const base = quickDesc.dataset.baseDesc || quickDesc.textContent || '';
            quickDesc.textContent = `${base} Preparing for ${mapLaunchBtn.dataset.vowelLabel || 'this map'}.`;
          }
          pulseDetail();
        });

        mapPhaseBtn?.addEventListener('click', () => {
          if (mapPhaseBtn.disabled) return;
          const phase = mapPhaseBtn.dataset.vowelPhase;
          if (phase && window.NB_STAGE3?.setPhase) {
            window.NB_STAGE3.setPhase(phase);
          }
          if (window.NB_STAGE3?.scrollIntoView) {
            window.NB_STAGE3.scrollIntoView();
          } else {
            document.getElementById('dlxStage3')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          const stage3ElRef = document.getElementById('dlxStage3');
          if (stage3ElRef) {
            stage3ElRef.classList.remove('dlx-stage--flash');
            void stage3ElRef.offsetWidth;
            stage3ElRef.classList.add('dlx-stage--flash');
            window.setTimeout(() => stage3ElRef.classList.remove('dlx-stage--flash'), 1400);
          }
          if (mapTipEl && phase) {
            mapTipEl.textContent = `Stage 3 drills now filtered to ${phase}.`;
          }
          pulseDetail();
        });
      };

      const initImageIntroOutro = () => {
        const images = Array.from(document.querySelectorAll('img'));
        if (!images.length) return;
        images.forEach(img => img.setAttribute('data-animate-image', 'true'));
        if (!('IntersectionObserver' in window)) {
          images.forEach(img => img.classList.add('is-image-intro'));
          return;
        }
        const observer = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-image-intro');
              entry.target.classList.remove('is-image-outro');
            } else {
              entry.target.classList.remove('is-image-intro');
              entry.target.classList.add('is-image-outro');
            }
          });
        }, { threshold: 0.35, rootMargin: '0px 0px -10% 0px' });
        images.forEach(img => observer.observe(img));
      };

      initImageIntroOutro();
      initAlphaGrid();
      initSpeechSpeedControls();
      initVowelCards();
      updateSoundQuestUI();

      if (letterSoundGrid && !letterSoundGrid.childElementCount) {
        buildLetterSoundGrid();
      }
      setLetterSoundVisual(letterSoundState.currentLetter || 'A', 'rest', { forceShape: true });
      setLetterSoundPauseState(true);

      const updateMiniGameStatus = topic => {
        const statusEl = el(`[data-topic-status="${topic}"]`);
        if (!statusEl) return;
        const stats = state.miniGames[topic] || { rounds: 0, stars: 0 };
        statusEl.textContent = `Rounds today: ${stats.rounds} • Stars: ${stats.stars}`;
      };

      ['short', 'long', 'team'].forEach(topic => {
        pickWords(topic);
        updateMiniGameStatus(topic);
      });

      els('.js-vowel-new').forEach(btn => btn.addEventListener('click', () => pickWords(btn.getAttribute('data-topic'))));

      els('.js-vowel-complete').forEach(btn => {
        btn.addEventListener('click', () => {
          const topic = btn.getAttribute('data-topic');
          const stats = state.miniGames[topic];
          if (!stats) return;
          stats.rounds += 1;
          if (stats.rounds % 3 === 0) {
            stats.stars += 1;
            state.scratchReady = true;
          }
          state.gamesCompleted += 1;
          persist();
          updateMiniGameStatus(topic);
          updateStatsUI();
        });
      });

      const profilePanel = el('#dlxProfilePanel');
      const profileName = el('#dlxProfileName');
      const profileReward = el('#dlxProfileReward');
      const profileVoice = el('#dlxProfileVoice');
      const profileReminder = el('#dlxProfileReminder');
      const profileAge = el('#dlxProfileAge');
      const profileGender = el('#dlxProfileGender');
      const profileOrigin = el('#dlxProfileOrigin');

      const openProfilePanel = () => {
        profileName.value = state.profile.name;
        profileReward.value = state.profile.reward;
        profileVoice.value = state.profile.voice;
        profileReminder.checked = state.profile.reminder;
        profileAge.value = state.profile.age || '';
        profileGender.value = state.profile.gender || '';
        profileOrigin.value = state.profile.origin || '';
        profilePanel.removeAttribute('hidden');
      };

      const closeProfilePanel = () => profilePanel.setAttribute('hidden', 'hidden');

      el('#dlxOpenProfileBtn')?.addEventListener('click', openProfilePanel);
      els('[data-profile-close]').forEach(btn => btn.addEventListener('click', closeProfilePanel));

      el('#dlxProfileSave')?.addEventListener('click', () => {
        state.profile.name = profileName.value.trim();
        state.profile.reward = profileReward.value;
        state.profile.voice = profileVoice.value;
        state.profile.reminder = profileReminder.checked;
        state.profile.age = profileAge.value ? Math.min(120, Math.max(4, Number(profileAge.value))) : '';
        state.profile.gender = profileGender.value;
        state.profile.origin = profileOrigin.value.trim();
        persist();
        closeProfilePanel();
      });

      const downloadBtn = el('#downloadResourcesPdf');
      downloadBtn?.addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = 'assets/downloads/dyslexia-adult-resources.pdf';
        link.download = 'NeuroBreath-dyslexia-resources.pdf';
        document.body.appendChild(link);
        link.click();
        link.remove();
      });

      document.addEventListener('keydown', evt => {
        if (evt.key === 'Escape') {
          if (!focusScreen.hasAttribute('hidden')) closeFocusScreen();
          if (!scratchModal.hasAttribute('hidden')) scratchModal.setAttribute('hidden', 'hidden');
          if (!profilePanel.hasAttribute('hidden')) closeProfilePanel();
          if (!soundQuestScreen?.hasAttribute('hidden')) closeSoundQuest();
        }
      });
    })();
  </script>

  <script src="assets/js/dlx-phonics-curriculum-phase-2-3-5.js"></script>
  <script src="assets/js/dlx-audio-tts-bridge.js"></script>
  <script src="assets/js/dlx-analytics-stage3.js"></script>
  <script>
    (() => {
      const onReady = fn => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fn);
        } else {
          fn();
        }
      };

      const addFreshAnimation = (el, className) => {
        if (!el) return;
        el.classList.remove(className);
        void el.offsetWidth;
        el.classList.add(className);
      };

      const stage3Curriculum = window.NB_CURRICULUM || {};

      const legacyVowelQuestPool = [
        { level: 1, family: 'Short Street', soundLabel: 'short /a/', clue: 'Which spelling matches the vowel in “cat”?', options: ['a', 'ai', 'ar'], correct: 'a', hint: 'Short Street: one letter, quick sound.' },
        { level: 2, family: 'Short Street', soundLabel: 'short /e/', clue: 'Which spelling matches the vowel in “bed”?', options: ['e', 'ee', 'ea'], correct: 'e', hint: 'Short Street again – single vowel letter.' },
        { level: 3, family: 'Short Street', soundLabel: 'short /u/', clue: 'Which spelling matches the vowel in “sun”?', options: ['u', 'ue', 'oo'], correct: 'u', hint: 'Think of the quick sound in “sun”.' },
        { level: 4, family: 'Skyline Towers', soundLabel: 'long /ai/', clue: 'Which spelling matches the vowel in “rain”?', options: ['ai', 'a', 'ar'], correct: 'ai', hint: 'Skyline Towers uses vowel teams like “ai”.' },
        { level: 5, family: 'Skyline Towers', soundLabel: 'long /ee/', clue: 'Which spelling matches the vowel in “tree”?', options: ['ee', 'e', 'ea'], correct: 'ee', hint: 'Long /ee/ often uses “ee” in the middle.' },
        { level: 6, family: 'Skyline Towers', soundLabel: 'long /oe/', clue: 'Which spelling matches the vowel in “boat”?', options: ['oa', 'o', 'oo'], correct: 'oa', hint: 'Think of the tower story: oa keeps the sound long.' },
        { level: 7, family: 'Team Bridge', soundLabel: 'long /ie/', clue: 'Which spelling matches the vowel in “pie”?', options: ['ie', 'i', 'ee'], correct: 'ie', hint: 'Two letters, one sound: team story.' },
        { level: 8, family: 'R-River', soundLabel: '/ar/', clue: 'Which spelling matches the vowel in “car”?', options: ['ar', 'a', 'ai'], correct: 'ar', hint: 'R-River patterns glue vowel + r together.' },
        { level: 9, family: 'R-River', soundLabel: '/er/', clue: 'Which spelling matches the vowel in “her”?', options: ['er', 'ur', 'ir'], correct: 'er', hint: 'All three can say /er/, but “her” uses “er”.' },
        { level: 10, family: 'Slide Park', soundLabel: 'flexible /oa/', clue: 'Which spelling matches the vowel in “though”?', options: ['ough', 'oa', 'oe'], correct: 'ough', hint: 'Slide Park: flexible patterns like “ough”.' }
      ];

      const getVowelQuestQuestions = () => {
        const levels = Array.isArray(stage3Curriculum?.vowelQuest?.levels) ? stage3Curriculum.vowelQuest.levels : [];
        const normalized = [];
        levels.forEach((level, levelIdx) => {
          const label = (level?.label || '').trim() || `Level ${level?.levelNumber || levelIdx + 1}`;
          const description = (level?.description || '').trim();
          (Array.isArray(level?.items) ? level.items : []).forEach((item, idx) => {
            const options = Array.isArray(item?.options) ? item.options.map(opt => String(opt)).filter(Boolean) : [];
            if (!options.length) return;
            const correctIndex = Number.isInteger(item?.correctIndex)
              ? Math.min(Math.max(item.correctIndex, 0), options.length - 1)
              : 0;
            normalized.push({
              level: item?.levelNumber || level?.levelNumber || idx + 1,
              family: label,
              soundLabel: item?.displayPrompt || (item?.phoneme ? `Sound: ${item.phoneme}` : 'Target sound'),
              clue: item?.clue || item?.coachCue || 'Tap the spelling or word that matches this vowel sound.',
              options,
              correct: options[correctIndex],
              hint: item?.hint || description || 'Focus on accuracy first, then gentle speed.'
            });
          });
        });
        return normalized.length ? normalized : legacyVowelQuestPool;
      };

      const legacyFluencySentences = [
        'The calm reader takes a gentle breath at every full stop.',
        'Pause slightly at commas and let your voice fall at the end of a sentence.',
        'Keep your eyes moving forward, even if one word feels sticky.',
        'Match your breathing to the rhythm of the line, not to a stopwatch.',
        'Let your voice show the question mark or exclamation mark at the end.',
        'Read as if you are explaining this sentence to a friend who trusts you.',
        'Slow, steady reading often leads to stronger understanding.',
        'Tiny pauses between phrases give your working memory time to catch up.',
        'You can always read a sentence twice if it helps it feel smoother.',
        'Expression and calm pacing matter more than racing to the end.'
      ];

      const getFluencySentencePool = () => {
        const sets = Array.isArray(stage3Curriculum?.fluencyPacer?.sets) ? stage3Curriculum.fluencyPacer.sets : [];
        const normalized = [];
        sets.forEach(set => {
          const label = (set?.label || '').trim() || 'Fluency pacer set';
          const description = (set?.description || '').trim();
          const wpmTarget = Number(set?.wpmTarget) || null;
          (Array.isArray(set?.sentences) ? set.sentences : []).forEach(sentence => {
            const text = String(sentence || '').trim();
            if (!text) return;
            normalized.push({ text, label, description, wpmTarget });
          });
        });
        if (normalized.length) return normalized;
        return legacyFluencySentences.map(text => ({ text, label: 'Calm pacing set', description: 'Coaching lines for expression practice.', wpmTarget: 70 }));
      };

      function initVowelQuest() {
        const panel = document.getElementById('vowelQuestGame');
        if (!panel) return;

        const roundEl = document.getElementById('vowelQuestRound');
        const levelEl = document.getElementById('vowelQuestLevel');
        const streakEl = document.getElementById('vowelQuestStreak');
        const scoreEl = document.getElementById('vowelQuestScore');
        const promptEl = document.getElementById('vowelQuestPrompt');
        const optionsEl = document.getElementById('vowelQuestOptions');
        const feedbackEl = document.getElementById('vowelQuestFeedback');
        const startBtn = document.getElementById('vowelQuestStartBtn');
        const hintBtn = document.getElementById('vowelQuestHintBtn');

        const items = getVowelQuestQuestions();
        if (!items.length) {
          if (promptEl) {
            promptEl.textContent = 'Add Vowel Quest levels to NB_CURRICULUM to unlock this drill.';
          }
          startBtn && (startBtn.disabled = true);
          hintBtn && (hintBtn.disabled = true);
          return;
        }

        let currentIndex = -1;
        let score = 0;
        let streak = 0;
        let roundsPlayed = 0;
        let awaitingAnswer = false;

        const updateStatus = () => {
          const active = currentIndex >= 0 ? items[currentIndex] : items[0];
          if (levelEl) levelEl.textContent = active ? String(active.level || 1) : '1';
          if (streakEl) streakEl.textContent = String(streak);
          if (scoreEl) scoreEl.textContent = String(score);
          if (roundEl) roundEl.textContent = roundsPlayed > 0 ? String(roundsPlayed) : '–';
        };

        const clearOptions = () => {
          while (optionsEl.firstChild) {
            optionsEl.removeChild(optionsEl.firstChild);
          }
        };

        const renderQuestion = () => {
          const poolIndex = (currentIndex + 1) % items.length;
          currentIndex = poolIndex;
          const item = items[poolIndex];

          roundsPlayed += 1;
          panel.classList.add('dlx-game-panel--active');
          awaitingAnswer = true;
          clearOptions();

          if (promptEl) {
            const soundLabel = item.soundLabel || 'Target sound';
            const clue = item.clue || 'Tap the spelling that matches this sound.';
            promptEl.textContent = `${soundLabel} · ${clue}`;
            addFreshAnimation(promptEl, 'dlx-prompt--fresh');
          }
          if (feedbackEl) {
            const baseHint = item.hint || 'Focus on accuracy first, then speed.';
            feedbackEl.textContent = `${item.family} · ${baseHint}`;
          }

          const shuffled = item.options.slice().sort(() => Math.random() - 0.5);
          shuffled.forEach(opt => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline dlx-game-option';
            btn.textContent = opt;
            btn.setAttribute('data-choice', opt);
            btn.addEventListener('click', () => handleChoice(item, opt, btn));
            optionsEl.appendChild(btn);
          });

          if (startBtn) startBtn.textContent = 'Next round';
          updateStatus();
        };

        const handleChoice = (item, choice, buttonEl) => {
          if (!awaitingAnswer) return;
          awaitingAnswer = false;

          const buttons = Array.from(optionsEl.querySelectorAll('button'));
          buttons.forEach(btn => {
            btn.disabled = true;
            if (btn.getAttribute('data-choice') === item.correct) {
              btn.classList.add('is-correct');
            }
          });

          if (choice === item.correct) {
            score += 1;
            streak += 1;
            buttonEl && buttonEl.classList.add('is-correct');
            if (feedbackEl) {
              const streakNote = streak >= 5
                ? 'You have a strong calm streak building — note how your body feels.'
                : 'Take one calm breath before you start the next round.';
              feedbackEl.textContent = `Correct – ${item.family} win. ${streakNote}`;
            }
          } else {
            streak = 0;
            if (buttonEl) {
              buttonEl.classList.add('is-wrong');
            }
            if (feedbackEl) {
              feedbackEl.textContent = `That was a tricky one. The best match here is “${item.correct}”. You can always replay this sound family.`;
            }
          }

          panel.classList.remove('dlx-game-panel--active');
          updateStatus();
        };

        startBtn?.addEventListener('click', () => {
          renderQuestion();
        });

        hintBtn?.addEventListener('click', () => {
          if (currentIndex < 0) {
            if (feedbackEl) {
              feedbackEl.textContent = 'Start a round first so your hint matches the sound family.';
            }
            return;
          }
          const item = items[currentIndex];
          if (feedbackEl) {
            feedbackEl.textContent = item?.hint || 'Name the pattern before you tap.';
          }
        });

        updateStatus();
      }

      function initFluencyPacer() {
        const panel = document.getElementById('fluencyPacerGame');
        if (!panel) return;

        const sentenceEl = document.getElementById('fluencyPacerSentence');
        const countEl = document.getElementById('fluencyPacerCount');
        const paceLabelEl = document.getElementById('fluencyPacerPaceLabel');
        const progressEl = document.getElementById('fluencyPacerProgress');
        const timerEl = document.getElementById('fluencyPacerTimer');
        const feedbackEl = document.getElementById('fluencyPacerFeedback');

        const paceButtons = Array.from(panel.querySelectorAll('.fluency-pace-btn'));
        const startBtn = document.getElementById('fluencyPacerStartBtn');
        const nextBtn = document.getElementById('fluencyPacerNextBtn');

        const sentencePool = getFluencySentencePool();
        if (!sentencePool.length) {
          if (sentenceEl) sentenceEl.textContent = 'Add fluency sets to NB_CURRICULUM.fluencyPacer to unlock this drill.';
          startBtn && (startBtn.disabled = true);
          nextBtn && (nextBtn.disabled = true);
          paceButtons.forEach(btn => (btn.disabled = true));
          return;
        }

        const paceDurations = { slow: 18, medium: 12, fast: 8 };

        let currentIndex = 0;
        let currentPace = 'medium';
        let timerId = null;
        let remaining = 0;
        let sentencesRead = 0;

        const formatSeconds = s => `${String(s).padStart(2, '0')}s`;

        const updateCount = () => {
          if (countEl) countEl.textContent = String(sentencesRead);
        };

        const setPace = pace => {
          if (!paceDurations[pace]) return;
          currentPace = pace;
          paceButtons.forEach(btn => {
            if (btn.dataset.pace === pace) {
              btn.classList.add('is-active');
            } else {
              btn.classList.remove('is-active');
            }
          });
          if (paceLabelEl) {
            const label = pace === 'slow' ? 'Slow' : pace === 'fast' ? 'Fast' : 'Medium';
            paceLabelEl.textContent = label;
          }
        };

        const showSentence = () => {
          if (!sentencePool.length || !sentenceEl) return;
          const current = sentencePool[currentIndex];
          sentenceEl.textContent = current?.text || 'Take a calm breath, then tap Start.';
          addFreshAnimation(sentenceEl, 'dlx-prompt--fresh');
        };

        const resetTimer = () => {
          clearInterval(timerId);
          timerId = null;
          remaining = 0;
          if (progressEl) progressEl.value = 0;
          if (timerEl) timerEl.textContent = '00s';
          panel.classList.remove('dlx-game-panel--active');
        };

        const startPacer = () => {
          resetTimer();
          const duration = paceDurations[currentPace];
          remaining = duration;
          if (progressEl) progressEl.value = 0;

          paceButtons.forEach(btn => (btn.disabled = true));
          if (startBtn) startBtn.disabled = true;
          if (nextBtn) nextBtn.disabled = true;

          panel.classList.add('dlx-game-panel--active');

          timerId = window.setInterval(() => {
            remaining -= 1;
            const elapsed = Math.max(0, duration - remaining);
            if (progressEl) {
              progressEl.value = Math.round((elapsed / duration) * 100);
            }
            if (timerEl) {
              timerEl.textContent = formatSeconds(Math.max(remaining, 0));
            }
            if (remaining <= 0) {
              clearInterval(timerId);
              timerId = null;
              panel.classList.remove('dlx-game-panel--active');
              if (timerEl) timerEl.textContent = 'Done';
              if (feedbackEl) {
                feedbackEl.textContent = 'Nice work. Take one gentle breath, then tap “Next sentence” when you are ready.';
              }
              if (nextBtn) nextBtn.disabled = false;
              paceButtons.forEach(btn => (btn.disabled = false));
              if (startBtn) startBtn.disabled = false;
            }
          }, 1000);
        };

        paceButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const pace = btn.dataset.pace;
            setPace(pace);
          });
        });

        startBtn?.addEventListener('click', () => {
          if (!sentenceEl || !sentenceEl.textContent) {
            showSentence();
          }
          if (feedbackEl) {
            const meta = sentencePool[currentIndex];
            const labelNote = meta?.label ? `${meta.label}. ` : '';
            feedbackEl.textContent = `${labelNote}Read aloud with gentle pacing. Notice your breathing at the end of each line.`;
          }
          startPacer();
        });

        nextBtn?.addEventListener('click', () => {
          sentencesRead += 1;
          updateCount();
          currentIndex = (currentIndex + 1) % sentencePool.length;
          showSentence();

          if (feedbackEl) {
            const meta = sentencePool[currentIndex];
            const labelNote = meta?.label ? `${meta.label}. ` : '';
            if (sentencesRead === 3 || sentencesRead === 5 || sentencesRead === 10) {
              feedbackEl.textContent = `${labelNote}You have completed ${sentencesRead} calm sentences. That is a strong fluency block — well done.`;
            } else {
              feedbackEl.textContent = `${labelNote}Scan the next sentence quickly with your eyes, then start the pacer again when ready.`;
            }
          }
          if (nextBtn) nextBtn.disabled = true;
          resetTimer();
        });

        setPace('medium');
        showSentence();
        updateCount();
      }

      function initRapidNaming() {
        const panel = document.getElementById('rapidNamingGame');
        if (!panel) return;

        const stripEl = document.getElementById('rapidNamingStrip');
        const progressEl = document.getElementById('rapidNamingProgress');
        const timerEl = document.getElementById('rapidNamingTimer');
        const stripsEl = document.getElementById('rapidNamingStrips');
        const bestEl = document.getElementById('rapidNamingBest');
        const feedbackEl = document.getElementById('rapidNamingFeedback');

        const newStripBtn = document.getElementById('rapidNamingNewStripBtn');
        const startBtn = document.getElementById('rapidNamingStartBtn');
        const completeBtn = document.getElementById('rapidNamingCompleteBtn');

        const items = ['red', 'blue', 'green', 'yellow', 'purple', 'circle', 'square', 'triangle', 'star', 'heart', 'sun', 'moon', 'cloud', 'tree', 'leaf', 'cat', 'dog', 'bus', 'train', 'book'];

        const STRIP_LENGTH = 8;
        const MAX_SECONDS = 40;
        const STORAGE_KEY = 'dlx_rapidNamingStats';
        const todayKey = () => new Date().toISOString().slice(0, 10);

        let timerId = null;
        let elapsed = 0;
        let stripsCount = 0;
        let stripsToday = 0;
        let statsDate = todayKey();
        let bestTime = null;
        let hasActiveStrip = false;

        const formatSeconds = s => `${String(s).padStart(2, '0')}s`;

        const ensureCurrentDay = () => {
          const today = todayKey();
          if (statsDate !== today) {
            statsDate = today;
            stripsToday = 0;
          }
        };

        const loadStats = () => {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (typeof parsed.stripsCount === 'number') stripsCount = parsed.stripsCount;
            if (typeof parsed.bestTime === 'number') bestTime = parsed.bestTime;
            if (typeof parsed.stripsToday === 'number') stripsToday = parsed.stripsToday;
            if (typeof parsed.date === 'string') statsDate = parsed.date;
          } catch (e) {
            /* noop */
          }
          ensureCurrentDay();
        };

        const saveStats = () => {
          try {
            const payload = JSON.stringify({ stripsCount, bestTime, stripsToday, date: statsDate });
            window.localStorage.setItem(STORAGE_KEY, payload);
          } catch (e) {
            /* noop */
          }
        };

        const updateStats = () => {
          if (stripsEl) stripsEl.textContent = String(stripsToday);
          if (bestEl) {
            bestEl.textContent = bestTime == null ? '—' : formatSeconds(bestTime);
          }
        };

        const resetTimer = () => {
          clearInterval(timerId);
          timerId = null;
          elapsed = 0;
          if (progressEl) progressEl.value = 0;
          if (timerEl) timerEl.textContent = '00s';
          panel.classList.remove('dlx-game-panel--active');
        };

        const buildStrip = () => {
          if (!stripEl) return;
          stripEl.innerHTML = '';
          const pool = items.slice();
          for (let i = 0; i < STRIP_LENGTH; i += 1) {
            const choiceIndex = Math.floor(Math.random() * pool.length);
            const value = pool.splice(choiceIndex, 1)[0];
            const chip = document.createElement('span');
            chip.className = 'dlx-strip-chip';
            chip.textContent = value;
            stripEl.appendChild(chip);
          }
          addFreshAnimation(stripEl, 'dlx-strip--fresh');
        };

        const startTimer = () => {
          resetTimer();
          if (progressEl) progressEl.value = 0;
          panel.classList.add('dlx-game-panel--active');

          timerId = window.setInterval(() => {
            elapsed += 1;
            const clamped = Math.min(elapsed, MAX_SECONDS);
            if (progressEl) {
              progressEl.value = Math.round((clamped / MAX_SECONDS) * 100);
            }
            if (timerEl) timerEl.textContent = formatSeconds(clamped);
            if (elapsed >= MAX_SECONDS) {
              clearInterval(timerId);
              timerId = null;
              panel.classList.remove('dlx-game-panel--active');
              if (feedbackEl) {
                feedbackEl.textContent = 'You reached the top of the calm timer. Finish the strip in your own time, then tap “Strip finished”.';
              }
              completeBtn && (completeBtn.disabled = false);
            }
          }, 1000);
        };

        newStripBtn?.addEventListener('click', () => {
          buildStrip();
          hasActiveStrip = true;
          resetTimer();
          if (feedbackEl) {
            feedbackEl.textContent = 'Name each item from left to right. When ready, start the calm timer and keep your rhythm steady.';
          }
          if (startBtn) startBtn.disabled = false;
          if (completeBtn) completeBtn.disabled = true;
        });

        startBtn?.addEventListener('click', () => {
          if (!hasActiveStrip) {
            buildStrip();
            hasActiveStrip = true;
          }
          if (feedbackEl) {
            feedbackEl.textContent = 'Let your eyes glide along the strip. Calm rhythm beats racing to the end.';
          }
          startBtn.disabled = true;
          if (newStripBtn) newStripBtn.disabled = true;
          if (completeBtn) completeBtn.disabled = false;
          startTimer();
        });

        completeBtn?.addEventListener('click', () => {
          clearInterval(timerId);
          timerId = null;
          panel.classList.remove('dlx-game-panel--active');

          const finalTime = elapsed || 1;
          ensureCurrentDay();
          stripsToday += 1;
          stripsCount += 1;
          if (bestTime == null || finalTime < bestTime) {
            bestTime = finalTime;
            if (feedbackEl) {
              feedbackEl.textContent = `New calm best: ${formatSeconds(finalTime)}. Notice how your body feels at this rhythm.`;
            }
          } else if (feedbackEl) {
            feedbackEl.textContent = `Strip logged in ${formatSeconds(finalTime)}. Compare how your body feels with previous runs, not just the number.`;
          }

          if (stripsToday === 3 || stripsToday === 5 || stripsToday === 10) {
            if (feedbackEl) {
              feedbackEl.textContent += ' This is a great moment to trigger a small Scratch & Shine celebration.';
            }
          }

          hasActiveStrip = false;
          if (newStripBtn) newStripBtn.disabled = false;
          if (startBtn) startBtn.disabled = true;
          if (completeBtn) completeBtn.disabled = true;
          resetTimer();
          updateStats();
          saveStats();

          if (typeof window.updateDlxRewardsBar === 'function') {
            window.updateDlxRewardsBar();
          }
        });

        loadStats();
        updateStats();
        resetTimer();
      }

      /* ------------------------- VOWEL STUDIOS PLANNER ------------------------- */

      function initVowelStudiosPlanner() {
        const panels = Array.from(document.querySelectorAll('.dlx-studio-panel'));
        if (!panels.length) return;

        const STORAGE_KEY_PREFIX = 'dlx_studio_';

        const todayKey = () => {
          const d = new Date();
          return d.toISOString().slice(0, 10);
        };

        const loadStudioState = studioKey => {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY_PREFIX + studioKey);
            if (!raw) return null;
            return JSON.parse(raw);
          } catch (e) {
            return null;
          }
        };

        const saveStudioState = (studioKey, state) => {
          try {
            window.localStorage.setItem(STORAGE_KEY_PREFIX + studioKey, JSON.stringify(state));
          } catch (e) {
            /* noop */
          }
        };

        const updateStudioUI = (panel, state) => {
          const stepsDone = state.stepsToday?.length || 0;
          const stepsTotal = panel.querySelectorAll('.dlx-step-chip').length;

          const stepsEl = panel.querySelector('[data-studio-steps]');
          const streakEl = panel.querySelector('[data-studio-streak]');
          const progressEl = panel.querySelector('[data-studio-progress]');
          const progressLabelEl = panel.querySelector('[data-studio-progress-label]');
          const feedbackEl = panel.querySelector('[data-studio-feedback]');

          if (stepsEl) stepsEl.textContent = String(stepsDone);
          if (streakEl) streakEl.textContent = String(state.streakDays || 0);

          if (progressEl) {
            progressEl.max = stepsTotal || 4;
            progressEl.value = stepsDone;
          }
          if (progressLabelEl) {
            progressLabelEl.textContent = `${stepsDone}/${stepsTotal || 4}`;
          }

          const chips = Array.from(panel.querySelectorAll('.dlx-step-chip'));
          chips.forEach(chip => {
            const stepId = chip.getAttribute('data-step-id');
            const statusSpan = chip.querySelector('.dlx-step-chip-status');
            const isDone = state.stepsToday?.includes(stepId);
            chip.classList.toggle('is-done', !!isDone);
            if (statusSpan) {
              statusSpan.textContent = isDone ? 'Done' : 'Not done';
            }
          });

          if (feedbackEl) {
            if (!stepsTotal) {
              feedbackEl.textContent = 'Pick one realistic step and mark it when finished.';
            } else if (stepsDone === 0) {
              feedbackEl.textContent = 'Start with one step only. It is better to do 1–2 strong steps than rush all four.';
            } else if (stepsDone < stepsTotal) {
              feedbackEl.textContent = `You completed ${stepsDone} of ${stepsTotal} steps today — strong work. Pause for a breath, then decide if the next lamp needs to light up now or tomorrow.`;
            } else {
              feedbackEl.textContent = 'All four steps are lit. Take one deep breath in, one slow breath out, log a Strength note, then Scratch & Shine.';
            }
          }
        };

        const initialisePanel = panel => {
          const studioKey = panel.getAttribute('data-studio-key');
          if (!studioKey) return;

          const today = todayKey();
          let state = loadStudioState(studioKey) || {
            lastDate: null,
            streakDays: 0,
            stepsToday: []
          };

          if (state.lastDate !== today) {
            if (state.lastDate) {
              try {
                const prev = new Date(state.lastDate);
                const now = new Date(today);
                const diffDays = Math.floor((now - prev) / (1000 * 60 * 60 * 24));
                if (diffDays === 1) {
                  state.streakDays = (state.streakDays || 0) + 1;
                } else if (diffDays > 1) {
                  state.streakDays = 1;
                } else if (!state.streakDays) {
                  state.streakDays = 1;
                }
              } catch (e) {
                state.streakDays = state.streakDays || 1;
              }
            } else {
              state.streakDays = state.streakDays || 1;
            }
            state.lastDate = today;
            state.stepsToday = [];
          }

          const chips = Array.from(panel.querySelectorAll('.dlx-step-chip'));
          chips.forEach(chip => {
            chip.addEventListener('click', () => {
              const stepId = chip.getAttribute('data-step-id');
              if (!stepId) return;
              const idx = state.stepsToday.indexOf(stepId);
              if (idx === -1) {
                state.stepsToday.push(stepId);
              } else {
                state.stepsToday.splice(idx, 1);
              }
              panel.classList.add('dlx-game-panel--active');
              updateStudioUI(panel, state);
              saveStudioState(studioKey, state);
            });
          });

          const completeBtn = panel.querySelector('[data-studio-complete-day]');
          if (completeBtn) {
            completeBtn.addEventListener('click', () => {
              const allIds = chips.map(chip => chip.getAttribute('data-step-id')).filter(Boolean);
              state.stepsToday = allIds;
              state.lastDate = todayKey();
              state.streakDays = (state.streakDays || 0) + (state.stepsToday.length ? 0 : 1);
              panel.classList.add('dlx-game-panel--active');
              updateStudioUI(panel, state);
              saveStudioState(studioKey, state);
            });
          }

          updateStudioUI(panel, state);
        };

        panels.forEach(initialisePanel);
      }

      /* ------------------------- MINI GAMES HUB ------------------------- */

      function initMiniGamesHub() {
        const panel = document.getElementById('miniGamesHubPanel');
        if (!panel) return;

        const todayEl = document.getElementById('miniGamesToday');
        const xpEl = document.getElementById('miniGamesXP');
        const promptEl = document.getElementById('miniGamePrompt');
        const feedbackEl = document.getElementById('miniGameFeedback');
        const newBtn = document.getElementById('miniGameNewBtn');
        const doneBtn = document.getElementById('miniGameDoneBtn');
        const typeButtons = Array.from(panel.querySelectorAll('.mini-type-btn'));

        const STORAGE_KEY = 'dlx_miniGames';

        const todayKey = () => {
          const d = new Date();
          return d.toISOString().slice(0, 10);
        };

        const challengeTemplates = {
          sound: [
            'Pick one vowel sound and find 5 words around you that use it. Say each word twice, then one calm breath.',
            'Use mouth cues or mirrors to show 3 vowel sounds, then let the learner “be the teacher” and copy you.',
            'Say a word and ask: “Where does the vowel live?” (short street, tower, team, r-river or slide park).',
            'Clap once for each sound in a short word, then stretch the vowel and say it in slow motion.'
          ],
          word: [
            'Build 3 words with the same pattern using tiles or scrap paper, then read them in a silly voice.',
            'Sort 8 words into two columns (for example short /a/ vs long /ai/). Count which side wins.',
            'Take one sentence from the Vowel Studio and swap just one word at a time to make new sentences.',
            'Choose 3 words and draw a tiny sketch for each one instead of writing a definition.'
          ],
          breath: [
            '1 minute of box breathing while tracing words with a finger, then share one sentence that feels easier.',
            'Breathe in for 4, out for 4 while slowly reading a word list together, one word at a time.',
            'Use coherent breathing (5-5) for 6 breaths, then read a single paragraph out loud.',
            'Silent box breathing (no audio) for 30–60 seconds before a tricky reading passage.'
          ]
        };

        let state = {
          today: todayKey(),
          todayCount: 0,
          xp: 0
        };

        const loadState = () => {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return;
            state = {
              today: parsed.today || todayKey(),
              todayCount: parsed.todayCount || 0,
              xp: parsed.xp || 0
            };
            if (state.today !== todayKey()) {
              state.today = todayKey();
              state.todayCount = 0;
            }
          } catch (e) {
            /* noop */
          }
        };

        const saveState = () => {
          try {
            window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch (e) {
            /* noop */
          }
        };

        const updateUI = () => {
          if (todayEl) todayEl.textContent = String(state.todayCount);
          if (xpEl) xpEl.textContent = String(state.xp);
        };

        const getActiveType = () => {
          const active = typeButtons.find(btn => btn.classList.contains('is-active'));
          return active?.dataset.type || 'sound';
        };

        let hasActiveChallenge = false;

        typeButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            typeButtons.forEach(b => b.classList.remove('is-active'));
            btn.classList.add('is-active');
            if (feedbackEl) {
              feedbackEl.textContent = 'Type selected. Tap “New challenge” to generate a ready-to-use idea for that category.';
            }
          });
        });

        newBtn?.addEventListener('click', () => {
          const type = getActiveType();
          const list = challengeTemplates[type] || [];
          if (!list.length) return;
          const choice = list[Math.floor(Math.random() * list.length)];
          if (promptEl) {
            promptEl.textContent = choice;
            addFreshAnimation(promptEl, 'dlx-prompt--fresh');
          }
          if (feedbackEl) {
            feedbackEl.textContent = 'Run this mini game once. When you are done offline, tap “Mark done” to log calm XP.';
          }
          hasActiveChallenge = true;
          panel.classList.add('dlx-game-panel--active');
          if (doneBtn) doneBtn.disabled = false;
        });

        doneBtn?.addEventListener('click', () => {
          if (!hasActiveChallenge) return;
          hasActiveChallenge = false;
          panel.classList.remove('dlx-game-panel--active');

          state.todayCount += 1;
          state.xp += 5;
          saveState();
          updateUI();

          if (typeof window.updateDlxRewardsBar === 'function') {
            window.updateDlxRewardsBar();
          }

          if (feedbackEl) {
            let extra = '';
            if (state.todayCount === 3 || state.todayCount === 5 || state.todayCount === 10) {
              extra = ' This is a strong moment for a sticker, Scratch & Shine reward, or a quick “you kept going” shout-out.';
            }
            feedbackEl.textContent = `Mini game logged. You have completed ${state.todayCount} today and earned ${state.xp} calm XP in total.` + extra;
          }
          if (doneBtn) doneBtn.disabled = true;
        });

        loadState();
        updateUI();
      }

      /* ------------------------- QUEST MODES ------------------------- */

      function initQuestModes() {
        const panels = Array.from(document.querySelectorAll('.dlx-quest-panel'));
        if (!panels.length) return;

        const STORAGE_KEY_PREFIX = 'dlx_quest_';

        const loadQuestState = questKey => {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY_PREFIX + questKey);
            if (!raw) return null;
            return JSON.parse(raw);
          } catch (e) {
            return null;
          }
        };

        const saveQuestState = (questKey, state) => {
          try {
            window.localStorage.setItem(STORAGE_KEY_PREFIX + questKey, JSON.stringify(state));
          } catch (e) {
            /* noop */
          }
        };

        const updateQuestUI = (panel, state) => {
          const steps = Array.from(panel.querySelectorAll('.dlx-quest-step-btn'));
          const stepsDone = state.completed || [];
          const doneCount = stepsDone.length;
          const total = steps.length || 1;

          const stepsEl = panel.querySelector('[data-quest-steps]');
          const badgeEl = panel.querySelector('[data-quest-badge]');
          const progressEl = panel.querySelector('[data-quest-progress]');
          const progressLabelEl = panel.querySelector('[data-quest-progress-label]');
          const feedbackEl = panel.querySelector('[data-quest-feedback]');

          if (stepsEl) stepsEl.textContent = String(doneCount);
          if (badgeEl) badgeEl.textContent = state.badgeEarned ? 'Unlocked' : 'Not yet';

          if (progressEl) {
            progressEl.max = total;
            progressEl.value = doneCount;
          }
          if (progressLabelEl) {
            progressLabelEl.textContent = `${doneCount}/${total}`;
          }

          steps.forEach(btn => {
            const idx = parseInt(btn.getAttribute('data-step-index') || '0', 10);
            const statusSpan = btn.querySelector('.dlx-quest-step-status');
            const isDone = stepsDone.includes(idx);
            btn.classList.toggle('is-done', isDone);
            if (statusSpan) {
              statusSpan.textContent = isDone ? 'Done' : 'Not done';
            }
          });

          if (feedbackEl) {
            if (doneCount === 0) {
              feedbackEl.textContent = 'Choose one step that feels realistic. Completing even the first step is already progress.';
            } else if (doneCount < total) {
              feedbackEl.textContent = 'You can pause the quest here. When everyone is ready, return and light up the next step.';
            } else {
              feedbackEl.textContent = 'Quest complete. This is the moment to award a badge or certificate and write down what helped.';
            }
          }
        };

        const initialiseQuestPanel = panel => {
          const questKey = panel.getAttribute('data-quest-key');
          if (!questKey) return;

          const steps = Array.from(panel.querySelectorAll('.dlx-quest-step-btn'));
          let state = loadQuestState(questKey) || {
            completed: [],
            badgeEarned: false
          };

          steps.forEach(btn => {
            btn.addEventListener('click', () => {
              const idx = parseInt(btn.getAttribute('data-step-index') || '0', 10);
              const pos = state.completed.indexOf(idx);
              if (pos === -1) {
                state.completed.push(idx);
              } else {
                state.completed.splice(pos, 1);
              }
              const total = steps.length || 1;
              if (state.completed.length === total) {
                state.badgeEarned = true;
                panel.classList.add('dlx-game-panel--active');
              } else if (state.completed.length < total) {
                state.badgeEarned = false;
              }

              updateQuestUI(panel, state);
              saveQuestState(questKey, state);

              if (typeof window.updateDlxRewardsBar === 'function') {
                window.updateDlxRewardsBar();
              }
            });
          });

          updateQuestUI(panel, state);
        };

        panels.forEach(initialiseQuestPanel);
      }

      /* ------------------------- REWARDS / SCRATCH & SHINE BAR + CERT PANEL ------------------------- */

      function initRewardsBar() {
        var bar = document.getElementById('dlxRewardsBar');
        var noOp = function () {};

        if (!bar) {
          window.updateDlxRewardsBar = noOp;
          window.openDlxCertificatePanel = noOp;
          return;
        }

        var STORAGE_KEY = 'dlx_rewards';

        var chips = {
          rn3: bar.querySelector('[data-reward-id="rn3"]'),
          mini5: bar.querySelector('[data-reward-id="mini5"]'),
          calmQuest: bar.querySelector('[data-reward-id="calmQuest"]'),
          teamQuest: bar.querySelector('[data-reward-id="teamQuest"]')
        };

        var backdrop = document.getElementById('dlxCertBackdrop');
        var panel = document.getElementById('dlxCertPanel');

        var badgeLabelEl = panel ? panel.querySelector('[data-cert-badge]') : null;
        var badgeTaglineEl = panel ? panel.querySelector('[data-cert-tagline]') : null;
        var badgeLineEl = panel ? panel.querySelector('[data-cert-badge-line]') : null;
        var nameInput = panel ? panel.querySelector('#dlxCertNameInput') : null;
        var adultInput = panel ? panel.querySelector('#dlxCertAdultInput') : null;
        var dateInput = panel ? panel.querySelector('#dlxCertDateInput') : null;
        var previewNameEl = panel ? panel.querySelector('[data-cert-name]') : null;
        var previewBadgeEl = panel ? panel.querySelector('[data-cert-badge-line]') : null;
        var previewSignedEl = panel ? panel.querySelector('[data-cert-signed-line]') : null;
        var previewDateEl = panel ? panel.querySelector('[data-cert-date]') : null;
        var openFullBtn = panel ? panel.querySelector('#dlxCertOpenFullBtn') : null;
        var closeBtn = panel ? panel.querySelector('[data-cert-close]') : null;
        var printBtn = panel ? panel.querySelector('#dlxCertPrintBtn') : null;

        var rewardsState = {
          rn3: false,
          mini5: false,
          calmQuest: false,
          teamQuest: false
        };

        var rewardMeta = {
          rn3: {
            label: 'Rapid Naming Spark',
            tagline: 'For completing 3 or more Rapid Naming strips in a single day.',
            badgeLine: 'Rapid Naming Spark · Level 1'
          },
          mini5: {
            label: 'Mini Game Glow',
            tagline: 'For completing 5 or more short reading mini games in a day.',
            badgeLine: 'Mini Game Glow · Level 1'
          },
          calmQuest: {
            label: 'Calm Reading Badge',
            tagline: 'For finishing the Calm Reading 7-Day Quest.',
            badgeLine: 'Calm Reading Badge · Seven-Day Streak'
          },
          teamQuest: {
            label: 'Team Plan Badge',
            tagline: 'For completing the School & Home Team Quest together.',
            badgeLine: 'School & Home Team Badge'
          }
        };

        function loadRewards() {
          try {
            var raw = window.localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            var parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return;
            for (var key in rewardsState) {
              if (Object.prototype.hasOwnProperty.call(parsed, key)) {
                rewardsState[key] = !!parsed[key];
              }
            }
          } catch (e) {
            /* noop */
          }
        }

        function saveRewards() {
          try {
            window.localStorage.setItem(STORAGE_KEY, JSON.stringify(rewardsState));
          } catch (e) {
            /* noop */
          }
        }

        function applyToUI() {
          var anyUnlocked = false;
          for (var k in rewardsState) {
            if (rewardsState[k]) {
              anyUnlocked = true;
              break;
            }
          }
          if (anyUnlocked) {
            bar.classList.add('dlx-rewards-bar--active');
          } else {
            bar.classList.remove('dlx-rewards-bar--active');
          }

          function updateChip(id) {
            var chip = chips[id];
            if (!chip) return;
            var unlocked = !!rewardsState[id];
            if (unlocked) {
              chip.classList.add('is-unlocked');
            } else {
              chip.classList.remove('is-unlocked');
            }
            var statusEl = chip.querySelector('[data-reward-status]');
            if (statusEl) {
              statusEl.textContent = unlocked ? 'Unlocked' : 'Locked';
            }
            chip.setAttribute('aria-pressed', unlocked ? 'true' : 'false');
          }

          updateChip('rn3');
          updateChip('mini5');
          updateChip('calmQuest');
          updateChip('teamQuest');
        }

        function recalcFromSources() {
          var changed = false;

          var rnCount = 0;
          try {
            var raw = window.localStorage.getItem('dlx_rapidNamingStats') || window.localStorage.getItem('dlx_rapidNaming');
            if (raw) {
              var rnState = JSON.parse(raw);
              if (rnState && typeof rnState === 'object') {
                if (typeof rnState.stripsToday === 'number') rnCount = rnState.stripsToday;
                else if (typeof rnState.strips === 'number') rnCount = rnState.strips;
                else if (typeof rnState.count === 'number') rnCount = rnState.count;
              }
            }
          } catch (e) {
            /* noop */
          }

          if (!rnCount) {
            var rnEl =
              document.getElementById('rapidNamingStripsDone') ||
              document.getElementById('rapidNamingStripsToday') ||
              document.getElementById('rapidNamingStrips');
            if (rnEl) {
              var parsed = parseInt((rnEl.textContent || '').trim(), 10);
              if (!isNaN(parsed)) rnCount = parsed;
            }
          }

          if (rnCount >= 3 && !rewardsState.rn3) {
            rewardsState.rn3 = true;
            changed = true;
          }

          try {
            var mgRaw = window.localStorage.getItem('dlx_miniGames');
            if (mgRaw) {
              var mgState = JSON.parse(mgRaw);
              if (mgState && typeof mgState === 'object') {
                var todayCount = typeof mgState.todayCount === 'number' ? mgState.todayCount : 0;
                if (todayCount >= 5 && !rewardsState.mini5) {
                  rewardsState.mini5 = true;
                  changed = true;
                }
              }
            }
          } catch (e) {
            /* noop */
          }

          try {
            var calmRaw = window.localStorage.getItem('dlx_quest_calm7');
            if (calmRaw) {
              var calmState = JSON.parse(calmRaw);
              if (
                calmState &&
                typeof calmState === 'object' &&
                calmState.badgeEarned &&
                !rewardsState.calmQuest
              ) {
                rewardsState.calmQuest = true;
                changed = true;
              }
            }
          } catch (e) {
            /* noop */
          }

          try {
            var teamRaw = window.localStorage.getItem('dlx_quest_team5');
            if (teamRaw) {
              var teamState = JSON.parse(teamRaw);
              if (
                teamState &&
                typeof teamState === 'object' &&
                teamState.badgeEarned &&
                !rewardsState.teamQuest
              ) {
                rewardsState.teamQuest = true;
                changed = true;
              }
            }
          } catch (e) {
            /* noop */
          }

          if (changed) {
            saveRewards();
          }
          applyToUI();
        }

        function watchRapidNamingCount() {
          var rnEl =
            document.getElementById('rapidNamingStripsDone') ||
            document.getElementById('rapidNamingStripsToday') ||
            document.getElementById('rapidNamingStrips');
          if (!rnEl || typeof MutationObserver === 'undefined') return;
          var observer = new MutationObserver(function () {
            recalcFromSources();
          });
          observer.observe(rnEl, {
            characterData: true,
            childList: true,
            subtree: true
          });
        }

        function syncCertPreview() {
          if (!panel) return;
          var nameVal = (nameInput && nameInput.value ? nameInput.value : '').trim();
          var adultVal = (adultInput && adultInput.value ? adultInput.value : '').trim();
          var dateVal = dateInput && dateInput.value ? dateInput.value : '';

          if (!nameVal) nameVal = 'Your learner';
          if (!adultVal) adultVal = 'Coach / Teacher';

          var currentId = panel.getAttribute('data-active-reward-id');
          var meta = currentId && rewardMeta[currentId] ? rewardMeta[currentId] : null;

          if (previewNameEl) previewNameEl.textContent = nameVal;
          if (previewBadgeEl && meta) previewBadgeEl.textContent = meta.badgeLine;
          if (previewSignedEl) previewSignedEl.textContent = 'Signed: ' + adultVal;
          if (previewDateEl) previewDateEl.textContent = dateVal;
        }

        function openCertPanel(rewardId) {
          if (!panel || !backdrop) return;

          if (!rewardsState[rewardId]) {
            var lockedChip = chips[rewardId];
            if (lockedChip) {
              lockedChip.classList.add('dlx-reward-chip--locked-pulse');
              window.setTimeout(function () {
                lockedChip.classList.remove('dlx-reward-chip--locked-pulse');
              }, 400);
            }
            return;
          }

          var meta = rewardMeta[rewardId] || null;
          if (badgeLabelEl && meta) {
            badgeLabelEl.textContent = meta.label;
          }
          if (badgeTaglineEl && meta) {
            badgeTaglineEl.textContent = meta.tagline;
          }
          if (badgeLineEl && meta) {
            badgeLineEl.textContent = meta.badgeLine;
          }

          if (openFullBtn) {
            var chipEl = chips[rewardId];
            var url = chipEl && chipEl.getAttribute('data-cert-url') ? chipEl.getAttribute('data-cert-url') : '';
            if (url && url !== '#') {
              openFullBtn.hidden = false;
              openFullBtn.disabled = false;
              openFullBtn.setAttribute('data-url', url);
            } else {
              openFullBtn.hidden = true;
            }
          }

          if (dateInput && !dateInput.value) {
            var todayIso = new Date().toISOString().slice(0, 10);
            dateInput.value = todayIso;
          }

          syncCertPreview();

          backdrop.hidden = false;
          panel.hidden = false;
          panel.setAttribute('data-active-reward-id', rewardId);

          if (nameInput && typeof nameInput.focus === 'function') {
            nameInput.focus();
          }
        }

        function closeCertPanel() {
          if (!panel || !backdrop) return;
          panel.hidden = true;
          backdrop.hidden = true;
          panel.removeAttribute('data-active-reward-id');
        }

        for (var id in chips) {
          if (Object.prototype.hasOwnProperty.call(chips, id)) {
            (function (rewardId) {
              var chip = chips[rewardId];
              if (!chip) return;
              chip.addEventListener('click', function () {
                openCertPanel(rewardId);
              });
            })(id);
          }
        }

        if (nameInput) {
          nameInput.addEventListener('input', syncCertPreview);
        }
        if (adultInput) {
          adultInput.addEventListener('input', syncCertPreview);
        }
        if (dateInput) {
          dateInput.addEventListener('input', syncCertPreview);
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', function () {
            closeCertPanel();
          });
        }
        if (backdrop) {
          backdrop.addEventListener('click', function () {
            closeCertPanel();
          });
        }
        if (printBtn) {
          printBtn.addEventListener('click', function () {
            window.print();
          });
        }
        if (openFullBtn) {
          openFullBtn.addEventListener('click', function () {
            var url = openFullBtn.getAttribute('data-url') || '';
            if (url && url !== '#') {
              window.open(url, '_blank', 'noopener');
            }
          });
        }

        document.addEventListener('keydown', function (evt) {
          if (evt.key === 'Escape' || evt.key === 'Esc') {
            closeCertPanel();
          }
        });

        loadRewards();
        applyToUI();
        watchRapidNamingCount();

        window.updateDlxRewardsBar = recalcFromSources;
        window.openDlxCertificatePanel = openCertPanel;

        recalcFromSources();
      }

      onReady(() => {
        initRewardsBar();
        initVowelQuest();
        initFluencyPacer();
        initRapidNaming();
        initVowelStudiosPlanner();
        initMiniGamesHub();
        initQuestModes();

        if (typeof window.updateDlxRewardsBar === 'function') {
          window.updateDlxRewardsBar();
        }
      });
    })();
  </script>

  <script id="nb-helpers">
(() => {
  try {
    document.querySelectorAll('[data-href]').forEach(a => { if (!a.getAttribute('href')) a.setAttribute('href', a.getAttribute('data-href')); });
    const nav = document.getElementById('mainNav') || document.querySelector('.main-nav');
    const btn = document.getElementById('navToggle');
    const menuGroups = Array.from(document.querySelectorAll('.menu-group'));
    const menuButtons = menuGroups.map(group => group.querySelector('.menu-toggle')).filter(Boolean);

    const closeMenuGroups = keepOpen => {
      menuGroups.forEach(group => {
        if (group === keepOpen) return;
        group.classList.remove('open');
        group.querySelector('.menu-toggle')?.setAttribute('aria-expanded', 'false');
      });
    };

    if (btn && nav) {
      btn.addEventListener('click', () => {
        const open = nav.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
        if (!open) closeMenuGroups();
      });
    }

    menuButtons.forEach(button => {
      const group = button.closest('.menu-group');
      button.addEventListener('click', evt => {
        evt.preventDefault();
        const nextState = !group.classList.contains('open');
        closeMenuGroups(nextState ? group : null);
        group.classList.toggle('open', nextState);
        button.setAttribute('aria-expanded', nextState ? 'true' : 'false');
      });
    });

    document.addEventListener('click', evt => {
      if (!nav?.contains(evt.target) && evt.target !== btn) {
        nav?.classList.remove('open');
        btn?.setAttribute('aria-expanded', 'false');
        closeMenuGroups();
      }
    });
    const yf = document.getElementById('yearFooter'); if (yf) yf.textContent = String(new Date().getFullYear());
    document.querySelector('[data-action="back-to-top"]')?.addEventListener('click', e => {
      e.preventDefault();
      try {
        (document.getElementById('top') || document.body).scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  } catch (e) {
    console.error(e);
  }
})();
  </script>

  <script>
    (function () {
      if (typeof document === 'undefined') return;

      function byId(id) {
        return document.getElementById(id);
      }

      var quickStartButtons = Array.from(document.querySelectorAll('[data-open-quick-start]'));
      quickStartButtons.forEach(function (btn) {
        if (btn.getAttribute('data-quick-start-bound')) return;
        btn.setAttribute('data-quick-start-bound', 'true');
        btn.addEventListener('click', function (evt) {
          evt.preventDefault();
          var target = btn.getAttribute('data-open-quick-start') || null;
          var minutes = btn.getAttribute('data-quick-start-minutes');
          if (typeof window !== 'undefined' && typeof window.__dlxOpenFocus === 'function') {
            window.__dlxOpenFocus(target, minutes ? Number(minutes) : undefined);
            return;
          }
          var trigger = byId('openQuickStart');
          trigger?.dispatchEvent(new Event('click', { bubbles: true }));
        });
      });

      var quickStartNextButtons = Array.from(document.querySelectorAll('.quick-start-next__btn'));
      var smoothScrollTo = function (selector) {
        if (!selector) return false;
        var target = document.querySelector(selector);
        if (!target) return false;
        try {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
          var top = target.getBoundingClientRect().top + window.pageYOffset;
          window.scrollTo({ top: top, behavior: 'smooth' });
        }
        return true;
      };
      var closeQuickStartModal = function () {
        var closeBtn = byId('closeQuickStart');
        if (closeBtn) {
          closeBtn.click();
          return true;
        }
        var modal = byId('quickStartDialog');
        if (modal) modal.classList.remove('active');
        return false;
      };
      quickStartNextButtons.forEach(function (btn) {
        if (btn.getAttribute('data-next-bound')) return;
        btn.setAttribute('data-next-bound', 'true');
        btn.addEventListener('click', function (evt) {
          var selector = btn.getAttribute('href');
          if (!selector || selector === '#') return;
          evt.preventDefault();
          var closed = closeQuickStartModal();
          window.setTimeout(function () {
            smoothScrollTo(selector);
          }, closed ? 320 : 80);
        });
      });

      var routeBtn = byId('dlxDailyRouteBtn');
      if (routeBtn && !routeBtn.getAttribute('data-hero-enhanced')) {
        routeBtn.setAttribute('data-hero-enhanced', 'true');
        routeBtn.addEventListener('click', function (evt) {
          var selector = routeBtn.getAttribute('data-scroll');
          if (!selector) return;
          var target = document.querySelector(selector);
          if (!target) return;
          evt.preventDefault();
          try {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } catch (error) {
            var top = target.getBoundingClientRect().top + window.pageYOffset;
            window.scrollTo(0, top);
          }
        });
      }

      var researchBtn = byId('dlxViewResearchBtn');
      if (researchBtn && !researchBtn.getAttribute('data-hero-enhanced')) {
        researchBtn.setAttribute('data-hero-enhanced', 'true');
        researchBtn.addEventListener('click', function (evt) {
          var selector = researchBtn.getAttribute('data-scroll');
          if (!selector) return;
          var target = document.querySelector(selector);
          if (!target) return;
          evt.preventDefault();
          try {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } catch (error) {
            var top = target.getBoundingClientRect().top + window.pageYOffset;
            window.scrollTo(0, top);
          }
        });
      }

      var profileBtn = byId('dlxOpenProfileBtn');
      if (profileBtn && !profileBtn.getAttribute('data-hero-enhanced')) {
        profileBtn.setAttribute('data-hero-enhanced', 'true');
        profileBtn.addEventListener('click', function () {
          var panel = byId('dlxProfilePanel');
          if (panel) panel.removeAttribute('hidden');
        });
      }
    })();
  </script>

  <!-- NEUROBREATH:SCRIPTS BEGIN -->
  <!-- NEUROBREATH:SCRIPTS END -->

  <footer class="site-footer" id="siteFooter">
    <div class="inner">
      <div class="ft-top">
        <section class="ft-brand">
          <div class="row">
            <a class="ft-logo" href="index.html" data-href="index.html" aria-label="NeuroBreath home"></a>
            <div>
              <h4 class="ft-heading">NeuroBreath</h4>
              <div class="muted">Quiet, practical tools for mental health and wellbeing.</div>
            </div>
          </div>
          <div class="ft-actions">
            <a href="coffee.html" class="btn" data-href="coffee.html">Support Us</a>
            <a href="coffee.html" class="btn" data-href="coffee.html">☕ Support Us</a>
          </div>
          <div class="theme-editor" id="themeEditor" aria-labelledby="themeEditorTitle">
            <h3 class="theme-title" id="themeEditorTitle">Theme editor</h3>
            <p id="themeStatus" class="theme-status" role="status" aria-live="polite">Default theme in use. Choose "Auto match" to personalise.</p>
            <div class="theme-actions">
              <button type="button" class="btn theme-btn" data-mode="auto">Auto match</button>
              <button type="button" class="btn theme-btn" data-mode="day">Daylight</button>
              <button type="button" class="btn theme-btn" data-mode="night">Night</button>
              <button type="button" class="btn theme-btn" data-mode="reset">Reset</button>
            </div>
            <div class="theme-custom">
              <label for="themeColorInput">Custom colour</label>
              <div class="theme-custom-row">
                <input type="color" id="themeColorInput" name="themeColorInput" value="#203158" aria-label="Pick a custom background colour" />
                <div class="theme-swatches" role="group" aria-label="Quick colour options">
                  <button class="theme-swatch" type="button" data-color="#15213a" data-label="Midnight">
                    <span class="theme-swatch__chip" aria-hidden="true"></span>
                    <span class="theme-swatch__label">
                      <strong>Midnight</strong>
                      <small>#15213A</small>
                    </span>
                  </button>
                  <button class="theme-swatch" type="button" data-color="#1a2a40" data-label="Twilight">
                    <span class="theme-swatch__chip" aria-hidden="true"></span>
                    <span class="theme-swatch__label">
                      <strong>Twilight</strong>
                      <small>#1A2A40</small>
                    </span>
                  </button>
                  <button class="theme-swatch" type="button" data-color="#2d3b5f" data-label="Harbour">
                    <span class="theme-swatch__chip" aria-hidden="true"></span>
                    <span class="theme-swatch__label">
                      <strong>Harbour</strong>
                      <small>#2D3B5F</small>
                    </span>
                  </button>
                  <button class="theme-swatch" type="button" data-color="#3a2f5f" data-label="Violet">
                    <span class="theme-swatch__chip" aria-hidden="true"></span>
                    <span class="theme-swatch__label">
                      <strong>Violet</strong>
                      <small>#3A2F5F</small>
                    </span>
                  </button>
                  <button class="theme-swatch" type="button" data-color="#0f3b46" data-label="Rain">
                    <span class="theme-swatch__chip" aria-hidden="true"></span>
                    <span class="theme-swatch__label">
                      <strong>Rain</strong>
                      <small>#0F3B46</small>
                    </span>
                  </button>
                  <button class="theme-swatch" type="button" data-color="#ffffff" data-label="Bright">
                    <span class="theme-swatch__chip" aria-hidden="true"></span>
                    <span class="theme-swatch__label">
                      <strong>Bright</strong>
                      <small>#FFFFFF</small>
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <nav class="ft-nav" aria-label="Footer">
          <details class="ft-group">
            <summary>Conditions <span aria-hidden="true">▾</span></summary>
            <div class="links">
              <p><a href="autism.html" data-href="autism.html">Autism</a> · <a href="autism-parent.html" data-href="autism-parent.html">Autism Parent</a> · <a href="adhd.html" data-href="adhd.html">ADHD</a> · <a href="dyslexia-reading-training.html" data-href="dyslexia-reading-training.html">Dyslexia</a></p>
              <p><a href="anxiety.html" data-href="anxiety.html">Anxiety</a> · <a href="depression.html" data-href="depression.html">Depression</a> · <a href="stress.html" data-href="stress.html">Stress</a> · <a href="sleep.html" data-href="sleep.html">Sleep</a></p>
            </div>
          </details>
          <details class="ft-group">
            <summary>Breathing &amp; Focus <span aria-hidden="true">▾</span></summary>
            <div class="links">
              <p><a href="breath.html" data-href="breath.html">Breathing basics</a> · <a href="focus.html" data-href="focus.html">Focus</a> · <a href="mindfulness.html" data-href="mindfulness.html">Mindfulness</a></p>
              <p><a href="sos-60.html" data-href="sos-60.html">SOS-60</a> · <a href="box-breathing.html" data-href="box-breathing.html">Box</a> · <a href="4-7-8-breathing.html" data-href="4-7-8-breathing.html">4-7-8</a> · <a href="coherent-5-5.html" data-href="coherent-5-5.html">Coherent 5-5</a></p>
            </div>
          </details>
          <details class="ft-group">
            <summary>Tools <span aria-hidden="true">▾</span></summary>
            <div class="links">
              <p><a href="breath-tools.html" data-href="breath-tools.html">Breath tools</a> · <a href="sleep-tools.html" data-href="sleep-tools.html">Sleep tools</a> · <a href="mood-tools.html" data-href="mood-tools.html">Mood tools</a></p>
              <p><a href="adhd-tools.html" data-href="adhd-tools.html">ADHD tools</a> · <a href="autism-tools.html" data-href="autism-tools.html">Autism tools</a> · <a href="stress-tools.html" data-href="stress-tools.html">Stress tools</a></p>
            </div>
          </details>
          <details class="ft-group">
            <summary>About <span aria-hidden="true">▾</span></summary>
            <div class="links">
              <p><a href="about.html" data-href="about.html">About</a> · <a href="aims-objectives.html" data-href="aims-objectives.html">Aims &amp; stories</a> · <a href="coffee.html" data-href="coffee.html">Support us</a> · <a href="contact.html" data-href="contact.html">Contact</a></p>
            </div>
          </details>
        </nav>
      </div>

      <div class="ft-bottom">
        <div class="ft-bottom__copy" aria-label="Site notice">
          <p class="muted">Educational information only. Not medical advice. NeuroBreath is a free resource by NeuroBreath.</p>
          <p class="muted">© <span id="yearFooter"></span> NeuroBreath. All rights reserved.</p>
        </div>
        <button type="button" class="btn back-to-top-btn" data-action="back-to-top" aria-label="Back to top">
          <span class="back-to-top__label">Back to top</span>
          <span class="back-to-top__icon" aria-hidden="true">↑</span>
        </button>
      </div>
    </div>
  </footer>

  <div id="shareSheet" class="sheet hidden" aria-hidden="true">
    <div id="shareBackdrop"></div>
    <div class="sheet-card" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <div class="sheet-head">
        <h2 id="shareTitle" class="sheet-title">Share</h2>
        <button id="shareClose" class="sheet-close" aria-label="Close">×</button>
      </div>
      <textarea id="shareText" class="share-text" readonly></textarea>
      <div class="share-actions">
        <button class="btn" id="copyShare" type="button">📋 Copy text</button>
        <button class="btn" id="shareNative" type="button">🔗 Share…</button>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const STORAGE_KEY = "nb_dlx_stage3_v1";

      function getStorage() {
        try {
          return window.localStorage;
        } catch (e) {
          return null;
        }
      }

      function getDefaultState() {
        return {
          games: {
            "vowel-quest": {
              round: 0,
              level: 1,
              streak: 0,
              score: 0,
              timerSeconds: 0,
            },
            "fluency-pacer": {
              sentences: 0,
              pace: "Medium",
              timerSeconds: 0,
            },
            "rapid-strip": {
              strips: 0,
              "best-time": null,
              timerSeconds: 0,
            },
          },
          studios: {
            short: {
              steps: [false, false, false, false],
              streak: 0,
            },
            long: {
              steps: [false, false, false, false],
              streak: 0,
            },
            mixed: {
              steps: [false, false, false, false],
              streak: 0,
            },
          },
        };
      }

      function mergeState(defaults, stored) {
        if (!stored) return defaults;
        const out = JSON.parse(JSON.stringify(defaults));

        if (stored.games) {
          Object.keys(stored.games).forEach(function (key) {
            out.games[key] = Object.assign(
              {},
              out.games[key] || {},
              stored.games[key]
            );
          });
        }
        if (stored.studios) {
          Object.keys(stored.studios).forEach(function (key) {
            const defStudio = out.studios[key] || { steps: [false, false, false, false], streak: 0 };
            const storedStudio = stored.studios[key] || {};
            out.studios[key] = {
              steps: Array.isArray(storedStudio.steps)
                ? storedStudio.steps.slice(0, 4)
                : defStudio.steps.slice(0, 4),
              streak:
                typeof storedStudio.streak === "number"
                  ? storedStudio.streak
                  : defStudio.streak,
            };
          });
        }
        return out;
      }

      function loadState() {
        const defaults = getDefaultState();
        const storage = getStorage();
        if (!storage) return defaults;
        try {
          const raw = storage.getItem(STORAGE_KEY);
          if (!raw) return defaults;
          const parsed = JSON.parse(raw);
          return mergeState(defaults, parsed);
        } catch (e) {
          return defaults;
        }
      }

      function saveState() {
        const storage = getStorage();
        if (!storage) return;
        try {
          storage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          // ignore quota errors etc.
        }
      }

      function formatSeconds(total) {
        const seconds = Math.max(0, Math.floor(total || 0));
        if (seconds < 60) {
          return (seconds < 10 ? "0" : "") + seconds + "s";
        }
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return m + "m " + (s < 10 ? "0" : "") + s + "s";
      }

      function createToast() {
        let toast = document.querySelector(".dlx-toast");
        if (!toast) {
          toast = document.createElement("div");
          toast.className = "dlx-toast";
          document.body.appendChild(toast);
        }
        return toast;
      }

      let toastTimer = null;

      function showToast(message) {
        const toast = createToast();
        toast.textContent = message;
        toast.classList.add("dlx-toast--visible");
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function () {
          toast.classList.remove("dlx-toast--visible");
        }, 4500);
      }

      const GAME_COPY = {
        "vowel-quest": {
          explain:
            "Vowel Quest practises mapping a heard vowel sound to the correct spelling pattern, one calm round at a time.",
          hints: [
            "Keep the sound in your mind while you scan the spellings.",
            "Say the sound quietly before you tap the answer.",
            "If you are unsure, tap slowly and listen again.",
          ],
        },
        "fluency-pacer": {
          explain:
            "Fluency Pacer supports phrasing, punctuation and breath control. Follow the moving rhythm instead of rushing.",
          hints: [
            "Breathe gently at every full stop or comma.",
            "Use a slower pace first, then build up.",
            "Focus on smooth, steady reading – not speed.",
          ],
        },
        "rapid-strip": {
          explain:
            "Rapid Naming Strip trains naming speed and rhythm while keeping a calm breath between strips.",
          hints: [
            "Point with your finger or eyes from left to right.",
            "Aim for a steady rhythm, not racing.",
            "Pause for a calm breath at the end of each strip.",
          ],
        },
      };

      const stage3Curriculum = window.NB_CURRICULUM || {};

      const VQ_FALLBACK = [
        {
          id: "vq-demo-1",
          phase: "Phase 2",
          levelNumber: 1,
          label: "Short vowels sampler",
          description: "Quick check on Phase 2 short vowels.",
          items: [
            {
              id: "vq-demo-1-1",
              phoneme: "/a/",
              displayPrompt: "Sound: /a/ (short a)",
              ttsPrompt: "Sound: short a",
              ttsClipId: null,
              options: ["a", "e", "i"],
              correctIndex: 0,
            },
            {
              id: "vq-demo-1-2",
              phoneme: "/e/",
              displayPrompt: "Sound: /e/ (short e)",
              ttsPrompt: "Sound: short e",
              ttsClipId: null,
              options: ["a", "e", "o"],
              correctIndex: 1,
            },
          ],
        },
        {
          id: "vq-demo-2",
          phase: "Phase 3",
          levelNumber: 2,
          label: "Vowel teams sampler",
          description: "Phase 3 vowel team checkpoint.",
          items: [
            {
              id: "vq-demo-2-1",
              phoneme: "/ai/",
              displayPrompt: "Sound: /ai/ (long a)",
              ttsPrompt: "Sound: long a",
              ttsClipId: null,
              options: ["ai", "ee", "oa"],
              correctIndex: 0,
            },
            {
              id: "vq-demo-2-2",
              phoneme: "/ē/",
              displayPrompt: "Sound: /ē/ (long e)",
              ttsPrompt: "Sound: long e",
              ttsClipId: null,
              options: ["ee", "ai", "oi"],
              correctIndex: 0,
            },
          ],
        },
      ];

      const FP_FALLBACK = [
        {
          id: "fp-demo-1",
          phase: "Phase 2",
          levelNumber: 1,
          label: "Calm CVC sentences",
          wpmTarget: 60,
          description: "Short Phase 2 review lines.",
          sentences: [
            { text: "Sam sat on the mat.", ttsClipId: null },
            { text: "Meg met Tim at the bus.", ttsClipId: null },
          ],
        },
        {
          id: "fp-demo-2",
          phase: "Phase 3",
          levelNumber: 2,
          label: "Digraph practice",
          wpmTarget: 70,
          description: "Phase 3 digraph lines.",
          sentences: [
            { text: "The thin moth sat on the mesh.", ttsClipId: null },
            { text: "The goat slept on a high rock.", ttsClipId: null },
          ],
        },
      ];

      const VQ_ALL_LEVELS = Array.isArray(stage3Curriculum?.vowelQuest?.levels) && stage3Curriculum.vowelQuest.levels.length
        ? stage3Curriculum.vowelQuest.levels
        : VQ_FALLBACK;
      let VQ_LEVELS = VQ_ALL_LEVELS.slice();
      let vqCurrentLevelIndex = 0;
      let vqCurrentItemIndex = 0;
      let vqActivePhase = "all";
      let vqHasStarted = false;

      const FP_ALL_SETS = Array.isArray(stage3Curriculum?.fluencyPacer?.sets) && stage3Curriculum.fluencyPacer.sets.length
        ? stage3Curriculum.fluencyPacer.sets
        : FP_FALLBACK;
      let FLUENCY_SETS = FP_ALL_SETS.slice();
      let fpCurrentSetIndex = 0;
      let fpCurrentSentenceIndex = 0;
      let fpActivePhase = "all";
      let fpHasStarted = false;

      function buildPhaseSummaryData() {
        const phaseMap = new Map();

        function ensurePhase(phaseName) {
          const key = phaseName || "Unlabelled phase";
          if (!phaseMap.has(key)) {
            phaseMap.set(key, {
              phase: key,
              vowelLevelCount: 0,
              vowelItemCount: 0,
              fluencySetCount: 0,
              fluencySentenceCount: 0,
            });
          }
          return phaseMap.get(key);
        }

        if (Array.isArray(VQ_ALL_LEVELS)) {
          VQ_ALL_LEVELS.forEach(function (level) {
            if (!level) return;
            const phaseName = level.phase || "Unlabelled phase";
            const phaseData = ensurePhase(phaseName);
            phaseData.vowelLevelCount += 1;
            if (Array.isArray(level.items)) {
              phaseData.vowelItemCount += level.items.length;
            }
          });
        }

        if (Array.isArray(FP_ALL_SETS)) {
          FP_ALL_SETS.forEach(function (set) {
            if (!set) return;
            const phaseName = set.phase || "Unlabelled phase";
            const phaseData = ensurePhase(phaseName);
            phaseData.fluencySetCount += 1;
            if (Array.isArray(set.sentences)) {
              phaseData.fluencySentenceCount += set.sentences.length;
            }
          });
        }

        const phases = Array.from(phaseMap.values());
        phases.sort(function (a, b) {
          return a.phase.localeCompare(b.phase, "en");
        });

        const all = phases.reduce(
          function (acc, phase) {
            acc.vowelLevelCount += phase.vowelLevelCount;
            acc.vowelItemCount += phase.vowelItemCount;
            acc.fluencySetCount += phase.fluencySetCount;
            acc.fluencySentenceCount += phase.fluencySentenceCount;
            return acc;
          },
          {
            phase: "All",
            vowelLevelCount: 0,
            vowelItemCount: 0,
            fluencySetCount: 0,
            fluencySentenceCount: 0,
          }
        );

        return { all: all, phases: phases };
      }

      function renderPhaseSummary() {
        const chipsContainer = document.querySelector("[data-phase-summary-chips]");
        if (!chipsContainer) return;

        const summary = buildPhaseSummaryData();
        chipsContainer.innerHTML = "";

        function isPhaseActive(phaseName) {
          if (phaseName === "All") {
            const vqIsAll = vqActivePhase === "all" || !vqActivePhase;
            const fpIsAll = fpActivePhase === "all" || !fpActivePhase;
            return vqIsAll && fpIsAll;
          }
          return vqActivePhase === phaseName || fpActivePhase === phaseName;
        }

        function createChip(options) {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "dlx-phase-chip" + (options.isActive ? " dlx-phase-chip--active" : "");
          chip.innerHTML = options.innerHTML;
          chip.addEventListener("click", options.onClick);
          chipsContainer.appendChild(chip);
        }

        createChip({
          isActive: isPhaseActive("All"),
          innerHTML:
            '<span class="dlx-phase-chip__label">All phases</span>' +
            '<span class="dlx-phase-chip__counts">' +
            "VQ: " + summary.all.vowelLevelCount + " levels · " + summary.all.vowelItemCount + " items · " +
            "FP: " + summary.all.fluencySetCount + " sets · " + summary.all.fluencySentenceCount + " sentences" +
            "</span>" +
            '<span class="dlx-phase-chip__status">' +
            (isPhaseActive("All") ? "Currently active" : "Tap to use") +
            "</span>",
          onClick: function () {
            const vqSelect = document.querySelector("[data-vq-phase-select]");
            const fpSelect = document.querySelector("[data-fp-phase-select]");
            if (vqSelect) vqSelect.value = "all";
            if (fpSelect) fpSelect.value = "all";
            setVowelQuestPhase("all");
            setFluencyPhase("all");
          },
        });

        summary.phases.forEach(function (phase) {
          const isActive = isPhaseActive(phase.phase);
          createChip({
            isActive: isActive,
            innerHTML:
              '<span class="dlx-phase-chip__label">' + phase.phase + "</span>" +
              '<span class="dlx-phase-chip__counts">' +
              "VQ: " + phase.vowelLevelCount + " levels · " + phase.vowelItemCount + " items · " +
              "FP: " + phase.fluencySetCount + " sets · " + phase.fluencySentenceCount + " sentences" +
              "</span>" +
              '<span class="dlx-phase-chip__status">' + (isActive ? "In use" : "Available") + "</span>",
            onClick: function () {
              const vqSelect = document.querySelector("[data-vq-phase-select]");
              const fpSelect = document.querySelector("[data-fp-phase-select]");
              if (vqSelect) vqSelect.value = phase.phase;
              if (fpSelect) fpSelect.value = phase.phase;
              setVowelQuestPhase(phase.phase);
              setFluencyPhase(phase.phase);
            },
          });
        });
      }

      function setVowelQuestPhase(phase) {
        vqActivePhase = phase || "all";
        if (window.NB_ANALYTICS && typeof window.NB_ANALYTICS.logEvent === "function") {
          window.NB_ANALYTICS.logEvent({
            game: "vowelQuest",
            event: "phase_change",
            phase: vqActivePhase,
          });
        }
        if (vqActivePhase === "all") {
          VQ_LEVELS = VQ_ALL_LEVELS.slice();
        } else {
          VQ_LEVELS = VQ_ALL_LEVELS.filter(function (level) {
            return level && level.phase === vqActivePhase;
          });
          if (!VQ_LEVELS.length) {
            VQ_LEVELS = VQ_ALL_LEVELS.slice();
            vqActivePhase = "all";
          }
        }
        vqCurrentLevelIndex = 0;
        vqCurrentItemIndex = 0;
        renderVowelQuestItem();
        renderPhaseSummary();
      }

      function getActiveVowelQuestLevel() {
        if (!VQ_LEVELS.length) return null;
        return VQ_LEVELS[vqCurrentLevelIndex] || VQ_LEVELS[0] || null;
      }

      function getCurrentVowelQuestItem() {
        const level = getActiveVowelQuestLevel();
        if (!level || !Array.isArray(level.items) || !level.items.length) return null;
        return level.items[vqCurrentItemIndex] || level.items[0] || null;
      }

      function renderVowelQuestItem() {
        if (!stage3El) return;
        const promptEl = stage3El.querySelector("[data-vq-prompt]");
        const optionsEl = stage3El.querySelector("[data-vq-options]");
        const levelLabelEl = stage3El.querySelector("[data-vq-level-label]");
        const phaseLabelEl = stage3El.querySelector("[data-vq-phase-label]");
        const playBtn = stage3El.querySelector("[data-vq-play-sound]");

        if (!promptEl || !optionsEl) return;

        const level = getActiveVowelQuestLevel();
        const item = getCurrentVowelQuestItem();

        if (!level || !item) {
          promptEl.textContent = "Add Vowel Quest levels to NB_CURRICULUM to unlock this drill.";
          optionsEl.innerHTML = "";
          if (levelLabelEl) levelLabelEl.textContent = "";
          if (phaseLabelEl) phaseLabelEl.textContent = "";
          if (playBtn) playBtn.disabled = true;
          return;
        }

        if (levelLabelEl) {
          levelLabelEl.textContent = level.label || "";
        }
        if (phaseLabelEl) {
          phaseLabelEl.textContent = level.phase || vqActivePhase || "";
        }

        if (!vqHasStarted) {
          promptEl.textContent = "Tap \u201cStart round\u201d to see your first sound prompt.";
          optionsEl.innerHTML = "";
          if (playBtn) playBtn.disabled = true;
          return;
        }

        promptEl.textContent = item.displayPrompt || item.ttsPrompt || item.phoneme || "Listen carefully to the vowel sound.";
        optionsEl.innerHTML = "";

        (item.options || []).forEach(function (opt, index) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-outline dlx-game-option";
          btn.textContent = opt;
          btn.setAttribute("data-vq-choice", String(index));
          btn.addEventListener("click", function () {
            handleVowelQuestAnswer(index);
          });
          optionsEl.appendChild(btn);
        });

        if (playBtn) {
          playBtn.disabled = !item.ttsClipId;
        }
      }

      function logVowelQuestAttempt(isCorrect, targetLevelNumber) {
        if (!state || !state.games || !state.games["vowel-quest"]) return;
        const gameState = state.games["vowel-quest"];
        gameState.round = (gameState.round || 0) + 1;
        gameState.level = targetLevelNumber || gameState.level || 1;
        if (isCorrect) {
          gameState.score = (gameState.score || 0) + 10;
          gameState.streak = (gameState.streak || 0) + 1;
        } else {
          gameState.streak = 0;
        }
        saveState();
        updateGameDom("vowel-quest");
      }

      function handleVowelQuestAnswer(selectedIndex) {
        const level = getActiveVowelQuestLevel();
        const item = getCurrentVowelQuestItem();
        if (!level || !item) return;

        const optionsEl = stage3El?.querySelector("[data-vq-options]");
        const buttons = optionsEl ? Array.from(optionsEl.querySelectorAll("button")) : [];
        const correctIndex = Number.isInteger(item.correctIndex) ? item.correctIndex : 0;
        const isCorrect = selectedIndex === correctIndex;

        if (window.NB_ANALYTICS && typeof window.NB_ANALYTICS.logEvent === "function") {
          window.NB_ANALYTICS.logEvent({
            game: "vowelQuest",
            event: "answer",
            correct: isCorrect,
            phase: level.phase || null,
            levelId: level.id,
            levelNumber: level.levelNumber,
            itemId: item.id,
            phoneme: item.phoneme || null,
            selectedIndex: selectedIndex,
            correctIndex: correctIndex,
          });
        }

        buttons.forEach(function (btn, idx) {
          btn.disabled = true;
          if (idx === correctIndex) {
            btn.classList.add("is-correct");
          }
          if (idx === selectedIndex && idx !== correctIndex) {
            btn.classList.add("is-wrong");
          }
        });

        logVowelQuestAttempt(isCorrect, level.levelNumber || level.id);

        window.setTimeout(function () {
          const totalItems = Array.isArray(level.items) ? level.items.length : 0;
          vqCurrentItemIndex += 1;
          if (totalItems && vqCurrentItemIndex >= totalItems) {
            vqCurrentItemIndex = 0;
            if (VQ_LEVELS.length) {
              vqCurrentLevelIndex = (vqCurrentLevelIndex + 1) % VQ_LEVELS.length;
            }
          }
          renderVowelQuestItem();
        }, 600);
      }

      function playCurrentVowelQuestClip() {
        const item = getCurrentVowelQuestItem();
        if (!item || !item.ttsClipId) return;
        if (window.NB_AUDIO && typeof window.NB_AUDIO.playCurriculumClip === "function") {
          window.NB_AUDIO.playCurriculumClip(item.ttsClipId);
        }
      }

      function initStage3VowelQuestCard() {
        if (!stage3El) return;
        const card = stage3El.querySelector("#vowelQuestCard");
        if (!card) return;

        const phaseSelect = card.querySelector("[data-vq-phase-select]");
        if (phaseSelect) {
          phaseSelect.value = vqActivePhase;
          phaseSelect.addEventListener("change", function (event) {
            setVowelQuestPhase(event.target.value || "all");
          });
        }

        const startBtn = card.querySelector("[data-vq-start]");
        if (startBtn) {
          startBtn.addEventListener("click", function () {
            vqHasStarted = true;
            vqCurrentLevelIndex = 0;
            vqCurrentItemIndex = 0;
            renderVowelQuestItem();
          });
        }

        const playBtn = card.querySelector("[data-vq-play-sound]");
        if (playBtn) {
          playBtn.addEventListener("click", function () {
            playCurrentVowelQuestClip();
          });
        }

        renderVowelQuestItem();
      }

      function setFluencyPhase(phase) {
        fpActivePhase = phase || "all";
        if (window.NB_ANALYTICS && typeof window.NB_ANALYTICS.logEvent === "function") {
          window.NB_ANALYTICS.logEvent({
            game: "fluencyPacer",
            event: "phase_change",
            phase: fpActivePhase,
          });
        }
        if (fpActivePhase === "all") {
          FLUENCY_SETS = FP_ALL_SETS.slice();
        } else {
          FLUENCY_SETS = FP_ALL_SETS.filter(function (set) {
            return set && set.phase === fpActivePhase;
          });
          if (!FLUENCY_SETS.length) {
            FLUENCY_SETS = FP_ALL_SETS.slice();
            fpActivePhase = "all";
          }
        }
        fpCurrentSetIndex = 0;
        fpCurrentSentenceIndex = 0;
        renderFluencySentence();
        renderPhaseSummary();
      }

      function getActiveFluencySet() {
        if (!FLUENCY_SETS.length) return null;
        return FLUENCY_SETS[fpCurrentSetIndex] || FLUENCY_SETS[0] || null;
      }

      function getCurrentSentenceObj() {
        const set = getActiveFluencySet();
        if (!set || !Array.isArray(set.sentences) || !set.sentences.length) {
          return { text: "", ttsClipId: null };
        }
        const raw = set.sentences[fpCurrentSentenceIndex] || set.sentences[0];
        if (typeof raw === "string") {
          return { text: raw, ttsClipId: null };
        }
        return {
          text: raw?.text || "",
          ttsClipId: raw?.ttsClipId || null,
        };
      }

      function renderFluencySentence() {
        if (!stage3El) return;
        const sentenceEl = stage3El.querySelector("[data-fp-sentence]");
        const setLabelEl = stage3El.querySelector("[data-fp-set-label]");
        const phaseLabelEl = stage3El.querySelector("[data-fp-phase-label]");
        const targetEl = stage3El.querySelector("[data-fp-wpm-target]");
        const playBtn = stage3El.querySelector("[data-fp-play-sound]");

        if (!sentenceEl) return;

        const set = getActiveFluencySet();
        if (!set || !Array.isArray(set.sentences) || !set.sentences.length) {
          sentenceEl.textContent = "Add Fluency Pacer sets to NB_CURRICULUM.fluencyPacer to unlock this drill.";
          if (setLabelEl) setLabelEl.textContent = "";
          if (phaseLabelEl) phaseLabelEl.textContent = "";
          if (targetEl) targetEl.textContent = "";
          if (playBtn) playBtn.disabled = true;
          return;
        }

        const sentenceObj = getCurrentSentenceObj();

        sentenceEl.textContent = sentenceObj.text;
        if (setLabelEl) setLabelEl.textContent = set.label || "";
        if (phaseLabelEl) phaseLabelEl.textContent = set.phase || fpActivePhase || "";
        if (targetEl) {
          targetEl.textContent = set.wpmTarget ? set.wpmTarget + " WPM target" : "";
        }
        if (!fpHasStarted) {
          sentenceEl.textContent = "Tap \u201cStart pacer\u201d to see your first sentence.";
          if (playBtn) playBtn.disabled = true;
          return;
        }
        if (playBtn) {
          playBtn.disabled = !sentenceObj.ttsClipId;
        }

        if (fpHasStarted && window.NB_ANALYTICS && typeof window.NB_ANALYTICS.logEvent === "function") {
          window.NB_ANALYTICS.logEvent({
            game: "fluencyPacer",
            event: "sentence_shown",
            phase: set.phase || null,
            setId: set.id,
            levelNumber: set.levelNumber,
            sentenceIndex: fpCurrentSentenceIndex,
            sentenceText: sentenceObj.text || "",
            wpmTarget: set.wpmTarget,
          });
        }
      }

      function nextFluencySentence() {
        const set = getActiveFluencySet();
        if (!set || !Array.isArray(set.sentences) || !set.sentences.length) return;
        fpCurrentSentenceIndex += 1;
        if (fpCurrentSentenceIndex >= set.sentences.length) {
          fpCurrentSentenceIndex = 0;
          if (FLUENCY_SETS.length) {
            fpCurrentSetIndex = (fpCurrentSetIndex + 1) % FLUENCY_SETS.length;
          }
        }
        renderFluencySentence();
      }

      function playCurrentFluencyClip() {
        const sentenceObj = getCurrentSentenceObj();
        if (!sentenceObj.ttsClipId) return;
        if (window.NB_AUDIO && typeof window.NB_AUDIO.playCurriculumClip === "function") {
          window.NB_AUDIO.playCurriculumClip(sentenceObj.ttsClipId);
        }
      }

      function initStage3FluencyPacerCard() {
        if (!stage3El) return;
        const card = stage3El.querySelector("#fluencyPacerCard");
        if (!card) return;

        const phaseSelect = card.querySelector("[data-fp-phase-select]");
        if (phaseSelect) {
          phaseSelect.value = fpActivePhase;
          phaseSelect.addEventListener("change", function (event) {
            setFluencyPhase(event.target.value || "all");
          });
        }

        const startBtn = card.querySelector("[data-fp-start]");
        if (startBtn) {
          startBtn.addEventListener("click", function () {
            fpHasStarted = true;
            fpCurrentSetIndex = 0;
            fpCurrentSentenceIndex = 0;
            renderFluencySentence();
          });
        }

        const nextBtn = card.querySelector("[data-fp-next]");
        if (nextBtn) {
          nextBtn.addEventListener("click", function () {
            if (!fpHasStarted) return;
            nextFluencySentence();
          });
        }

        const playBtn = card.querySelector("[data-fp-play-sound]");
        if (playBtn) {
          playBtn.addEventListener("click", function () {
            playCurrentFluencyClip();
          });
        }

        renderFluencySentence();
      }

      const timers = {};
      let state = null;
      let stage3El = null;

      window.NB_STAGE3 = window.NB_STAGE3 || {};
      window.NB_STAGE3.setPhase = phase => {
        if (!phase) return;
        setVowelQuestPhase(phase);
        setFluencyPhase(phase);
      };
      window.NB_STAGE3.scrollIntoView = () => {
        const section = stage3El || document.getElementById('dlxStage3');
        section?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };

      function stopTimer(gameId) {
        const entry = timers[gameId];
        if (entry && entry.intervalId) {
          clearInterval(entry.intervalId);
        }
        delete timers[gameId];
      }

      function updateTimerDisplay(gameId) {
        const gameState = state.games[gameId];
        if (!gameState) return;
        const displayEls = stage3El.querySelectorAll(
          '[data-game="' + gameId + '"][data-field="timer"]'
        );
        const value = formatSeconds(gameState.timerSeconds || 0);
        displayEls.forEach(function (el) {
          el.textContent = value;
        });
      }

      function setActiveBlockButton(gameId, btn) {
        const all = stage3El.querySelectorAll(
          '[data-game="' + gameId + '"][data-game-block]'
        );
        all.forEach(function (b) {
          b.classList.toggle("is-active-block", b === btn);
        });
      }

      function startTimer(gameId, options) {
        options = options || {};
        stopTimer(gameId);

        const gameState = state.games[gameId];
        if (!gameState) return;

        gameState.timerSeconds = 0;
        updateTimerDisplay(gameId);

        const mode = options.mode || "open";
        const targetSeconds =
          typeof options.targetSeconds === "number" ? options.targetSeconds : null;

        const intervalId = setInterval(function () {
          gameState.timerSeconds = (gameState.timerSeconds || 0) + 1;
          updateTimerDisplay(gameId);
          if (mode === "block" && targetSeconds != null) {
            if (gameState.timerSeconds >= targetSeconds) {
              stopTimer(gameId);
              showToast("Calm block complete for " + gameId.replace("-", " ") + ".");
              saveState();
            }
          }
        }, 1000);

        timers[gameId] = {
          intervalId: intervalId,
          mode: mode,
          targetSeconds: targetSeconds,
        };
      }

      function updateGameDom(gameId) {
        const gameState = state.games[gameId];
        if (!gameState) return;

        const metricEls = stage3El.querySelectorAll(
          '[data-game="' + gameId + '"][data-field]'
        );

        metricEls.forEach(function (el) {
          const field = el.getAttribute("data-field");
          if (field === "timer") {
            el.textContent = formatSeconds(gameState.timerSeconds || 0);
            return;
          }
          if (field === "best-time") {
            const bt = gameState["best-time"];
            el.textContent =
              bt == null || bt === "—" ? "—" : formatSeconds(bt);
            return;
          }
          const value = gameState[field];
          if (typeof value !== "undefined") {
            el.textContent = value;
          }
        });
      }

      function updateAllGamesDom() {
        Object.keys(state.games).forEach(updateGameDom);
      }

      function getStudioKeyFromElement(el) {
        const card = el.closest(".dlx-studio-card");
        if (!card) return null;
        const metric = card.querySelector("[data-studio]");
        if (!metric) return null;
        return metric.getAttribute("data-studio");
      }

      function updateStudioDom(studioKey) {
        const studioState = state.studios[studioKey];
        if (!studioState) return;
        const cardMetric = stage3El.querySelector(
          '.dlx-studio-card [data-studio="' + studioKey + '"]'
        );
        if (!cardMetric) return;
        const card = cardMetric.closest(".dlx-studio-card");
        if (!card) return;

        const stepsCompleted = studioState.steps.filter(Boolean).length;

        // metrics at top
        const stepsMetric = card.querySelector(
          '[data-studio="' + studioKey + '"][data-field="steps"]'
        );
        if (stepsMetric) stepsMetric.textContent = stepsCompleted;

        const streakMetric = card.querySelector(
          '[data-studio="' + studioKey + '"][data-field="streak"]'
        );
        if (streakMetric) streakMetric.textContent = studioState.streak || 0;

        const progressCount = card.querySelector(
          '[data-studio="' + studioKey + '"][data-field="steps-count"]'
        );
        if (progressCount) progressCount.textContent = stepsCompleted;

        // individual steps
        const stepsEls = card.querySelectorAll(".dlx-studio-step");
        stepsEls.forEach(function (stepEl) {
          const idx = parseInt(stepEl.getAttribute("data-step"), 10) || 0;
          const done = !!studioState.steps[idx - 1];
          stepEl.classList.toggle("dlx-studio-step--done", done);
          const status = stepEl.querySelector(".dlx-studio-step__status");
          if (status) {
            status.textContent = done ? "Done" : "Not done";
          }
        });
      }

      function updateAllStudiosDom() {
        ["short", "long", "mixed"].forEach(updateStudioDom);
      }

      function handleGameStart(btn) {
        const gameId = btn.getAttribute("data-game-start");
        if (!gameId || !state.games[gameId]) return;
        const gameState = state.games[gameId];

        if (gameId === "vowel-quest") {
          gameState.timerSeconds = 0;
        } else if (gameId === "fluency-pacer") {
          // For now just reset timer and keep pace/sentences.
          gameState.timerSeconds = 0;
        } else if (gameId === "rapid-strip") {
          // Start calm timer; counts are updated when strip is finished.
          gameState.timerSeconds = 0;
        }

        saveState();
        updateGameDom(gameId);
        startTimer(gameId, { mode: "open" });
      }

      function handleGameBlock(btn) {
        const gameId = btn.getAttribute("data-game");
        if (!gameId || !state.games[gameId]) return;
        const minutes = parseInt(btn.getAttribute("data-game-block"), 10) || 1;
        setActiveBlockButton(gameId, btn);
        startTimer(gameId, {
          mode: "block",
          targetSeconds: minutes * 60,
        });
        showToast("Calm block started: " + minutes + " minute(s).");
      }

      function handleGameNext(btn) {
        const gameId = btn.getAttribute("data-game-next");
        if (!gameId || !state.games[gameId]) return;
        const gameState = state.games[gameId];
        if (gameId === "fluency-pacer") {
          if (!fpHasStarted) return;
          gameState.sentences = (gameState.sentences || 0) + 1;
          saveState();
          updateGameDom(gameId);
        }
      }

      function handleStripNew(btn) {
        const gameId = btn.getAttribute("data-strip-new");
        if (!gameId || !state.games[gameId]) return;
        const gameState = state.games[gameId];
        // Reset timer but do not touch strips count.
        gameState.timerSeconds = 0;
        updateGameDom(gameId);
        stopTimer(gameId);
        showToast("New naming strip ready – start when you are set.");
      }

      function handleStripFinished(btn) {
        const gameId = btn.getAttribute("data-strip-finished");
        if (!gameId || !state.games[gameId]) return;
        const gameState = state.games[gameId];
        const elapsed = gameState.timerSeconds || 0;

        gameState.strips = (gameState.strips || 0) + 1;
        if (
          gameState["best-time"] == null ||
          elapsed < gameState["best-time"]
        ) {
          gameState["best-time"] = elapsed;
        }

        stopTimer(gameId);
        saveState();
        updateGameDom(gameId);
        showToast(
          "Strip logged in " + formatSeconds(elapsed) + ". Nice steady rhythm."
        );
      }

      function handleGameExplain(btn) {
        const gameId = btn.getAttribute("data-game-explain");
        if (!gameId) return;
        const copy = GAME_COPY[gameId];
        const message =
          (copy && copy.explain) ||
          "This game supports calm, structured practice for reading and phonics.";
        showToast(message);
      }

      function handleGameHint(btn) {
        const gameId = btn.getAttribute("data-game-hint");
        if (!gameId) return;
        const copy = GAME_COPY[gameId];
        if (!copy || !Array.isArray(copy.hints) || copy.hints.length === 0) {
          showToast("Focus on slow, steady practice and clear sounds.");
          return;
        }
        const hint =
          copy.hints[Math.floor(Math.random() * copy.hints.length)];
        showToast(hint);
      }

      function handleFocusMode(btn) {
        const currentOn = stage3El.classList.contains("dlx-stage3--focus");
        const turnOn = !currentOn;
        stage3El.classList.toggle("dlx-stage3--focus", turnOn);
        const all = stage3El.querySelectorAll("[data-focus-mode]");
        all.forEach(function (b) {
          b.textContent = turnOn ? "🌙 Exit focus mode" : "🌙 Focus mode";
        });
        if (turnOn) {
          showToast("Focus mode on – Stage 3 is now highlighted.");
        }
      }

      function handleStudioStepToggle(stepEl) {
        // Avoid toggling when clicking a button inside the step (future-proof).
        if (stepEl.querySelector("button") && stepEl.contains(document.activeElement)) {
          return;
        }
        const studioKey = getStudioKeyFromElement(stepEl);
        if (!studioKey || !state.studios[studioKey]) return;
        const studioState = state.studios[studioKey];
        const idx = parseInt(stepEl.getAttribute("data-step"), 10) || 0;
        const index = idx - 1;
        if (index < 0 || index >= studioState.steps.length) return;

        studioState.steps[index] = !studioState.steps[index];
        saveState();
        updateStudioDom(studioKey);
      }

      function handleStudioComplete(btn) {
        const studioKey = btn.getAttribute("data-studio-complete");
        if (!studioKey || !state.studios[studioKey]) return;
        const studioState = state.studios[studioKey];

        // Increment simple streak and reset steps.
        studioState.streak = (studioState.streak || 0) + 1;
        studioState.steps = [false, false, false, false];

        saveState();
        updateStudioDom(studioKey);
        showToast(
          "Studio marked complete – streak now " +
            studioState.streak +
            " day(s)."
        );
      }

      document.addEventListener("DOMContentLoaded", function () {
        stage3El = document.getElementById("dlxStage3");
        if (!stage3El) return;

        state = loadState();

        // Initial DOM sync
        updateAllGamesDom();
        updateAllStudiosDom();
        initStage3VowelQuestCard();
        initStage3FluencyPacerCard();
        renderPhaseSummary();

        stage3El.addEventListener("click", function (event) {
          const target = event.target;

          const btnStart = target.closest("[data-game-start]");
          if (btnStart) {
            handleGameStart(btnStart);
            return;
          }

          const btnBlock = target.closest("[data-game-block]");
          if (btnBlock) {
            handleGameBlock(btnBlock);
            return;
          }

          const btnNext = target.closest("[data-game-next]");
          if (btnNext) {
            handleGameNext(btnNext);
            return;
          }

          const btnStripNew = target.closest("[data-strip-new]");
          if (btnStripNew) {
            handleStripNew(btnStripNew);
            return;
          }

          const btnStripFinished = target.closest("[data-strip-finished]");
          if (btnStripFinished) {
            handleStripFinished(btnStripFinished);
            return;
          }

          const btnExplain = target.closest("[data-game-explain]");
          if (btnExplain) {
            handleGameExplain(btnExplain);
            return;
          }

          const btnHint = target.closest("[data-game-hint]");
          if (btnHint) {
            handleGameHint(btnHint);
            return;
          }

          const btnFocus = target.closest("[data-focus-mode]");
          if (btnFocus) {
            handleFocusMode(btnFocus);
            return;
          }

          const btnStudioComplete = target.closest("[data-studio-complete]");
          if (btnStudioComplete) {
            handleStudioComplete(btnStudioComplete);
            return;
          }

          const studioStep = target.closest(".dlx-studio-step");
          if (studioStep && !target.closest("button")) {
            handleStudioStepToggle(studioStep);
            return;
          }
        });
      });
    })();
  </script>

</body>
</html>